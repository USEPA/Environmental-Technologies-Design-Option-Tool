Attribute VB_Name = "Correlations"
Option Explicit



'C------ CALCULATE WATER DENSITY (kg/m^3) VIA MTU CORRELATION.
'INPUTS:
'    - TEMPERATURE as Input_Temp, degK.
'RETURNS:
'    - WATER DENSITY, g/cm^3.
Function KineticCorr_WaterDensity( _
    Input_Temp) As Double
Dim TA As Double
Dim RetVal As Double
Dim A1 As Double
Dim A2 As Double
Dim A3 As Double
Dim A4 As Double
Dim A5 As Double
Dim XAVG As Double
Dim FAVG As Double
  A1 = -1.4176800403
  A2 = 8.976651524
  A3 = -12.275501969
  A4 = 7.4584410413
  A5 = -1.738491605
  XAVG = 324.65
  FAVG = 0.98396
  'NOTE: Input_Temp IS IN UNITS OF DEGK.
  TA = Input_Temp / XAVG
  RetVal = (A1 + A2 * TA + _
           A3 * TA ^ 2# + _
           A4 * TA ^ 3# + _
           A5 * TA ^ 4#) * FAVG * 1000#
  '(NOTE 1000# FACTOR IS TO CONVERT g/cm^3 TO kg/m^3.)
  KineticCorr_WaterDensity = RetVal
End Function
'C------ CALCULATE WATER VISCOSITY (g/cm-s) VIA YAWS CORRELATION.
'INPUTS:
'    - TEMPERATURE as Input_Temp, degK.
'RETURNS:
'    - WATER VISCOSITY, kg/m-s
'      (THIS WAS INCORRECTLY LABELLED AS g/cm-s BEFORE 1/6/99).
Function KineticCorr_WaterViscosity( _
    Input_Temp As Double) As Double
Dim TB As Double
Dim RetVal As Double
  'NOTE: Input_Temp IS IN UNITS OF DEGK.
  TB = Input_Temp
  RetVal = Exp((-24.71) + (4209#) / TB + _
           (0.04527) * TB - (0.00003376) * TB ^ 2#)
  RetVal = RetVal / 1000#
  KineticCorr_WaterViscosity = RetVal
End Function
'C------ CALCULATE AIR VISCOSITY (g/cm-s) VIA HOKANSON CODE.
'INPUTS:
'    - TEMPERATURE as Input_Temp, degK.
'RETURNS:
'    - AIR VISCOSITY, kg/m-s
'      (THIS WAS INCORRECTLY LABELLED AS g/cm-s BEFORE 1/6/99).
Function KineticCorr_AirViscosity( _
    Input_Temp As Double) As Double
  'NOTE: Input_Temp IS IN UNITS OF DEGK.
  KineticCorr_AirViscosity = _
      0.00000017 * (Input_Temp ^ 0.818)
End Function
'C------ CALCULATE AIR DENSITY (kg/m^3) VIA HOKANSON CODE.
'INPUTS:
'    - TEMPERATURE as Input_Temp, degK.
'    - PRESSURE as Input_Pres, atm.
'RETURNS:
'    - AIR DENSITY, kg/m^3.
Function KineticCorr_AirDensity( _
    Input_Temp As Double, _
    Input_Pres As Double) As Double
Dim MWAVG As Double
Dim r As Double
Dim ThisVal As Double
  'NOTE: Input_Temp IS IN UNITS OF DEGK.
  'NOTE: Input_Pres IS IN UNITS OF ATM.
  MWAVG = 28.95   'UNITS OF G/GMOL.
  r = 0.08205     'UNITS OF (L-ATM)/(GMOL-K).
  '
  ' ON THE NEXT LINE, THE UNITS ARE gmol/L =
  ' (atm/((L-atm)/(gmol-K))/(K)) =
  ' (atm*gmol-K)/(L-atm-K) = gmol/L (CHECKS).
  ThisVal = (Input_Pres / r / Input_Temp)
  '
  ' ON THE NEXT LINE, THE UNITS ARE g/L = (gmol/L)*(g/gmol) (CHECKS).
  ThisVal = ThisVal * MWAVG
  '
  ' ON THE NEXT LINE, THE UNITS ARE kg/m^3 = g/L (CHECKS).
  ThisVal = ThisVal * 1#
  '
  ' RETURN THE VALUE.
  KineticCorr_AirDensity = ThisVal
  'KineticCorr_AirDensity = _
      (1# / 1000#) * ((MWAVG) * (Input_Pres)) / ((r) * (Input_Temp))
End Function


Sub Update_FluidDensity(Temperature As Double, Pressure As Double, Density As Double)
Dim Dummy As Double
  If (State_Check_Water(1)) Then
    If (Bed.Phase = 0) Then
      'Call H2ODens(dummy, Temperature + 273.15)
      Dummy = KineticCorr_WaterDensity(Temperature + 273.15)
    Else
      'Call AIRDens(dummy, Temperature + 273.15, Pressure)
      Dummy = KineticCorr_AirDensity(Temperature + 273.15, Pressure)
    End If
    Density = Dummy / 1000#
    '(NOTE 1/1000 FACTOR IS TO CONVERT kg/m^3 TO g/cm^3.)
  End If
  'Note: If density correlation not in use, Density
  'is returned unchanged.
End Sub
Sub Update_FluidViscosity(Temperature As Double, Viscosity As Double)
Dim Dummy As Double
  If (State_Check_Water(2)) Then
    If (Bed.Phase = 0) Then
      'Call H2OVisc(dummy, Temperature + 273.15)
      Dummy = KineticCorr_WaterViscosity(Temperature + 273.15)
    Else
      'Call AirVisc(dummy, Temperature + 273.15)
      Dummy = KineticCorr_AirViscosity(Temperature + 273.15)
    End If
    Viscosity = Dummy * 10#
    '(NOTE 10# FACTOR IS TO CONVERT kg/m-s TO g/cm-s.)
  End If
  'Note: If viscosity correlation not in use, Viscosity
  'is returned unchanged.
End Sub


Function Diffg(i As Integer) As Double
'Wilke-Lee Correlation
Dim WTAIR As Double, Press  As Double
Dim RCOM As Double, RAIR As Double, VOLA As Double, RAB As Double
Dim EAB As Double, E As Double, FE As Double, DiffgT As Double
  WTAIR = 28.964
  RAIR = 0.3711
  'Press = Bed.Pressure * 101.3
  'Converting P from atm to Pa
  Press = Bed.Pressure * 101325
  'Converting Molar Volume @ NBP from cm3/mol to m3/kmol
  VOLA = Component(i).MolarVolume / 1000#
  RCOM = 1.18 * VOLA ^ 0.333333333333
  RAB = (RAIR + RCOM) / 2#
  'Energy of molecular attraction
  '78.6 is Eair and Ecompound is calculated using : e/k = 1.21 * Tb (Tb = NBP)
  ' Actually, EAB is = to epsilonAB over k
  EAB = Sqr(78.6 * 1.21 * (Component(i).BP + 273.15))
  'Collision function
  E = Log((Bed.Temperature + 273.15) / EAB) / Log(10#)
  FE = 10 ^ (-0.14329 - 0.48343 * E + 0.1939 * E ^ 2 + 0.13612 * E ^ 3 - 0.20578 * E ^ 4 + 0.083899 * E ^ 5 - 0.011491 * E ^ 6)
  DiffgT = (0.0001 * (1.084 - 0.249 * Sqr(1# / WTAIR + 1# / Component(i).MW)) * (Bed.Temperature + 273.15) ^ 1.5 * Sqr(1# / WTAIR + 1# / Component(i).MW)) / (Press * RAB ^ 2 * FE)
  'Converting from m2/s to cm2/s
  Diffg = DiffgT * 100# * 100#
End Function
Function Diffl(i As Integer) As Double
  'Diffl is in cm2/s
  Diffl = 0.0001326 / (100# * Bed.WaterViscosity) ^ 1.14 / (Component(i).MolarVolume) ^ 0.589
End Function


Function Dp(i As Integer) As Double
  'Dp is in cm2/s
  If (Bed.Phase = 0) Then
    Dp = Diffl(i) / Component(i).Tortuosity
  Else
    Dp = Diffg(i) / Component(i).Tortuosity
  End If
End Function
Function Ds(i As Integer) As Double
'Ds is in cm2/s
'Dl and Dg are in cm2/s
'Carbon.Density is converted from g/cm3 -> g/l  by multipling by 1000
'C0 is in mg/l
'q0 is in mg/g
  If ((Component(i).Use_Tortuosity_Correlation) And (Component(i).Constant_Tortuosity)) Then
    '---- Force Ds to 1.0e-30
    Ds = 1E-30
  Else
    If (Bed.Phase = 0) Then
      Ds = Carbon.Porosity * Diffl(i) * Component(i).InitialConcentration * Component(i).SPDFR / (1000# * Carbon.Density * Component(i).Tortuosity * (Component(i).InitialConcentration) ^ Component(i).Use_OneOverN * Component(i).Use_K)
    Else
      Ds = Carbon.Porosity * Diffg(i) * Component(i).InitialConcentration * Component(i).SPDFR / (1000# * Carbon.Density * Component(i).Tortuosity * (Component(i).InitialConcentration) ^ Component(i).Use_OneOverN * Component(i).Use_K)
    End If
  End If
End Function


Function kf(i As Integer) As Double
Dim Re As Double   'Reynolds number
Dim Vs As Double   'Superficial velocity
Dim Vi As Double   'Interstitial velocity
Dim EBED As Double 'Bed Porosity
Dim ss As Double   'Schmidt number
Dim D As Double
  If Error_In_Kinetic_Calculation Then
    kf = 0.00125
    Exit Function
  End If
  On Error GoTo Error_KF
  If (Bed.Phase = 0) Then
    '>>>>>> >>>   LIQUID PHASE   <<< <<<<<<
    'EBED IS DIMENSIONLESS.
    EBED = 1 - Bed.Weight / Bed.Diameter ^ 2 / PI * 4 / Bed.length / Carbon.Density / 1000#
    'Vs is in m/s
    Vs = Bed.Flowrate * 4# / Bed.Diameter ^ 2 / PI
    Vi = Vs / EBED
    'The Reynolds number is the INTERSTITIAL Reynolds Number
    'The viscosity is converted from g/cm.s to kg/m.s by dividing its value by 10.0
    Re = 2# * Carbon.ParticleRadius * Vi * Bed.WaterDensity * 1000# / (Bed.WaterViscosity / 10#)
    ss = SC(i)
    'KF is in cm/s
    'Diffg is in cm2/s, Carbon.ParticleRadius is in m -> Kf is in cm/s
    'The Gnielinski correlation is used instead of the following one.
    'kf = 2.4 * Vs * 100 / Re ^ .66 / SS ^ .58
    kf = (1# + 1.5 * (1 - EBED)) * Carbon.ShapeFactor * Diffl(i) / (2 * Carbon.ParticleRadius * 100#) * (2# + 0.644 * Re ^ 0.5 * ss ^ (1 / 3))
  Else
    '>>>>>> >>>   GAS PHASE   <<< <<<<<<
    'EBED IS DIMENSIONLESS.
    EBED = 1 - Bed.Weight / Bed.Diameter ^ 2 / PI * 4 / Bed.length / Carbon.Density / 1000#
    'Vs is in m/s
    Vs = Bed.Flowrate * 4# / Bed.Diameter ^ 2 / PI
    Vi = Vs / EBED
    If (USE_GASPHASE_WAKAO_AND_FUNAZUKRI) Then
      'USE THE WAKAO-FUNAZUKRI CORRELATION.
      '---- Old code: Wakao-Funzaki
      'The Reynolds number is the SUPERFICIAL Reynolds Number
      'The viscosity is converted from g/cm.s to kg/m.s by dividing its value by 10.0
      Re = 2# * Carbon.ParticleRadius * Vs * Bed.WaterDensity * 1000# / (Bed.WaterViscosity / 10#)
      ss = SC(i)
      'Diffg is in cm2/s, Radius is in m -> Kf is in cm/s
      kf = Diffg(i) / (2 * Carbon.ParticleRadius * 100#) * Carbon.ShapeFactor * (2# + 1.1 * Re ^ 0.6 * ss ^ (1 / 3))
      '---- End of Old code
    Else
      'USE THE GNIELINSKI CORRELATION.
      '---- New kf for gas phase (Gnielinski Correlation) added by EJO on 11/1/96
      'The Reynolds number is the INTERSTITIAL Reynolds Number
      'The viscosity is converted from g/cm.s to kg/m.s by dividing its value by 10.0
      'Note: for gas phase, variables Bed.WaterDensity and Bed.WaterViscosity store
      '         Air Density and Air Viscosity, respectively
      Re = 2# * Carbon.ParticleRadius * Vi * Bed.WaterDensity * 1000# / (Bed.WaterViscosity / 10#)
      ss = SC(i)
      'Diffg is in cm2/s, Radius is in m -> Kf is in cm/s
      kf = (1# + 1.5 * (1 - EBED)) * Carbon.ShapeFactor * Diffg(i) / (2 * Carbon.ParticleRadius * 100#) * (2# + 0.644 * Re ^ 0.5 * ss ^ (1 / 3))
    End If
  End If
  Exit Function
Error_KF:
  Call Show_Error("An error occurred while calculating " & _
      "the Kf coefficient.  This error is certainly due " & _
      "to a value of the apparent density that is too low.")
  Error_In_Kinetic_Calculation = True
  kf = 0.00125
  Resume Exit_KF
Exit_KF:
End Function


Function Re() As Double
Dim SurfaceLoading As Double            'm/s
Dim CarbonParticleDiameter As Double    'm
Dim FluidViscosity As Double            'kg/m-s
Dim FluidDensity As Double              'kg/m^3
Dim Porosity As Double                  '(-)
  SurfaceLoading = SF()
  FluidViscosity = Bed.WaterViscosity * 0.1             'Convert g/cm-s to kg/m-s.
  FluidDensity = Bed.WaterDensity * 1000                'Convert g/cm^3 to kg/m^3.
  CarbonParticleDiameter = 2 * Carbon.ParticleRadius
  Call GetMoreBedParameters
  Re = (CarbonParticleDiameter) * (FluidDensity) * (SurfaceLoading) / (FluidViscosity) / Bed.Porosity
End Function


Function SC(i As Integer) As Double
Dim VA As Double, DA As Double
  If (Bed.Phase = 0) Then
    SC = Bed.WaterViscosity / Bed.WaterDensity / Diffl(i)
  Else
    'DA = (28.694 * Bed.Pressure) / (.08216 * (Bed.Temperature + 273.15) * 1000#)
    'VA = .0000017 * (Bed.Temperature + 273.15) ^ .818
    'Diffg in cm2/s
    'VA in g/cm.s
    'DA in g/cm3
    VA = Bed.WaterViscosity       'NOTE: WHEN BED.PHASE=1, THIS IS ACTUALLY THE _AIR_ VISCOSITY.
    DA = Bed.WaterDensity         'NOTE: WHEN BED.PHASE=1, THIS IS ACTUALLY THE _AIR_ DENSITY.
    SC = VA / (DA * Diffg(i))
  End If
End Function


Function SF() As Double
Dim CrossSectionalArea As Double        'm^2
  CrossSectionalArea = 3.14159 * ((Bed.Diameter) ^ 2) / 4
  SF = Bed.Flowrate / CrossSectionalArea
End Function


Function Tortuosity(i As Integer) As Double
  'THE OLD CORRELATION FOR Constant_Tortuosity = True
  'HAS BEEN REMOVED FOR SEVERAL YEARS NOW (1998).
  'If (Component(i).Constant_Tortuosity) Then
  '  tortuosity = 0.782 + 0.925 * CDbl(Bed.Length * PI * Bed.Diameter * Bed.Diameter / 4# / Bed.Flowrate / 60#)
  'Else
    Tortuosity = 1#
  'End If
End Function


Function Get_Correlation_Description(Which As Integer) As String
  Select Case Which
    Case 0:     'FOR FILM DIFFUSION.
      Select Case Bed.Phase
        Case 0:     'LIQUID-PHASE.
          Get_Correlation_Description = "Gnielinski Correlation"
        Case 1:     'GAS-PHASE.
          If (USE_GASPHASE_WAKAO_AND_FUNAZUKRI) Then
            Get_Correlation_Description = "Wakao and Funazukri Correlation"
          Else
            Get_Correlation_Description = "Gnielinski Correlation"
          End If
      End Select
    Case 1:     'FOR SURFACE DIFFUSION.
      Get_Correlation_Description = "Sontheimer Correlation"
    Case 2:     'FOR PORE DIFFUSION.
      Select Case Bed.Phase
        Case 0:     'LIQUID-PHASE.
          Get_Correlation_Description = "Hayduk and Laudie for diffusion coefficient, user-entry for tortuosity"
        Case 1:     'GAS-PHASE.
          Get_Correlation_Description = "Wilke-Lee modification of the Hirschfelder - Bird - Spotz method for diffusion coefficient, user-entry for tortuosity"
      End Select
  End Select
End Function










Function SPDFR_Corr(i As Integer)
  Select Case Component(i).SPDFR_Low_Concentration
    Case True
      SPDFR_Corr = 5.5797 * (Bed.length * PI * Bed.Diameter * Bed.Diameter / 4# / Bed.Flowrate / 60#) ^ (-0.595)
    Case False
      SPDFR_Corr = 16.263 * (Bed.length * PI * Bed.Diameter * Bed.Diameter / 4# / Bed.Flowrate / 60#) ^ (-0.843)
  End Select
End Function


Sub Update_KP_Values()
Dim i As Integer
  For i = 1 To Number_Component
    'Update kf
    If Component(i).Corr(1) Then
      Component(i).kf = kf(i)
    End If
    'Update Ds
    If Component(i).Corr(2) Then
      Component(i).Ds = Ds(i)
    End If
    'Update Dp
    If Component(i).Corr(3) Then
     Component(i).Dp = Dp(i)
    End If
  Next i
End Sub


Attribute VB_Name = "CorrelationsDimless"
Option Explicit


Function Bip(i As Integer) As Double
  Bip = (ST(i)) / (Edp(i))
End Function
Function Bis(i As Integer) As Double
  Bis = (ST(i)) / (Eds(i))
End Function


Function Dgp(i As Integer) As Double
Dim EBED As Double, TAU As Double
  EBED = 1 - Bed.Weight / Bed.Diameter / Bed.Diameter / PI * 4 / Bed.Length / Carbon.Density / 1000#
  Dgp = Carbon.Porosity * (1 - EBED) / (EBED)
End Function
Function Dgs(i As Integer) As Double
Dim EBED As Double
Dim qe As Double
  EBED = 1 - Bed.Weight / Bed.Diameter / Bed.Diameter / PI * 4 / Bed.Length / Carbon.Density / 1000#
  qe = (Component(i).Use_K) * (Component(i).InitialConcentration) ^ (Component(i).Use_OneOverN)
  Dgs = Carbon.Density * qe * (1 - EBED) * 1000# / (EBED * Component(i).InitialConcentration)
  ' Explanation:
  ' Dgs = (rho_a)*(q_e)*(1-epsilon)/(epsilon*C_0)
  ' Note:
  ' "epsilon" is EBED=1-Bed.Weight/Bed.Diameter/Bed.Diameter/Pi*4/Bed.Length/Carbon.Density/1000#
  ' "C_0" is Component(i).InitialConcentration
  ' "rho_a" is "adsorbent density which includes pore volume"
  ' "q_e" is "adsorbent phase concentration in equilibrium
  '           with initial bulk phase concentration
  '           (K(i))*(C_0(i))^(Use_OneOverN(i))
End Function


Function Edp(i As Integer)
Dim EBED As Double, TAU As Double, Dgp As Double
  EBED = 1 - Bed.Weight / Bed.Diameter / Bed.Diameter / PI * 4 / Bed.Length / Carbon.Density / 1000#
  TAU = Bed.Diameter * Bed.Diameter * PI / 4 * Bed.Length * EBED / Bed.Flowrate
  Dgp = Carbon.Porosity * (1 - EBED) / EBED
  'DGp = (1 - EBED) / EBED
  Edp = Component(i).Dp * Dgp * TAU / (Carbon.ParticleRadius * 100) ^ 2
End Function
Function Eds(i As Integer)
Dim EBED As Double, qe As Double, TAU As Double, Dgs As Double
  'QE in mg/g
  'Initial Conc. in mg/l
  'Tau in s
  EBED = 1 - Bed.Weight / Bed.Diameter / Bed.Diameter / PI * 4 / Bed.Length / Carbon.Density / 1000#
  qe = Component(i).Use_K * (Component(i).InitialConcentration) ^ Component(i).Use_OneOverN
  TAU = Bed.Diameter * Bed.Diameter * PI / 4 * Bed.Length * EBED / Bed.Flowrate
  Dgs = Carbon.Density * 1000# * (1 - EBED) * qe / EBED / Component(i).InitialConcentration
  Eds = Component(i).Ds * Dgs * TAU / (Carbon.ParticleRadius * 100) ^ 2
End Function


Function ST(i As Integer) As Double
Dim EBED As Double, TAU As Double
  EBED = 1 - Bed.Weight / Bed.Diameter / Bed.Diameter / PI * 4 / Bed.Length / Carbon.Density / 1000#
  TAU = Bed.Diameter * Bed.Diameter * PI / 4 * Bed.Length * EBED / Bed.Flowrate
  'kf in cm/s
  'Tau in s
  'PArticleRadius in m, converted in cm
  ST = Component(i).kf * (1 - EBED) * TAU / EBED / (Carbon.ParticleRadius * 100)
End Function

Attribute VB_Name = "DataEntry"
Option Explicit



Function Format_It(ByVal X As Double, ByVal N As Integer) As String
Dim s As String
  Select Case N
  Case 2
    Select Case Abs(X)
     Case Is < 0.1
      s = Format$(X, "0.00E+00")
     Case Is > 100#
      s = Format$(X, "0.00E+00")
     Case Else
      s = Format$(X, "0.00")
     End Select
  Case 3
    Select Case Abs(X)
     Case Is < 0.1
      s = Format$(X, "0.000E+00")
     Case Is > 100#
      s = Format$(X, "0.000E+00")
     Case Else
      s = Format$(X, "0.000")
     End Select
  End Select
  Format_It = s
End Function


Public Function Global_ReadOnlyKeyPress(ByVal KeyAscii%) As Integer
Dim KeyStroke%
  Select Case KeyAscii%
    ' CONTROL CHARACTERS: ^C, <BS>, ^V, ^X, ^Z
    Case 3, 8, 22, 24, 26
      KeyStroke% = KeyAscii%
    Case 13 ' <Enter> -> <Tab>
      SendKeys "{TAB}", True
    Case Else
      KeyStroke% = 0
  End Select
  Global_ReadOnlyKeyPress = KeyStroke%
End Function
Public Function Global_Numeric0123456789KeyPress(ByVal KeyAscii%) As Integer
Dim KeyStroke%
  Select Case KeyAscii%
    Case 48 To 57:
      KeyStroke% = KeyAscii%
    ' CONTROL CHARACTERS: ^C, <BS>, ^V, ^X, ^Z
    Case 3, 8, 22, 24, 26
      KeyStroke% = KeyAscii%
    Case 13 ' <Enter> -> <Tab>
      SendKeys "{TAB}", True
    Case Else
      KeyStroke% = 0
  End Select
  Global_Numeric0123456789KeyPress = KeyStroke%
End Function
Public Function Global_NumericKeyPress(ByVal KeyAscii%) As Integer
Dim KeyStroke%
  '
  ' THIS FUNCTION ONLY ALLOWS THE USER TO
  ' ENTER NUMERIC VALUES INTO A TEXT BOX
  '
  Select Case KeyAscii%
    ' ASCII CHARACTERS:  +, -, ., 0-9, E
    Case 43, 45, 46, 48 To 57, 69
      KeyStroke% = KeyAscii%
    ' CONTROL CHARACTERS: ^C, <BS>, ^V, ^X, ^Z
    Case 3, 8, 22, 24, 26
      KeyStroke% = KeyAscii%
    Case 101 ' e -> E
      KeyStroke% = 69
    Case 13 ' <Enter> -> <Tab>
      SendKeys "{TAB}", True
    Case Else
      KeyStroke% = 0
  End Select
  Global_NumericKeyPress = KeyStroke%
End Function
Public Function Global_MultilineTextKeyPress(ByVal KeyAscii%) As Integer
Dim KeyStroke%
  Select Case KeyAscii%
    'Case 13: ' <Enter> -> <Tab>
    '  SendKeys "{TAB}", True
    '  KeyStroke% = 0
    Case 34:  'double-quote character (")
      KeyStroke% = 0
    Case Else:
      KeyStroke% = KeyAscii%
  End Select
  Global_MultilineTextKeyPress = KeyStroke%
End Function
Public Function Global_TextKeyPress(ByVal KeyAscii%) As Integer
Dim KeyStroke%
  Select Case KeyAscii%
    Case 13: ' <Enter> -> <Tab>
      SendKeys "{TAB}", True
      KeyStroke% = 0
    Case 34:  'double-quote character (")
      KeyStroke% = 0
    Case Else:
      KeyStroke% = KeyAscii%
  End Select
  Global_TextKeyPress = KeyStroke%
End Function
Public Sub Global_GotFocus(gObject As Object)
  gObject.BackColor = RGB(0, 220, 220)
  gObject.SelStart = 0
  gObject.SelLength = Len(gObject.Text)
End Sub
Public Sub Global_LostFocus(gObject As Object)
  gObject.BackColor = RGB(255, 255, 255)
  gObject.SelLength = 0
End Sub


Function GetDoubleFormat(ByVal Value As Double) As String
Dim AbsValue As Double
  AbsValue = Abs(Value)
  Select Case AbsValue
    Case 0#
      GetDoubleFormat = "0"
    Case Is < 0.001
      GetDoubleFormat = "0.00E+00"
    Case Is < 0.01
      GetDoubleFormat = "0.00E+00"
    Case Is < 0.1
      GetDoubleFormat = "0.0000"
    Case Is < 1
      GetDoubleFormat = "0.000"
    Case Is < 10
      GetDoubleFormat = "0.00"
    Case Is < 100
      GetDoubleFormat = "0.0"
    Case Is < 100000
      GetDoubleFormat = "0"
    'Case Is < 1000# * 1000# * 1000#
    '  GetDoubleFormat = "###,###,###,###"
    Case Else
      GetDoubleFormat = "0.00E+00"
  End Select
End Function
Function GetDoubleFormatLonger(ByVal Value As Double) As String
Dim AbsValue As Double
  AbsValue = Abs(Value)
  Select Case AbsValue
    Case 0#
      GetDoubleFormatLonger = "0"
    Case Is < 0.001
      GetDoubleFormatLonger = "0.00000E+00"
    Case Is < 0.01
      GetDoubleFormatLonger = "0.00000E+00"
    Case Is < 0.1
      GetDoubleFormatLonger = "0.0000000"
    Case Is < 1#
      GetDoubleFormatLonger = "0.000000"
    Case Is < 10#
      GetDoubleFormatLonger = "0.00000"
    Case Is < 100#
      GetDoubleFormatLonger = "0.0000"
    Case Is < 1000#
      GetDoubleFormatLonger = "0.000"
    Case Is < 10000#
      GetDoubleFormatLonger = "0.00"
    Case Is < 100000#
      GetDoubleFormatLonger = "0.0"
    Case Is < 1000000#
      GetDoubleFormatLonger = "0"
    Case Is < 100000000#
      GetDoubleFormatLonger = "0"
    'Case Is < 1000# * 1000# * 1000#
    '  GetDoubleFormat = "###,###,###,###"
    Case Else
      GetDoubleFormatLonger = "0.00000E+00"
  End Select
End Function
Public Function NumberToMFBString(Value As Variant) As String
Dim pformat$
  Select Case VarType(Value)
    Case vbLong, vbInteger
      pformat$ = "0"
    Case vbDouble, vbSingle
      pformat$ = GetDoubleFormat(CDbl(Value))
    Case vbString
      NumberToMFBString = Value
      Exit Function
  End Select
  NumberToMFBString = Format$(Value, pformat$)
End Function
Public Sub AssignTextAndTag(gObject As Object, Value As Variant)
  gObject.Text = NumberToMFBString(Value)
  gObject.Tag = gObject.Text
End Sub
Public Sub AssignCaptionAndTag(gObject As Object, Value As Variant)
  gObject.Caption = NumberToMFBString(Value)
  gObject.Tag = gObject.Caption
End Sub


'Sub Test_LostFocus_WithUnits( _
'    text_box As TextBox, _
'    ConversionFactor As Double, _
'    LB As Double, _
'    ub As Double, _
'    dummy As Double, _
'    VName As String, _
'    Range As String, _
'    Flag_OK As Integer)
'  On Error GoTo ErrHandlerLost2
'  '-- Get number into standard units
'  If (ConversionFactor < 0) Then
'    dummy = ReverseTemperatureConversion(-ConversionFactor - 1, CDbl(text_box))
'  Else
'    dummy = CDbl(text_box) / ConversionFactor
'  End If
'
'  '-- Do range checking
'  If (dummy < LB) Or (dummy > ub) Then GoTo RangeVariable2
'  Flag_OK = True
'  GoTo Exit_Test_LostFocus2
'
'ErrHandlerLost2:
'  MsgBox "Invalid Data Value" & Chr$(10) & _
'      "The wrong value is replaced by the previous one.", _
'      vbExclamation, "Error in " & VName
'  text_box.Text = Temp_Text
'  Resume Active_Variable2
'
'Active_Variable2:
'  '-- Don't need the next 3 lines any more!
'  If (text_box.Enabled) Then
'    text_box.SetFocus
'  End If
'
'  Flag_OK = False
'  GoTo Exit_Test_LostFocus2
'
'RangeVariable2:
'  MsgBox "Value Out Of Range" & Range & Chr$(10) & "The wrong value is replaced by the previous one.", vbExclamation, "Error in " & VName
'  text_box = Temp_Text
'  GoTo Active_Variable2
'
'Exit_Test_LostFocus2:
'End Sub



Attribute VB_Name = "FileIO"
Option Explicit

Global Project_Is_Dirty As Boolean





Const FileIO_declarations_end = True


'NOTE: THIS FUNCTION WORKS EQUALLY WELL ON
'EITHER FILES OR DIRECTORIES.
Function File_IsExists(fn As String) As Boolean
Dim Dummy As Long
  On Error GoTo err_File_IsExists
  Dummy = GetAttr(fn)   'TRIGGERS ERROR IF FILE DOES NOT EXIST.
  File_IsExists = True
  Exit Function
exit_err_File_IsExists:
  File_IsExists = False
  Exit Function
err_File_IsExists:
  Resume exit_err_File_IsExists
End Function
Function FileExists(fn As String) As Boolean
  FileExists = File_IsExists(fn)
End Function
Sub KillFile_If_Exists(fn As String)
  If (File_IsExists(fn)) Then
    On Error Resume Next
    Kill fn
  End If
End Sub


Sub file_new()
  'DISABLE RESULTS MENU: PSDM, CPHSDM, ECM, COMPARE PSDM, COMPARE CPHSDM.
  frmMain.mnuResultsItem(0).Enabled = False
  frmMain.mnuResultsItem(1).Enabled = False
  frmMain.mnuResultsItem(2).Enabled = False
  frmMain.mnuResultsItem(3).Enabled = False
  frmMain.mnuResultsItem(4).Enabled = False
  ''''frmMain.mnuResultsItem(10).Enabled = False      'PSDM-IN-ROOM.
  'DISABLE OPTIONS MENU: FOULING, INFLUENT CONC, EFFLUENT CONC.
  frmMain.mnuOptionsItem(0).Enabled = False
  frmMain.mnuOptionsItem(1).Enabled = False
  frmMain.mnuOptionsItem(2).Enabled = False
  'DISABLE RUN MENU: PSDM, CPHSDM, ECM.
  frmMain.mnuRunItem(0).Enabled = False
  frmMain.mnuRunItem(1).Enabled = False
  frmMain.mnuRunItem(2).Enabled = False
  frmMain.mnuRunItem(10).Enabled = False      'PSDM-IN-ROOM.
  'DISABLE FILE MENU: SAVE.
  frmMain.mnuFileItem(2).Enabled = False
  
  'INITIALIZE FOR LIQUID PHASE DEFAULTS.
  Bed.Phase = 0
  Call Initialize_All_Data(0)
  frmMain.Caption = name_app & "  -  (Untitled)"

  'CLEAR DIRTY (CHANGES) FLAG.
  Project_Is_Dirty = False
  Call DirtyStatus_Set_Current
End Sub


Sub File_Open(fn_Open As String)
Dim f As Integer
Dim ThisVersion As Double
Dim ShowLegacyWarning As Boolean
Dim OpenedOkay As Boolean
Dim IsLegacyVersion As Boolean
Dim DbTest1 As Database
Dim Rs1 As Recordset
Dim IsInvalidFormat As Boolean
Dim DataVersion_Major As Integer
Dim DataVersion_Minor As Integer
  On Error GoTo err_file_open
  If (Not FileExists(fn_Open)) Then
    Call Show_Error("File `" & fn_Open & "` does not exist.")
    GoTo exit_sub
  End If
  frmMain.MousePointer = 11
  'DETERMINE WHETHER THIS IS A LEGACY VERSION.
  IsLegacyVersion = True
  On Error Resume Next
  Set DbTest1 = OpenDatabase(fn_Open)
  If (Err.number = 0) Then
    IsLegacyVersion = False
    DbTest1.Close
  End If
  On Error GoTo err_file_open
  If (IsLegacyVersion = False) Then
    'DETERMINE WHETHER THE MDB FORMAT FILE IS A LEGACY-VERSION.
    IsInvalidFormat = True
    Set DbTest1 = OpenDatabase(fn_Open)
    If (Database_IsTableExist(DbTest1, "Version") = False) Then
      'INVALID FORMAT.
    Else
      Set Rs1 = DbTest1.OpenRecordset("Version")
      If (Database_NoRecordsInRecordset(Rs1)) Then
        'INVALID FORMAT.
      Else
        DataVersion_Major = 0#
        DataVersion_Minor = 0#
        Rs1.MoveFirst
        Do Until Rs1.EOF
          Select Case Trim$(UCase$(Database_Get_String(Rs1, "FieldName")))
            Case Trim$(UCase$("DataVersion_Major")): Call Database_LoadProperty(Rs1, DataVersion_Major)
            Case Trim$(UCase$("DataVersion_Minor")): Call Database_LoadProperty(Rs1, DataVersion_Minor)
            ''''Case Trim$(UCase$("ContainsPSDMInRoomData")): Call Database_LoadProperty(Rs1, ContainsPSDMInRoomData)
          End Select
          Rs1.MoveNext
        Loop
        Rs1.Close
        DbTest1.Close
      End If
    End If
    If (DataVersion_Major = 1) Then
      Select Case DataVersion_Minor
        Case 60:
          'OPEN A NON-LEGACY-VERSION FILE.
          Call file_new
          OpenedOkay = File_Open_Latest_v1_60(fn_Open)
          If (OpenedOkay) Then IsInvalidFormat = False
      End Select
    End If
    If (IsInvalidFormat) Then
      Call Show_Error("The selected file is not a " & _
          "valid Adsorption Design Software file.")
      GoTo exit_sub
    End If
  Else
    'OPEN A LEGACY-VERSION FILE (TEXT FORMAT).
    f = FreeFile
    Open fn_Open For Input As #f
    Input #f, ThisVersion
    ShowLegacyWarning = True
    OpenedOkay = True
    Select Case ThisVersion
      Case 1#: Call File_Open_Legacy_v1_00(f)
      Case 1.2: Call File_Open_Legacy_v1_20(f)
      Case 1.3: Call File_Open_Legacy_v1_30(f)
      Case 1.42:
        If (Activate_PSDMInRoom) Then
          ' DO NOTHING.
        Else
          Call Show_Error("Warning: The selected file contains " & _
              "PSDM-in-room model data which is not accessible " & _
              "using this version of the Adsorption Design Software.  " & _
              "The file will be loaded anyway.")
        End If
        Call File_Open_Legacy_v1_42(f)
      Case 1.4:
        ''''ShowLegacyWarning = False
        OpenedOkay = File_Open_Legacy_v1_40(f)
      Case Else:
        Call Show_Error("The selected file is not a " & _
            "valid Adsorption Design Software file.")
        Close #f
        GoTo exit_sub
    End Select
    If (OpenedOkay = False) Then
      Close #f
      Call file_new
      GoTo exit_sub
    End If
  End If
  'UPDATE CURRENT BED PHASE.
  Call chem_phase(Bed.Phase)
  'SHOW LEGACY WARNING IF NECESSARY.
  If (ShowLegacyWarning) Then
    'Call Show_Message("Warning: This file is formatted as an " & _
        "AdDesignS Version " & Format$(ThisVersion, "0.00") & _
        " file.  If saved, it will be saved as an AdDesignS " & _
        "Version " & Format$(NVersion, "0.00") & _
        " file.")
    Call Show_Message00("Warning: This file is formatted as an " & _
        "AdDesignS Version " & Format$(ThisVersion, "0.00") & _
        " file.  If saved, it will be saved as an AdDesignS " & _
        "Version " & Trim$(Str$(Latest_DataVersion_Major)) & "." & _
        Trim$(Str$(Latest_DataVersion_Minor)) & _
        " file.", _
        vbInformation, _
        App.Title & " : Legacy File Version Warning")
  End If
  Close #f
  'UPDATE DISPLAY.
  Filename = fn_Open
  frmMain.Caption = name_app & "  -  " & Trim$(Filename)
  Call frmMain_Refresh
  'CLEAR DIRTY FLAG.
  Project_Is_Dirty = False
  Call DirtyStatus_Set_Current
  'MOVE THIS FILENAME TO TOP OF LAST-FEW-FILES LIST.
  Call OldFileList_Promote( _
      Filename, _
      1, _
      frmMain.mnuFileItem(199), _
      frmMain.mnuFileItem(191), _
      frmMain.mnuFileItem(192), _
      frmMain.mnuFileItem(193), _
      frmMain.mnuFileItem(194))
  GoTo exit_sub
exit_sub:
  frmMain.MousePointer = 0
  Exit Sub
exit_err_file_open:
  Call file_new
  GoTo exit_sub
err_file_open:
  Call Show_Trapped_Error("file_open")
  On Error Resume Next
  Close f
  Resume exit_err_file_open
End Sub
Sub File_OpenAs(fn_force As String)
Dim fn_openas As String
  If (fn_force <> "") Then
    fn_openas = fn_force
  Else
    'INPUT NEW FILENAME.
    On Error GoTo err_file_openas
    frmMain.CommonDialog1.DialogTitle = "Open AdDesignS File"
    frmMain.CommonDialog1.Filter = "All Files (*.*)|*.*|AdDesignS Files (*.dat)|*.dat"
    frmMain.CommonDialog1.FilterIndex = 2
    frmMain.CommonDialog1.CancelError = True
    frmMain.CommonDialog1.flags = _
        cdlOFNFileMustExist + _
        cdlOFNPathMustExist
    frmMain.CommonDialog1.ShowOpen
    fn_openas = Trim$(frmMain.CommonDialog1.Filename)
    If (fn_openas = "") Then
      'DO NOTHING.
      Exit Sub
    End If
  End If
  'OPEN THIS FILE.
  Call File_Open(fn_openas)
exit_err_file_openas:
  Exit Sub
err_file_openas:
  If (Err.number = cdlCancel) Then
    'CANCEL BUTTON WAS SELECTED.
    Resume exit_err_file_openas
  End If
  Resume exit_err_file_openas
End Sub


'RETURNS:
'- true = save went okay.
'- false = save failed.
Function File_Save(fn_Save As String) As Boolean
Dim f As Integer
Dim SavedOkay As Boolean
  On Error GoTo err_File_Save
  'SAVE FILE.
  ''''f = FreeFile
  ''''Open fn_Save For Output As #f
  ''''Call File_Save_Latest_v1_40(f)
  frmMain.MousePointer = 11
  SavedOkay = File_Save_Latest_v1_60(fn_Save)
  If (SavedOkay = False) Then
    GoTo exit_err_File_Save
  End If
  ''''Close #f
  'CLEAR DIRTY FLAG.
  Project_Is_Dirty = False
  Call DirtyStatus_Set_Current
  File_Save = True
  'UPDATE DISPLAY.
  Filename = fn_Save
  frmMain.Caption = name_app & "  -  " & Trim$(Filename)
  Call frmMain_Refresh
  'MOVE THIS FILENAME TO TOP OF LAST-FEW-FILES LIST.
  Call OldFileList_Promote( _
      Filename, _
      1, _
      frmMain.mnuFileItem(199), _
      frmMain.mnuFileItem(191), _
      frmMain.mnuFileItem(192), _
      frmMain.mnuFileItem(193), _
      frmMain.mnuFileItem(194))
  GoTo Exit_Function
Exit_Function:
  frmMain.MousePointer = 0
  Exit Function
exit_err_File_Save:
  File_Save = False
  GoTo Exit_Function
err_File_Save:
  Call Show_Trapped_Error("File_Save")
  On Error Resume Next
  Close f
  Resume exit_err_File_Save
End Function
'RETURNS:
'- true = save went okay.
'- false = save failed.
Function File_SaveAs(fn_force As String) As Boolean
Dim f As Integer
Dim fn_saveas As String
Dim RetVal As Integer
  If (fn_force <> "") Then
    fn_saveas = fn_force
  Else
    Do While (1 = 1)
      'INPUT NEW FILENAME.
      On Error GoTo err_File_SaveAs
      frmMain.CommonDialog1.DialogTitle = "Save AdDesignS File"
      frmMain.CommonDialog1.Filter = "All Files (*.*)|*.*|AdDesignS Files (*.dat)|*.dat"
      frmMain.CommonDialog1.FilterIndex = 2
      frmMain.CommonDialog1.CancelError = True
      frmMain.CommonDialog1.flags = _
          cdlOFNOverwritePrompt + _
          cdlOFNPathMustExist
      frmMain.CommonDialog1.ShowSave
      fn_saveas = Trim$(frmMain.CommonDialog1.Filename)
      If (fn_saveas = "") Then
        'DO NOTHING.
        Exit Function
      End If
      'If (Not File_IsExists(fn_saveas)) Then
      '  Exit Do
      'End If
      'RetVal = MsgBox("File " & fn_saveas & _
      '    " already exists.  Do you want to replace it?", _
      '    vbQuestion + vbYesNo, _
      '    App.Title & " : Overwrite File ?")
      'If (RetVal = vbYes) Then Exit Do
      'NOTE: "REPLACE?" CHECK HANDLED IN COMMON
      'DIALOG CONTROL NOW.
      Exit Do
    Loop
  End If
  'OPEN THIS FILE.
  File_SaveAs = File_Save(fn_saveas)
  Exit Function
exit_err_File_SaveAs:
  File_SaveAs = False
  Exit Function
err_File_SaveAs:
  If (Err.number = cdlCancel) Then
    'CANCEL BUTTON WAS SELECTED.
    Resume exit_err_File_SaveAs
  End If
  Call Show_Trapped_Error("File_SaveAs")
  Resume exit_err_File_SaveAs
End Function


Function Project_IsDirtyFlagThrown() As Boolean
  If (Project_Is_Dirty) Then
    Project_IsDirtyFlagThrown = True
  Else
    Project_IsDirtyFlagThrown = False
  End If
End Function


'RETURNS:
'- true = it's okay to unload this file now.
'- false = cancel the unload.
Function file_query_unload() As Integer
Dim RetVal As Integer
Dim msg As String
  If (Not Project_IsDirtyFlagThrown()) Then
    file_query_unload = True
    Exit Function
  End If
  msg = "Do you want to save the changes you made to "
  If (Filename = "") Then
    msg = msg & "this new project"
  Else
    msg = msg & "your project of filename " & Filename
  End If
  msg = msg & " ?"
  RetVal = MsgBox(msg, vbCritical + vbYesNoCancel, App.Title & " : Save Changes ?")
  Select Case RetVal
    Case vbYes:
      If (File_SaveAs(Filename) = True) Then
        'SAVE WENT OK; IT'S NOW OKAY TO UNLOAD THIS FILE.
        file_query_unload = True
      Else
        'SAVE FAILED; DON'T UNLOAD THIS FILE.
        file_query_unload = False
      End If
      Exit Function
    Case vbNo:
      file_query_unload = True
      Exit Function
    Case vbCancel:
      file_query_unload = False
      Exit Function
  End Select
End Function


Sub ProjectFile_Read(f As Integer, ByRef RetVal As Variant, Optional optDummy1 As Variant)
Dim outputstr$
Dim outlin As String
Dim sub_name As String
Dim input1 As String
Dim input2 As String
  Input #f, input1, input2
  sub_name = "ProjectFile_Read"
  Select Case VarType(RetVal)
    Case vbBoolean
      RetVal = Val(input1)
    Case vbByte, vbInteger, vbLong, vbCurrency
      RetVal = Val(input1)
    Case vbSingle, vbDouble
      RetVal = Val(input1)
    Case vbString, vbDate
      RetVal = input1
    Case vbObject
        MsgBox sub_name & " vbObject not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbError
        MsgBox sub_name & " vbError not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbDataObject
        MsgBox sub_name & " vbDataObject not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbVariant
        MsgBox sub_name & " vbVariant not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbArray
        MsgBox sub_name & " vbArray not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbEmpty
        MsgBox sub_name & " vbEmpty not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbNull
        MsgBox sub_name & " vbNull not implemented"
        GoTo EXIT_FALSE_VALUE
  End Select
  GoTo EXIT_OK
EXIT_FALSE_VALUE:
  Print #f, "   - - - ERROR IN " & sub_name & "() - - -"
  Exit Sub
EXIT_OK:
  Exit Sub
End Sub
Sub ProjectFile_Write(f As Integer, v As Variant, s As String)
Dim outputstr$
Dim outlin As String
Dim sub_name As String
  sub_name = "ProjectFile_Write"
  Select Case VarType(v)
    Case vbBoolean
        outputstr$ = IIf(v, "1", "0")
    Case vbByte, vbInteger, vbLong, vbCurrency
        outputstr$ = Trim$(CStr(v))
    Case vbSingle, vbDouble
        outputstr$ = Trim$(CStr(v))
    Case vbString, vbDate
        outputstr$ = CStr(v)
    Case vbObject
        MsgBox sub_name & " vbObject not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbError
        MsgBox sub_name & " vbError not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbDataObject
        MsgBox sub_name & " vbDataObject not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbVariant
        MsgBox sub_name & " vbVariant not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbArray
        MsgBox sub_name & " vbArray not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbEmpty
        MsgBox sub_name & " vbEmpty not implemented"
        GoTo EXIT_FALSE_VALUE
    Case vbNull
        MsgBox sub_name & " vbNull not implemented"
        GoTo EXIT_FALSE_VALUE
  End Select
  outlin = Chr$(34) & Trim$(outputstr$) & Chr$(34) & "," & _
      Chr$(34) & s & Chr$(34)
  'outlin = Trim$(outputstr$)
  'If (Len(outlin) > 27) Then
  '  outlin = outlin & "    "
  'Else
  '  Do While (1 = 1)
  '    If (Len(outlin) >= 27) Then Exit Do
  '    outlin = outlin & " "
  '  Loop
  'End If
  'outlin = outlin & s
  Print #f, outlin
  GoTo EXIT_OK
EXIT_FALSE_VALUE:
  Print #f, "   - - - ERROR IN " & sub_name & "() - - -"
  Exit Sub
EXIT_OK:
  Exit Sub
End Sub



Attribute VB_Name = "FileIO_Latest"
Option Explicit

Const STR_EOF_MARKER = "12345-EOF-MARKER-12345"





Const FileIO_Latest_declarations_end = True


Sub Bed_ProjectFile_Read(f As Integer, _
    be As BedPropertyType)
  Call ProjectFile_Read(f, be.Length, "be.Length")
  Call ProjectFile_Read(f, be.Diameter, "be.Diameter")
  Call ProjectFile_Read(f, be.Weight, "be.Weight")
  Call ProjectFile_Read(f, be.Flowrate, "be.Flowrate")
  Call ProjectFile_Read(f, be.WaterDensity, "be.WaterDensity")
  Call ProjectFile_Read(f, be.WaterViscosity, "be.WaterViscosity")
  Call ProjectFile_Read(f, be.Temperature, "be.Temperature")
  Call ProjectFile_Read(f, be.Pressure, "be.Pressure")
  Call ProjectFile_Read(f, be.Phase, "be.Phase")
  Call ProjectFile_Read(f, be.NumberOfBeds, "be.NumberOfBeds")
  Call ProjectFile_Read(f, be.Water_Correlation.Name, "be.Water_Correlation.Name")
  Call ProjectFile_Read(f, be.Water_Correlation.Coeff(1), "be.Water_Correlation.Coeff(1)")
  Call ProjectFile_Read(f, be.Water_Correlation.Coeff(2), "be.Water_Correlation.Coeff(2)")
  Call ProjectFile_Read(f, be.Water_Correlation.Coeff(3), "be.Water_Correlation.Coeff(3)")
  Call ProjectFile_Read(f, be.Water_Correlation.Coeff(4), "be.Water_Correlation.Coeff(4)")
End Sub
Sub Bed_ProjectFile_Write(f As Integer, _
    be As BedPropertyType)
  Call ProjectFile_Write(f, be.Length, "be.Length")
  Call ProjectFile_Write(f, be.Diameter, "be.Diameter")
  Call ProjectFile_Write(f, be.Weight, "be.Weight")
  Call ProjectFile_Write(f, be.Flowrate, "be.Flowrate")
  Call ProjectFile_Write(f, be.WaterDensity, "be.WaterDensity")
  Call ProjectFile_Write(f, be.WaterViscosity, "be.WaterViscosity")
  Call ProjectFile_Write(f, be.Temperature, "be.Temperature")
  Call ProjectFile_Write(f, be.Pressure, "be.Pressure")
  Call ProjectFile_Write(f, be.Phase, "be.Phase")
  Call ProjectFile_Write(f, be.NumberOfBeds, "be.NumberOfBeds")
  Call ProjectFile_Write(f, be.Water_Correlation.Name, "be.Water_Correlation.Name")
  Call ProjectFile_Write(f, be.Water_Correlation.Coeff(1), "be.Water_Correlation.Coeff(1)")
  Call ProjectFile_Write(f, be.Water_Correlation.Coeff(2), "be.Water_Correlation.Coeff(2)")
  Call ProjectFile_Write(f, be.Water_Correlation.Coeff(3), "be.Water_Correlation.Coeff(3)")
  Call ProjectFile_Write(f, be.Water_Correlation.Coeff(4), "be.Water_Correlation.Coeff(4)")
End Sub


Sub Component_ProjectFile_Read(f As Integer, _
    co As ComponentPropertyType)
  Call ProjectFile_Read(f, co.Name, "co.Name")
  Call ProjectFile_Read(f, co.CAS, "co.CAS")
  Call ProjectFile_Read(f, co.MW, "co.MW")
  Call ProjectFile_Read(f, co.InitialConcentration, "co.InitialConcentration")
  Call ProjectFile_Read(f, co.MolarVolume, "co.MolarVolume")
  Call ProjectFile_Read(f, co.BP, "co.BP")
  Call ProjectFile_Read(f, co.Use_K, "co.Use_K")
  Call ProjectFile_Read(f, co.Use_OneOverN, "co.Use_OneOverN")
  Call ProjectFile_Read(f, co.Liquid_Density, "co.Liquid_Density")
  Call ProjectFile_Read(f, co.Aqueous_Solubility, "co.Aqueous_Solubility")
  Call ProjectFile_Read(f, co.Vapor_Pressure, "co.Vapor_Pressure")
  Call ProjectFile_Read(f, co.Refractive_Index, "co.Refractive_Index")
  Call ProjectFile_Read(f, co.SPDFR, "co.SPDFR")
  Call ProjectFile_Read(f, co.SPDFR_Low_Concentration, "co.SPDFR_Low_Concentration")
  Call ProjectFile_Read(f, co.Use_SPDFR_Correlation, "co.Use_SPDFR_Correlation")
  Call ProjectFile_Read(f, co.kf, "co.kf")
  Call ProjectFile_Read(f, co.Ds, "co.Ds")
  Call ProjectFile_Read(f, co.Dp, "co.Dp")
  Call ProjectFile_Read(f, co.Corr(1), "co.Corr(1)")
  Call ProjectFile_Read(f, co.Corr(2), "co.Corr(2)")
  Call ProjectFile_Read(f, co.Corr(3), "co.Corr(3)")
  Call ProjectFile_Read(f, co.KP_User_Input(1), "co.KP_User_Input(1)")
  Call ProjectFile_Read(f, co.KP_User_Input(2), "co.KP_User_Input(2)")
  Call ProjectFile_Read(f, co.KP_User_Input(3), "co.KP_User_Input(3)")
  Call ProjectFile_Read(f, co.K_Reduction, "co.K_Reduction")
  Call ProjectFile_Read(f, co.Correlation.Name, "co.Correlation.Name")
  Call ProjectFile_Read(f, co.Correlation.Coeff(1), "co.Correlation.Coeff(1)")
  Call ProjectFile_Read(f, co.Correlation.Coeff(2), "co.Correlation.Coeff(2)")
  Call ProjectFile_Read(f, co.IsothermDB_Component_Name, "co.IsothermDB_Component_Name")
  Call ProjectFile_Read(f, co.IsothermDB_Range_Num, "co.IsothermDB_Range_Num")
  Call ProjectFile_Read(f, co.IPES_OrderOfMagnitude, "co.IPES_OrderOfMagnitude")
  Call ProjectFile_Read(f, co.IPES_NumRegressionPts, "co.IPES_NumRegressionPts")
  Call ProjectFile_Read(f, co.IPES_RelativeHumidity, "co.IPES_RelativeHumidity")
  Call ProjectFile_Read(f, co.IPES_EstimationMethod, "co.IPES_EstimationMethod")
  Call ProjectFile_Read(f, co.Source_KandOneOverN, "co.Source_KandOneOverN")
  Call ProjectFile_Read(f, co.IsothermDB_K, "co.IsothermDB_K")
  Call ProjectFile_Read(f, co.IsothermDB_OneOverN, "co.IsothermDB_OneOverN")
  Call ProjectFile_Read(f, co.IPESResult_K, "co.IPESResult_K")
  Call ProjectFile_Read(f, co.IPESResult_OneOverN, "co.IPESResult_OneOverN")
  Call ProjectFile_Read(f, co.UserEntered_K, "co.UserEntered_K")
  Call ProjectFile_Read(f, co.UserEntered_OneOverN, "co.UserEntered_OneOverN")
  Call ProjectFile_Read(f, co.Tortuosity, "co.tortuosity")
  Call ProjectFile_Read(f, co.Use_Tortuosity_Correlation, "co.Use_Tortuosity_Correlation")
  Call ProjectFile_Read(f, co.Constant_Tortuosity, "co.Constant_Tortuosity")
End Sub
Sub Component_ProjectFile_Write(f As Integer, _
    co As ComponentPropertyType)
  Call ProjectFile_Write(f, co.Name, "co.Name")
  Call ProjectFile_Write(f, co.CAS, "co.CAS")
  Call ProjectFile_Write(f, co.MW, "co.MW")
  Call ProjectFile_Write(f, co.InitialConcentration, "co.InitialConcentration")
  Call ProjectFile_Write(f, co.MolarVolume, "co.MolarVolume")
  Call ProjectFile_Write(f, co.BP, "co.BP")
  Call ProjectFile_Write(f, co.Use_K, "co.Use_K")
  Call ProjectFile_Write(f, co.Use_OneOverN, "co.Use_OneOverN")
  Call ProjectFile_Write(f, co.Liquid_Density, "co.Liquid_Density")
  Call ProjectFile_Write(f, co.Aqueous_Solubility, "co.Aqueous_Solubility")
  Call ProjectFile_Write(f, co.Vapor_Pressure, "co.Vapor_Pressure")
  Call ProjectFile_Write(f, co.Refractive_Index, "co.Refractive_Index")
  Call ProjectFile_Write(f, co.SPDFR, "co.SPDFR")
  Call ProjectFile_Write(f, co.SPDFR_Low_Concentration, "co.SPDFR_Low_Concentration")
  Call ProjectFile_Write(f, co.Use_SPDFR_Correlation, "co.Use_SPDFR_Correlation")
  Call ProjectFile_Write(f, co.kf, "co.kf")
  Call ProjectFile_Write(f, co.Ds, "co.Ds")
  Call ProjectFile_Write(f, co.Dp, "co.Dp")
  Call ProjectFile_Write(f, co.Corr(1), "co.Corr(1)")
  Call ProjectFile_Write(f, co.Corr(2), "co.Corr(2)")
  Call ProjectFile_Write(f, co.Corr(3), "co.Corr(3)")
  Call ProjectFile_Write(f, co.KP_User_Input(1), "co.KP_User_Input(1)")
  Call ProjectFile_Write(f, co.KP_User_Input(2), "co.KP_User_Input(2)")
  Call ProjectFile_Write(f, co.KP_User_Input(3), "co.KP_User_Input(3)")
  Call ProjectFile_Write(f, co.K_Reduction, "co.K_Reduction")
  Call ProjectFile_Write(f, co.Correlation.Name, "co.Correlation.Name")
  Call ProjectFile_Write(f, co.Correlation.Coeff(1), "co.Correlation.Coeff(1)")
  Call ProjectFile_Write(f, co.Correlation.Coeff(2), "co.Correlation.Coeff(2)")
  Call ProjectFile_Write(f, co.IsothermDB_Component_Name, "co.IsothermDB_Component_Name")
  Call ProjectFile_Write(f, co.IsothermDB_Range_Num, "co.IsothermDB_Range_Num")
  Call ProjectFile_Write(f, co.IPES_OrderOfMagnitude, "co.IPES_OrderOfMagnitude")
  Call ProjectFile_Write(f, co.IPES_NumRegressionPts, "co.IPES_NumRegressionPts")
  Call ProjectFile_Write(f, co.IPES_RelativeHumidity, "co.IPES_RelativeHumidity")
  Call ProjectFile_Write(f, co.IPES_EstimationMethod, "co.IPES_EstimationMethod")
  Call ProjectFile_Write(f, co.Source_KandOneOverN, "co.Source_KandOneOverN")
  Call ProjectFile_Write(f, co.IsothermDB_K, "co.IsothermDB_K")
  Call ProjectFile_Write(f, co.IsothermDB_OneOverN, "co.IsothermDB_OneOverN")
  Call ProjectFile_Write(f, co.IPESResult_K, "co.IPESResult_K")
  Call ProjectFile_Write(f, co.IPESResult_OneOverN, "co.IPESResult_OneOverN")
  Call ProjectFile_Write(f, co.UserEntered_K, "co.UserEntered_K")
  Call ProjectFile_Write(f, co.UserEntered_OneOverN, "co.UserEntered_OneOverN")
  Call ProjectFile_Write(f, co.Tortuosity, "co.tortuosity")
  Call ProjectFile_Write(f, co.Use_Tortuosity_Correlation, "co.Use_Tortuosity_Correlation")
  Call ProjectFile_Write(f, co.Constant_Tortuosity, "co.Constant_Tortuosity")
End Sub


'RETURNS:
'- true = open went okay.
'- false = open failed.
Function File_Open_Latest_v1_40(f As Integer) As Boolean
Dim i As Integer
Dim J As Integer
Dim Test_STR_EOF_MARKER As String
  Call ProjectFile_Read(f, FileNote, "FileNote")
  Call ProjectFile_Read(f, Number_Component, "Number_Component")
  For i = 1 To Number_Component
    Call Component_ProjectFile_Read(f, Component(i))
  Next i
  Call Bed_ProjectFile_Read(f, Bed)
  Call UnitsOfDisplay_ProjectFile_Read(f)
  'MISCELLANEOUS BLOCK.
  Call ProjectFile_Read(f, Carbon.Name, "Carbon.Name")
  Call ProjectFile_Read(f, Carbon.Porosity, "Carbon.Porosity")
  Call ProjectFile_Read(f, Carbon.Density, "Carbon.Density")
  Call ProjectFile_Read(f, Carbon.ParticleRadius, "Carbon.ParticleRadius")
  Call ProjectFile_Read(f, Carbon.Tortuosity, "Carbon.tortuosity")
  Call ProjectFile_Read(f, Carbon.W0, "Carbon.W0")
  Call ProjectFile_Read(f, Carbon.BB, "Carbon.BB")
  Call ProjectFile_Read(f, Carbon.PolanyiExponent, "Carbon.PolanyiExponent")
  Call ProjectFile_Read(f, State_Check_Water(1), "State_Check_Water(1)")
  Call ProjectFile_Read(f, State_Check_Water(2), "State_Check_Water(2)")
  Call ProjectFile_Read(f, Carbon.ShapeFactor, "Carbon.ShapeFactor")
  Call ProjectFile_Read(f, Constant_Tortuosity, "Constant_Tortuosity")
  Call ProjectFile_Read(f, Carbon.ShapeFactor, "Carbon.ShapeFactor")
  Call ProjectFile_Read(f, NC, "NC")
  Call ProjectFile_Read(f, MC, "MC")
  Call ProjectFile_Read(f, TimeP.Init, "TimeP.Init")
  Call ProjectFile_Read(f, TimeP.End, "TimeP.End")
  Call ProjectFile_Read(f, TimeP.np, "TimeP.np")
  Call ProjectFile_Read(f, TimeP.Step, "TimeP.Step")
  'INFLUENT POINTS.
  Call ProjectFile_Read(f, Number_Influent_Points, "Number_Influent_Points")
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      Input #f, T_Influent(i)
      For J = 1 To Number_Component
        Input #f, C_Influent(J, i)
      Next J
    Next i
  End If
  'EFFLUENT POINTS.
  Call ProjectFile_Read(f, NData_Points, "NData_Points")
  If (NData_Points > 0) Then
    For i = 1 To NData_Points
      Input #f, T_Data_Points(i)
      For J = 1 To Number_Component
        Input #f, C_Data_Points(J, i)
      Next J
    Next i
  End If
  Call ProjectFile_Read(f, Test_STR_EOF_MARKER, "STR_EOF_MARKER")
  If (Test_STR_EOF_MARKER <> STR_EOF_MARKER) Then
    Call Show_Error("This file has an invalid file format.")
    File_Open_Latest_v1_40 = False
  Else
    File_Open_Latest_v1_40 = True
  End If
End Function
Sub File_Save_Latest_v1_40(f As Integer)
Dim i As Integer
Dim J As Integer
  Print #f, 1.4
  Call ProjectFile_Write(f, FileNote, "FileNote")
  Call ProjectFile_Write(f, Number_Component, "Number_Component")
  For i = 1 To Number_Component
    Call Component_ProjectFile_Write(f, Component(i))
  Next i
  Call Bed_ProjectFile_Write(f, Bed)
  Call UnitsOfDisplay_ProjectFile_Write(f)
  'MISCELLANEOUS BLOCK.
  Call ProjectFile_Write(f, Carbon.Name, "Carbon.Name")
  Call ProjectFile_Write(f, Carbon.Porosity, "Carbon.Porosity")
  Call ProjectFile_Write(f, Carbon.Density, "Carbon.Density")
  Call ProjectFile_Write(f, Carbon.ParticleRadius, "Carbon.ParticleRadius")
  Call ProjectFile_Write(f, Carbon.Tortuosity, "Carbon.tortuosity")
  Call ProjectFile_Write(f, Carbon.W0, "Carbon.W0")
  Call ProjectFile_Write(f, Carbon.BB, "Carbon.BB")
  Call ProjectFile_Write(f, Carbon.PolanyiExponent, "Carbon.PolanyiExponent")
  Call ProjectFile_Write(f, State_Check_Water(1), "State_Check_Water(1)")
  Call ProjectFile_Write(f, State_Check_Water(2), "State_Check_Water(2)")
  Call ProjectFile_Write(f, Carbon.ShapeFactor, "Carbon.ShapeFactor")
  Call ProjectFile_Write(f, Constant_Tortuosity, "Constant_Tortuosity")
  Call ProjectFile_Write(f, Carbon.ShapeFactor, "Carbon.ShapeFactor")
  Call ProjectFile_Write(f, NC, "NC")
  Call ProjectFile_Write(f, MC, "MC")
  Call ProjectFile_Write(f, TimeP.Init, "TimeP.Init")
  Call ProjectFile_Write(f, TimeP.End, "TimeP.End")
  Call ProjectFile_Write(f, TimeP.np, "TimeP.np")
  Call ProjectFile_Write(f, TimeP.Step, "TimeP.Step")
  'INFLUENT POINTS.
  Call ProjectFile_Write(f, Number_Influent_Points, "Number_Influent_Points")
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      Write #f, T_Influent(i)
      For J = 1 To Number_Component
        Write #f, C_Influent(J, i)
      Next J
    Next i
  End If
  'EFFLUENT POINTS.
  Call ProjectFile_Write(f, NData_Points, "NData_Points")
  If (NData_Points > 0) Then
    For i = 1 To NData_Points
      Write #f, T_Data_Points(i)
      For J = 1 To Number_Component
        Write #f, C_Data_Points(J, i)
      Next J
    Next i
  End If
  Call ProjectFile_Write(f, STR_EOF_MARKER, "STR_EOF_MARKER")
End Sub


Sub Units1_ProjectFile_Read(f As Integer, CboX As Control, Desc As String)
Dim TxtX As Control
Dim InLine As String
Dim Dummy1 As String
Dim NewUnits As String
Dim H As Integer
  Call ProjectFile_Read(f, InLine, Dummy1)
  NewUnits = InLine
  H = unitsys_lookup_cbox(CboX)
  Set TxtX = unitsys(H).TxtX
  Call unitsys_set_units(TxtX, NewUnits)
End Sub
Sub Units1_ProjectFile_Write(f As Integer, CboX As Control, Desc As String)
Dim OutStr As String
  If (CboX.ListIndex >= 0) Then
    OutStr = CboX.List(CboX.ListIndex)
  Else
    If (CboX.ListCount > 0) Then
      OutStr = CboX.List(0)
    Else
      OutStr = ""     'NOT LIKELY TO GET HERE!
    End If
  End If
  Call ProjectFile_Write(f, OutStr, Desc)
End Sub


Sub UnitsOfDisplay_ProjectFile_Read(f As Integer)
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(0), "frmMain.txtBedUnits(0)")
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(1), "frmMain.txtBedUnits(1)")
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(2), "frmMain.txtBedUnits(2)")
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(3), "frmMain.txtBedUnits(3)")
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(4), "frmMain.txtBedUnits(4)")
  Call Units1_ProjectFile_Read(f, frmMain.txtCarbonUnits(1), "frmMain.txtCarbonUnits(1)")
  Call Units1_ProjectFile_Read(f, frmMain.txtCarbonUnits(2), "frmMain.txtCarbonUnits(2)")
  Call Units1_ProjectFile_Read(f, frmMain.txtTimeUnits(0), "frmMain.txtTimeUnits(0)")
  Call Units1_ProjectFile_Read(f, frmMain.txtTimeUnits(1), "frmMain.txtTimeUnits(1)")
  Call Units1_ProjectFile_Read(f, frmMain.txtTimeUnits(2), "frmMain.txtTimeUnits(2)")
  Call ProjectFile_Read(f, PropertyUnits.MW, "PropertyUnits.MW")
  Call ProjectFile_Read(f, PropertyUnits.MolarVolume, "PropertyUnits.MolarVolume")
  Call ProjectFile_Read(f, PropertyUnits.BP, "PropertyUnits.BP")
  Call ProjectFile_Read(f, PropertyUnits.InitialConcentration, "PropertyUnits.InitialConcentration")
  Call ProjectFile_Read(f, PropertyUnits.Liquid_Density, "PropertyUnits.Liquid_Density")
  Call ProjectFile_Read(f, PropertyUnits.Aqueous_Solubility, "PropertyUnits.Aqueous_Solubility")
  Call ProjectFile_Read(f, PropertyUnits.Vapor_Pressure, "PropertyUnits.Vapor_Pressure")
  Call ProjectFile_Read(f, PropertyUnits.k, "PropertyUnits.k")
End Sub
Sub UnitsOfDisplay_ProjectFile_Write(f As Integer)
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(0), "frmMain.txtBedUnits(0)")
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(1), "frmMain.txtBedUnits(1)")
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(2), "frmMain.txtBedUnits(2)")
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(3), "frmMain.txtBedUnits(3)")
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(4), "frmMain.txtBedUnits(4)")
  Call Units1_ProjectFile_Write(f, frmMain.txtCarbonUnits(1), "frmMain.txtCarbonUnits(1)")
  Call Units1_ProjectFile_Write(f, frmMain.txtCarbonUnits(2), "frmMain.txtCarbonUnits(2)")
  Call Units1_ProjectFile_Write(f, frmMain.txtTimeUnits(0), "frmMain.txtTimeUnits(0)")
  Call Units1_ProjectFile_Write(f, frmMain.txtTimeUnits(1), "frmMain.txtTimeUnits(1)")
  Call Units1_ProjectFile_Write(f, frmMain.txtTimeUnits(2), "frmMain.txtTimeUnits(2)")
  Call ProjectFile_Write(f, PropertyUnits.MW, "PropertyUnits.MW")
  Call ProjectFile_Write(f, PropertyUnits.MolarVolume, "PropertyUnits.MolarVolume")
  Call ProjectFile_Write(f, PropertyUnits.BP, "PropertyUnits.BP")
  Call ProjectFile_Write(f, PropertyUnits.InitialConcentration, "PropertyUnits.InitialConcentration")
  Call ProjectFile_Write(f, PropertyUnits.Liquid_Density, "PropertyUnits.Liquid_Density")
  Call ProjectFile_Write(f, PropertyUnits.Aqueous_Solubility, "PropertyUnits.Aqueous_Solubility")
  Call ProjectFile_Write(f, PropertyUnits.Vapor_Pressure, "PropertyUnits.Vapor_Pressure")
  Call ProjectFile_Write(f, PropertyUnits.k, "PropertyUnits.k")
End Sub



Attribute VB_Name = "FileIO_LatestMDB"
Option Explicit





Const FileIO_LatestMDB_declarations_end = True


'RETURNS:
'         TRUE = SUCCEEDED IN LOADING.
'         FALSE = FAILED IN LOADING.
Function File_Open_Latest_v1_60( _
    fn_This As String) As Boolean
Dim Ws1 As Workspace
Dim Db1 As Database
Dim Rs1 As Recordset
Dim Use_FieldIndex As Integer
Dim Use_FieldIndex2 As Integer
Dim ContainsTable_PSDMInRoomData As Boolean
Dim rp As RoomParam_Type

  '>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  '>>>>>>>>>>>>>>>>>>>>>>>>>>>  INPUT FROM MAIN DATABASE  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  '<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  If (Not FileExists(fn_This)) Then
    'ERROR: UNABLE TO FIND THE FILE!
    File_Open_Latest_v1_60 = False
    Exit Function
  End If
  'OPEN DATABASE.
  Set Db1 = OpenDatabase(fn_This)

  '=========== INPUT DATA FROM DATABASE TABLES. =================
  
  '------ INPUT DATA FROM TABLE "Version". ------------------------------------------------------------------------------------------------------
  'APPLICABLE DEFAULT VALUES:
  ContainsTable_PSDMInRoomData = False
  If (Database_IsTableExist(Db1, "Version") = False) Then
    'DO NOTHING: USE DEFAULT VALUES.
  Else
    Set Rs1 = Db1.OpenRecordset("Version")
    If (Database_NoRecordsInRecordset(Rs1)) Then
      'DO NOTHING: USE DEFAULT VALUES.
    Else
      Rs1.MoveFirst
      Do Until Rs1.EOF
        ''''Use_FieldIndex = CInt(Database_Get_Long(Rs1, "FieldIndex"))
        Select Case Trim$(UCase$(Database_Get_String(Rs1, "FieldName")))
          'HEADER BLOCK.
          Case Trim$(UCase$("ContainsTable_PSDMInRoomData")): Call Database_LoadProperty(Rs1, ContainsTable_PSDMInRoomData)
        End Select
        Rs1.MoveNext
      Loop
    End If
    Rs1.Close
  End If
  
  '------ INPUT DATA FROM TABLE "Main". ------------------------------------------------------------------------------------------------------
  If (Database_IsTableExist(Db1, "Main") = False) Then
    'DO NOTHING: USE DEFAULT VALUES.
  Else
    Set Rs1 = Db1.OpenRecordset("Main")
    If (Database_NoRecordsInRecordset(Rs1)) Then
      'DO NOTHING: USE DEFAULT VALUES.
    Else
      Rs1.MoveFirst
      Do Until Rs1.EOF
        Use_FieldIndex = CInt(Database_Get_Long(Rs1, "FieldIndex"))
        Select Case Trim$(UCase$(Database_Get_String(Rs1, "FieldName")))
          'HEADER BLOCK.
          Case Trim$(UCase$("FileNote")): Call Database_LoadProperty(Rs1, FileNote, True)
          Case Trim$(UCase$("Number_Component")): Call Database_LoadProperty(Rs1, Number_Component)
          'COMPONENT PROPERTIES BLOCK.
          Case Trim$(UCase$("Co.Name")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Name)
          Case Trim$(UCase$("Co.CAS")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).CAS)
          Case Trim$(UCase$("Co.MW")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).MW)
          Case Trim$(UCase$("Co.InitialConcentration")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).InitialConcentration)
          Case Trim$(UCase$("Co.MolarVolume")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).MolarVolume)
          Case Trim$(UCase$("Co.BP")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).BP)
          Case Trim$(UCase$("Co.Use_K")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Use_K)
          Case Trim$(UCase$("Co.Use_OneOverN")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Use_OneOverN)
          Case Trim$(UCase$("Co.Liquid_Density")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Liquid_Density)
          Case Trim$(UCase$("Co.Aqueous_Solubility")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Aqueous_Solubility)
          Case Trim$(UCase$("Co.Vapor_Pressure")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Vapor_Pressure)
          Case Trim$(UCase$("Co.Refractive_Index")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Refractive_Index)
          Case Trim$(UCase$("Co.SPDFR")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).SPDFR)
          Case Trim$(UCase$("Co.SPDFR_Low_Concentration")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).SPDFR_Low_Concentration)
          Case Trim$(UCase$("Co.Use_SPDFR_Correlation")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Use_SPDFR_Correlation)
          Case Trim$(UCase$("Co.kf")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).kf)
          Case Trim$(UCase$("Co.Ds")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Ds)
          Case Trim$(UCase$("Co.Dp")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Dp)
          Case Trim$(UCase$("Co.Corr(1)")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Corr(1))
          Case Trim$(UCase$("Co.Corr(2)")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Corr(2))
          Case Trim$(UCase$("Co.Corr(3)")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Corr(3))
          Case Trim$(UCase$("Co.KP_User_Input(1)")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).KP_User_Input(1))
          Case Trim$(UCase$("Co.KP_User_Input(2)")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).KP_User_Input(2))
          Case Trim$(UCase$("Co.KP_User_Input(3)")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).KP_User_Input(3))
          Case Trim$(UCase$("Co.K_Reduction")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).K_Reduction)
          Case Trim$(UCase$("Co.Correlation.Name")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Correlation.Name)
          Case Trim$(UCase$("Co.Correlation.Coeff(1)")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Correlation.Coeff(1))
          Case Trim$(UCase$("Co.Correlation.Coeff(2)")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Correlation.Coeff(2))
          Case Trim$(UCase$("Co.IsothermDB_Component_Name")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IsothermDB_Component_Name)
          Case Trim$(UCase$("Co.IsothermDB_Range_Num")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IsothermDB_Range_Num)
          Case Trim$(UCase$("Co.IPES_OrderOfMagnitude")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IPES_OrderOfMagnitude)
          Case Trim$(UCase$("Co.IPES_NumRegressionPts")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IPES_NumRegressionPts)
          Case Trim$(UCase$("Co.IPES_RelativeHumidity")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IPES_RelativeHumidity)
          Case Trim$(UCase$("Co.IPES_EstimationMethod")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IPES_EstimationMethod)
          Case Trim$(UCase$("Co.Source_KandOneOverN")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Source_KandOneOverN)
          Case Trim$(UCase$("Co.IsothermDB_K")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IsothermDB_K)
          Case Trim$(UCase$("Co.IsothermDB_OneOverN")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IsothermDB_OneOverN)
          Case Trim$(UCase$("Co.IPESResult_K")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IPESResult_K)
          Case Trim$(UCase$("Co.IPESResult_OneOverN")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).IPESResult_OneOverN)
          Case Trim$(UCase$("Co.UserEntered_K")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).UserEntered_K)
          Case Trim$(UCase$("Co.UserEntered_OneOverN")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).UserEntered_OneOverN)
          Case Trim$(UCase$("Co.Tortuosity")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Tortuosity)
          Case Trim$(UCase$("Co.Use_Tortuosity_Correlation")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Use_Tortuosity_Correlation)
          Case Trim$(UCase$("Co.Constant_Tortuosity")): Call Database_LoadProperty(Rs1, Component(Use_FieldIndex).Constant_Tortuosity)
          'BED PROPERTIES BLOCK.
          Case Trim$(UCase$("Be.length")): Call Database_LoadProperty(Rs1, Bed.length)
          Case Trim$(UCase$("Be.Diameter")): Call Database_LoadProperty(Rs1, Bed.Diameter)
          Case Trim$(UCase$("Be.Weight")): Call Database_LoadProperty(Rs1, Bed.Weight)
          Case Trim$(UCase$("Be.Flowrate")): Call Database_LoadProperty(Rs1, Bed.Flowrate)
          Case Trim$(UCase$("Be.WaterDensity")): Call Database_LoadProperty(Rs1, Bed.WaterDensity)
          Case Trim$(UCase$("Be.WaterViscosity")): Call Database_LoadProperty(Rs1, Bed.WaterViscosity)
          Case Trim$(UCase$("Be.Temperature")): Call Database_LoadProperty(Rs1, Bed.Temperature)
          Case Trim$(UCase$("Be.Pressure")): Call Database_LoadProperty(Rs1, Bed.Pressure)
          Case Trim$(UCase$("Be.Phase")): Call Database_LoadProperty(Rs1, Bed.Phase)
          Case Trim$(UCase$("Be.NumberOfBeds")): Call Database_LoadProperty(Rs1, Bed.NumberOfBeds)
          Case Trim$(UCase$("Be.Water_Correlation.Name")): Call Database_LoadProperty(Rs1, Bed.Water_Correlation.Name)
          Case Trim$(UCase$("Be.Water_Correlation.Coeff(1)")): Call Database_LoadProperty(Rs1, Bed.Water_Correlation.Coeff(1))
          Case Trim$(UCase$("Be.Water_Correlation.Coeff(2)")): Call Database_LoadProperty(Rs1, Bed.Water_Correlation.Coeff(2))
          Case Trim$(UCase$("Be.Water_Correlation.Coeff(3)")): Call Database_LoadProperty(Rs1, Bed.Water_Correlation.Coeff(3))
          Case Trim$(UCase$("Be.Water_Correlation.Coeff(4)")): Call Database_LoadProperty(Rs1, Bed.Water_Correlation.Coeff(4))
          'UNITS BLOCK.
          Case Trim$(UCase$("frmMain.txtBedUnits(0)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtBedUnits(0))
          Case Trim$(UCase$("frmMain.txtBedUnits(1)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtBedUnits(1))
          Case Trim$(UCase$("frmMain.txtBedUnits(2)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtBedUnits(2))
          Case Trim$(UCase$("frmMain.txtBedUnits(3)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtBedUnits(3))
          Case Trim$(UCase$("frmMain.txtBedUnits(4)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtBedUnits(4))
          Case Trim$(UCase$("frmMain.txtCarbonUnits(1)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtCarbonUnits(1))
          Case Trim$(UCase$("frmMain.txtCarbonUnits(2)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtCarbonUnits(2))
          Case Trim$(UCase$("frmMain.txtTimeUnits(0)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtTimeUnits(0))
          Case Trim$(UCase$("frmMain.txtTimeUnits(1)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtTimeUnits(1))
          Case Trim$(UCase$("frmMain.txtTimeUnits(2)")): Call Units1_Database_LoadProperty(Rs1, frmMain.txtTimeUnits(2))
          Case Trim$(UCase$("PropertyUnits.MW")): Call Database_LoadProperty(Rs1, PropertyUnits.MW)
          Case Trim$(UCase$("PropertyUnits.MolarVolume")): Call Database_LoadProperty(Rs1, PropertyUnits.MolarVolume)
          Case Trim$(UCase$("PropertyUnits.BP")): Call Database_LoadProperty(Rs1, PropertyUnits.BP)
          Case Trim$(UCase$("PropertyUnits.InitialConcentration")): Call Database_LoadProperty(Rs1, PropertyUnits.InitialConcentration)
          Case Trim$(UCase$("PropertyUnits.Liquid_Density")): Call Database_LoadProperty(Rs1, PropertyUnits.Liquid_Density)
          Case Trim$(UCase$("PropertyUnits.Aqueous_Solubility")): Call Database_LoadProperty(Rs1, PropertyUnits.Aqueous_Solubility)
          Case Trim$(UCase$("PropertyUnits.Vapor_Pressure")): Call Database_LoadProperty(Rs1, PropertyUnits.Vapor_Pressure)
          Case Trim$(UCase$("PropertyUnits.k")): Call Database_LoadProperty(Rs1, PropertyUnits.k)
          'MISCELLANEOUS BLOCK.
          Case Trim$(UCase$("Carbon.Name")): Call Database_LoadProperty(Rs1, Carbon.Name)
          Case Trim$(UCase$("Carbon.Porosity")): Call Database_LoadProperty(Rs1, Carbon.Porosity)
          Case Trim$(UCase$("Carbon.Density")): Call Database_LoadProperty(Rs1, Carbon.Density)
          Case Trim$(UCase$("Carbon.ParticleRadius")): Call Database_LoadProperty(Rs1, Carbon.ParticleRadius)
          Case Trim$(UCase$("Carbon.Tortuosity")): Call Database_LoadProperty(Rs1, Carbon.Tortuosity)
          Case Trim$(UCase$("Carbon.W0")): Call Database_LoadProperty(Rs1, Carbon.W0)
          Case Trim$(UCase$("Carbon.BB")): Call Database_LoadProperty(Rs1, Carbon.BB)
          Case Trim$(UCase$("Carbon.PolanyiExponent")): Call Database_LoadProperty(Rs1, Carbon.PolanyiExponent)
          Case Trim$(UCase$("State_Check_Water(1)")): Call Database_LoadProperty(Rs1, State_Check_Water(1))
          Case Trim$(UCase$("State_Check_Water(2)")): Call Database_LoadProperty(Rs1, State_Check_Water(2))
          Case Trim$(UCase$("Carbon.ShapeFactor")): Call Database_LoadProperty(Rs1, Carbon.ShapeFactor)
          Case Trim$(UCase$("Constant_Tortuosity")): Call Database_LoadProperty(Rs1, Constant_Tortuosity)
          Case Trim$(UCase$("Carbon.ShapeFactor")): Call Database_LoadProperty(Rs1, Carbon.ShapeFactor)
          Case Trim$(UCase$("NC")): Call Database_LoadProperty(Rs1, NC)
          Case Trim$(UCase$("MC")): Call Database_LoadProperty(Rs1, MC)
          Case Trim$(UCase$("TimeP.Init")): Call Database_LoadProperty(Rs1, TimeP.Init)
          Case Trim$(UCase$("TimeP.End")): Call Database_LoadProperty(Rs1, TimeP.End)
          Case Trim$(UCase$("TimeP.np")): Call Database_LoadProperty(Rs1, TimeP.np)
          Case Trim$(UCase$("TimeP.Step")): Call Database_LoadProperty(Rs1, TimeP.Step)
          'INFLUENT/EFFLUENT POINT COUNTS.
          Case Trim$(UCase$("Number_Influent_Points")): Call Database_LoadProperty(Rs1, Number_Influent_Points)
          Case Trim$(UCase$("NData_Points")): Call Database_LoadProperty(Rs1, NData_Points)
        End Select
        Rs1.MoveNext
      Loop
    End If
    Rs1.Close
  End If

  '------ INPUT DATA FROM TABLE "InfluentPoints". ------------------------------------------------------------------------------------------------------
  If (Database_IsTableExist(Db1, "InfluentPoints") = False) Then
    'DO NOTHING: USE DEFAULT VALUES.
  Else
    Set Rs1 = Db1.OpenRecordset("InfluentPoints")
    If (Database_NoRecordsInRecordset(Rs1)) Then
      'DO NOTHING: USE DEFAULT VALUES.
    Else
      Rs1.MoveFirst
      Do Until Rs1.EOF
        Use_FieldIndex = CInt(Database_Get_Long(Rs1, "FieldIndex"))
        Use_FieldIndex2 = CInt(Database_Get_Long(Rs1, "FieldIndex2"))
        Select Case Trim$(UCase$(Database_Get_String(Rs1, "FieldName")))
          Case Trim$(UCase$("T_Influent")): Call Database_LoadProperty(Rs1, T_Influent(Use_FieldIndex))
          Case Trim$(UCase$("C_Influent")): Call Database_LoadProperty(Rs1, C_Influent(Use_FieldIndex, Use_FieldIndex2))
        End Select
        Rs1.MoveNext
      Loop
    End If
    Rs1.Close
  End If

  '------ INPUT DATA FROM TABLE "EffluentPoints". ------------------------------------------------------------------------------------------------------
  If (Database_IsTableExist(Db1, "EffluentPoints") = False) Then
    'DO NOTHING: USE DEFAULT VALUES.
  Else
    Set Rs1 = Db1.OpenRecordset("EffluentPoints")
    If (Database_NoRecordsInRecordset(Rs1)) Then
      'DO NOTHING: USE DEFAULT VALUES.
    Else
      Rs1.MoveFirst
      Do Until Rs1.EOF
        Use_FieldIndex = CInt(Database_Get_Long(Rs1, "FieldIndex"))
        Use_FieldIndex2 = CInt(Database_Get_Long(Rs1, "FieldIndex2"))
        Select Case Trim$(UCase$(Database_Get_String(Rs1, "FieldName")))
          Case Trim$(UCase$("T_Data_Points")): Call Database_LoadProperty(Rs1, T_Data_Points(Use_FieldIndex))
          Case Trim$(UCase$("C_Data_Points")): Call Database_LoadProperty(Rs1, C_Data_Points(Use_FieldIndex, Use_FieldIndex2))
        End Select
        Rs1.MoveNext
      Loop
    End If
    Rs1.Close
  End If
  
  '------ INPUT DATA FROM TABLE "PSDMInRoomData". ------------------------------------------------------------------------------------------------------
  If (ContainsTable_PSDMInRoomData) Then
    rp = RoomParams
    If (Database_IsTableExist(Db1, "PSDMInRoomData") = False) Then
      'DO NOTHING: USE DEFAULT VALUES.
    Else
      Set Rs1 = Db1.OpenRecordset("PSDMInRoomData")
      If (Database_NoRecordsInRecordset(Rs1)) Then
        'DO NOTHING: USE DEFAULT VALUES.
      Else
        Rs1.MoveFirst
        Do Until Rs1.EOF
          Use_FieldIndex = CInt(Database_Get_Long(Rs1, "FieldIndex"))
          Select Case Trim$(UCase$(Database_Get_String(Rs1, "FieldName")))
            ' INPUT ROOM PARAMETERS.
            Case Trim$(UCase$("RP.COUNT_CONTAMINANT")): Call Database_LoadProperty(Rs1, rp.COUNT_CONTAMINANT)
            Case Trim$(UCase$("RP.ROOM_VOL")): Call Database_LoadProperty(Rs1, rp.ROOM_VOL)
            Case Trim$(UCase$("RP.ROOM_FLOWRATE")): Call Database_LoadProperty(Rs1, rp.ROOM_FLOWRATE)
            Case Trim$(UCase$("RP.ROOM_C0")): Call Database_LoadProperty(Rs1, rp.ROOM_C0(Use_FieldIndex))
            Case Trim$(UCase$("RP.ROOM_EMIT")): Call Database_LoadProperty(Rs1, rp.ROOM_EMIT(Use_FieldIndex))
            ' CALCULATED ROOM PARAMETERS.
            Case Trim$(UCase$("RP.ROOM_CHANGE_RATE")): Call Database_LoadProperty(Rs1, rp.ROOM_CHANGE_RATE)
            Case Trim$(UCase$("RP.ROOM_SS_VALUE")): Call Database_LoadProperty(Rs1, rp.ROOM_SS_VALUE(Use_FieldIndex))
            ' UNITS FOR ALL VARIABLES.
            Case Trim$(UCase$("RP.ROOM_VOL_Units")): Call Database_LoadProperty(Rs1, rp.ROOM_VOL_Units)
            Case Trim$(UCase$("RP.ROOM_FLOWRATE_Units")): Call Database_LoadProperty(Rs1, rp.ROOM_FLOWRATE_Units)
            Case Trim$(UCase$("RP.ROOM_C0_Units")): Call Database_LoadProperty(Rs1, rp.ROOM_C0_Units)
            Case Trim$(UCase$("RP.ROOM_EMIT_Units")): Call Database_LoadProperty(Rs1, rp.ROOM_EMIT_Units)
            Case Trim$(UCase$("RP.INITIAL_ROOM_CONC_Units")): Call Database_LoadProperty(Rs1, rp.INITIAL_ROOM_CONC_Units)
            ' NEW AS OF 9/16/98.
            Case Trim$(UCase$("RP.INITIAL_ROOM_CONC")): Call Database_LoadProperty(Rs1, rp.INITIAL_ROOM_CONC(Use_FieldIndex))
          End Select
          Rs1.MoveNext
        Loop
      End If
      Rs1.Close
    End If
    RoomParams = rp
    Call RoomParam_Recalculate(RoomParams)
  End If
  
  'CLOSE THE DATABASE FILE.
  Db1.Close

  'RETURN A "SUCCESS" MESSAGE TO CALLER.
  File_Open_Latest_v1_60 = True

End Function


'RETURNS:
'         TRUE = SUCCEEDED IN SAVING.
'         FALSE = FAILED IN SAVING.
Function File_Save_Latest_v1_60( _
    fn_This As String) As Boolean
Dim Ws1 As Workspace
Dim Db1 As Database
Dim Rs1 As Recordset
Dim i As Integer
Dim j As Integer
Dim Co As ComponentPropertyType
Dim Be As BedPropertyType
Dim IsLegacyVersion As Boolean
Dim NeedToCreateNewDatabase As Boolean
Dim rp As RoomParam_Type

  '>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  '>>>>>>>>>>>>>>>>>>>>>>>>>>>  SAVE TO MAIN DATABASE  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  '<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  
  'IF FILE DOES NOT EXIST, CREATE IT.
  'FOR EACH TABLE, IF IT EXISTS, DELETE IT.
  If (Not FileExists(fn_This)) Then
    'CREATE NEW DATABASE.
    NeedToCreateNewDatabase = True
  Else
    'DETERMINE WHETHER OLD FILE IS A LEGACY VERSION (i.e. A NON-MDB FILE).
    IsLegacyVersion = True
    On Error Resume Next
    Set Db1 = OpenDatabase(fn_This)
    If (Err.number = 0) Then
      IsLegacyVersion = False
      Db1.Close
    End If
    On Error GoTo 0
    If (IsLegacyVersion) Then
      'DELETE OLD FILE, CREATE NEW DATABASE (SEE BELOW).
      Kill fn_This
      NeedToCreateNewDatabase = True
    Else
      'OPEN DATABASE NORMALLY.
      Set Db1 = OpenDatabase(fn_This)
    End If
  End If
  If (NeedToCreateNewDatabase) Then
    FileCopy MAIN_APP_PATH & "\dbase\template.dat", fn_This
    Set Db1 = OpenDatabase(fn_This)
  End If
  'CREATE NEW TABLES WITHIN DATABASE, IF NECESSARY.
  Call Database_CreateMFBTable_IfNoExist(Db1, "Version", True)
  Call Database_CreateMFBTable_IfNoExist(Db1, "Main", True)
  Call Database_CreateMFBTable_IfNoExist_TwoIndices(Db1, "InfluentPoints")
  Call Database_CreateMFBTable_IfNoExist_TwoIndices(Db1, "EffluentPoints")
  Call Database_CreateMFBTable_IfNoExist(Db1, "PSDMInRoomData", True)
  
  '=========== OUTPUT DATA TO DATABASE TABLES. =================
  
  '------ OUTPUT DATA TO TABLE "Version". ------------------------------------------------------------------------------------------------------
  'START SAVE TO THIS TABLE.
  Call Database_DeleteTableContents(Db1, "Version")
  Set Rs1 = Db1.OpenRecordset("Version")
  Call Database_SaveProperty(Rs1, "DataVersion_Major", CInt(Latest_DataVersion_Major))
  Call Database_SaveProperty(Rs1, "DataVersion_Minor", CInt(Latest_DataVersion_Minor))
  Call Database_SaveProperty(Rs1, "ContainsTable_PSDMInRoomData", True)
  'END SAVE TO THIS TABLE.
  Rs1.Close
  
  '------ OUTPUT DATA TO TABLE "Main". ------------------------------------------------------------------------------------------------------
  'START SAVE TO THIS TABLE.
  Call Database_DeleteTableContents(Db1, "Main")
  Set Rs1 = Db1.OpenRecordset("Main")
  'HEADER BLOCK.
  Call Database_SaveProperty(Rs1, "*FileNote", FileNote)
  Call Database_SaveProperty(Rs1, "Number_Component", Number_Component)
  'COMPONENT PROPERTIES BLOCK.
  For i = 1 To Number_Component
    Co = Component(i)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Name", i, Co.Name)
    Call Database_SavePropertyWithIndex(Rs1, "Co.CAS", i, Co.CAS)
    Call Database_SavePropertyWithIndex(Rs1, "Co.MW", i, Co.MW)
    Call Database_SavePropertyWithIndex(Rs1, "Co.InitialConcentration", i, Co.InitialConcentration)
    Call Database_SavePropertyWithIndex(Rs1, "Co.MolarVolume", i, Co.MolarVolume)
    Call Database_SavePropertyWithIndex(Rs1, "Co.BP", i, Co.BP)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Use_K", i, Co.Use_K)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Use_OneOverN", i, Co.Use_OneOverN)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Liquid_Density", i, Co.Liquid_Density)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Aqueous_Solubility", i, Co.Aqueous_Solubility)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Vapor_Pressure", i, Co.Vapor_Pressure)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Refractive_Index", i, Co.Refractive_Index)
    Call Database_SavePropertyWithIndex(Rs1, "Co.SPDFR", i, Co.SPDFR)
    Call Database_SavePropertyWithIndex(Rs1, "Co.SPDFR_Low_Concentration", i, Co.SPDFR_Low_Concentration)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Use_SPDFR_Correlation", i, Co.Use_SPDFR_Correlation)
    Call Database_SavePropertyWithIndex(Rs1, "Co.kf", i, Co.kf)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Ds", i, Co.Ds)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Dp", i, Co.Dp)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Corr(1)", i, Co.Corr(1))
    Call Database_SavePropertyWithIndex(Rs1, "Co.Corr(2)", i, Co.Corr(2))
    Call Database_SavePropertyWithIndex(Rs1, "Co.Corr(3)", i, Co.Corr(3))
    Call Database_SavePropertyWithIndex(Rs1, "Co.KP_User_Input(1)", i, Co.KP_User_Input(1))
    Call Database_SavePropertyWithIndex(Rs1, "Co.KP_User_Input(2)", i, Co.KP_User_Input(2))
    Call Database_SavePropertyWithIndex(Rs1, "Co.KP_User_Input(3)", i, Co.KP_User_Input(3))
    Call Database_SavePropertyWithIndex(Rs1, "Co.K_Reduction", i, Co.K_Reduction)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Correlation.Name", i, Co.Correlation.Name)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Correlation.Coeff(1)", i, Co.Correlation.Coeff(1))
    Call Database_SavePropertyWithIndex(Rs1, "Co.Correlation.Coeff(2)", i, Co.Correlation.Coeff(2))
    Call Database_SavePropertyWithIndex(Rs1, "Co.IsothermDB_Component_Name", i, Co.IsothermDB_Component_Name)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IsothermDB_Range_Num", i, Co.IsothermDB_Range_Num)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IPES_OrderOfMagnitude", i, Co.IPES_OrderOfMagnitude)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IPES_NumRegressionPts", i, Co.IPES_NumRegressionPts)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IPES_RelativeHumidity", i, Co.IPES_RelativeHumidity)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IPES_EstimationMethod", i, Co.IPES_EstimationMethod)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Source_KandOneOverN", i, Co.Source_KandOneOverN)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IsothermDB_K", i, Co.IsothermDB_K)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IsothermDB_OneOverN", i, Co.IsothermDB_OneOverN)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IPESResult_K", i, Co.IPESResult_K)
    Call Database_SavePropertyWithIndex(Rs1, "Co.IPESResult_OneOverN", i, Co.IPESResult_OneOverN)
    Call Database_SavePropertyWithIndex(Rs1, "Co.UserEntered_K", i, Co.UserEntered_K)
    Call Database_SavePropertyWithIndex(Rs1, "Co.UserEntered_OneOverN", i, Co.UserEntered_OneOverN)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Tortuosity", i, Co.Tortuosity)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Use_Tortuosity_Correlation", i, Co.Use_Tortuosity_Correlation)
    Call Database_SavePropertyWithIndex(Rs1, "Co.Constant_Tortuosity", i, Co.Constant_Tortuosity)
  Next i
  'BED PROPERTIES BLOCK.
  Be = Bed
  Call Database_SaveProperty(Rs1, "Be.length", Be.length)
  Call Database_SaveProperty(Rs1, "Be.Diameter", Be.Diameter)
  Call Database_SaveProperty(Rs1, "Be.Weight", Be.Weight)
  Call Database_SaveProperty(Rs1, "Be.Flowrate", Be.Flowrate)
  Call Database_SaveProperty(Rs1, "Be.WaterDensity", Be.WaterDensity)
  Call Database_SaveProperty(Rs1, "Be.WaterViscosity", Be.WaterViscosity)
  Call Database_SaveProperty(Rs1, "Be.Temperature", Be.Temperature)
  Call Database_SaveProperty(Rs1, "Be.Pressure", Be.Pressure)
  Call Database_SaveProperty(Rs1, "Be.Phase", Be.Phase)
  Call Database_SaveProperty(Rs1, "Be.NumberOfBeds", Be.NumberOfBeds)
  Call Database_SaveProperty(Rs1, "Be.Water_Correlation.Name", Be.Water_Correlation.Name)
  Call Database_SaveProperty(Rs1, "Be.Water_Correlation.Coeff(1)", Be.Water_Correlation.Coeff(1))
  Call Database_SaveProperty(Rs1, "Be.Water_Correlation.Coeff(2)", Be.Water_Correlation.Coeff(2))
  Call Database_SaveProperty(Rs1, "Be.Water_Correlation.Coeff(3)", Be.Water_Correlation.Coeff(3))
  Call Database_SaveProperty(Rs1, "Be.Water_Correlation.Coeff(4)", Be.Water_Correlation.Coeff(4))
  'UNITS BLOCK.
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtBedUnits(0), "frmMain.txtBedUnits(0)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtBedUnits(1), "frmMain.txtBedUnits(1)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtBedUnits(2), "frmMain.txtBedUnits(2)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtBedUnits(3), "frmMain.txtBedUnits(3)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtBedUnits(4), "frmMain.txtBedUnits(4)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtCarbonUnits(1), "frmMain.txtCarbonUnits(1)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtCarbonUnits(2), "frmMain.txtCarbonUnits(2)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtTimeUnits(0), "frmMain.txtTimeUnits(0)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtTimeUnits(1), "frmMain.txtTimeUnits(1)")
  Call Units1_Database_SaveProperty(Rs1, frmMain.txtTimeUnits(2), "frmMain.txtTimeUnits(2)")
  Call Database_SaveProperty(Rs1, "PropertyUnits.MW", PropertyUnits.MW)
  Call Database_SaveProperty(Rs1, "PropertyUnits.MolarVolume", PropertyUnits.MolarVolume)
  Call Database_SaveProperty(Rs1, "PropertyUnits.BP", PropertyUnits.BP)
  Call Database_SaveProperty(Rs1, "PropertyUnits.InitialConcentration", PropertyUnits.InitialConcentration)
  Call Database_SaveProperty(Rs1, "PropertyUnits.Liquid_Density", PropertyUnits.Liquid_Density)
  Call Database_SaveProperty(Rs1, "PropertyUnits.Aqueous_Solubility", PropertyUnits.Aqueous_Solubility)
  Call Database_SaveProperty(Rs1, "PropertyUnits.Vapor_Pressure", PropertyUnits.Vapor_Pressure)
  Call Database_SaveProperty(Rs1, "PropertyUnits.k", PropertyUnits.k)
  'MISCELLANEOUS BLOCK.
  Call Database_SaveProperty(Rs1, "Carbon.Name", Carbon.Name)
  Call Database_SaveProperty(Rs1, "Carbon.Porosity", Carbon.Porosity)
  Call Database_SaveProperty(Rs1, "Carbon.Density", Carbon.Density)
  Call Database_SaveProperty(Rs1, "Carbon.ParticleRadius", Carbon.ParticleRadius)
  Call Database_SaveProperty(Rs1, "Carbon.Tortuosity", Carbon.Tortuosity)
  Call Database_SaveProperty(Rs1, "Carbon.W0", Carbon.W0)
  Call Database_SaveProperty(Rs1, "Carbon.BB", Carbon.BB)
  Call Database_SaveProperty(Rs1, "Carbon.PolanyiExponent", Carbon.PolanyiExponent)
  Call Database_SaveProperty(Rs1, "State_Check_Water(1)", State_Check_Water(1))
  Call Database_SaveProperty(Rs1, "State_Check_Water(2)", State_Check_Water(2))
  Call Database_SaveProperty(Rs1, "Carbon.ShapeFactor", Carbon.ShapeFactor)
  Call Database_SaveProperty(Rs1, "Constant_Tortuosity", Constant_Tortuosity)
  Call Database_SaveProperty(Rs1, "Carbon.ShapeFactor", Carbon.ShapeFactor)
  Call Database_SaveProperty(Rs1, "NC", NC)
  Call Database_SaveProperty(Rs1, "MC", MC)
  Call Database_SaveProperty(Rs1, "TimeP.Init", TimeP.Init)
  Call Database_SaveProperty(Rs1, "TimeP.End", TimeP.End)
  Call Database_SaveProperty(Rs1, "TimeP.np", TimeP.np)
  Call Database_SaveProperty(Rs1, "TimeP.Step", TimeP.Step)
  'INFLUENT/EFFLUENT POINT COUNTS.
  Call Database_SaveProperty(Rs1, "Number_Influent_Points", Number_Influent_Points)
  Call Database_SaveProperty(Rs1, "NData_Points", NData_Points)
  'END SAVE TO THIS TABLE.
  Rs1.Close
  
  '------ OUTPUT DATA TO TABLE "InfluentPoints". ------------------------------------------------------------------------------------------------------
  'START SAVE TO THIS TABLE.
  Call Database_DeleteTableContents(Db1, "InfluentPoints")
  Set Rs1 = Db1.OpenRecordset("InfluentPoints")
  'MAIN DATA SET.
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      ''''Write #f, T_Influent(i)
      Rs1.AddNew
      Rs1("FieldName") = "T_Influent"
      Rs1("FieldIndex") = i
      Rs1("dblValue") = T_Influent(i)
      Rs1.Update
      For j = 1 To Number_Component
        ''''Write #f, C_Influent(j, i)
        Rs1.AddNew
        Rs1("FieldName") = "C_Influent"
        Rs1("FieldIndex") = j
        Rs1("FieldIndex2") = i
        Rs1("dblValue") = C_Influent(j, i)
        Rs1.Update
      Next j
    Next i
  End If
  'END SAVE TO THIS TABLE.
  Rs1.Close
  
  '------ OUTPUT DATA TO TABLE "EffluentPoints". ------------------------------------------------------------------------------------------------------
  'START SAVE TO THIS TABLE.
  Call Database_DeleteTableContents(Db1, "EffluentPoints")
  Set Rs1 = Db1.OpenRecordset("EffluentPoints")
  'MAIN DATA SET.
  If (NData_Points > 0) Then
    For i = 1 To NData_Points
      ''''Write #f, T_Data_Points(i)
      Rs1.AddNew
      Rs1("FieldName") = "T_Data_Points"
      Rs1("FieldIndex") = i
      Rs1("dblValue") = T_Data_Points(i)
      Rs1.Update
      For j = 1 To Number_Component
        ''''Write #f, C_Data_Points(j, i)
        Rs1.AddNew
        Rs1("FieldName") = "C_Data_Points"
        Rs1("FieldIndex") = j
        Rs1("FieldIndex2") = i
        Rs1("dblValue") = C_Data_Points(j, i)
        Rs1.Update
      Next j
    Next i
  End If
  'END SAVE TO THIS TABLE.
  Rs1.Close
  
  '------ OUTPUT DATA TO TABLE "PSDMInRoomData". ------------------------------------------------------------------------------------------------------
  'START SAVE TO THIS TABLE.
  Call Database_DeleteTableContents(Db1, "PSDMInRoomData")
  Set Rs1 = Db1.OpenRecordset("PSDMInRoomData")
  ' INPUT ROOM PARAMETERS.
  rp = RoomParams
  Call Database_SaveProperty(Rs1, "RP.COUNT_CONTAMINANT", rp.COUNT_CONTAMINANT)
  Call Database_SaveProperty(Rs1, "RP.ROOM_VOL", rp.ROOM_VOL)
  Call Database_SaveProperty(Rs1, "RP.ROOM_FLOWRATE", rp.ROOM_FLOWRATE)
  For i = 1 To rp.COUNT_CONTAMINANT
    Call Database_SavePropertyWithIndex(Rs1, "RP.ROOM_C0", i, rp.ROOM_C0(i))
    Call Database_SavePropertyWithIndex(Rs1, "RP.ROOM_EMIT", i, rp.ROOM_EMIT(i))
  Next i
  ' CALCULATED ROOM PARAMETERS.
  Call Database_SaveProperty(Rs1, "RP.ROOM_CHANGE_RATE", rp.ROOM_CHANGE_RATE)
  For i = 1 To rp.COUNT_CONTAMINANT
    Call Database_SavePropertyWithIndex(Rs1, "RP.ROOM_SS_VALUE", i, rp.ROOM_SS_VALUE(i))
  Next i
  ' UNITS FOR ALL VARIABLES.
  Call Database_SaveProperty(Rs1, "RP.ROOM_VOL_Units", rp.ROOM_VOL_Units)
  Call Database_SaveProperty(Rs1, "RP.ROOM_FLOWRATE_Units", rp.ROOM_FLOWRATE_Units)
  Call Database_SaveProperty(Rs1, "RP.ROOM_C0_Units", rp.ROOM_C0_Units)
  Call Database_SaveProperty(Rs1, "RP.ROOM_EMIT_Units", rp.ROOM_EMIT_Units)
  Call Database_SaveProperty(Rs1, "RP.INITIAL_ROOM_CONC_Units", rp.INITIAL_ROOM_CONC_Units)
  ' NEW AS OF 9/16/98.
  For i = 1 To rp.COUNT_CONTAMINANT
    Call Database_SavePropertyWithIndex(Rs1, "RP.INITIAL_ROOM_CONC", i, rp.INITIAL_ROOM_CONC(i))
  Next i
  
  'END SAVE TO THIS TABLE.
  Rs1.Close
  
  'CLOSE THE DATABASE FILE.
  Db1.Close

  'COMPACT THE DATABASE FILE.
      'TO DO: USE THE DbEngine.CompactDatabase METHOD
      'TO COMPACT THE DATABASE.  PROBLEM TO CONSIDER:
      'THE DB MUST BE COMPACTED TO A TEMPORARY FILE,
      'WHICH THEN SHOULD OVERWRITE THE ORIGINAL FILE.
  
  'RETURN A "SUCCESS" MESSAGE TO CALLER.
  File_Save_Latest_v1_60 = True
  
End Function


Sub Units1_Database_SaveProperty(Rs1 As Recordset, CboX As Control, Desc As String)
Dim OutStr As String
  If (CboX.ListIndex >= 0) Then
    OutStr = CboX.List(CboX.ListIndex)
  Else
    If (CboX.ListCount > 0) Then
      OutStr = CboX.List(0)
    Else
      OutStr = ""     'NOT LIKELY TO GET HERE!
    End If
  End If
  ''''Call ProjectFile_Write(f, OutStr, Desc)
  Call Database_SaveProperty(Rs1, Desc, OutStr)
End Sub
Sub Units1_Database_LoadProperty(Rs1 As Recordset, CboX As Control)
Dim TxtX As Control
Dim inline As String
Dim Dummy1 As String
Dim NewUnits As String
Dim H As Integer
  Call Database_LoadProperty(Rs1, inline)
  ''''Call ProjectFile_Read(f, InLine, Dummy1)
  NewUnits = inline
  H = unitsys_lookup_cbox(CboX)
  Set TxtX = unitsys(H).TxtX
  Call unitsys_set_units(TxtX, NewUnits)
End Sub


Sub Database_LoadProperty( _
    Rs1 As Recordset, _
    LoadedData As Variant, _
    Optional Use_memoValue As Boolean = False)
  Select Case VarType(LoadedData)
    Case vbBoolean:
      LoadedData = CBool(Database_Get_Long(Rs1, "lngValue"))
    Case vbByte:
      LoadedData = CByte(Database_Get_Long(Rs1, "lngValue"))
    Case vbInteger:
      LoadedData = CInt(Database_Get_Long(Rs1, "lngValue"))
    Case vbLong:
      LoadedData = CLng(Database_Get_Long(Rs1, "lngValue"))
    Case vbString, vbDate:
      If (Use_memoValue) Then
        LoadedData = CStr(Database_Get_String(Rs1, "memoValue"))
      Else
        LoadedData = CStr(Database_Get_String(Rs1, "strValue"))
      End If
    Case vbDouble:
      LoadedData = CDbl(Database_Get_Double(Rs1, "dblValue"))
    Case vbSingle:
      LoadedData = CSng(Database_Get_Double(Rs1, "dblValue"))
  End Select
End Sub
Sub Database_SaveProperty( _
    Rs1 As Recordset, _
    in_Use_FieldName As String, _
    SavedData As Variant)
Dim Use_memoValue As Boolean
Dim Use_FieldName As String
  'NOTE: IF THE FIRST CHARACTER IS AN ASTERISK ("*"), THEN
  'THE FIELD TYPE USED IS THE MEMO TYPE (memoValue).
  Use_memoValue = False
  If (Left$(in_Use_FieldName, 1) = "*") Then
    Use_FieldName = Right$(in_Use_FieldName, Len(in_Use_FieldName) - 1)
    Use_memoValue = True
  Else
    Use_FieldName = in_Use_FieldName
  End If
  Rs1.AddNew
  Rs1("FieldName") = Use_FieldName
  Select Case VarType(SavedData)
    Case vbBoolean, vbByte, vbInteger, vbLong:
      Rs1("lngValue") = CLng(SavedData)
    Case vbString, vbDate:
      If (Use_memoValue) Then
        Rs1("memoValue") = CStr(SavedData)
      Else
        Rs1("strValue") = CStr(SavedData)
      End If
    Case vbDouble, vbSingle:
      Rs1("dblValue") = CDbl(SavedData)
  End Select
  Rs1.Update
End Sub
Sub Database_SavePropertyWithIndex( _
    Rs1 As Recordset, _
    in_Use_FieldName As String, _
    Use_FieldIndex As Integer, _
    SavedData As Variant)
Dim Use_memoValue As Boolean
Dim Use_FieldName As String
  'NOTE: IF THE FIRST CHARACTER IS AN ASTERISK ("*"), THEN
  'THE FIELD TYPE USED IS THE MEMO TYPE (memoValue).
  Use_memoValue = False
  If (Left$(in_Use_FieldName, 1) = "*") Then
    Use_FieldName = Right$(in_Use_FieldName, Len(in_Use_FieldName) - 1)
    Use_memoValue = True
  Else
    Use_FieldName = in_Use_FieldName
  End If
  Rs1.AddNew
  Rs1("FieldName") = Use_FieldName
  Rs1("FieldIndex") = Use_FieldIndex
  Select Case VarType(SavedData)
    Case vbBoolean, vbByte, vbInteger, vbLong:
      Rs1("lngValue") = CLng(SavedData)
    Case vbString, vbDate:
      If (Use_memoValue) Then
        Rs1("memoValue") = CStr(SavedData)
      Else
        Rs1("strValue") = CStr(SavedData)
      End If
    Case vbDouble, vbSingle:
      Rs1("dblValue") = CDbl(SavedData)
  End Select
  Rs1.Update
End Sub


Sub Database_DeleteTableContents( _
    Db1 As Database, _
    TableName As String)
Dim Rs1 As Recordset
  On Error GoTo err_Database_DeleteTableContents
  Set Rs1 = Db1.OpenRecordset(TableName)
  Rs1.MoveFirst
  Do Until Rs1.EOF
    Rs1.Delete
    Rs1.MoveNext
  Loop
  Rs1.Close
  Exit Sub
exit_err_Database_DeleteTableContents:
  Exit Sub
err_Database_DeleteTableContents:
  Resume exit_err_Database_DeleteTableContents
End Sub
Sub Database_CreateMFBTable( _
    Db1 As Database, _
    TableName As String, _
    Include_FieldIndex As Boolean, _
    Include_FieldIndex2 As Boolean)
Dim Td1 As TableDef
Dim Ff As Field
    
  Set Td1 = Db1.CreateTableDef(TableName)
  Set Ff = Td1.CreateField("RecordID", dbLong):
  'TODO: ADD AUTONUMBER SETUP FOR THIS FIELD (NOT TOO NEEDED).
  Td1.Fields.Append Ff
  Set Ff = Td1.CreateField("FieldName", dbText, 250):
  Ff.AllowZeroLength = True
  Td1.Fields.Append Ff
  If (Include_FieldIndex) Then
    Set Ff = Td1.CreateField("FieldIndex", dbLong):
    Td1.Fields.Append Ff
  End If
  If (Include_FieldIndex2) Then
    Set Ff = Td1.CreateField("FieldIndex2", dbLong):
    Td1.Fields.Append Ff
  End If
  Set Ff = Td1.CreateField("strValue", dbText, 250):
  Ff.AllowZeroLength = True
  Td1.Fields.Append Ff
  Set Ff = Td1.CreateField("dblValue", dbDouble):
  Td1.Fields.Append Ff
  Set Ff = Td1.CreateField("lngValue", dbLong):
  Td1.Fields.Append Ff
  Set Ff = Td1.CreateField("memoValue", dbMemo):
  Ff.AllowZeroLength = True
  Td1.Fields.Append Ff
  Set Ff = Td1.CreateField("Comments", dbText, 250):
  Ff.AllowZeroLength = True
  Td1.Fields.Append Ff
  Db1.TableDefs.Append Td1
End Sub
Sub Database_CreateMFBTable_IfNoExist( _
    Db1 As Database, _
    Use_TableName As String, _
    Include_FieldIndex As Boolean)
  If (Database_IsTableExist(Db1, Use_TableName) = False) Then
    Call Database_CreateMFBTable(Db1, Use_TableName, Include_FieldIndex, False)
  End If
End Sub
Sub Database_CreateMFBTable_IfNoExist_TwoIndices( _
    Db1 As Database, _
    Use_TableName As String)
  If (Database_IsTableExist(Db1, Use_TableName) = False) Then
    Call Database_CreateMFBTable(Db1, Use_TableName, True, True)
  End If
End Sub




Attribute VB_Name = "FileIO_Legacy"
Option Explicit




Const FileIO_Legacy_declarations_end = True


'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////     VERSION 1.00     ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub File_Open_Legacy_v1_00(f As Integer)
Dim i As Integer, j As Integer
Dim VersionST As String, msg As String
Dim PSDR As Double
'---Declaration for tempo variables
ReDim State_Check_WaterT(2) As Integer
Dim SPDFR_Low_Concentration_tempo As Integer
Dim Use_SPDFR_Correlation_Tempo As Integer
Dim Use_Tortuosity_Correlation_Tempo As Integer
Dim Constant_Tortuosity_Tempo As Integer
Dim PSDRTempo As Double
Dim Number_ComponentTempo As Integer
Dim BedTempo As BedPropertyType
ReDim CompoTempo(Number_Compo_Max) As ComponentPropertyType
Dim CarbonTempo As CarbonPropertyType
Dim MCTempo As Integer, NCTempo As Integer
Dim TimePTempo As Para_Int
Dim Number_Influent_PointsTempo As Integer
ReDim C_InfluentTempo(Number_Compo_Max, Number_Max_Influent_Points) As Double
ReDim T_InfluentTempo(Number_Max_Influent_Points) As Double
Dim NVersion_Temp As Double
Dim temp As String
ReDim u(5) As String
Dim TempName As String
'
'END OF DECLARATION.
'
  msg = ""
'-----------------------------------
'-----   Version 1.00 ---------
'-----------------------------------
  If batchrun <> 1 Then
   'temp = "Note--this is an Adsorption Simulation Software version 1.00 file."
   'temp = temp & NL & "If you save this file, it will be saved in version " & Format$(NVersion, "0.00") & " format."
   'MsgBox temp, MB_ICONEXCLAMATION, Application_Name
  End If
  Input #f, Number_ComponentTempo
  For i = 1 To Number_ComponentTempo
    Call SetComponentDefaults(CompoTempo(i), -1)
    Input #f, CompoTempo(i).Name, CompoTempo(i).MW, CompoTempo(i).InitialConcentration, CompoTempo(i).MolarVolume, CompoTempo(i).BP, CompoTempo(i).Use_K, CompoTempo(i).Use_OneOverN
    CompoTempo(i).UserEntered_K = CompoTempo(i).Use_K
    CompoTempo(i).UserEntered_OneOverN = CompoTempo(i).Use_OneOverN
    Input #f, CompoTempo(i).SPDFR, CompoTempo(i).SPDFR_Low_Concentration, CompoTempo(i).Use_SPDFR_Correlation
    Input #f, CompoTempo(i).kf, CompoTempo(i).Ds, CompoTempo(i).Dp, CompoTempo(i).Corr(1), CompoTempo(i).Corr(2), CompoTempo(i).Corr(3)
    Input #f, CompoTempo(i).KP_User_Input(1), CompoTempo(i).KP_User_Input(2), CompoTempo(i).KP_User_Input(3)
    Input #f, CompoTempo(i).K_Reduction, CompoTempo(i).Correlation.Name, CompoTempo(i).Correlation.Coeff(1), CompoTempo(i).Correlation.Coeff(2)
  Next i
  Input #f, BedTempo.length, BedTempo.Diameter, BedTempo.Weight, BedTempo.Flowrate, BedTempo.WaterDensity, BedTempo.WaterViscosity, BedTempo.Temperature, BedTempo.Pressure, BedTempo.Phase, BedTempo.NumberOfBeds
  Input #f, BedTempo.Water_Correlation.Name, BedTempo.Water_Correlation.Coeff(1), BedTempo.Water_Correlation.Coeff(2), BedTempo.Water_Correlation.Coeff(3), BedTempo.Water_Correlation.Coeff(4)
  Input #f, CarbonTempo.Name, CarbonTempo.Porosity, CarbonTempo.Density, CarbonTempo.ParticleRadius, CarbonTempo.Tortuosity
  Input #f, State_Check_WaterT(1), State_Check_WaterT(2)
  Input #f, Use_Tortuosity_Correlation_Tempo, Constant_Tortuosity_Tempo
  Input #f, NCTempo, MCTempo
  Input #f, TimePTempo.Init, TimePTempo.End, TimePTempo.np, TimePTempo.Step
  Input #f, Number_Influent_PointsTempo
  If (Number_Influent_PointsTempo > 0) Then
    For i = 1 To Number_Influent_PointsTempo
      Input #f, T_InfluentTempo(i)
      For j = 1 To Number_ComponentTempo
       Input #f, C_InfluentTempo(j, i)
      Next j
    Next i
  End If
  On Error GoTo No_Data_Points
  Input #f, NData_Points, Number_Component
  On Error GoTo 0
  CarbonTempo.ShapeFactor = 1#
  FileNote = ""
Read_Data_Points_v1_00:
  If (NData_Points > 0 And Number_Component > 0) Then
    For i = 1 To NData_Points
      Input #f, T_Data_Points(i)
      For j = 1 To Number_Component
        Input #f, C_Data_Points(j, i)
      Next j
    Next i
  End If
Update_Tortuosities_from_v1_00:
  For i = 1 To Number_ComponentTempo
    CompoTempo(i).Tortuosity = CarbonTempo.Tortuosity
    CompoTempo(i).Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
    CompoTempo(i).Constant_Tortuosity = Constant_Tortuosity_Tempo
  Next i
  'IMPORT ALL TEMPORARY DATA INTO GLOBAL VARIABLES.
  'Update_All_Data
  'Store all the read variables in global variables
  If (Number_ComponentTempo > 0) Then
    Component_Number_Selected = 1
  Else
    Component_Number_Selected = -1
  End If
  Number_Component = Number_ComponentTempo
  State_Check_Water(2) = State_Check_WaterT(2)
  State_Check_Water(1) = State_Check_WaterT(1)
  'Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
  'SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
'  Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
'  Constant_Tortuosity = Constant_Tortuosity_Tempo
  For i = 1 To Number_Component
    Component(i) = CompoTempo(i)
  Next i
  '========== What the heck does this code do!?!?
  '- Apparently all it does is cause problems.
  '- Commented out by ejo, 4/16/96. =================================
'  If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.00") And NVersion_Temp <> 1#) Then
'    If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.20") And NVersion_Temp <> 1.2) Then
'      If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.30") And NVersion_Temp <> 1.3) Then
  'If (NVersion_Temp <> 1#) Then
  '  If (NVersion_Temp <> 1.2) Then
  '    If (NVersion_Temp <> 1.3) Then
  '      For i = 1 To Number_Component
  '        Component(i).SPDFR = PSDRTempo
  '        Component(i).SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
  '        Component(i).Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
  '      Next i
  '    End If
  '  End If
  'End If
  Carbon = CarbonTempo
  Bed = BedTempo
  TimeP = TimePTempo
  NC = NCTempo
  MC = MCTempo
  TimeP = TimePTempo
  Number_Influent_Points = Number_Influent_PointsTempo
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      T_Influent(i) = T_InfluentTempo(i)
      For j = 1 To Number_Component
        C_Influent(j, i) = C_InfluentTempo(j, i)
      Next j
    Next i
  End If
  Exit Sub
No_Data_Points:
  NData_Points = 0
  Number_Component = 0
  Resume Read_Data_Points_v1_00
  'Select Case NVersion_Temp
  '  Case 1#
  '    Resume Read_Data_Points_v1_00
  '  '     .
  '  '     .
  '  '     .
  '  '.... other versions ...
  '  '     .
  '  '     .
  '  '     .
  'End Select
  'Resume Read_Data_Points_v_LATEST
End Sub


'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////     VERSION 1.20     ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub File_Open_Legacy_v1_20(f As Integer)
Dim i As Integer, j As Integer
Dim VersionST As String, msg As String
Dim PSDR As Double
'---Declaration for tempo variables
ReDim State_Check_WaterT(2) As Integer
Dim SPDFR_Low_Concentration_tempo As Integer
Dim Use_SPDFR_Correlation_Tempo As Integer
Dim Use_Tortuosity_Correlation_Tempo As Integer
Dim Constant_Tortuosity_Tempo As Integer
Dim PSDRTempo As Double
Dim Number_ComponentTempo As Integer
Dim BedTempo As BedPropertyType
ReDim CompoTempo(Number_Compo_Max) As ComponentPropertyType
Dim CarbonTempo As CarbonPropertyType
Dim MCTempo As Integer, NCTempo As Integer
Dim TimePTempo As Para_Int
Dim Number_Influent_PointsTempo As Integer
ReDim C_InfluentTempo(Number_Compo_Max, Number_Max_Influent_Points) As Double
ReDim T_InfluentTempo(Number_Max_Influent_Points) As Double
Dim NVersion_Temp As Double
Dim temp As String
ReDim u(5) As String
Dim TempName As String
'
'END OF DECLARATION.
'
  msg = ""
'-----------------------------------
'-----   Version 1.20 ---------
'-----------------------------------
  If batchrun <> 1 Then
   'temp = "Note--this is an Adsorption Simulation Software version 1.20 file."
   'temp = temp & NL & "If you save this file, it will be saved in version " & Format$(NVersion, "0.00") & " format."
   'MsgBox temp, MB_ICONEXCLAMATION, Application_Name
  End If
  Input #f, Number_ComponentTempo
  For i = 1 To Number_ComponentTempo
    Call SetComponentDefaults(CompoTempo(i), -1)
    Input #f, CompoTempo(i).Name, CompoTempo(i).MW, CompoTempo(i).InitialConcentration, CompoTempo(i).MolarVolume, CompoTempo(i).BP, CompoTempo(i).Use_K, CompoTempo(i).Use_OneOverN, CompoTempo(i).Liquid_Density, CompoTempo(i).Aqueous_Solubility, CompoTempo(i).Vapor_Pressure, CompoTempo(i).Refractive_Index
    Input #f, CompoTempo(i).SPDFR, CompoTempo(i).SPDFR_Low_Concentration, CompoTempo(i).Use_SPDFR_Correlation
    Input #f, CompoTempo(i).kf, CompoTempo(i).Ds, CompoTempo(i).Dp, CompoTempo(i).Corr(1), CompoTempo(i).Corr(2), CompoTempo(i).Corr(3)
    Input #f, CompoTempo(i).KP_User_Input(1), CompoTempo(i).KP_User_Input(2), CompoTempo(i).KP_User_Input(3)
    Input #f, CompoTempo(i).K_Reduction, CompoTempo(i).Correlation.Name, CompoTempo(i).Correlation.Coeff(1), CompoTempo(i).Correlation.Coeff(2)
    Input #f, CompoTempo(i).IsothermDB_Component_Name, CompoTempo(i).IsothermDB_Range_Num, CompoTempo(i).IPES_OrderOfMagnitude, CompoTempo(i).IPES_NumRegressionPts, CompoTempo(i).IPES_RelativeHumidity, CompoTempo(i).IPES_EstimationMethod, CompoTempo(i).Source_KandOneOverN
    Input #f, CompoTempo(i).IsothermDB_K, CompoTempo(i).IsothermDB_OneOverN, CompoTempo(i).IPESResult_K, CompoTempo(i).IPESResult_OneOverN, CompoTempo(i).UserEntered_K, CompoTempo(i).UserEntered_OneOverN
  Next i
  Input #f, BedTempo.length, BedTempo.Diameter, BedTempo.Weight, BedTempo.Flowrate, BedTempo.WaterDensity, BedTempo.WaterViscosity, BedTempo.Temperature, BedTempo.Pressure, BedTempo.Phase, BedTempo.NumberOfBeds
  Input #f, BedTempo.Water_Correlation.Name, BedTempo.Water_Correlation.Coeff(1), BedTempo.Water_Correlation.Coeff(2), BedTempo.Water_Correlation.Coeff(3), BedTempo.Water_Correlation.Coeff(4)
  Input #f, CarbonTempo.Name, CarbonTempo.Porosity, CarbonTempo.Density, CarbonTempo.ParticleRadius, CarbonTempo.Tortuosity, CarbonTempo.W0, CarbonTempo.BB, CarbonTempo.PolanyiExponent
  Input #f, State_Check_WaterT(1), State_Check_WaterT(2)
  Input #f, Use_Tortuosity_Correlation_Tempo, Constant_Tortuosity_Tempo
  Input #f, NCTempo, MCTempo
  Input #f, TimePTempo.Init, TimePTempo.End, TimePTempo.np, TimePTempo.Step
  CarbonTempo.ShapeFactor = 1#
  FileNote = ""
  Input #f, u(1), u(2), u(3), u(4), u(5)
  Call unitsys_set_units(frmMain.txtBedValue(0), u(1))
  Call unitsys_set_units(frmMain.txtBedValue(1), u(2))
  Call unitsys_set_units(frmMain.txtBedValue(2), u(3))
  Call unitsys_set_units(frmMain.txtBedValue(3), u(4))
  Call unitsys_set_units(frmMain.txtBedValue(4), u(5))
  'Call SetUnits(frmPFPSDM!txtBedUnits(0), u(1))
  'Call SetUnits(frmPFPSDM!txtBedUnits(1), u(2))
  'Call SetUnits(frmPFPSDM!txtBedUnits(2), u(3))
  'Call SetUnits(frmPFPSDM!txtBedUnits(3), u(4))
  'Call SetUnits(frmPFPSDM!txtBedUnits(4), u(5))
  Input #f, u(1), u(2)
  Call unitsys_set_units(frmMain.txtCarbon(1), u(1))
  Call unitsys_set_units(frmMain.txtCarbon(2), u(2))
  'Call SetUnits(frmPFPSDM!txtCarbonUnits(1), u(1))
  'Call SetUnits(frmPFPSDM!txtCarbonUnits(2), u(2))
  Input #f, PropertyUnits.MW, PropertyUnits.MolarVolume, PropertyUnits.BP, PropertyUnits.InitialConcentration
  Input #f, PropertyUnits.Liquid_Density, PropertyUnits.Aqueous_Solubility, PropertyUnits.Vapor_Pressure, PropertyUnits.k
  Input #f, Number_Influent_PointsTempo
  If (Number_Influent_PointsTempo > 0) Then
    For i = 1 To Number_Influent_PointsTempo
      Input #f, T_InfluentTempo(i)
      For j = 1 To Number_ComponentTempo
       Input #f, C_InfluentTempo(j, i)
      Next j
    Next i
  End If
  On Error GoTo No_Data_Points
  Input #f, NData_Points, Number_Component
  On Error GoTo 0
Read_Data_Points_v1_20:
  If (NData_Points > 0) And (Number_Component > 0) Then
    For i = 1 To NData_Points
      Input #f, T_Data_Points(i)
      For j = 1 To Number_Component
        Input #f, C_Data_Points(j, i)
      Next j
    Next i
  End If
Update_Tortuosities_from_v1_20:
  For i = 1 To Number_ComponentTempo
    CompoTempo(i).Tortuosity = CarbonTempo.Tortuosity
    CompoTempo(i).Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
    CompoTempo(i).Constant_Tortuosity = Constant_Tortuosity_Tempo
  Next i
  'IMPORT ALL TEMPORARY DATA INTO GLOBAL VARIABLES.
  'Update_All_Data
  'Store all the read variables in global variables
  If (Number_ComponentTempo > 0) Then
    Component_Number_Selected = 1
  Else
    Component_Number_Selected = -1
  End If
  Number_Component = Number_ComponentTempo
  State_Check_Water(2) = State_Check_WaterT(2)
  State_Check_Water(1) = State_Check_WaterT(1)
  'Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
  'SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
'  Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
'  Constant_Tortuosity = Constant_Tortuosity_Tempo
  For i = 1 To Number_Component
    Component(i) = CompoTempo(i)
  Next i
  '========== What the heck does this code do!?!?
  '- Apparently all it does is cause problems.
  '- Commented out by ejo, 4/16/96. =================================
'  If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.00") And NVersion_Temp <> 1#) Then
'    If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.20") And NVersion_Temp <> 1.2) Then
'      If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.30") And NVersion_Temp <> 1.3) Then
  'If (NVersion_Temp <> 1#) Then
  '  If (NVersion_Temp <> 1.2) Then
  '    If (NVersion_Temp <> 1.3) Then
  '      For i = 1 To Number_Component
  '        Component(i).SPDFR = PSDRTempo
  '        Component(i).SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
  '        Component(i).Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
  '      Next i
  '    End If
  '  End If
  'End If
  Carbon = CarbonTempo
  Bed = BedTempo
  TimeP = TimePTempo
  NC = NCTempo
  MC = MCTempo
  TimeP = TimePTempo
  Number_Influent_Points = Number_Influent_PointsTempo
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      T_Influent(i) = T_InfluentTempo(i)
      For j = 1 To Number_Component
        C_Influent(j, i) = C_InfluentTempo(j, i)
      Next j
    Next i
  End If
  Exit Sub
No_Data_Points:
  NData_Points = 0
  Number_Component = 0
  Resume Read_Data_Points_v1_20
  'Select Case NVersion_Temp
  '  Case 1#
  '    Resume Read_Data_Points_v1_00
  '  '     .
  '  '     .
  '  '     .
  '  '.... other versions ...
  '  '     .
  '  '     .
  '  '     .
  'End Select
  'Resume Read_Data_Points_v_LATEST
End Sub


'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////     VERSION 1.30     ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub File_Open_Legacy_v1_30(f As Integer)
Dim i As Integer, j As Integer
Dim VersionST As String, msg As String
Dim PSDR As Double
'---Declaration for tempo variables
ReDim State_Check_WaterT(2) As Integer
Dim SPDFR_Low_Concentration_tempo As Integer
Dim Use_SPDFR_Correlation_Tempo As Integer
Dim Use_Tortuosity_Correlation_Tempo As Integer
Dim Constant_Tortuosity_Tempo As Integer
Dim PSDRTempo As Double
Dim Number_ComponentTempo As Integer
Dim BedTempo As BedPropertyType
ReDim CompoTempo(Number_Compo_Max) As ComponentPropertyType
Dim CarbonTempo As CarbonPropertyType
Dim MCTempo As Integer, NCTempo As Integer
Dim TimePTempo As Para_Int
Dim Number_Influent_PointsTempo As Integer
ReDim C_InfluentTempo(Number_Compo_Max, Number_Max_Influent_Points) As Double
ReDim T_InfluentTempo(Number_Max_Influent_Points) As Double
Dim NVersion_Temp As Double
Dim temp As String
ReDim u(5) As String
Dim TempName As String
'
'END OF DECLARATION.
'
  msg = ""
'-----------------------------------
'-----   Version 1.30 ---------
'-----------------------------------
  Input #f, Number_ComponentTempo
  For i = 1 To Number_ComponentTempo
    Call SetComponentDefaults(CompoTempo(i), -1)
    '---- Modified by Eric J. Oman 8/8/97 BEGINS:
    Input #f, TempName, CompoTempo(i).MW, CompoTempo(i).InitialConcentration, CompoTempo(i).MolarVolume, CompoTempo(i).BP, CompoTempo(i).Use_K, CompoTempo(i).Use_OneOverN, CompoTempo(i).Liquid_Density, CompoTempo(i).Aqueous_Solubility, CompoTempo(i).Vapor_Pressure, CompoTempo(i).Refractive_Index
    If (Right$(Trim$(TempName), 5) = "#$1$#") Then
      Input #f, CompoTempo(i).CAS
      CompoTempo(i).Name = Left$(TempName, Len(TempName) - 5)
    Else
      CompoTempo(i).Name = TempName
    End If
    '---- Modified by Eric J. Oman 8/8/97 ENDS.
    Input #f, CompoTempo(i).SPDFR, CompoTempo(i).SPDFR_Low_Concentration, CompoTempo(i).Use_SPDFR_Correlation
    Input #f, CompoTempo(i).kf, CompoTempo(i).Ds, CompoTempo(i).Dp, CompoTempo(i).Corr(1), CompoTempo(i).Corr(2), CompoTempo(i).Corr(3)
    Input #f, CompoTempo(i).KP_User_Input(1), CompoTempo(i).KP_User_Input(2), CompoTempo(i).KP_User_Input(3)
    Input #f, CompoTempo(i).K_Reduction, CompoTempo(i).Correlation.Name, CompoTempo(i).Correlation.Coeff(1), CompoTempo(i).Correlation.Coeff(2)
    Input #f, CompoTempo(i).IsothermDB_Component_Name, CompoTempo(i).IsothermDB_Range_Num, CompoTempo(i).IPES_OrderOfMagnitude, CompoTempo(i).IPES_NumRegressionPts, CompoTempo(i).IPES_RelativeHumidity, CompoTempo(i).IPES_EstimationMethod, CompoTempo(i).Source_KandOneOverN
    Input #f, CompoTempo(i).IsothermDB_K, CompoTempo(i).IsothermDB_OneOverN, CompoTempo(i).IPESResult_K, CompoTempo(i).IPESResult_OneOverN, CompoTempo(i).UserEntered_K, CompoTempo(i).UserEntered_OneOverN
    Input #f, CompoTempo(i).Tortuosity, CompoTempo(i).Use_Tortuosity_Correlation, CompoTempo(i).Constant_Tortuosity
  Next i
  Input #f, BedTempo.length, BedTempo.Diameter, BedTempo.Weight, BedTempo.Flowrate, BedTempo.WaterDensity, BedTempo.WaterViscosity, BedTempo.Temperature, BedTempo.Pressure, BedTempo.Phase, BedTempo.NumberOfBeds
  Input #f, BedTempo.Water_Correlation.Name, BedTempo.Water_Correlation.Coeff(1), BedTempo.Water_Correlation.Coeff(2), BedTempo.Water_Correlation.Coeff(3), BedTempo.Water_Correlation.Coeff(4)
  Input #f, CarbonTempo.Name, CarbonTempo.Porosity, CarbonTempo.Density, CarbonTempo.ParticleRadius, CarbonTempo.Tortuosity, CarbonTempo.W0, CarbonTempo.BB, CarbonTempo.PolanyiExponent
  Input #f, State_Check_WaterT(1), State_Check_WaterT(2)
  Input #f, CarbonTempo.ShapeFactor, Constant_Tortuosity_Tempo       'Constant_Tortuosity_Tempo is Unused!!
  If (CarbonTempo.ShapeFactor <= 0#) Then
    CarbonTempo.ShapeFactor = 1#
  End If
  FileNote = ""
  Input #f, NCTempo, MCTempo
  Input #f, TimePTempo.Init, TimePTempo.End, TimePTempo.np, TimePTempo.Step
  Input #f, u(1), u(2), u(3), u(4), u(5)
  Call unitsys_set_units(frmMain.txtBedValue(0), u(1))
  Call unitsys_set_units(frmMain.txtBedValue(1), u(2))
  Call unitsys_set_units(frmMain.txtBedValue(2), u(3))
  Call unitsys_set_units(frmMain.txtBedValue(3), u(4))
  Call unitsys_set_units(frmMain.txtBedValue(4), u(5))
  'Call SetUnits(frmPFPSDM!txtBedUnits(0), u(1))
  'Call SetUnits(frmPFPSDM!txtBedUnits(1), u(2))
  'Call SetUnits(frmPFPSDM!txtBedUnits(2), u(3))
  'Call SetUnits(frmPFPSDM!txtBedUnits(3), u(4))
  'Call SetUnits(frmPFPSDM!txtBedUnits(4), u(5))
  Input #f, u(1), u(2)
  Call unitsys_set_units(frmMain.txtCarbon(1), u(1))
  Call unitsys_set_units(frmMain.txtCarbon(2), u(2))
  'Call SetUnits(frmPFPSDM!txtCarbonUnits(1), u(1))
  'Call SetUnits(frmPFPSDM!txtCarbonUnits(2), u(2))
  Input #f, PropertyUnits.MW, PropertyUnits.MolarVolume, PropertyUnits.BP, PropertyUnits.InitialConcentration
  Input #f, PropertyUnits.Liquid_Density, PropertyUnits.Aqueous_Solubility, PropertyUnits.Vapor_Pressure, PropertyUnits.k
  Input #f, Number_Influent_PointsTempo
  If (Number_Influent_PointsTempo > 0) Then
    For i = 1 To Number_Influent_PointsTempo
      Input #f, T_InfluentTempo(i)
      For j = 1 To Number_ComponentTempo
       Input #f, C_InfluentTempo(j, i)
      Next j
    Next i
  End If
  On Error GoTo No_Data_Points
  Input #f, NData_Points, Number_Component
  On Error GoTo 0
Read_Data_Points_v1_30:
  If (NData_Points > 0) And (Number_Component > 0) Then
    For i = 1 To NData_Points
      Input #f, T_Data_Points(i)
      For j = 1 To Number_Component
        Input #f, C_Data_Points(j, i)
      Next j
    Next i
  End If
  'IMPORT ALL TEMPORARY DATA INTO GLOBAL VARIABLES.
  'Update_All_Data
  'Store all the read variables in global variables
  If (Number_ComponentTempo > 0) Then
    Component_Number_Selected = 1
  Else
    Component_Number_Selected = -1
  End If
  Number_Component = Number_ComponentTempo
  State_Check_Water(2) = State_Check_WaterT(2)
  State_Check_Water(1) = State_Check_WaterT(1)
  'Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
  'SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
'  Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
'  Constant_Tortuosity = Constant_Tortuosity_Tempo
  For i = 1 To Number_Component
    Component(i) = CompoTempo(i)
  Next i
  '========== What the heck does this code do!?!?
  '- Apparently all it does is cause problems.
  '- Commented out by ejo, 4/16/96. =================================
'  If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.00") And NVersion_Temp <> 1#) Then
'    If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.20") And NVersion_Temp <> 1.2) Then
'      If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.30") And NVersion_Temp <> 1.3) Then
  'If (NVersion_Temp <> 1#) Then
  '  If (NVersion_Temp <> 1.2) Then
  '    If (NVersion_Temp <> 1.3) Then
  '      For i = 1 To Number_Component
  '        Component(i).SPDFR = PSDRTempo
  '        Component(i).SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
  '        Component(i).Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
  '      Next i
  '    End If
  '  End If
  'End If
  Carbon = CarbonTempo
  Bed = BedTempo
  TimeP = TimePTempo
  NC = NCTempo
  MC = MCTempo
  TimeP = TimePTempo
  Number_Influent_Points = Number_Influent_PointsTempo
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      T_Influent(i) = T_InfluentTempo(i)
      For j = 1 To Number_Component
        C_Influent(j, i) = C_InfluentTempo(j, i)
      Next j
    Next i
  End If
  Exit Sub
No_Data_Points:
  NData_Points = 0
  Number_Component = 0
  Resume Read_Data_Points_v1_30
  'Select Case NVersion_Temp
  '  Case 1#
  '    Resume Read_Data_Points_v1_00
  '  '     .
  '  '     .
  '  '     .
  '  '.... other versions ...
  '  '     .
  '  '     .
  '  '     .
  'End Select
  'Resume Read_Data_Points_v_LATEST
End Sub


'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////     VERSION 1.42     ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub File_Open_Legacy_v1_42(f As Integer)
Dim i As Integer, j As Integer
Dim VersionST As String, msg As String
Dim PSDR As Double
'---Declaration for tempo variables
ReDim State_Check_WaterT(2) As Integer
Dim SPDFR_Low_Concentration_tempo As Integer
Dim Use_SPDFR_Correlation_Tempo As Integer
Dim Use_Tortuosity_Correlation_Tempo As Integer
Dim Constant_Tortuosity_Tempo As Integer
Dim PSDRTempo As Double
Dim Number_ComponentTempo As Integer
Dim BedTempo As BedPropertyType
ReDim CompoTempo(Number_Compo_Max) As ComponentPropertyType
Dim CarbonTempo As CarbonPropertyType
Dim MCTempo As Integer, NCTempo As Integer
Dim TimePTempo As Para_Int
Dim Number_Influent_PointsTempo As Integer
ReDim C_InfluentTempo(Number_Compo_Max, Number_Max_Influent_Points) As Double
ReDim T_InfluentTempo(Number_Max_Influent_Points) As Double
Dim NVersion_Temp As Double
Dim temp As String
ReDim u(5) As String
Dim TempName As String
Dim DummyStr As String
'
'END OF DECLARATION.
'
'-----------------------------------
'-----   Version 1.42 ---------
'-----------------------------------
    Input #f, Number_ComponentTempo
    For i = 1 To Number_ComponentTempo
      Call SetComponentDefaults(CompoTempo(i), -1)
      '---- Modified by Eric J. Oman 8/8/97 BEGINS:
      Input #f, TempName, CompoTempo(i).MW, CompoTempo(i).InitialConcentration, CompoTempo(i).MolarVolume, CompoTempo(i).BP, CompoTempo(i).Use_K, CompoTempo(i).Use_OneOverN, CompoTempo(i).Liquid_Density, CompoTempo(i).Aqueous_Solubility, CompoTempo(i).Vapor_Pressure, CompoTempo(i).Refractive_Index
      If (Right$(Trim$(TempName), 5) = "#$1$#") Then
        Input #f, CompoTempo(i).CAS
        CompoTempo(i).Name = Left$(TempName, Len(TempName) - 5)
      Else
        CompoTempo(i).Name = TempName
      End If
      '---- Modified by Eric J. Oman 8/8/97 ENDS.
      Input #f, CompoTempo(i).SPDFR, CompoTempo(i).SPDFR_Low_Concentration, CompoTempo(i).Use_SPDFR_Correlation
      Input #f, CompoTempo(i).kf, CompoTempo(i).Ds, CompoTempo(i).Dp, CompoTempo(i).Corr(1), CompoTempo(i).Corr(2), CompoTempo(i).Corr(3)
      Input #f, CompoTempo(i).KP_User_Input(1), CompoTempo(i).KP_User_Input(2), CompoTempo(i).KP_User_Input(3)
      Input #f, CompoTempo(i).K_Reduction, CompoTempo(i).Correlation.Name, CompoTempo(i).Correlation.Coeff(1), CompoTempo(i).Correlation.Coeff(2)
      Input #f, CompoTempo(i).IsothermDB_Component_Name, CompoTempo(i).IsothermDB_Range_Num, CompoTempo(i).IPES_OrderOfMagnitude, CompoTempo(i).IPES_NumRegressionPts, CompoTempo(i).IPES_RelativeHumidity, CompoTempo(i).IPES_EstimationMethod, CompoTempo(i).Source_KandOneOverN
      Input #f, CompoTempo(i).IsothermDB_K, CompoTempo(i).IsothermDB_OneOverN, CompoTempo(i).IPESResult_K, CompoTempo(i).IPESResult_OneOverN, CompoTempo(i).UserEntered_K, CompoTempo(i).UserEntered_OneOverN
      Input #f, CompoTempo(i).Tortuosity, CompoTempo(i).Use_Tortuosity_Correlation, CompoTempo(i).Constant_Tortuosity
    Next i
    Input #f, BedTempo.length, BedTempo.Diameter, BedTempo.Weight, BedTempo.Flowrate, BedTempo.WaterDensity, BedTempo.WaterViscosity, BedTempo.Temperature, BedTempo.Pressure, BedTempo.Phase, BedTempo.NumberOfBeds
    Input #f, BedTempo.Water_Correlation.Name, BedTempo.Water_Correlation.Coeff(1), BedTempo.Water_Correlation.Coeff(2), BedTempo.Water_Correlation.Coeff(3), BedTempo.Water_Correlation.Coeff(4)
    Input #f, CarbonTempo.Name, CarbonTempo.Porosity, CarbonTempo.Density, CarbonTempo.ParticleRadius, CarbonTempo.Tortuosity, CarbonTempo.W0, CarbonTempo.BB, CarbonTempo.PolanyiExponent
    Input #f, State_Check_WaterT(1), State_Check_WaterT(2)
    Input #f, CarbonTempo.ShapeFactor, Constant_Tortuosity_Tempo       'Constant_Tortuosity_Tempo is Unused!!
    If (CarbonTempo.ShapeFactor <= 0#) Then
      CarbonTempo.ShapeFactor = 1#
    End If
    FileNote = ""
    Input #f, NCTempo, MCTempo
    Input #f, TimePTempo.Init, TimePTempo.End, TimePTempo.np, TimePTempo.Step
    Input #f, u(1), u(2), u(3), u(4), u(5)
    Call unitsys_set_units(frmMain.txtBedValue(0), u(1))
    Call unitsys_set_units(frmMain.txtBedValue(1), u(2))
    Call unitsys_set_units(frmMain.txtBedValue(2), u(3))
    Call unitsys_set_units(frmMain.txtBedValue(3), u(4))
    Call unitsys_set_units(frmMain.txtBedValue(4), u(5))
    'Call SetUnits(frmPFPSDM!txtBedUnits(0), u(1))
    'Call SetUnits(frmPFPSDM!txtBedUnits(1), u(2))
    'Call SetUnits(frmPFPSDM!txtBedUnits(2), u(3))
    'Call SetUnits(frmPFPSDM!txtBedUnits(3), u(4))
    'Call SetUnits(frmPFPSDM!txtBedUnits(4), u(5))
    Input #f, u(1), u(2)
    Call unitsys_set_units(frmMain.txtCarbon(1), u(1))
    Call unitsys_set_units(frmMain.txtCarbon(2), u(2))
    'Call SetUnits(frmPFPSDM!txtCarbonUnits(1), u(1))
    'Call SetUnits(frmPFPSDM!txtCarbonUnits(2), u(2))
    Input #f, PropertyUnits.MW, PropertyUnits.MolarVolume, PropertyUnits.BP, PropertyUnits.InitialConcentration
    Input #f, PropertyUnits.Liquid_Density, PropertyUnits.Aqueous_Solubility, PropertyUnits.Vapor_Pressure, PropertyUnits.k
    '---- Modified by Eric J. Oman 6/25/98 BEGINS:
    'NOTE: THIS IS A MODIFICATION FOR V1.40 OF THE DATA FILE.
    Input #f, DummyStr
    Input #f, RoomParams.ROOM_VOL, DummyStr
    Input #f, RoomParams.ROOM_FLOWRATE, DummyStr
    For i = 1 To Number_ComponentTempo
      Input #f, RoomParams.ROOM_C0(i), DummyStr
      Input #f, RoomParams.ROOM_EMIT(i), DummyStr
    Next i
    Input #f, RoomParams.ROOM_VOL_Units
    Input #f, RoomParams.ROOM_FLOWRATE_Units
    Input #f, RoomParams.ROOM_C0_Units
    Input #f, RoomParams.ROOM_EMIT_Units
    RoomParams.COUNT_CONTAMINANT = Number_ComponentTempo
    Call RoomParam_Recalculate(RoomParams)
    'MsgBox RoomParams.ROOM_VOL_Units
    '---- Modified by Eric J. Oman 6/25/98 ENDS.
    
    '---- Modified by Eric J. Oman 9/16/98 BEGINS:
    'NOTE: THIS IS A MODIFICATION FOR V1.42 OF THE DATA FILE.
    For i = 1 To Number_ComponentTempo
      Input #f, RoomParams.INITIAL_ROOM_CONC(i)
    Next i
    Input #f, RoomParams.INITIAL_ROOM_CONC_Units
    '---- Modified by Eric J. Oman 9/16/98 ENDS.

    Input #f, Number_Influent_PointsTempo
    If (Number_Influent_PointsTempo > 0) Then
      For i = 1 To Number_Influent_PointsTempo
        Input #f, T_InfluentTempo(i)
        For j = 1 To Number_ComponentTempo
         Input #f, C_InfluentTempo(j, i)
        Next j
      Next i
    End If
    On Error GoTo No_Data_Points
    Input #f, NData_Points, Number_Component
    On Error GoTo 0
Read_Data_Points_v1_42:
    If (NData_Points > 0) And (Number_Component > 0) Then
      For i = 1 To NData_Points
        Input #f, T_Data_Points(i)
        For j = 1 To Number_Component
          Input #f, C_Data_Points(j, i)
        Next j
      Next i
    End If
    ''''Close (f)
    ''''GoTo Start_Updating
  ''''End If
  'IMPORT ALL TEMPORARY DATA INTO GLOBAL VARIABLES.
  'Update_All_Data
  'Store all the read variables in global variables
  If (Number_ComponentTempo > 0) Then
    Component_Number_Selected = 1
  Else
    Component_Number_Selected = -1
  End If
  Number_Component = Number_ComponentTempo
  State_Check_Water(2) = State_Check_WaterT(2)
  State_Check_Water(1) = State_Check_WaterT(1)
  'Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
  'SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
'  Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
'  Constant_Tortuosity = Constant_Tortuosity_Tempo
  For i = 1 To Number_Component
    Component(i) = CompoTempo(i)
  Next i
  '========== What the heck does this code do!?!?
  '- Apparently all it does is cause problems.
  '- Commented out by ejo, 4/16/96. =================================
'  If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.00") And NVersion_Temp <> 1#) Then
'    If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.20") And NVersion_Temp <> 1.2) Then
'      If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.30") And NVersion_Temp <> 1.3) Then
  'If (NVersion_Temp <> 1#) Then
  '  If (NVersion_Temp <> 1.2) Then
  '    If (NVersion_Temp <> 1.3) Then
  '      For i = 1 To Number_Component
  '        Component(i).SPDFR = PSDRTempo
  '        Component(i).SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
  '        Component(i).Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
  '      Next i
  '    End If
  '  End If
  'End If
  Carbon = CarbonTempo
  Bed = BedTempo
  TimeP = TimePTempo
  NC = NCTempo
  MC = MCTempo
  TimeP = TimePTempo
  Number_Influent_Points = Number_Influent_PointsTempo
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      T_Influent(i) = T_InfluentTempo(i)
      For j = 1 To Number_Component
        C_Influent(j, i) = C_InfluentTempo(j, i)
      Next j
    Next i
  End If
  Exit Sub
No_Data_Points:
  NData_Points = 0
  Number_Component = 0
  Resume Read_Data_Points_v1_42

End Sub




'Sub openfile()
'    Dim f As Integer, i  As Integer, J As Integer
'    Dim VersionST As String, msg As String
'    Dim PSDR As Double
'    '---Declaration for tempo variables
'    ReDim State_Check_WaterT(2) As Integer
'    Dim SPDFR_Low_Concentration_tempo As Integer
'    Dim Use_SPDFR_Correlation_Tempo As Integer
'    Dim Use_Tortuosity_Correlation_Tempo As Integer
'    Dim Constant_Tortuosity_Tempo As Integer
'    Dim PSDRTempo As Double
'    Dim Number_ComponentTempo As Integer
'    Dim BedTempo As BedPropertyType
'    ReDim CompoTempo(Number_Compo_Max) As ComponentPropertyType
'    Dim CarbonTempo As CarbonPropertyType
'    Dim MCTempo As Integer, NCTempo As Integer
'    Dim TimePTempo As Para_Int
'    Dim Number_Influent_PointsTempo As Integer
'    ReDim C_InfluentTempo(Number_Compo_Max, Number_Max_Influent_Points) As Double
'    ReDim T_InfluentTempo(Number_Max_Influent_Points) As Double
'    Dim NVersion_Temp As Double
'    Dim temp As String
'    ReDim u(5) As String
'
'    Dim TempName As String
''---End declaration
'
'  msg = ""
'  On Error GoTo OpenError
'  f = FreeFile
'  Open Filename For Input As f
'
'  Input #f, NVersion_Temp
'  If (NVersion_Temp = 1#) Then
''-----------------------------------
''-----   Version 1.00 ---------
''-----------------------------------
'    If batchrun <> 1 Then
'     'temp = "Note--this is an Adsorption Simulation Software version 1.00 file."
'     'temp = temp & NL & "If you save this file, it will be saved in version " & Format$(NVersion, "0.00") & " format."
'     'MsgBox temp, MB_ICONEXCLAMATION, Application_Name
'    End If
'
'    Input #f, Number_ComponentTempo
'    For i = 1 To Number_ComponentTempo
'      Call SetComponentDefaults(CompoTempo(i), -1)
'      Input #f, CompoTempo(i).Name, CompoTempo(i).MW, CompoTempo(i).InitialConcentration, CompoTempo(i).MolarVolume, CompoTempo(i).BP, CompoTempo(i).Use_K, CompoTempo(i).Use_OneOverN
'      CompoTempo(i).UserEntered_K = CompoTempo(i).Use_K
'      CompoTempo(i).UserEntered_OneOverN = CompoTempo(i).Use_OneOverN
'      Input #f, CompoTempo(i).SPDFR, CompoTempo(i).SPDFR_Low_Concentration, CompoTempo(i).Use_SPDFR_Correlation
'      Input #f, CompoTempo(i).kf, CompoTempo(i).Ds, CompoTempo(i).Dp, CompoTempo(i).Corr(1), CompoTempo(i).Corr(2), CompoTempo(i).Corr(3)
'      Input #f, CompoTempo(i).KP_User_Input(1), CompoTempo(i).KP_User_Input(2), CompoTempo(i).KP_User_Input(3)
'      Input #f, CompoTempo(i).K_Reduction, CompoTempo(i).Correlation.Name, CompoTempo(i).Correlation.Coeff(1), CompoTempo(i).Correlation.Coeff(2)
'    Next i
'
'    Input #f, BedTempo.Length, BedTempo.Diameter, BedTempo.Weight, BedTempo.Flowrate, BedTempo.WaterDensity, BedTempo.WaterViscosity, BedTempo.Temperature, BedTempo.Pressure, BedTempo.Phase, BedTempo.NumberOfBeds
'    Input #f, BedTempo.Water_Correlation.Name, BedTempo.Water_Correlation.Coeff(1), BedTempo.Water_Correlation.Coeff(2), BedTempo.Water_Correlation.Coeff(3), BedTempo.Water_Correlation.Coeff(4)
'    Input #f, CarbonTempo.Name, CarbonTempo.Porosity, CarbonTempo.Density, CarbonTempo.ParticleRadius, CarbonTempo.tortuosity
'    Input #f, State_Check_WaterT(1), State_Check_WaterT(2)
'    Input #f, Use_Tortuosity_Correlation_Tempo, Constant_Tortuosity_Tempo
'    Input #f, NCTempo, MCTempo
'    Input #f, TimePTempo.Init, TimePTempo.End, TimePTempo.np, TimePTempo.Step
'    Input #f, Number_Influent_PointsTempo
'    If (Number_Influent_PointsTempo > 0) Then
'      For i = 1 To Number_Influent_PointsTempo
'        Input #f, T_InfluentTempo(i)
'        For J = 1 To Number_ComponentTempo
'         Input #f, C_InfluentTempo(J, i)
'        Next J
'      Next i
'    End If
'    On Error GoTo No_Data_Points
'    Input #f, NData_Points, Number_Component
'    On Error GoTo OpenError
'    CarbonTempo.ShapeFactor = 1#
'
'Read_Data_Points_v1_00:
'    If (NData_Points > 0 And Number_Component > 0) Then
'      For i = 1 To NData_Points
'        Input #f, T_Data_Points(i)
'        For J = 1 To Number_Component
'          Input #f, C_Data_Points(J, i)
'        Next J
'      Next i
'    End If
'
'Update_Tortuosities_from_v1_00:
'    For i = 1 To Number_ComponentTempo
'      CompoTempo(i).tortuosity = CarbonTempo.tortuosity
'      CompoTempo(i).Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
'      CompoTempo(i).Constant_Tortuosity = Constant_Tortuosity_Tempo
'    Next i
'
'    Close (f)
'    GoTo Start_Updating
'  End If
'
'  If (NVersion_Temp = 1.2) Then
''-----------------------------------
''-----   Version 1.20 ---------
''-----------------------------------
'    If batchrun <> 1 Then
'     'temp = "Note--this is an Adsorption Simulation Software version 1.20 file."
'     'temp = temp & NL & "If you save this file, it will be saved in version " & Format$(NVersion, "0.00") & " format."
'     'MsgBox temp, MB_ICONEXCLAMATION, Application_Name
'    End If
'
'    Input #f, Number_ComponentTempo
'    For i = 1 To Number_ComponentTempo
'      Call SetComponentDefaults(CompoTempo(i), -1)
'      Input #f, CompoTempo(i).Name, CompoTempo(i).MW, CompoTempo(i).InitialConcentration, CompoTempo(i).MolarVolume, CompoTempo(i).BP, CompoTempo(i).Use_K, CompoTempo(i).Use_OneOverN, CompoTempo(i).Liquid_Density, CompoTempo(i).Aqueous_Solubility, CompoTempo(i).Vapor_Pressure, CompoTempo(i).Refractive_Index
'      Input #f, CompoTempo(i).SPDFR, CompoTempo(i).SPDFR_Low_Concentration, CompoTempo(i).Use_SPDFR_Correlation
'      Input #f, CompoTempo(i).kf, CompoTempo(i).Ds, CompoTempo(i).Dp, CompoTempo(i).Corr(1), CompoTempo(i).Corr(2), CompoTempo(i).Corr(3)
'      Input #f, CompoTempo(i).KP_User_Input(1), CompoTempo(i).KP_User_Input(2), CompoTempo(i).KP_User_Input(3)
'      Input #f, CompoTempo(i).K_Reduction, CompoTempo(i).Correlation.Name, CompoTempo(i).Correlation.Coeff(1), CompoTempo(i).Correlation.Coeff(2)
'      Input #f, CompoTempo(i).IsothermDB_Component_Name, CompoTempo(i).IsothermDB_Range_Num, CompoTempo(i).IPES_OrderOfMagnitude, CompoTempo(i).IPES_NumRegressionPts, CompoTempo(i).IPES_RelativeHumidity, CompoTempo(i).IPES_EstimationMethod, CompoTempo(i).Source_KandOneOverN
'      Input #f, CompoTempo(i).IsothermDB_K, CompoTempo(i).IsothermDB_OneOverN, CompoTempo(i).IPESResult_K, CompoTempo(i).IPESResult_OneOverN, CompoTempo(i).UserEntered_K, CompoTempo(i).UserEntered_OneOverN
'    Next i
'
'    Input #f, BedTempo.Length, BedTempo.Diameter, BedTempo.Weight, BedTempo.Flowrate, BedTempo.WaterDensity, BedTempo.WaterViscosity, BedTempo.Temperature, BedTempo.Pressure, BedTempo.Phase, BedTempo.NumberOfBeds
'    Input #f, BedTempo.Water_Correlation.Name, BedTempo.Water_Correlation.Coeff(1), BedTempo.Water_Correlation.Coeff(2), BedTempo.Water_Correlation.Coeff(3), BedTempo.Water_Correlation.Coeff(4)
'    Input #f, CarbonTempo.Name, CarbonTempo.Porosity, CarbonTempo.Density, CarbonTempo.ParticleRadius, CarbonTempo.tortuosity, CarbonTempo.W0, CarbonTempo.BB, CarbonTempo.PolanyiExponent
'    Input #f, State_Check_WaterT(1), State_Check_WaterT(2)
'    Input #f, Use_Tortuosity_Correlation_Tempo, Constant_Tortuosity_Tempo
'    Input #f, NCTempo, MCTempo
'    Input #f, TimePTempo.Init, TimePTempo.End, TimePTempo.np, TimePTempo.Step
'
'    CarbonTempo.ShapeFactor = 1#
'
'    Input #f, u(1), u(2), u(3), u(4), u(5)
'    Call SetUnits(frmPFPSDM!txtBedUnits(0), u(1))
'    Call SetUnits(frmPFPSDM!txtBedUnits(1), u(2))
'    Call SetUnits(frmPFPSDM!txtBedUnits(2), u(3))
'    Call SetUnits(frmPFPSDM!txtBedUnits(3), u(4))
'    Call SetUnits(frmPFPSDM!txtBedUnits(4), u(5))
'
'    Input #f, u(1), u(2)
'    Call SetUnits(frmPFPSDM!txtCarbonUnits(1), u(1))
'    Call SetUnits(frmPFPSDM!txtCarbonUnits(2), u(2))
'
'    Input #f, PropertyUnits.MW, PropertyUnits.MolarVolume, PropertyUnits.BP, PropertyUnits.InitialConcentration
'    Input #f, PropertyUnits.Liquid_Density, PropertyUnits.Aqueous_Solubility, PropertyUnits.Vapor_Pressure, PropertyUnits.k
'
'    Input #f, Number_Influent_PointsTempo
'    If (Number_Influent_PointsTempo > 0) Then
'      For i = 1 To Number_Influent_PointsTempo
'        Input #f, T_InfluentTempo(i)
'        For J = 1 To Number_ComponentTempo
'         Input #f, C_InfluentTempo(J, i)
'        Next J
'      Next i
'    End If
'    On Error GoTo No_Data_Points
'    Input #f, NData_Points, Number_Component
'    On Error GoTo OpenError
'
'Read_Data_Points_v1_20:
'    If (NData_Points > 0) And (Number_Component > 0) Then
'      For i = 1 To NData_Points
'        Input #f, T_Data_Points(i)
'        For J = 1 To Number_Component
'          Input #f, C_Data_Points(J, i)
'        Next J
'      Next i
'    End If
'
'    Close (f)
'
'Update_Tortuosities_from_v1_20:
'    For i = 1 To Number_ComponentTempo
'      CompoTempo(i).tortuosity = CarbonTempo.tortuosity
'      CompoTempo(i).Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
'      CompoTempo(i).Constant_Tortuosity = Constant_Tortuosity_Tempo
'    Next i
'
'    GoTo Start_Updating
'  End If
'
'  If (NVersion_Temp = 1.3) Then
''-----------------------------------
''-----   Version 1.30 ---------
''-----------------------------------
'    Input #f, Number_ComponentTempo
'    For i = 1 To Number_ComponentTempo
'      Call SetComponentDefaults(CompoTempo(i), -1)
'      '---- Modified by Eric J. Oman 8/8/97 BEGINS:
'      Input #f, TempName, CompoTempo(i).MW, CompoTempo(i).InitialConcentration, CompoTempo(i).MolarVolume, CompoTempo(i).BP, CompoTempo(i).Use_K, CompoTempo(i).Use_OneOverN, CompoTempo(i).Liquid_Density, CompoTempo(i).Aqueous_Solubility, CompoTempo(i).Vapor_Pressure, CompoTempo(i).Refractive_Index
'      If (Right$(Trim$(TempName), 5) = "#$1$#") Then
'        Input #f, CompoTempo(i).CAS
'        CompoTempo(i).Name = Left$(TempName, Len(TempName) - 5)
'      Else
'        CompoTempo(i).Name = TempName
'      End If
'      '---- Modified by Eric J. Oman 8/8/97 ENDS.
'      Input #f, CompoTempo(i).SPDFR, CompoTempo(i).SPDFR_Low_Concentration, CompoTempo(i).Use_SPDFR_Correlation
'      Input #f, CompoTempo(i).kf, CompoTempo(i).Ds, CompoTempo(i).Dp, CompoTempo(i).Corr(1), CompoTempo(i).Corr(2), CompoTempo(i).Corr(3)
'      Input #f, CompoTempo(i).KP_User_Input(1), CompoTempo(i).KP_User_Input(2), CompoTempo(i).KP_User_Input(3)
'      Input #f, CompoTempo(i).K_Reduction, CompoTempo(i).Correlation.Name, CompoTempo(i).Correlation.Coeff(1), CompoTempo(i).Correlation.Coeff(2)
'      Input #f, CompoTempo(i).IsothermDB_Component_Name, CompoTempo(i).IsothermDB_Range_Num, CompoTempo(i).IPES_OrderOfMagnitude, CompoTempo(i).IPES_NumRegressionPts, CompoTempo(i).IPES_RelativeHumidity, CompoTempo(i).IPES_EstimationMethod, CompoTempo(i).Source_KandOneOverN
'      Input #f, CompoTempo(i).IsothermDB_K, CompoTempo(i).IsothermDB_OneOverN, CompoTempo(i).IPESResult_K, CompoTempo(i).IPESResult_OneOverN, CompoTempo(i).UserEntered_K, CompoTempo(i).UserEntered_OneOverN
'      Input #f, CompoTempo(i).tortuosity, CompoTempo(i).Use_Tortuosity_Correlation, CompoTempo(i).Constant_Tortuosity
'    Next i
'
'    Input #f, BedTempo.Length, BedTempo.Diameter, BedTempo.Weight, BedTempo.Flowrate, BedTempo.WaterDensity, BedTempo.WaterViscosity, BedTempo.Temperature, BedTempo.Pressure, BedTempo.Phase, BedTempo.NumberOfBeds
'    Input #f, BedTempo.Water_Correlation.Name, BedTempo.Water_Correlation.Coeff(1), BedTempo.Water_Correlation.Coeff(2), BedTempo.Water_Correlation.Coeff(3), BedTempo.Water_Correlation.Coeff(4)
'    Input #f, CarbonTempo.Name, CarbonTempo.Porosity, CarbonTempo.Density, CarbonTempo.ParticleRadius, CarbonTempo.tortuosity, CarbonTempo.W0, CarbonTempo.BB, CarbonTempo.PolanyiExponent
'    Input #f, State_Check_WaterT(1), State_Check_WaterT(2)
'    Input #f, CarbonTempo.ShapeFactor, Constant_Tortuosity_Tempo       'Constant_Tortuosity_Tempo is Unused!!
'    If (CarbonTempo.ShapeFactor <= 0#) Then
'      CarbonTempo.ShapeFactor = 1#
'    End If
'    Input #f, NCTempo, MCTempo
'    Input #f, TimePTempo.Init, TimePTempo.End, TimePTempo.np, TimePTempo.Step
'
'    Input #f, u(1), u(2), u(3), u(4), u(5)
'    Call SetUnits(frmPFPSDM!txtBedUnits(0), u(1))
'    Call SetUnits(frmPFPSDM!txtBedUnits(1), u(2))
'    Call SetUnits(frmPFPSDM!txtBedUnits(2), u(3))
'    Call SetUnits(frmPFPSDM!txtBedUnits(3), u(4))
'    Call SetUnits(frmPFPSDM!txtBedUnits(4), u(5))
'
'    Input #f, u(1), u(2)
'    Call SetUnits(frmPFPSDM!txtCarbonUnits(1), u(1))
'    Call SetUnits(frmPFPSDM!txtCarbonUnits(2), u(2))
'
'    Input #f, PropertyUnits.MW, PropertyUnits.MolarVolume, PropertyUnits.BP, PropertyUnits.InitialConcentration
'    Input #f, PropertyUnits.Liquid_Density, PropertyUnits.Aqueous_Solubility, PropertyUnits.Vapor_Pressure, PropertyUnits.k
'
'    Input #f, Number_Influent_PointsTempo
'    If (Number_Influent_PointsTempo > 0) Then
'      For i = 1 To Number_Influent_PointsTempo
'        Input #f, T_InfluentTempo(i)
'        For J = 1 To Number_ComponentTempo
'         Input #f, C_InfluentTempo(J, i)
'        Next J
'      Next i
'    End If
'    On Error GoTo No_Data_Points
'    Input #f, NData_Points, Number_Component
'    On Error GoTo OpenError
'
'Read_Data_Points_v_LATEST:
'    If (NData_Points > 0) And (Number_Component > 0) Then
'      For i = 1 To NData_Points
'        Input #f, T_Data_Points(i)
'        For J = 1 To Number_Component
'          Input #f, C_Data_Points(J, i)
'        Next J
'      Next i
'    End If
'
'    Close (f)
'    GoTo Start_Updating
'  Else
'    'MsgBox "This file is not a file for Adsorption Simulation Software Version " & Format$(NVersion, "0.00"), MB_ICONEXCLAMATION, Application_Name
'    MsgBox "This file is not a file for Adsorption Design Software Version " & Format$(NVersion, "0.00"), MB_ICONEXCLAMATION, Application_Name
'    Close (f)
'    GoTo Exit_Open
'  End If
'
'Start_Updating:
'  'Update_All_Data
'  'Store all the read variables in global variables
'  If (Number_ComponentTempo > 0) Then
'    Component_Number_Selected = 1
'  Else
'    Component_Number_Selected = -1
'  End If
'
'  Number_Component = Number_ComponentTempo
'  State_Check_Water(2) = State_Check_WaterT(2)
'  State_Check_Water(1) = State_Check_WaterT(1)
'  'Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
'  'SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
''  Use_Tortuosity_Correlation = Use_Tortuosity_Correlation_Tempo
''  Constant_Tortuosity = Constant_Tortuosity_Tempo
'
'  For i = 1 To Number_Component
'    Component(i) = CompoTempo(i)
'  Next i
'  '========== What the heck does this code do!?!?
'  '- Apparently all it does is cause problems.
'  '- Commented out by ejo, 4/16/96. =================================
''  If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.00") And NVersion_Temp <> 1#) Then
''    If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.20") And NVersion_Temp <> 1.2) Then
''      If (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 0.80")) And (Mid$(VersionST, 1, 45) <> ("Input file for ASS - Windows - Version 1.30") And NVersion_Temp <> 1.3) Then
'  'If (NVersion_Temp <> 1#) Then
'  '  If (NVersion_Temp <> 1.2) Then
'  '    If (NVersion_Temp <> 1.3) Then
'  '      For i = 1 To Number_Component
'  '        Component(i).SPDFR = PSDRTempo
'  '        Component(i).SPDFR_Low_Concentration = SPDFR_Low_Concentration_tempo
'  '        Component(i).Use_SPDFR_Correlation = Use_SPDFR_Correlation_Tempo
'  '      Next i
'  '    End If
'  '  End If
'  'End If
'
'  Carbon = CarbonTempo
'  Bed = BedTempo
'  TimeP = TimePTempo
'
'  NC = NCTempo
'  MC = MCTempo
'  TimeP = TimePTempo
'
'  Number_Influent_Points = Number_Influent_PointsTempo
'  If (Number_Influent_Points > 0) Then
'    For i = 1 To Number_Influent_Points
'      T_Influent(i) = T_InfluentTempo(i)
'      For J = 1 To Number_Component
'        C_Influent(J, i) = C_InfluentTempo(J, i)
'      Next J
'    Next i
'  End If
''Update the display
'  Call Update_Display_Data
'  Call Update_Display_Kinetic
'  Call Update_Bed_Density_Display
'  Call Update_Several_Bed_Properties(3)
'
''------------------------------------------------
'  frmPFPSDM!mnuFileItem(2).Enabled = True
'  frmPFPSDM!mnuFileItem(3).Enabled = True
'  If (Number_Component > 0) Then
'    frmPFPSDM!mnuRunItem(0).Enabled = True
'    frmPFPSDM!mnuRunItem(1).Enabled = True
'    frmPFPSDM!mnuRunItem(2).Enabled = True
'
'    frmPFPSDM!mnuResultsItem(0).Enabled = False
'    frmPFPSDM!mnuResultsItem(1).Enabled = False
'    frmPFPSDM!mnuResultsItem(2).Enabled = False
'    frmPFPSDM!mnuResultsItem(3).Enabled = False
'    frmPFPSDM!mnuResultsItem(4).Enabled = False
'
'    frmPFPSDM!mnuOptionsItem(0).Enabled = True
'    frmPFPSDM!mnuOptionsItem(1).Enabled = True
'    frmPFPSDM!mnuOptionsItem(2).Enabled = True
'  Else
'    frmPFPSDM!mnuRunItem(0).Enabled = False
'    frmPFPSDM!mnuRunItem(1).Enabled = False
'    frmPFPSDM!mnuRunItem(2).Enabled = False
'
'    frmPFPSDM!mnuResultsItem(0).Enabled = False
'    frmPFPSDM!mnuResultsItem(1).Enabled = False
'    frmPFPSDM!mnuResultsItem(2).Enabled = False
'    frmPFPSDM!mnuResultsItem(3).Enabled = False
'    frmPFPSDM!mnuResultsItem(4).Enabled = False
'
'    frmPFPSDM!mnuOptionsItem(0).Enabled = False
'    frmPFPSDM!mnuOptionsItem(1).Enabled = False
'    frmPFPSDM!mnuOptionsItem(2).Enabled = False
'  End If
'  frmPFPSDM.Caption = Application_Name & "  -  " & Trim$(Filename)
'
'  Exit Sub
'
''if file from Version 1.00, NData_Points and Number_Component are not available and set to 0.
'No_Data_Points:
'  NData_Points = 0
'  Number_Component = 0
'  Select Case NVersion_Temp
'    Case 1#
'      Resume Read_Data_Points_v1_00
'    '     .
'    '     .
'    '     .
'    '.... other versions ...
'    '     .
'    '     .
'    '     .
'  End Select
'  Resume Read_Data_Points_v_LATEST
'
'OpenError:
'  MsgBox msg & Chr$(10) & "Error occurred trying to open file, please retry.", MB_ICONEXCLAMATION, Application_Name
'  msg = ""
'  Close (f)
'  Resume Exit_Open
'
'Exit_Open:
'
'End Sub


Attribute VB_Name = "FileIO_Legacy2"
Option Explicit

Const STR_EOF_MARKER = "12345-EOF-MARKER-12345"





Const FileIO_Latest_declarations_end = True


Sub Bed_ProjectFile_Read(f As Integer, _
    be As BedPropertyType)
  Call ProjectFile_Read(f, be.length, "be.Length")
  Call ProjectFile_Read(f, be.Diameter, "be.Diameter")
  Call ProjectFile_Read(f, be.Weight, "be.Weight")
  Call ProjectFile_Read(f, be.Flowrate, "be.Flowrate")
  Call ProjectFile_Read(f, be.WaterDensity, "be.WaterDensity")
  Call ProjectFile_Read(f, be.WaterViscosity, "be.WaterViscosity")
  Call ProjectFile_Read(f, be.Temperature, "be.Temperature")
  Call ProjectFile_Read(f, be.Pressure, "be.Pressure")
  Call ProjectFile_Read(f, be.Phase, "be.Phase")
  Call ProjectFile_Read(f, be.NumberOfBeds, "be.NumberOfBeds")
  Call ProjectFile_Read(f, be.Water_Correlation.Name, "be.Water_Correlation.Name")
  Call ProjectFile_Read(f, be.Water_Correlation.Coeff(1), "be.Water_Correlation.Coeff(1)")
  Call ProjectFile_Read(f, be.Water_Correlation.Coeff(2), "be.Water_Correlation.Coeff(2)")
  Call ProjectFile_Read(f, be.Water_Correlation.Coeff(3), "be.Water_Correlation.Coeff(3)")
  Call ProjectFile_Read(f, be.Water_Correlation.Coeff(4), "be.Water_Correlation.Coeff(4)")
End Sub
Sub Bed_ProjectFile_Write(f As Integer, _
    be As BedPropertyType)
  Call ProjectFile_Write(f, be.length, "be.Length")
  Call ProjectFile_Write(f, be.Diameter, "be.Diameter")
  Call ProjectFile_Write(f, be.Weight, "be.Weight")
  Call ProjectFile_Write(f, be.Flowrate, "be.Flowrate")
  Call ProjectFile_Write(f, be.WaterDensity, "be.WaterDensity")
  Call ProjectFile_Write(f, be.WaterViscosity, "be.WaterViscosity")
  Call ProjectFile_Write(f, be.Temperature, "be.Temperature")
  Call ProjectFile_Write(f, be.Pressure, "be.Pressure")
  Call ProjectFile_Write(f, be.Phase, "be.Phase")
  Call ProjectFile_Write(f, be.NumberOfBeds, "be.NumberOfBeds")
  Call ProjectFile_Write(f, be.Water_Correlation.Name, "be.Water_Correlation.Name")
  Call ProjectFile_Write(f, be.Water_Correlation.Coeff(1), "be.Water_Correlation.Coeff(1)")
  Call ProjectFile_Write(f, be.Water_Correlation.Coeff(2), "be.Water_Correlation.Coeff(2)")
  Call ProjectFile_Write(f, be.Water_Correlation.Coeff(3), "be.Water_Correlation.Coeff(3)")
  Call ProjectFile_Write(f, be.Water_Correlation.Coeff(4), "be.Water_Correlation.Coeff(4)")
End Sub


Sub Component_ProjectFile_Read(f As Integer, _
    co As ComponentPropertyType)
  Call ProjectFile_Read(f, co.Name, "co.Name")
  Call ProjectFile_Read(f, co.CAS, "co.CAS")
  Call ProjectFile_Read(f, co.MW, "co.MW")
  Call ProjectFile_Read(f, co.InitialConcentration, "co.InitialConcentration")
  Call ProjectFile_Read(f, co.MolarVolume, "co.MolarVolume")
  Call ProjectFile_Read(f, co.BP, "co.BP")
  Call ProjectFile_Read(f, co.Use_K, "co.Use_K")
  Call ProjectFile_Read(f, co.Use_OneOverN, "co.Use_OneOverN")
  Call ProjectFile_Read(f, co.Liquid_Density, "co.Liquid_Density")
  Call ProjectFile_Read(f, co.Aqueous_Solubility, "co.Aqueous_Solubility")
  Call ProjectFile_Read(f, co.Vapor_Pressure, "co.Vapor_Pressure")
  Call ProjectFile_Read(f, co.Refractive_Index, "co.Refractive_Index")
  Call ProjectFile_Read(f, co.SPDFR, "co.SPDFR")
  Call ProjectFile_Read(f, co.SPDFR_Low_Concentration, "co.SPDFR_Low_Concentration")
  Call ProjectFile_Read(f, co.Use_SPDFR_Correlation, "co.Use_SPDFR_Correlation")
  Call ProjectFile_Read(f, co.kf, "co.kf")
  Call ProjectFile_Read(f, co.Ds, "co.Ds")
  Call ProjectFile_Read(f, co.Dp, "co.Dp")
  Call ProjectFile_Read(f, co.Corr(1), "co.Corr(1)")
  Call ProjectFile_Read(f, co.Corr(2), "co.Corr(2)")
  Call ProjectFile_Read(f, co.Corr(3), "co.Corr(3)")
  Call ProjectFile_Read(f, co.KP_User_Input(1), "co.KP_User_Input(1)")
  Call ProjectFile_Read(f, co.KP_User_Input(2), "co.KP_User_Input(2)")
  Call ProjectFile_Read(f, co.KP_User_Input(3), "co.KP_User_Input(3)")
  Call ProjectFile_Read(f, co.K_Reduction, "co.K_Reduction")
  Call ProjectFile_Read(f, co.Correlation.Name, "co.Correlation.Name")
  Call ProjectFile_Read(f, co.Correlation.Coeff(1), "co.Correlation.Coeff(1)")
  Call ProjectFile_Read(f, co.Correlation.Coeff(2), "co.Correlation.Coeff(2)")
  Call ProjectFile_Read(f, co.IsothermDB_Component_Name, "co.IsothermDB_Component_Name")
  Call ProjectFile_Read(f, co.IsothermDB_Range_Num, "co.IsothermDB_Range_Num")
  Call ProjectFile_Read(f, co.IPES_OrderOfMagnitude, "co.IPES_OrderOfMagnitude")
  Call ProjectFile_Read(f, co.IPES_NumRegressionPts, "co.IPES_NumRegressionPts")
  Call ProjectFile_Read(f, co.IPES_RelativeHumidity, "co.IPES_RelativeHumidity")
  Call ProjectFile_Read(f, co.IPES_EstimationMethod, "co.IPES_EstimationMethod")
  Call ProjectFile_Read(f, co.Source_KandOneOverN, "co.Source_KandOneOverN")
  Call ProjectFile_Read(f, co.IsothermDB_K, "co.IsothermDB_K")
  Call ProjectFile_Read(f, co.IsothermDB_OneOverN, "co.IsothermDB_OneOverN")
  Call ProjectFile_Read(f, co.IPESResult_K, "co.IPESResult_K")
  Call ProjectFile_Read(f, co.IPESResult_OneOverN, "co.IPESResult_OneOverN")
  Call ProjectFile_Read(f, co.UserEntered_K, "co.UserEntered_K")
  Call ProjectFile_Read(f, co.UserEntered_OneOverN, "co.UserEntered_OneOverN")
  Call ProjectFile_Read(f, co.Tortuosity, "co.tortuosity")
  Call ProjectFile_Read(f, co.Use_Tortuosity_Correlation, "co.Use_Tortuosity_Correlation")
  Call ProjectFile_Read(f, co.Constant_Tortuosity, "co.Constant_Tortuosity")
End Sub
Sub Component_ProjectFile_Write(f As Integer, _
    co As ComponentPropertyType)
  Call ProjectFile_Write(f, co.Name, "co.Name")
  Call ProjectFile_Write(f, co.CAS, "co.CAS")
  Call ProjectFile_Write(f, co.MW, "co.MW")
  Call ProjectFile_Write(f, co.InitialConcentration, "co.InitialConcentration")
  Call ProjectFile_Write(f, co.MolarVolume, "co.MolarVolume")
  Call ProjectFile_Write(f, co.BP, "co.BP")
  Call ProjectFile_Write(f, co.Use_K, "co.Use_K")
  Call ProjectFile_Write(f, co.Use_OneOverN, "co.Use_OneOverN")
  Call ProjectFile_Write(f, co.Liquid_Density, "co.Liquid_Density")
  Call ProjectFile_Write(f, co.Aqueous_Solubility, "co.Aqueous_Solubility")
  Call ProjectFile_Write(f, co.Vapor_Pressure, "co.Vapor_Pressure")
  Call ProjectFile_Write(f, co.Refractive_Index, "co.Refractive_Index")
  Call ProjectFile_Write(f, co.SPDFR, "co.SPDFR")
  Call ProjectFile_Write(f, co.SPDFR_Low_Concentration, "co.SPDFR_Low_Concentration")
  Call ProjectFile_Write(f, co.Use_SPDFR_Correlation, "co.Use_SPDFR_Correlation")
  Call ProjectFile_Write(f, co.kf, "co.kf")
  Call ProjectFile_Write(f, co.Ds, "co.Ds")
  Call ProjectFile_Write(f, co.Dp, "co.Dp")
  Call ProjectFile_Write(f, co.Corr(1), "co.Corr(1)")
  Call ProjectFile_Write(f, co.Corr(2), "co.Corr(2)")
  Call ProjectFile_Write(f, co.Corr(3), "co.Corr(3)")
  Call ProjectFile_Write(f, co.KP_User_Input(1), "co.KP_User_Input(1)")
  Call ProjectFile_Write(f, co.KP_User_Input(2), "co.KP_User_Input(2)")
  Call ProjectFile_Write(f, co.KP_User_Input(3), "co.KP_User_Input(3)")
  Call ProjectFile_Write(f, co.K_Reduction, "co.K_Reduction")
  Call ProjectFile_Write(f, co.Correlation.Name, "co.Correlation.Name")
  Call ProjectFile_Write(f, co.Correlation.Coeff(1), "co.Correlation.Coeff(1)")
  Call ProjectFile_Write(f, co.Correlation.Coeff(2), "co.Correlation.Coeff(2)")
  Call ProjectFile_Write(f, co.IsothermDB_Component_Name, "co.IsothermDB_Component_Name")
  Call ProjectFile_Write(f, co.IsothermDB_Range_Num, "co.IsothermDB_Range_Num")
  Call ProjectFile_Write(f, co.IPES_OrderOfMagnitude, "co.IPES_OrderOfMagnitude")
  Call ProjectFile_Write(f, co.IPES_NumRegressionPts, "co.IPES_NumRegressionPts")
  Call ProjectFile_Write(f, co.IPES_RelativeHumidity, "co.IPES_RelativeHumidity")
  Call ProjectFile_Write(f, co.IPES_EstimationMethod, "co.IPES_EstimationMethod")
  Call ProjectFile_Write(f, co.Source_KandOneOverN, "co.Source_KandOneOverN")
  Call ProjectFile_Write(f, co.IsothermDB_K, "co.IsothermDB_K")
  Call ProjectFile_Write(f, co.IsothermDB_OneOverN, "co.IsothermDB_OneOverN")
  Call ProjectFile_Write(f, co.IPESResult_K, "co.IPESResult_K")
  Call ProjectFile_Write(f, co.IPESResult_OneOverN, "co.IPESResult_OneOverN")
  Call ProjectFile_Write(f, co.UserEntered_K, "co.UserEntered_K")
  Call ProjectFile_Write(f, co.UserEntered_OneOverN, "co.UserEntered_OneOverN")
  Call ProjectFile_Write(f, co.Tortuosity, "co.tortuosity")
  Call ProjectFile_Write(f, co.Use_Tortuosity_Correlation, "co.Use_Tortuosity_Correlation")
  Call ProjectFile_Write(f, co.Constant_Tortuosity, "co.Constant_Tortuosity")
End Sub


'RETURNS:
'- true = open went okay.
'- false = open failed.
''''Function File_Open_Latest_v1_40(f As Integer) As Boolean
Function File_Open_Legacy_v1_40(f As Integer) As Boolean
Dim i As Integer
Dim J As Integer
Dim Test_STR_EOF_MARKER As String
  Call ProjectFile_Read(f, FileNote, "FileNote")
  Call ProjectFile_Read(f, Number_Component, "Number_Component")
  For i = 1 To Number_Component
    Call Component_ProjectFile_Read(f, Component(i))
  Next i
  Call Bed_ProjectFile_Read(f, Bed)
  Call UnitsOfDisplay_ProjectFile_Read(f)
  'MISCELLANEOUS BLOCK.
  Call ProjectFile_Read(f, Carbon.Name, "Carbon.Name")
  Call ProjectFile_Read(f, Carbon.Porosity, "Carbon.Porosity")
  Call ProjectFile_Read(f, Carbon.Density, "Carbon.Density")
  Call ProjectFile_Read(f, Carbon.ParticleRadius, "Carbon.ParticleRadius")
  Call ProjectFile_Read(f, Carbon.Tortuosity, "Carbon.tortuosity")
  Call ProjectFile_Read(f, Carbon.W0, "Carbon.W0")
  Call ProjectFile_Read(f, Carbon.BB, "Carbon.BB")
  Call ProjectFile_Read(f, Carbon.PolanyiExponent, "Carbon.PolanyiExponent")
  Call ProjectFile_Read(f, State_Check_Water(1), "State_Check_Water(1)")
  Call ProjectFile_Read(f, State_Check_Water(2), "State_Check_Water(2)")
  Call ProjectFile_Read(f, Carbon.ShapeFactor, "Carbon.ShapeFactor")
  Call ProjectFile_Read(f, Constant_Tortuosity, "Constant_Tortuosity")
  Call ProjectFile_Read(f, Carbon.ShapeFactor, "Carbon.ShapeFactor")
  Call ProjectFile_Read(f, NC, "NC")
  Call ProjectFile_Read(f, MC, "MC")
  Call ProjectFile_Read(f, TimeP.Init, "TimeP.Init")
  Call ProjectFile_Read(f, TimeP.End, "TimeP.End")
  Call ProjectFile_Read(f, TimeP.np, "TimeP.np")
  Call ProjectFile_Read(f, TimeP.Step, "TimeP.Step")
  'INFLUENT POINTS.
  Call ProjectFile_Read(f, Number_Influent_Points, "Number_Influent_Points")
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      Input #f, T_Influent(i)
      For J = 1 To Number_Component
        Input #f, C_Influent(J, i)
      Next J
    Next i
  End If
  'EFFLUENT POINTS.
  Call ProjectFile_Read(f, NData_Points, "NData_Points")
  If (NData_Points > 0) Then
    For i = 1 To NData_Points
      Input #f, T_Data_Points(i)
      For J = 1 To Number_Component
        Input #f, C_Data_Points(J, i)
      Next J
    Next i
  End If
  Call ProjectFile_Read(f, Test_STR_EOF_MARKER, "STR_EOF_MARKER")
  If (Test_STR_EOF_MARKER <> STR_EOF_MARKER) Then
    Call Show_Error("This file has an invalid file format.")
    File_Open_Legacy_v1_40 = False
  Else
    File_Open_Legacy_v1_40 = True
  End If
End Function
Sub File_Save_Legacy_v1_40(f As Integer)
Dim i As Integer
Dim J As Integer
  Print #f, 1.4
  Call ProjectFile_Write(f, FileNote, "FileNote")
  Call ProjectFile_Write(f, Number_Component, "Number_Component")
  For i = 1 To Number_Component
    Call Component_ProjectFile_Write(f, Component(i))
  Next i
  Call Bed_ProjectFile_Write(f, Bed)
  Call UnitsOfDisplay_ProjectFile_Write(f)
  'MISCELLANEOUS BLOCK.
  Call ProjectFile_Write(f, Carbon.Name, "Carbon.Name")
  Call ProjectFile_Write(f, Carbon.Porosity, "Carbon.Porosity")
  Call ProjectFile_Write(f, Carbon.Density, "Carbon.Density")
  Call ProjectFile_Write(f, Carbon.ParticleRadius, "Carbon.ParticleRadius")
  Call ProjectFile_Write(f, Carbon.Tortuosity, "Carbon.tortuosity")
  Call ProjectFile_Write(f, Carbon.W0, "Carbon.W0")
  Call ProjectFile_Write(f, Carbon.BB, "Carbon.BB")
  Call ProjectFile_Write(f, Carbon.PolanyiExponent, "Carbon.PolanyiExponent")
  Call ProjectFile_Write(f, State_Check_Water(1), "State_Check_Water(1)")
  Call ProjectFile_Write(f, State_Check_Water(2), "State_Check_Water(2)")
  Call ProjectFile_Write(f, Carbon.ShapeFactor, "Carbon.ShapeFactor")
  Call ProjectFile_Write(f, Constant_Tortuosity, "Constant_Tortuosity")
  Call ProjectFile_Write(f, Carbon.ShapeFactor, "Carbon.ShapeFactor")
  Call ProjectFile_Write(f, NC, "NC")
  Call ProjectFile_Write(f, MC, "MC")
  Call ProjectFile_Write(f, TimeP.Init, "TimeP.Init")
  Call ProjectFile_Write(f, TimeP.End, "TimeP.End")
  Call ProjectFile_Write(f, TimeP.np, "TimeP.np")
  Call ProjectFile_Write(f, TimeP.Step, "TimeP.Step")
  'INFLUENT POINTS.
  Call ProjectFile_Write(f, Number_Influent_Points, "Number_Influent_Points")
  If (Number_Influent_Points > 0) Then
    For i = 1 To Number_Influent_Points
      Write #f, T_Influent(i)
      For J = 1 To Number_Component
        Write #f, C_Influent(J, i)
      Next J
    Next i
  End If
  'EFFLUENT POINTS.
  Call ProjectFile_Write(f, NData_Points, "NData_Points")
  If (NData_Points > 0) Then
    For i = 1 To NData_Points
      Write #f, T_Data_Points(i)
      For J = 1 To Number_Component
        Write #f, C_Data_Points(J, i)
      Next J
    Next i
  End If
  Call ProjectFile_Write(f, STR_EOF_MARKER, "STR_EOF_MARKER")
End Sub


Sub Units1_ProjectFile_Read(f As Integer, CboX As Control, Desc As String)
Dim TxtX As Control
Dim InLine As String
Dim Dummy1 As String
Dim NewUnits As String
Dim H As Integer
  Call ProjectFile_Read(f, InLine, Dummy1)
  NewUnits = InLine
  H = unitsys_lookup_cbox(CboX)
  Set TxtX = unitsys(H).TxtX
  Call unitsys_set_units(TxtX, NewUnits)
End Sub
Sub Units1_ProjectFile_Write(f As Integer, CboX As Control, Desc As String)
Dim OutStr As String
  If (CboX.ListIndex >= 0) Then
    OutStr = CboX.List(CboX.ListIndex)
  Else
    If (CboX.ListCount > 0) Then
      OutStr = CboX.List(0)
    Else
      OutStr = ""     'NOT LIKELY TO GET HERE!
    End If
  End If
  Call ProjectFile_Write(f, OutStr, Desc)
End Sub


Sub UnitsOfDisplay_ProjectFile_Read(f As Integer)
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(0), "frmMain.txtBedUnits(0)")
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(1), "frmMain.txtBedUnits(1)")
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(2), "frmMain.txtBedUnits(2)")
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(3), "frmMain.txtBedUnits(3)")
  Call Units1_ProjectFile_Read(f, frmMain.txtBedUnits(4), "frmMain.txtBedUnits(4)")
  Call Units1_ProjectFile_Read(f, frmMain.txtCarbonUnits(1), "frmMain.txtCarbonUnits(1)")
  Call Units1_ProjectFile_Read(f, frmMain.txtCarbonUnits(2), "frmMain.txtCarbonUnits(2)")
  Call Units1_ProjectFile_Read(f, frmMain.txtTimeUnits(0), "frmMain.txtTimeUnits(0)")
  Call Units1_ProjectFile_Read(f, frmMain.txtTimeUnits(1), "frmMain.txtTimeUnits(1)")
  Call Units1_ProjectFile_Read(f, frmMain.txtTimeUnits(2), "frmMain.txtTimeUnits(2)")
  Call ProjectFile_Read(f, PropertyUnits.MW, "PropertyUnits.MW")
  Call ProjectFile_Read(f, PropertyUnits.MolarVolume, "PropertyUnits.MolarVolume")
  Call ProjectFile_Read(f, PropertyUnits.BP, "PropertyUnits.BP")
  Call ProjectFile_Read(f, PropertyUnits.InitialConcentration, "PropertyUnits.InitialConcentration")
  Call ProjectFile_Read(f, PropertyUnits.Liquid_Density, "PropertyUnits.Liquid_Density")
  Call ProjectFile_Read(f, PropertyUnits.Aqueous_Solubility, "PropertyUnits.Aqueous_Solubility")
  Call ProjectFile_Read(f, PropertyUnits.Vapor_Pressure, "PropertyUnits.Vapor_Pressure")
  Call ProjectFile_Read(f, PropertyUnits.k, "PropertyUnits.k")
End Sub
Sub UnitsOfDisplay_ProjectFile_Write(f As Integer)
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(0), "frmMain.txtBedUnits(0)")
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(1), "frmMain.txtBedUnits(1)")
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(2), "frmMain.txtBedUnits(2)")
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(3), "frmMain.txtBedUnits(3)")
  Call Units1_ProjectFile_Write(f, frmMain.txtBedUnits(4), "frmMain.txtBedUnits(4)")
  Call Units1_ProjectFile_Write(f, frmMain.txtCarbonUnits(1), "frmMain.txtCarbonUnits(1)")
  Call Units1_ProjectFile_Write(f, frmMain.txtCarbonUnits(2), "frmMain.txtCarbonUnits(2)")
  Call Units1_ProjectFile_Write(f, frmMain.txtTimeUnits(0), "frmMain.txtTimeUnits(0)")
  Call Units1_ProjectFile_Write(f, frmMain.txtTimeUnits(1), "frmMain.txtTimeUnits(1)")
  Call Units1_ProjectFile_Write(f, frmMain.txtTimeUnits(2), "frmMain.txtTimeUnits(2)")
  Call ProjectFile_Write(f, PropertyUnits.MW, "PropertyUnits.MW")
  Call ProjectFile_Write(f, PropertyUnits.MolarVolume, "PropertyUnits.MolarVolume")
  Call ProjectFile_Write(f, PropertyUnits.BP, "PropertyUnits.BP")
  Call ProjectFile_Write(f, PropertyUnits.InitialConcentration, "PropertyUnits.InitialConcentration")
  Call ProjectFile_Write(f, PropertyUnits.Liquid_Density, "PropertyUnits.Liquid_Density")
  Call ProjectFile_Write(f, PropertyUnits.Aqueous_Solubility, "PropertyUnits.Aqueous_Solubility")
  Call ProjectFile_Write(f, PropertyUnits.Vapor_Pressure, "PropertyUnits.Vapor_Pressure")
  Call ProjectFile_Write(f, PropertyUnits.k, "PropertyUnits.k")
End Sub



Attribute VB_Name = "FortranLink"
Option Explicit

Global FortranLink_Path As String
Global FortranLink_fn_MainInput As String
Global FortranLink_fn_MainOutput As String
'Global FortranLink_fn_FlowTimes As String
Global FortranLink_fn_FlowTimesInput As String
Global FortranLink_fn_BedDef() As String
Global FortranLink_fn_VarInf() As String
Global FortranLink_Version As String
Global FortranLink_fn_VarEff() As String
Global FortranLink_fn_MiscEff() As String
Global FortranLink_fn_Paths As String
Global FortranLink_EffluentStream_Count As Integer
Global FortranLink_fn_ErrorOutput As String


'- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
'      SHELL EXECUTION PROCESS -- BEGINS --
'- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

Private Type STARTUPINFO
  cb As Long
  lpReserved As String
  lpDesktop As String
  lpTitle As String
  dwX As Long
  dwY As Long
  dwXSize As Long
  dwYSize As Long
  dwXCountChars As Long
  dwYCountChars As Long
  dwFillAttribute As Long
  dwFlags As Long
  wShowWindow As Integer
  cbReserved2 As Integer
  lpReserved2 As Long
  hStdInput As Long
  hStdOutput As Long
  hStdError As Long
End Type

Private Type PROCESS_INFORMATION
  hProcess As Long
  hThread As Long
  dwProcessID As Long
  dwThreadID As Long
End Type


Private Const NORMAL_PRIORITY_CLASS = &H20&
Private Const INFINITE = -1&
Private Declare Function CloseHandle Lib "kernel32" (ByVal hObject As Long) As Long
Private Declare Function WaitForSingleObject Lib "kernel32" (ByVal _
        hHandle As Long, ByVal dwMilliseconds As Long) As Long
Private Declare Function CreateProcessA Lib "kernel32" (ByVal _
        lpApplicationName As Long, ByVal lpCommandLine As String, ByVal _
        lpProcessAttributes As Long, ByVal lpThreadAttributes As Long, _
        ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, _
        ByVal lpEnvironment As Long, ByVal lpCurrentDirectory As Long, _
        lpStartupInfo As STARTUPINFO, lpProcessInformation As _
        PROCESS_INFORMATION) As Long

'- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
'      SHELL EXECUTION PROCESS -- ENDS --
'- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


'Global FortranLink_fn_MainInput As String
'Global FortranLink_fn_MainOutput As String
'Global FortranLink_Components_Count As Integer
'Global FortranLink_fn_Components() As String
'Global FortranLink_fn_pH As String



Const FortranLink_declarations_end = 0


Public Sub FortranLink_ExecAndWaitForProcess(cmdline$)
Dim proc As PROCESS_INFORMATION
Dim start As STARTUPINFO
Dim ret&
  ' Initialize the STARTUPINFO structure:
  start.cb = Len(start)
  ' Start the shelled application:
  ret& = CreateProcessA(0&, cmdline$, 0&, 0&, 1&, _
     NORMAL_PRIORITY_CLASS, 0&, 0&, start, proc)
  ' Wait for the shelled application to finish:
  ret& = WaitForSingleObject(proc.hProcess, INFINITE)
  ret& = CloseHandle(proc.hProcess)
End Sub


Sub WriteFortranInput(f As Integer, v As Variant, s As String)
Dim outputstr$
Dim outlin As String
  Select Case VarType(v)
    Case vbBoolean
      outputstr$ = IIf(v, "1", "0")
    Case vbByte, vbInteger, vbLong, vbCurrency
      outputstr$ = Trim$(CStr(v))
    Case vbSingle, vbDouble
      outputstr$ = Trim$(CStr(v))
    Case vbString, vbDate
      'outputstr$ = CStr(v)
      outputstr$ = Chr$(34) & CStr(v) & Chr$(34)
    Case vbObject
      MsgBox "WriteFortranInput vbObject not implemented"
      GoTo EXIT_FALSE_VALUE
    Case vbError
      MsgBox "WriteFortranInput vbError not implemented"
      GoTo EXIT_FALSE_VALUE
    Case vbDataObject
      MsgBox "WriteFortranInput vbDataObject not implemented"
      GoTo EXIT_FALSE_VALUE
    Case vbVariant
      MsgBox "WriteFortranInput vbVariant not implemented"
      GoTo EXIT_FALSE_VALUE
    Case vbArray
      MsgBox "WriteFortranInput vbArray not implemented"
      GoTo EXIT_FALSE_VALUE
    Case vbEmpty
      MsgBox "WriteFortranInput vbEmpty not implemented"
      GoTo EXIT_FALSE_VALUE
    Case vbNull
      MsgBox "WriteFortranInput vbNull not implemented"
      GoTo EXIT_FALSE_VALUE
  End Select
  outlin = Trim$(outputstr$)
  If (Len(outlin) > 27) Then
    outlin = outlin & "    "
  Else
    Do While (1 = 1)
      If (Len(outlin) >= 27) Then Exit Do
      outlin = outlin & " "
    Loop
  End If
  outlin = outlin & s
  Print #f, outlin
  GoTo EXIT_OK
EXIT_FALSE_VALUE:
  Print #f, "   - - - ERROR IN WriteFortranInput() - - -"
  Exit Sub
EXIT_OK:
  Exit Sub
End Sub


'Sub FortranLink_SetFilenames()
'Dim i As Integer
'  'SET FILENAMES.
'  FortranLink_Path = AppPath & "\SIMS\" & NowProj.code
'  FortranLink_fn_MainInput = FortranLink_Path & "\catreac_main.in"
'  FortranLink_fn_MainOutput = FortranLink_Path & "\catreac_main.out"
'  FortranLink_fn_ErrorOutput = FortranLink_Path & "\catreac_nflag.out"
'  FortranLink_fn_FlowTimesInput = FortranLink_Path & "\catreac_flowtimes.in"
'  'ReDim FortranLink_fn_BedDef(1 To NowProj.BedDefs_Count)
'  'For i = 1 To NowProj.BedDefs_Count
'  '  FortranLink_fn_BedDef(i) = FortranLink_Path & "\catreac_bed" & Trim$(Str$(i)) & ".in"
'  'Next i
'  'ReDim FortranLink_fn_VarInf(1 To NowInfluentConc_Count)
'  'For i = 1 To NowInfluentConc_Count
'  '  FortranLink_fn_VarInf(i) = FortranLink_Path & "\catreac_varinf" & Trim$(Str$(i)) & ".in"
'  'Next i
'  FortranLink_Version = "1.00"
'  'ReDim FortranLink_fn_VarEff(1 To FortranLink_EffluentStream_Count)
'  'ReDim FortranLink_fn_MiscEff(1 To FortranLink_EffluentStream_Count)
'  'For i = 1 To FortranLink_EffluentStream_Count
'  '  FortranLink_fn_VarEff(i) = FortranLink_Path & "\catreac_vareff" & Trim$(Str$(i)) & ".out"
'  '  FortranLink_fn_VarEff(i) = FortranLink_Path & "\catreac_misceff" & Trim$(Str$(i)) & ".out"
'  'Next i
'  FortranLink_fn_Paths = AppPath & "\catpath.txt"
'End Sub


'Sub FortranLink_WritePathFile()
'Dim f As Integer
'Dim fn_PathFile As String
'Dim qq As String
'  'SET FILENAMES.
'  Call FortranLink_SetFilenames
'  'OUTPUT FILENAME OF MAIN INPUTS.
'  fn_PathFile = FortranLink_fn_Paths
'  f = FreeFile
'  Open fn_PathFile For Output As #f
'  qq = Chr$(34)
'  Print #f, qq & Trim$(FortranLink_fn_MainInput) & qq
'  Close #f
'End Sub


Attribute VB_Name = "INIFILES"
Option Explicit

Declare Function GetPrivateProfileString Lib "kernel32" Alias "GetPrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpDefault As String, ByVal lpReturnedString As String, ByVal nSize As Long, ByVal lpFileName As String) As Long
Declare Function GetPrivateProfileInt Lib "kernel32" Alias "GetPrivateProfileIntA" (ByVal lpApplicationName As String, ByVal lpKeyName As String, ByVal nDefault As Long, ByVal lpFileName As String) As Long
Declare Function GetSystemDirectory Lib "kernel32" Alias "GetSystemDirectoryA" (ByVal lpBuffer As String, ByVal nSize As Long) As Long
Declare Function GetWindowsDirectory Lib "kernel32" Alias "GetWindowsDirectoryA" (ByVal lpBuffer As String, ByVal nSize As Long) As Long
Declare Function WritePrivateProfileString Lib "kernel32" Alias "WritePrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpString As Any, ByVal lpFileName As String) As Long

Global fn_OldFileList As String           'full name including path
Global Const fn_INI_name = "ADS.INI"     'non-full name NOT including Windows path

  'OldFiles(i,j):
  '     i = menu code
  '     j = file within that menu (file 1,2,3, or 4, where
  '         file 1 is the most recently accessed file)
Global OldFiles(1 To 5, 1 To 4) As String





Const INIFILES_declarations_end = 0


Function GetWindowsDir() As String
Dim Value As Integer
Dim storage As String * 144
  Value = GetWindowsDirectory(ByVal storage, ByVal Len(storage))
  GetWindowsDir = Trim$(Left$(storage, Value))
End Function


Function GetWindowsTempDir() As String
Dim retstr As String
  retstr = Trim$(Environ$("TEMP"))
  If (retstr = "") Then retstr = Trim$(Environ$("TMP"))
  'IF NEITHER THE TEMP OR TMP ENVIRONMENT VARIABLES EXIST
  'THEN WE USE THE WINDOWS DIRECTORY AS THE TEMPORARY
  'FILE PATH.
  If (retstr = "") Then
    retstr = Trim$(GetWindowsDir())
  End If
  If (Right$(retstr, 1) = "\") Then
    'REMOVE TRAILING BACKSLASH.
    retstr = Left$(retstr, Len(retstr) - 1)
  End If
  GetWindowsTempDir = retstr
End Function


Sub ini_putsetting0(fn_ini As String, ini_header As String, INI_VarName As String, ini_newsetting As String)
Dim lpApplicationName As String
Dim lpKeyName As String
Dim lpString As String
Dim lpFileName As String
Dim valid As Integer
  lpApplicationName = ini_header
  lpKeyName = INI_VarName
  lpString = ini_newsetting
  lpFileName = fn_ini
  valid = WritePrivateProfileString(ByVal lpApplicationName, ByVal lpKeyName, ByVal lpString, ByVal lpFileName)
End Sub
Sub INI_PutSetting(INI_VarName As String, NewSetting As String)
  Call ini_putsetting0(fn_OldFileList, _
      "UserSettings", INI_VarName, NewSetting)
End Sub


Function INI_GetSetting00(fn_ini As String, ini_header As String, INI_VarName As String) As String
  INI_GetSetting00 = INI_GetSetting0(fn_ini, ini_header, INI_VarName)
End Function
Function INI_GetSetting0(fn_ini As String, ini_header As String, INI_VarName As String) As String
Dim lpApplicationName As String
Dim lpKeyName As String
Dim lpszDefault As String
Dim lpReturnedString As String * 200
Dim nSize As Integer
Dim lpFileName As String

Dim BytesCopied As Integer
Dim temp As String

  lpApplicationName = ini_header
  lpKeyName = INI_VarName
  lpszDefault = ""
  lpReturnedString = ""
  nSize = Len(lpReturnedString)
  lpFileName = fn_ini

  BytesCopied = GetPrivateProfileString(ByVal lpApplicationName, ByVal lpKeyName, ByVal lpszDefault, ByVal lpReturnedString, ByVal nSize, ByVal lpFileName)
  temp = Left$(Trim$(lpReturnedString), BytesCopied)
  INI_GetSetting0 = temp

End Function
Function INI_Getsetting(INI_VarName As String) As String
  INI_Getsetting = _
      INI_GetSetting0(fn_OldFileList, "UserSettings", INI_VarName)
End Function


Sub OldFileList_Populate( _
    num_menu As Integer, _
    menu0 As Menu, _
    menu1 As Menu, menu2 As Menu, _
    menu3 As Menu, menu4 As Menu)
  OldFiles(num_menu, 1) = INI_GetSetting0(fn_OldFileList, "old_files", _
      "old_file(" & Trim$(Str$(num_menu)) & ",1)")
  OldFiles(num_menu, 2) = INI_GetSetting0(fn_OldFileList, "old_files", _
      "old_file(" & Trim$(Str$(num_menu)) & ",2)")
  OldFiles(num_menu, 3) = INI_GetSetting0(fn_OldFileList, "old_files", _
      "old_file(" & Trim$(Str$(num_menu)) & ",3)")
  OldFiles(num_menu, 4) = INI_GetSetting0(fn_OldFileList, "old_files", _
      "old_file(" & Trim$(Str$(num_menu)) & ",4)")
  Call OldFileList_UpdateMenu(num_menu, menu0, menu1, menu2, menu3, menu4)
End Sub
Sub OldFileList_Promote( _
    fn_newfile As String, _
    num_menu As Integer, _
    menu0 As Menu, menu1 As Menu, menu2 As Menu, _
    menu3 As Menu, menu4 As Menu)
Dim i As Integer
Dim Found As Integer
  'IF NOT IN CURRENT LIST, SHIFT 1-3 DOWN TO 2-4 AND REPLACE 1.
  'IF IN CURRENT LIST, SAVE, SHIFT OTHERS DOWN, AND MOVE TO 1.
  fn_newfile = LCase$(fn_newfile)
  Found = -1
  For i = 1 To 4
    If (Trim$(LCase$(fn_newfile)) = Trim$(LCase$(OldFiles(num_menu, i)))) Then
      Found = i
      Exit For
    End If
  Next i
  If (Found = -1) Then
    For i = 4 To 2 Step -1
      OldFiles(num_menu, i) = OldFiles(num_menu, i - 1)
    Next i
    OldFiles(num_menu, 1) = fn_newfile
  Else
    For i = Found To 2 Step -1
      OldFiles(num_menu, i) = OldFiles(num_menu, i - 1)
    Next i
    OldFiles(num_menu, 1) = fn_newfile
  End If
  'UPDATE MENU:
  Call OldFileList_UpdateMenu(num_menu, menu0, menu1, menu2, menu3, menu4)
  'UPDATE INI FILE:
  For i = 1 To 4
    Call ini_putsetting0(fn_OldFileList, _
        "old_files", _
        "old_file(" & Trim$(Str$(num_menu)) & "," & Trim$(Str$(i)) & ")", _
        OldFiles(num_menu, i))
  Next i
End Sub
Sub OldFileList_UpdateMenu(num_menu As Integer, _
    menu0 As Menu, _
    menu1 As Menu, menu2 As Menu, _
    menu3 As Menu, menu4 As Menu)
Dim found_at_least_one As Integer
Dim i As Integer
Dim mnu As Menu
  found_at_least_one = False
  For i = 1 To 4
    If (i = 1) Then Set mnu = menu1
    If (i = 2) Then Set mnu = menu2
    If (i = 3) Then Set mnu = menu3
    If (i = 4) Then Set mnu = menu4
    If (OldFiles(num_menu, i) <> "") Then
      found_at_least_one = True
      mnu.Caption = "&" & Trim$(Str$(i)) & " - " & OldFiles(num_menu, i)
      mnu.Visible = True
    Else
      mnu.Visible = False
    End If
  Next i
  If (Not found_at_least_one) Then
    menu0.Visible = False
  Else
    menu0.Visible = True
  End If
End Sub
Attribute VB_Name = "LaunchFileVia"
Option Explicit

Global Const OSTYPE_WIN95 = 1
Global Const OSTYPE_WINNT = 2

Global Const LAUNCHFILEVIA_IS_DEBUG_MODE_ON = False






Const LaunchFileVia_declarations_end = True


'RETURNS:
'    TRUE = SUCCEEDED.
'    FALSE = FAILED.
Function LaunchFileViaStartMethod_0( _
    fn_Dir As String, _
    fn_File As String, _
    OSTYPE As Integer) As Boolean
Dim RetVal As Integer
Dim CmdLine As String
    
  On Error GoTo err_LaunchFileViaStartMethod_0
  
  If (Trim$(fn_Dir) <> "") Then
    ChDir Trim$(fn_Dir)
  End If
  Select Case OSTYPE
    Case OSTYPE_WIN95:
      CmdLine = "command.com /c start " & Trim$(fn_File)
    Case OSTYPE_WINNT:
      CmdLine = "cmd /c start " & Trim$(fn_File)
  End Select
  If (LAUNCHFILEVIA_IS_DEBUG_MODE_ON) Then
    MsgBox "CmdLine = `" & CmdLine & "`"
  End If
  RetVal = 0 * Shell(CmdLine, 1)
  
  LaunchFileViaStartMethod_0 = True
  Exit Function
    
exit_err_LaunchFileViaStartMethod_0:
  LaunchFileViaStartMethod_0 = False
  Exit Function
err_LaunchFileViaStartMethod_0:
  Resume exit_err_LaunchFileViaStartMethod_0
End Function


'RETURNS:
'    TRUE = SUCCEEDED.
'    FALSE = FAILED.
Function LaunchFileViaExecMethod( _
    fn_Dir As String, _
    fn_File As String) As Boolean
Dim RetVal As Integer
Dim CmdLine As String
    
  On Error GoTo err_LaunchFileViaExecMethod
  
  If (Trim$(fn_Dir) <> "") Then
    ChDir Trim$(fn_Dir)
    On Error Resume Next
    ChDrive Trim$(fn_Dir)
    On Error GoTo err_LaunchFileViaExecMethod
  End If
  CmdLine = Trim$(fn_File)
  If (LAUNCHFILEVIA_IS_DEBUG_MODE_ON) Then
    MsgBox "CmdLine = `" & CmdLine & "`"
  End If
  'CmdLine = Dir("*.exe")
  
  RetVal = 0 * Shell(CmdLine, 1)
  
  LaunchFileViaExecMethod = True
  Exit Function
    
exit_err_LaunchFileViaExecMethod:
  LaunchFileViaExecMethod = False
  Exit Function
err_LaunchFileViaExecMethod:
  Resume exit_err_LaunchFileViaExecMethod
End Function


'RETURNS:
'    TRUE = SUCCEEDED.
'    FALSE = FAILED.
Function LaunchFileViaStartMethod( _
    fn_Dir As String, _
    fn_File As String) As Boolean
Dim RetValBool As Boolean
  RetValBool = LaunchFileViaStartMethod_0( _
      Trim$(fn_Dir), _
      Trim$(fn_File), _
      OSTYPE_WINNT)
  If (Not RetValBool) Then
    RetValBool = LaunchFileViaStartMethod_0( _
        Trim$(fn_Dir), _
        Trim$(fn_File), _
        OSTYPE_WIN95)
  End If
  LaunchFileViaStartMethod = RetValBool
End Function


'RETURNS:
'    TRUE = SUCCEEDED.
'    FALSE = FAILED.
Function LaunchFile_General( _
    fn_Dir As String, _
    fn_File As String) As Boolean
Dim RetValBool As Boolean
  If (Right$(Trim$(UCase$(fn_File)), 4) = ".EXE") Or _
      (Right$(Trim$(UCase$(fn_File)), 4) = ".COM") Or _
      (Right$(Trim$(UCase$(fn_File)), 4) = ".BAT") Then
    RetValBool = LaunchFileViaExecMethod(fn_Dir, fn_File)
  Else
    RetValBool = LaunchFileViaStartMethod(fn_Dir, fn_File)
  End If
  LaunchFile_General = RetValBool
End Function




Attribute VB_Name = "LicData"
Option Explicit

Global Const AppProgramKey = "ADS"
Global Const AppCopyrightYears = "1995-1998"
Global Const AppName = "AdDesignS"
Global AppWillExpire As Integer     'true/false
Global AppExpireYear As Integer
Global AppExpireMonth As Integer
Global AppExpireDay As Integer
Global Global_fpath_dir_CPAS As String


'Global Const LICFILE_GetInfoProgram = "MTCHK.EXE"
Global Const LICFILE_GetInfoProgram = "CPASCHK.EXE"
Global Const LICFILE_GetInfoProgramParams = "-GET_INFO"

'Global Const LICFILE_LicName = "ETDOT10.LIC"
Global Const LICFILE_LicName = "CPAS.LIC"
'Global Const LICFILE_NewLicInfo = "MTNEWLIC.X"
'Global Const LICFILE_GoodSerialNumber = "OKNUM.X"
'Global Const LICFILE_BadSerialNumber = "BADNUM.X"
Global Const LICFILE_GoodLicenseFile = "GO.X"
Global Const LICFILE_BadLicenseFile = "EXIT.X"

Type LicFile_Data_Type
  'Z_PROGRAMKEY_ADS As String
  'Z_PROGRAMKEY_ASAP As String
  'Z_PROGRAMKEY_STEPP As String
  Z_SERIALNUMBER As String
  Z_USERNAME As String
  Z_USERCOMPANY As String
  Z_PROGRAMKEY As String
  Z_EXPIRATIONDATE As String
  Z_RELEASETYPE As String
  Z_VERSIONCODE As String
  Z_VERSIONTYPE As String
  'ZZ_LASTEXECUTIONDATE As String
  'ZZ_LASTEXECUTIONTIME As String
End Type
Global lfd As LicFile_Data_Type

Function get_expiration_info() As String
  Select Case Trim$(UCase$(lfd.Z_VERSIONTYPE))
    Case Trim$(UCase$("VER_INTERNAL_STUDENT")):
      get_expiration_info = "No Expiration Date (Student Copy)"
    Case Trim$(UCase$("VER_WONT_EXPIRE")):
      get_expiration_info = "No Expiration Date (Professional Copy)"
    Case Else:
      get_expiration_info = "Expires on " & Trim$(Str$(AppExpireMonth)) & "/" & Trim$(Str$(AppExpireDay)) & "/" & Trim$(Str$(AppExpireYear))
  End Select
End Function

Function get_program_version_with_build_info() As String
Dim ver As String
Dim capped As String
  capped = LCase$(Trim$(lfd.Z_RELEASETYPE))
  If (Len(capped) >= 1) Then
    Mid$(capped, 1, 1) = UCase$(Mid$(capped, 1, 1))
  End If
  ver = lfd.Z_VERSIONCODE & " (" & capped & ")"
  'ver = ver & Trim$(App.Major) & "."
  'ver = ver & Trim$(App.Minor) & "."
  'ver = ver & Trim$(App.Revision)
  get_program_version_with_build_info = ver
End Function

Sub LicFileData_Read(return_fpath_dir_CPAS As String)
Dim WinDir As String
Dim fn_CPASCHK As String
Dim CmdLine As String
Dim time_start As Double
Dim fn_GoodLicenseFile As String
Dim fn_BadLicenseFile As String
Dim time_elapsed As Double
Dim f As Integer
Dim RetVal As Integer
Dim copy_z_expirationdate As String
Dim temp As String
Dim fn_CPASDIR_INI As String
Dim fpath_dir_CPAS As String

  'GET CPAS DIRECTORY NAME.
  fn_CPASDIR_INI = App.Path & "\CPASDIR.INI"
  If (Not FileExists(fn_CPASDIR_INI)) Then
    'UNABLE TO READ LICENSE FILE DATA.
    GoTo err_Cant_Read_Licensing_Data
  End If
  temp = Trim$(INI_GetSetting00(fn_CPASDIR_INI, "Directory", "CPASDIR"))
  fpath_dir_CPAS = temp
  return_fpath_dir_CPAS = temp

  'CHECK ON LICENSE FILE.
  WinDir = GetWindowsDir()
  'fn_MTCHK = WinDir & "\" & LICFILE_GetInfoProgram
  fn_CPASCHK = fpath_dir_CPAS & "\DBASE\" & LICFILE_GetInfoProgram
  If (FileExists(fn_CPASCHK)) Then
    'THAT'S OKAY.
  Else
    'UNABLE TO READ LICENSE FILE DATA.
    GoTo err_Cant_Read_Licensing_Data
  End If
  CmdLine = fn_CPASCHK & " " & LICFILE_GetInfoProgramParams
  CmdLine = CmdLine & " " & fpath_dir_CPAS
  CmdLine = CmdLine & " " & AppProgramKey
  'fn_GoodLicenseFile = WinDir & "\" & LICFILE_GoodLicenseFile
  'fn_BadLicenseFile = WinDir & "\" & LICFILE_BadLicenseFile
  fn_GoodLicenseFile = fpath_dir_CPAS & "\DBASE\" & LICFILE_GoodLicenseFile
  fn_BadLicenseFile = fpath_dir_CPAS & "\DBASE\" & LICFILE_BadLicenseFile
  time_start = Timer
  RetVal = 0 * Shell(CmdLine, 1)
  Do While (1 = 1)
    DoEvents
    If (FileExists(fn_GoodLicenseFile)) Then
      'Kill fn_GoodLicenseFile    'DELETED BELOW.
      DoEvents
      Exit Do
    End If
    If (FileExists(fn_BadLicenseFile)) Then
      Kill fn_BadLicenseFile
      DoEvents
      End
    End If
    time_elapsed = Timer - time_start
    If (time_elapsed > 10#) Then
      'UNABLE TO READ LICENSE FILE DATA.
      GoTo err_Cant_Read_Licensing_Data
    End If
  Loop

  'READ IN LICENSE FILE INFO.
  f = FreeFile
  Open fn_GoodLicenseFile For Input As #f
  Line Input #f, lfd.Z_SERIALNUMBER
  Line Input #f, lfd.Z_USERNAME
  Line Input #f, lfd.Z_USERCOMPANY
  Line Input #f, lfd.Z_PROGRAMKEY
  Line Input #f, lfd.Z_EXPIRATIONDATE
  Line Input #f, lfd.Z_RELEASETYPE
  Line Input #f, lfd.Z_VERSIONCODE
  Line Input #f, lfd.Z_VERSIONTYPE
  Close #f
  Kill fn_GoodLicenseFile
  
  Select Case Trim$(UCase$(lfd.Z_VERSIONTYPE))
    Case Trim$(UCase$("VER_INTERNAL_STUDENT")):
      AppWillExpire = False
    Case Trim$(UCase$("VER_WONT_EXPIRE")):
      AppWillExpire = False
    Case Else:
      AppWillExpire = True
      copy_z_expirationdate = Trim$(UCase$(lfd.Z_EXPIRATIONDATE))
      copy_z_expirationdate = Parser_RemoveCharacters(" ", copy_z_expirationdate)
      If (Parser_GetNumArgs(",", copy_z_expirationdate) = 3) Then
        Call Parser_GetArg(",", copy_z_expirationdate, 1, temp)
        AppExpireMonth = CInt(Val(temp))
        Call Parser_GetArg(",", copy_z_expirationdate, 2, temp)
        AppExpireDay = CInt(Val(temp))
        Call Parser_GetArg(",", copy_z_expirationdate, 3, temp)
        AppExpireYear = CInt(Val(temp))
      End If
  End Select
  
  Exit Sub

err_Cant_Read_Licensing_Data:
  MsgBox "Unable to read licensing data.  You may need to re-install the software.", 48, AppName
  End
End Sub

Sub Parser_GetArg(sepchar As String, InLine As String, ArgNum As Integer, retstr As String)
Dim i As Integer
Dim J As Integer
  retstr = ""
  J = 1
  For i = 1 To Len(InLine)
    If (Mid$(InLine, i, 1) = sepchar) Then
      J = J + 1
      If (J > ArgNum) Then Exit For
    Else
      If (J = ArgNum) Then
        retstr = retstr + Mid$(InLine, i, 1)
      End If
    End If
  Next i
End Sub

Function Parser_GetNumArgs(sepchar As String, InLine As String) As Integer
Dim NumArgs As Integer
Dim i As Integer
  NumArgs = 1     'between chr #1 and first separator char.
  For i = 1 To Len(InLine)
    If (Mid$(InLine, i, 1) = sepchar) Then
      NumArgs = NumArgs + 1
    End If
  Next i
  Parser_GetNumArgs = NumArgs
End Function

Function Parser_RemoveCharacters(remove_char As String, InLine As String) As String
Dim retstr As String
Dim i As Integer
Dim ok_append As Integer
Dim thisc As String
  retstr = ""
  For i = 1 To Len(InLine)
    ok_append = True
    thisc = Mid$(InLine, i, 1)
    If (thisc = remove_char) Then ok_append = False
    If (ok_append) Then
      retstr = retstr & thisc
    End If
  Next i
  Parser_RemoveCharacters = retstr
End Function

Function Parser_RemoveDuplicateSeparators(sepchar As String, InLine As String) As String
Dim retstr As String
Dim i As Integer
Dim ok_append As Integer
Dim thisc As String
  retstr = ""
  For i = 1 To Len(InLine)
    ok_append = True
    thisc = Mid$(InLine, i, 1)
    If (i > 1) Then
      If (thisc = sepchar) Then
        If (Right$(retstr, 1) = sepchar) Then
          ok_append = False
        End If
      End If
    End If
    If (ok_append) Then
      retstr = retstr & thisc
    End If
  Next i
  Parser_RemoveDuplicateSeparators = retstr
End Function

'NOTE: THERE IS NO RECURSION CHECKER!  IT IS POSSIBLE
'TO SEND THIS ROUTINE INTO AN INFINITE LOOP WITH
'POORLY CHOSEN PARAMETERS.
Function Parser_ReplaceStrings( _
    InputStr As String, _
    OldStr As String, _
    NewStr As String) As String
'Dim Instr_Result As String
Dim Instr_Result As Integer
Dim WorkingStr As String
Dim Part1 As String
Dim Part2 As String
  WorkingStr = InputStr
  
''temp
'Open "c:\test.out" For Output As #1
'Dim i As Integer
'For i = 1 To Len(WorkingStr)
'  Print #1, Asc(Mid$(WorkingStr, i, 1))
'Next i
'Close #1
'  MsgBox WorkingStr
  
  Do While (1 = 1)
    Instr_Result = InStr(WorkingStr, OldStr)
    If (Instr_Result = 0) Then
      Exit Do
    End If
    If (Instr_Result > 1) Then
      Part1 = Left$(WorkingStr, Instr_Result - 1)
    End If
    If (Instr_Result < Len(WorkingStr) - Len(OldStr) + 1) Then
      Part2 = Right$(WorkingStr, Len(WorkingStr) - Instr_Result - Len(OldStr) + 1)
    End If
    WorkingStr = Part1 & NewStr & Part2
'123456789012
'testingXXout           12-2+1=11       12-8-2+1=3
'testingXXo             10-2+1=9        10-8-2+1=1
'testingXX              9-2+1=8         9-8-2+1=0
'-----------------------------------------------------
'12345678901
'testingXout            12-2+1=11       11-8-1+1=3
'testingXo              10-2+1=9        9-8-1+1=1
'testingX               9-2+1=8         8-8-1+1=0
  Loop
  
'Open "c:\test.out" For Output As #1
'For i = 1 To Len(WorkingStr)
'  Print #1, Asc(Mid$(WorkingStr, i, 1))
'Next i
'Close #1
  
  Parser_ReplaceStrings = WorkingStr
End Function



Attribute VB_Name = "MainProgram"
Option Explicit

'GLOBAL CONSTANTS -- APPLICATION RELATED.
Global Const AppCopyright = "Michigan Technological University, 1995-98"
Global Const AppRegisteredUser = ""
Global Const AppRegisteredCompany = ""
Global Const AppRegisteredSerial = ""

Global MAIN_APP_PATH As String


'splash_mode: 0 = Continue/Exit window
'             1 = I Agree/I agree, never show again/Exit window
Global splash_mode As Integer

'splash_button_pressed:
'1 = Continue or I Agree
'2 = I agree, never show again
'3 = Exit
Global splash_button_pressed As Integer






Const MainProgram_declarations_end = 0


Function get_program_version_with_build_info_VB4() As String
Dim ver As String
  ver = ver & Trim$(App.Major) & "."
  ver = ver & Trim$(App.Minor) & "."
  ver = ver & Trim$(App.Revision)
  get_program_version_with_build_info_VB4 = ver
End Function


Function frmSplash_Run() As Integer
Dim tpath$
Dim tstr$
Dim must_read_disclaimer As Integer
Dim msg As String

  '''SET UP INI FILE PATH.
  ''tpath$ = GetWindowsDir() & ProgramIniFile$
  
  'SHOW THE CONTINUE/EXIT FRONT WINDOW.
  splash_mode = 0
  splash_button_pressed = 0
  On Error GoTo err_frmSplash_Run
'Error 5
  frmSplash.Show 1
  Select Case splash_button_pressed
    Case 1:         'Hit Continue
      'DO NOTHING.
    Case 3:         'Hit Exit
      End
  End Select
    
  'IS THE DISCLAIMER WINDOW STILL ACTIVE?
  must_read_disclaimer = True
  ''tstr$ = INI_GetSetting0(fn_INI_path, "disclaimer", "has_read_disclaimer")
  tstr$ = INI_GetSetting0(fn_OldFileList, "disclaimer", "has_read_disclaimer")
  'tstr$ = ini_getsetting("has_seen_disclaimer")
  If (tstr$ = "1") Then
    must_read_disclaimer = False
  End If
  
  If (must_read_disclaimer) Then
    'SHOW THE DISCLAIMER WINDOW.
    splash_mode = 1
    splash_button_pressed = 0
    frmSplash.Show 1
    Select Case splash_button_pressed
      Case 1:         'Hit I Agree
        'DO NOTHING.
      Case 2:         'Hit I agree, never show again
        ''Call ini_putsetting0(fn_INI_path, "disclaimer", "has_read_disclaimer", "1")
        Call ini_putsetting0(fn_OldFileList, "disclaimer", "has_read_disclaimer", "1")
        'Call ini_putsetting("has_seen_disclaimer", "1")
      Case 3:         'Hit Exit
        End
    End Select
  End If

  frmSplash_Run = True
  Exit Function
  
exit_err_frmSplash_Run:
  Call Show_Error("Halting due to an error.")
  End
err_frmSplash_Run:
  msg = "Detected an error.  " & _
      "Err.Number = " & Trim$(Str$(Err.number)) & "; " & _
      "Err.Source = `" & Err.Source & "`.  Now halting program."
  Call Show_Message(msg)
  Resume exit_err_frmSplash_Run
End Function


Sub ChangeDir_Exes()
  ChDrive MAIN_APP_PATH
  ChDir MAIN_APP_PATH & "\EXES"
End Sub
Sub ChangeDir_Main()
  ChDrive MAIN_APP_PATH
  ChDir MAIN_APP_PATH
End Sub


Sub Main()
Dim fn_misc1 As String
Dim LicFileLocation As Integer
Dim fpath_INI As String
Dim msg As String
Dim fn_Test As String

  'SET UP MAIN APP PATH VARIABLE.
  If (File_IsExists(App.Path & "\debug_in_vb6.txt")) Then
    'FOR DEBUGGING IN THE VB5 ENVIRONMENT.
    MAIN_APP_PATH = "X:\etdot10\code\ads\vb6"
    ChDrive MAIN_APP_PATH
    ChDir MAIN_APP_PATH
  Else
    'DO NOTHING.
    MAIN_APP_PATH = App.Path
  End If
  
  'VERIFY THAT PATHS ARE PROPERLY SET UP.
  fn_misc1 = App.Path & "\dbase\misc1.dat"
  If (File_IsExists(fn_misc1)) Then
    'DO NOTHING; THIS IS OKAY.
  Else
    Call Show_Error("The file `" & fn_misc1 & "` is missing.  " & _
        "Therefore the software must have been improperly installed.  " & _
        "Recommendation: Check the `Start In` path specified in the " & _
        "program icon, or else perform a re-install of the software.")
    End
  End If
  fn_Test = MAIN_APP_PATH & "\dbase\template.dat"
  If (File_IsExists(fn_Test)) Then
    'DO NOTHING; THIS IS OKAY.
  Else
    Call Show_Error("The file `" & fn_Test & "` is missing.  " & _
        "Therefore the software must have been improperly installed.  " & _
        "Recommendation: Check the `Start In` path specified in the " & _
        "program icon, or else perform a re-install of the software.")
    End
  End If
  
  'READ IN THE LICENSE FILE DATA.
  Call LicFileData_Read(Global_fpath_dir_CPAS)
  fpath_INI = Global_fpath_dir_CPAS & "\DBASE"
  ''READ IN THE LICENSE FILE DATA.
  'Call LicFileData_Read(LicFileLocation)
  'Select Case LicFileLocation
  '  Case LICFILELOCATION_WIN:
  '    fpath_INI = GetWindowsDir()
  '  Case LICFILELOCATION_APPPATH:
  '    fpath_INI = App.Path
  'End Select

  On Error GoTo err_main

  ''ENSURE THAT CODE REALIZES IT NEEDS TO CREATE A NEW PROJECT.
  'NowProj_exists = False
  
'app
  'OPEN WORKSPACE TO HOLD DATABASES, STORE DATABASE NAMES.
  Set Ws1 = Workspaces(0)
  fn_DB_dir = App.Path & "\dbase"
  Database_Path = fn_DB_dir
  fn_DB_Isotherm = fn_DB_dir & "\isotherm.mdb"
  fn_DB_Carbon = fn_DB_dir & "\carbon.mdb"
  Exe_Path = App.Path & "\exes"
    'TODOTODO: Add checks to verify that each of these
    'databases is available for exclusive use
    'by this program.
  
  'SET UP INI FILENAME FOR DISCLAIMER CHECK.
  fn_OldFileList = fpath_INI & "\" & fn_INI_name

''TEMPORARILY: DO NOT LOAD frmSplash.
'If (1 = 0) Then
  'LOAD THE SPLASH WINDOW.
  If (frmSplash_Run() = False) Then
    End
  End If
'End If
  
  'INITIALIZE THE UNIT STRUCTURES.
  Call unitsys_initialize
  
  'LAUNCH THE MAIN WINDOW.
  frmMain.Show
  Exit Sub

exit_err_main:
  Call Show_Error("Halting due to an error.")
  End
err_main:
  msg = "Detected an error in main().  " & _
      "Err.Number = " & Trim$(Str$(Err.number)) & "; " & _
      "Err.Source = `" & Err.Source & "`.  Now halting program."
  Call Show_Message(msg)
  Resume exit_err_main
End Sub


Sub debug_output(s As String)
Dim f As Integer
  f = FreeFile
  Open "c:\bug.txt" For Append As #f
  Write #f, "ADS", Date$ & " " & Time$ & " -- " & s
  Close #f
End Sub


'Returns:
'TRUE = The program is internal to MTU, thus show the hidden menu
'FALSE = The program is distributed, hide the menu
Function check_internal_to_mtu() As Integer
Dim file_1_not_found As Integer
Dim file_2_not_found As Integer
Dim is_internal_to_mtu As Integer

  On Error GoTo err_check_internal_to_mtu1
  file_1_not_found = True
  If (Dir("c:\a_aaaaaa\internal.txt") <> "") Then file_1_not_found = False
  
res_err_check_internal_to_mtu1:
  On Error GoTo err_check_internal_to_mtu1
  file_2_not_found = True
  'If (Dir("g:\a_aaaaaa\internal.txt") <> "") Then file_2_not_found = False
  'NOTE: Scanning the G: drive on some computers causes a
  '"hanging" problem so this scan was removed.  EJO, 1/6/98.

res_err_check_internal_to_mtu2:
  is_internal_to_mtu = True
  If (file_1_not_found) And (file_2_not_found) Then
    is_internal_to_mtu = False
  End If
  check_internal_to_mtu = is_internal_to_mtu
  Exit Function

err_check_internal_to_mtu1:
  file_1_not_found = True
  Resume res_err_check_internal_to_mtu1

err_check_internal_to_mtu2:
  file_2_not_found = True
  Resume res_err_check_internal_to_mtu2

End Function

Attribute VB_Name = "MDB_Stuff"
Option Explicit

Global ws1 As Workspace
Global fn_DB_dir As String
Global fn_DB_Isotherm As String
Global fn_DB_Carbon As String

'
'DATABASE PASSWORD LISTED BELOW.  AS A DIFFERENCE FROM
'THE WAY AdDesignS WORKED UNDER MS VB 3.0,
'NO USER NAME IS REQUIRED, ONLY A PASSWORD.
'
'NOTE: FOR SOME #$(*&@#$*# ANNOYING REASON, ONCE A
'PASSWORD IS SUPPLIED FOR A DATABASE TO BE ACCESSED
'FROM VISUAL BASIC 5 (IN THE WAY THIS PROGRAM ACCESSES
'THE DATABASES), IT CANNOT BE DIRECTLY ACCESS FROM
'MICROSOFT ACCESS USING THE SAME PASSWORD IF THE PASSWORD
'WAS 14 CHARACTERS LONG (OR MAYBE JUST THIS EXAMPLE).
'USING THE NEW 9 CHARACTER PASSWORD WORKS EQUALLY
'WELL IN VB 5.0 AND MS ACCESS 8.0.
'              Eric J. Oman
'              9/21/98
'
''Global Const User_Password = "frieda4wisc836"
'Global Const Encrypted_User_Password = "AeJ>;2atJh8m^g"
'Global Const User_Password = "frieda836"
Global Const Encrypted_User_Password = "AeJ>;2m^g"
''Global Const User_Name = "victor t. hart"
'Global Const Encrypted_User_Name = "qJ8k\e%kO%G2ek"






Const MDB_Stuff_declarations_end = True


Function Database_Get_String(rs As Recordset, fn As String) As String
Dim v As Variant
  v = rs(fn)
  If (IsNull(v)) Then
    Database_Get_String = ""
  Else
    Database_Get_String = Trim$(v)
  End If
End Function
Function Database_Get_Double(rs As Recordset, fn As String) As Double
Dim v As Variant
  v = rs(fn)
  If (IsNull(v)) Then
    Database_Get_Double = 0#
  Else
    Database_Get_Double = CDbl(v)
  End If
End Function
Function Database_Get_Integer(rs As Recordset, fn As String) As Integer
Dim v As Variant
  v = rs(fn)
  If (IsNull(v)) Then
    Database_Get_Integer = 0
  Else
    Database_Get_Integer = CInt(v)
  End If
End Function
Function Database_Get_Long(rs As Recordset, fn As String) As Long
Dim v As Variant
  v = rs(fn)
  If (IsNull(v)) Then
    Database_Get_Long = 0
  Else
    Database_Get_Long = CLng(v)
  End If
End Function


Function GetNewPrimaryKey0( _
    db_SourceData As Database, _
    tn As String, _
    fn As String) As Long
Dim criteria As String
Dim RS1 As Recordset
Dim keys() As Long
Dim i As Integer
Dim J As Long
Dim keys_count As Integer
Dim Found As Boolean

  'LOAD ALL PRIMARY KEYS INTO MEMORY.
  criteria = "select " & fn & " from [" & tn & "]"
  Set RS1 = _
      db_SourceData.OpenRecordset(criteria)
  RS1.MoveFirst
  RS1.MoveLast
  RS1.MoveFirst
  keys_count = RS1.RecordCount
  ReDim keys(1 To keys_count)
  i = 0
  Do Until RS1.EOF
    i = i + 1
    keys(i) = Database_Get_Long(RS1, fn)
    RS1.MoveNext
  Loop
  RS1.Close
  J = 1
  Do While (1 = 1)
    Found = False
    For i = 1 To keys_count
      If (keys(i) = J) Then
        Found = True
        Exit For
      End If
    Next i
    If (Not Found) Then
      Exit Do
    End If
    J = J + 1
  Loop
  GetNewPrimaryKey0 = J
End Function


Function decrypt_string(password As String) As String
Dim newpass$
Dim keyval%, i%, length%
ReDim Key(100) As Integer
  For i% = 32 To 122
    keyval% = ((i% * 3) Mod 91)
    Key(keyval%) = i%
  Next i%
  length% = Len(password)
  newpass$ = ""
  For i% = 1 To length%
    newpass$ = newpass$ + Chr$(Key(Asc(Mid$(password, i%, 1)) - 32))
  Next i%
  decrypt_string = newpass$
End Function


Function Database_IsTableExist( _
    Db1 As Database, _
    TableName As String) As Boolean
Dim RS1 As Recordset
  On Error GoTo err_Database_IsTableExist
  Set RS1 = Db1.OpenRecordset(TableName)
  Database_IsTableExist = True
  RS1.Close
exit_err_Database_IsTableExist:
  Exit Function
err_Database_IsTableExist:
  Database_IsTableExist = False
  Resume exit_err_Database_IsTableExist
End Function


Function Database_NoRecordsInRecordset( _
    RS1 As Recordset) As Boolean
  On Error GoTo err_Database_NoRecordsInRecordset
  RS1.MoveFirst
  RS1.MoveLast
  RS1.MoveFirst
  Database_NoRecordsInRecordset = False
  Exit Function
exit_err_Database_NoRecordsInRecordset:
  Database_NoRecordsInRecordset = True
  Exit Function
err_Database_NoRecordsInRecordset:
  'ERROR OCCURRED, THEREFORE THERE MUST NOT BE ANY
  'VALID RECORDS WITHIN THIS RECORDSET.
  Resume exit_err_Database_NoRecordsInRecordset
End Function



Attribute VB_Name = "MiscUI"
Option Explicit




Const MiscUI_declarations_end = True


Sub CalcStatus_Set(newVal As Boolean)
  If (newVal) Then
    Call GenericStatus_Set("Calculating -- please wait.")
  Else
    Call GenericStatus_Set("")
  End If
End Sub
Sub GenericStatus_Set(fn_Text As String)
  frmMain.sspanel_Status = fn_Text
End Sub
Sub DirtyStatus_Set(newVal As Boolean)
  If (newVal) Then
    frmMain.sspanel_Dirty = "Data Changed"
    frmMain.sspanel_Dirty.ForeColor = QBColor(12)
  Else
    frmMain.sspanel_Dirty = "Unchanged"
    frmMain.sspanel_Dirty.ForeColor = QBColor(0)
  End If
End Sub
Sub DirtyStatus_Set_Current()
  Call DirtyStatus_Set(Project_Is_Dirty)
End Sub
Sub DirtyStatus_Throw()
  Project_Is_Dirty = True
  Call DirtyStatus_Set_Current
End Sub


Sub frmMain_Close_All_Windows()
Dim ifc%
Dim i%
  On Error Resume Next
  ifc% = Forms.Count - 1
  For i% = ifc% To 0 Step -1
    'If (Forms(i%).name <> "frmMain") And _
       (Forms(i%).name <> "frmProgress") Then
    If (Forms(i%).Name <> "frmMain") Then
      Unload Forms(i%)
    End If
  Next i%
End Sub


Sub CenterOnScreen(frm_to_center As Form)
  frm_to_center.Left = (Screen.Width - frm_to_center.Width) / 2
  frm_to_center.Top = (Screen.Height - frm_to_center.Height) / 2
End Sub
Sub CenterOnForm(frm_to_center As Form, frm As Form)
  frm_to_center.Left = frm.Left + (frm.Width - frm_to_center.Width) / 2
  frm_to_center.Top = frm.Top + (frm.Height - frm_to_center.Height) / 2
End Sub


Sub Show_Message00(msg As String, flags As Integer, WinTitle As String)
  MsgBox msg, flags, WinTitle
End Sub
Sub Show_Message0(msg As String, flags As Integer)
  Call Show_Message00(msg, vbInformation, App.Title)
End Sub
Sub Show_Message(msg As String)
  Call Show_Message0(msg, vbInformation)
End Sub
Sub Show_Error(msg As String)
  Beep
  Call Show_Message0(msg, vbExclamation)
End Sub
Sub Show_Trapped_Error(subname As String)
  Call Show_Error("An error #" & Trim$(Str$(Err)) & _
      " has occurred in routine " & Trim$(subname) & _
      ": `" & Trim$(Error$) & "`.  Ending this operation.")
End Sub


Sub Launch_Notepad(fn_edit As String)
Dim CmdLine As String
Dim RetVal As Integer
  CmdLine = "notepad " & fn_edit
  RetVal = 0 * Shell(CmdLine, 3)
End Sub

Attribute VB_Name = "ModelCPHSDM"
Option Explicit

Const ModelCPHSDM_IN_PathFile = "CPHSDM1.IN"
Const ModelCPHSDM_IN_Main = "CPHSDM2.IN"
Const ModelCPHSDM_OUT_SuccessFlag = "CPHSDM1.OUT"
Const ModelCPHSDM_OUT_Main = "CPHSDM2.OUT"

Const ModelCPHSDM_Version = 1#
Const ModelCPHSDM_ExeName = "CPHSDM2.EXE"
Const ModelCPHSDM_EofTestMarker = 123456#

'Const ModelCPHSDM_NMAX = 1
Private Type ModelCPHSDM_Inputs_Type
  Bed(1 To 6) As Double
  Compo(1 To 4) As Double
  Kine(1 To 2) As Double
End Type
Dim ModelCPHSDM_Inputs As ModelCPHSDM_Inputs_Type
Private Type ModelCPHSDM_Outputs_Type
  TACT(1 To 210) As Double
  CC(1 To 210) As Double
  PARAM(1 To 7) As Double
  ER_FLAG As Integer
End Type
Dim ModelCPHSDM_Outputs As ModelCPHSDM_Outputs_Type




Const ModelCPHSDM_declarations_end = True


Sub ModelCPHSDM_Go()
  Call ModelCPHSDM_WritePathFile
  Call ModelCPHSDM_WriteMainFile
  Call ModelCPHSDM_CallEXE
  Call ModelCPHSDM_ProcessOutput
  If (ModelIO_IsKeepTempFiles() = False) Then
    Call ModelCPHSDM_RemoveLinkFiles
  End If
End Sub


Sub ModelCPHSDM_RemoveLinkFiles()
  Call KillFile_If_Exists(Exe_Path & "\" & ModelCPHSDM_IN_PathFile)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelCPHSDM_IN_Main)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelCPHSDM_OUT_SuccessFlag)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelCPHSDM_OUT_Main)
End Sub
Sub ModelCPHSDM_CallEXE()
Dim CmdLine As String
  Call ChangeDir_Exes
  CmdLine = ModelCPHSDM_ExeName
  Call ModelIO_Timer_Start
  Call FortranLink_ExecAndWaitForProcess(CmdLine)
  Call ModelIO_Timer_End
  Call ChangeDir_Main
End Sub
Sub ModelCPHSDM_ProcessOutput()
Dim f As Integer
Dim fn_This As String
Dim ER_FLAG As Integer
Dim DummyStr1 As String
Dim temp As String
Dim i As Integer
Dim J As Integer
Dim MO As ModelCPHSDM_Outputs_Type
Dim EOFTESTMARKER As Double
Dim Flag05 As Boolean
Dim Flag50 As Boolean
Dim Flag95 As Boolean
  'READ SUCCESS FLAG OUTPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelCPHSDM_OUT_SuccessFlag
  If (Not FileExists(fn_This)) Then
    Call Show_Error("Unable to find output file: Calculations failed.")
    Exit Sub
  End If
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, ER_FLAG
  Close #f
  If (ER_FLAG <> 0) Then
    Select Case ER_FLAG
      Case 40
        temp = "The value of 1/n is out of range for St minimum."
      Case 41
        temp = "The value of 1/n is out of range for St minimum."
      Case 42
        temp = "The value of the Biot number is out of range."
      Case 44
        temp = "The value of 1/n is out of range."
      Case Else
        temp = "Unknown Error."
    End Select
    Call Show_Error("The CPHSDM failed to converge." & vbCrLf & temp)
    Exit Sub
  Else
    Call Show_Message( _
        "CPHSDM Model Calculations Complete." & _
        vbCrLf & _
        vbCrLf & _
        ModelIO_Timer_SummaryMsg)
  End If
  'READ MAIN OUTPUT FILE.
  fn_This = Exe_Path & "\" & ModelCPHSDM_OUT_Main
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  For i = 1 To 210
    Input #f, MO.TACT(i)
  Next i
  Line Input #f, DummyStr1
  For i = 1 To 210
    Input #f, MO.CC(i)
  Next i
  Line Input #f, DummyStr1
  For i = 1 To 7
    Input #f, MO.PARAM(i)
  Next i
  Line Input #f, DummyStr1
  Input #f, EOFTESTMARKER
  If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelCPHSDM_EofTestMarker)) Then
    Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
    Exit Sub
  End If
  Close #f
  ModelCPHSDM_Outputs = MO
  'TRANSFER OUTPUT DATA TO MORE PERMANENT MEMORY.
  For i = 1 To CPM_Max_Points
    CPM_Results.T(i) = MO.TACT(i)           'TACT(I) is in days
    CPM_Results.C_Over_C0(i) = MO.CC(i)     'CC(I) is dimensionless
  Next i
  For i = 1 To 7
    CPM_Results.Par(i) = MO.PARAM(i)
  Next i
  ' Description of CPM_Results.Par
  ' 1 -> Minimum Stanton number
  ' 2 -> Minimum EBCT (min)
  ' 3 -> Minimum Length (cm)
  ' 4 -> Throughput Ratio at 95%
  ' 5 -> Throughput Ratio at 5%
  ' 6 -> EBCT of MTZ (min)
  ' 7 -> Length of MTZ (cm)
  CPM_Results.Bed = Bed
  CPM_Results.Carbon = Carbon
  CPM_Results.Component = Component(Component_Index_CPM)
  ''''CPM_Results.Constant_Tortuosity = Constant_Tortuosity
  ''''CPM_Results.Use_Tortuosity_Correlation = Use_Tortuosity_Correlation
  Flag05 = True
  Flag50 = True
  Flag95 = True
  For J = 1 To CPM_Max_Points
    If (J > 2) Then
      If (MO.CC(J) >= 0.05) And (MO.CC(J - 1) < 0.05) And Flag05 Then
        CPM_Results.ThroughPut_05.T = (MO.TACT(J) - MO.TACT(J - 1)) / _
            (MO.CC(J) - MO.CC(J - 1)) * (0.05 - MO.CC(J - 1)) + MO.TACT(J - 1)
        CPM_Results.ThroughPut_05.C = ((MO.CC(J) - MO.CC(J - 1)) / _
            (MO.TACT(J) - MO.TACT(J - 1)) * _
            (CPM_Results.ThroughPut_05.T - MO.TACT(J - 1)) + MO.CC(J - 1)) * _
            CPM_Results.Component.InitialConcentration
        Flag05 = False
      End If
      If (MO.CC(J) >= 0.5) And (MO.CC(J - 1) < 0.5) And Flag50 Then
        CPM_Results.ThroughPut_50.T = (MO.TACT(J) - MO.TACT(J - 1)) / _
            (MO.CC(J) - MO.CC(J - 1)) * (0.5 - MO.CC(J - 1)) + MO.TACT(J - 1)
        CPM_Results.ThroughPut_50.C = ((MO.CC(J) - MO.CC(J - 1)) / _
            (MO.TACT(J) - MO.TACT(J - 1)) * _
            (CPM_Results.ThroughPut_50.T - MO.TACT(J - 1)) + MO.CC(J - 1)) * _
            CPM_Results.Component.InitialConcentration
        Flag50 = False
      End If
      If (MO.CC(J) >= 0.95) And (MO.CC(J - 1) < 0.95) And Flag95 Then
        CPM_Results.ThroughPut_95.T = (MO.TACT(J) - MO.TACT(J - 1)) / _
            (MO.CC(J) - MO.CC(J - 1)) * (0.95 - MO.CC(J - 1)) + MO.TACT(J - 1)
        CPM_Results.ThroughPut_95.C = ((MO.CC(J) - MO.CC(J - 1)) / _
            (MO.TACT(J) - MO.TACT(J - 1)) * _
            (CPM_Results.ThroughPut_95.T - MO.TACT(J - 1)) + MO.CC(J - 1)) * _
            CPM_Results.Component.InitialConcentration
        Flag95 = False
      End If
    End If
  Next J
  'ENABLE RESULTS MENU COMMANDS.
  frmMain.mnuResultsItem(1).Enabled = True
  If (NData_Points > 0) Then
    frmMain.mnuResultsItem(4).Enabled = True
  End If
End Sub
Sub ModelCPHSDM_WriteMainFile()
Dim f As Integer
Dim fn_This As String
Dim MI As ModelCPHSDM_Inputs_Type
Dim i As Integer
Dim J As Integer
Dim A1 As Double
Dim A2 As Double
Dim A3 As Double
Dim A4 As Double
  'PREPARE INPUTS.
  J = Component_Index_CPM
  '
  '------ INPUT SET #1: BED PROPERTIES. ------
  '
  'PARTICLE DIAMETER (cm).
  MI.Bed(1) = Carbon.ParticleRadius * 200#
  'BED DENSITY (g/cm^3).
  MI.Bed(2) = Bed.Weight * 4# / Bed.Length / Bed.Diameter ^ 2# / PI / 1000#
  'APPARENT PARTICLE DENSITY (g/cm^3).
  MI.Bed(3) = Carbon.Density
  'EBCT (minutes).
  MI.Bed(4) = Bed.Length * PI * Bed.Diameter * Bed.Diameter / 4# / Bed.Flowrate / 60#
  'SUPERFICIAL VELOCITY (cm/s).
  MI.Bed(5) = Bed.Flowrate * 4# / PI / Bed.Diameter ^ 2# * 100#
  'PARTICLE POROSITY (dimensionless).
  MI.Bed(6) = Carbon.Porosity
  '
  '------ INPUT SET #2: COMPONENT PROPERTIES. ------
  '
  'MOLECULAR WEIGHT (g/gmol).
  MI.Compo(1) = Component(J).MW
  'INFLUENT CONCENTRATION (ug/L).
  MI.Compo(2) = Component(J).InitialConcentration * 1000#
  'FREUNDLICH K (umol/g)*(L/umol)^(1/n).
  MI.Compo(3) = Component(J).Use_K * (1000# / Component(J).MW) ^ (1 - Component(J).Use_OneOverN)
  'FREUNDLICH 1/n (dimensionless).
  MI.Compo(4) = Component(J).Use_OneOverN
  '
  '------ INPUT SET #3: KINETIC PARAMETERS. ------
  '
  'FILM TRANSFER COEFFICIENT (cm/s).
  MI.Kine(1) = Component(J).kf
  'SURFACE DIFFUSION COEFFICIENT (cm^2/s).
  MI.Kine(2) = Component(J).Ds
  '
  '------ CALCULATE K REDUCTION DUE TO FOULING. ------
  '
  A1 = Bed.Water_Correlation.Coeff(1) * Component(J).Correlation.Coeff(1) + Component(J).Correlation.Coeff(2)
  A2 = Bed.Water_Correlation.Coeff(2) * Component(J).Correlation.Coeff(1)
  A3 = Bed.Water_Correlation.Coeff(3) * Component(J).Correlation.Coeff(1)
  A4 = Bed.Water_Correlation.Coeff(4) * Component(J).Correlation.Coeff(1)
  If (Bed.Phase = 0) Then
    If (Component(J).K_Reduction) And (Bed.Water_Correlation.Coeff(1) <> 1# And Bed.Water_Correlation.Coeff(2) <> 0# And Bed.Water_Correlation.Coeff(3) <> 0# And Bed.Water_Correlation.Coeff(4) <> 0#) Then
      Dim DG1 As Double
      Dim DG2 As Double
      Dim KovK0 As Double
      Dim DG As Double
      Dim TAU As Double
      Dim T_Minut As Double
      i = 0
      DG2 = 1#
      KovK0 = 1#
ModelCPHSDM_WriteMainFile_NextIteration:
      If (i < Max_Number_Fouling_Iterations) And (Abs(1# - DG1 / DG2) > 0.01) Then
        DG1 = 1000# * MI.Bed(2) * (MI.Bed(2) / MI.Bed(3)) / _
            (1 - MI.Bed(2) / MI.Bed(3)) / MI.Compo(2) * KovK0 * MI.Compo(3) * MI.Compo(2) ^ MI.Compo(4)
        'TAU = EBST * epsilon
        TAU = MI.Bed(4) * (1 - MI.Bed(2) / MI.Bed(3))
        T_Minut = TAU * (DG1 + 1)
        KovK0 = A1 + A2 * T_Minut + A3 * Exp(A4 * T_Minut)
        DG2 = 1000# * MI.Bed(2) * (MI.Bed(2) / MI.Bed(3)) / _
            (1 - MI.Bed(2) / MI.Bed(3)) / MI.Compo(2) * KovK0 * MI.Compo(3) * MI.Compo(2) ^ MI.Compo(4)
        i = i + 1
        GoTo ModelCPHSDM_WriteMainFile_NextIteration
      End If
      If i < Max_Number_Fouling_Iterations Then
        MI.Compo(3) = MI.Compo(3) * KovK0
      Else
        Call Show_Error( _
            "The iterations to evaluate the capacity reduction " & _
            "due to fouling did not converge." & vbCrLf & _
            "It will be assumed there is no fouling.")
      End If
    End If
  End If
  'WRITE INPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelCPHSDM_IN_Main
  'fn_This = App.Path & "\" & ModelECM_IN_Main
  Open fn_This For Output As #f
  Call WriteFortranInput(f, ModelCPHSDM_Version, "MODULE_VERSION")
  Call WriteFortranInput(f, MI.Bed(1), "Bed(1), particle diameter, cm")
  Call WriteFortranInput(f, MI.Bed(2), "Bed(2), bed density, g/cm^3")
  Call WriteFortranInput(f, MI.Bed(3), "Bed(3), apparent particle density, g/cm^3")
  Call WriteFortranInput(f, MI.Bed(4), "Bed(4), empty bed contact time (EBCT), minutes")
  Call WriteFortranInput(f, MI.Bed(5), "Bed(5), superficial velocity, cm/s")
  Call WriteFortranInput(f, MI.Bed(6), "Bed(6), particle porosity, dimless")
  Call WriteFortranInput(f, MI.Compo(1), "Compo(1), molecular weight, g/gmol")
  Call WriteFortranInput(f, MI.Compo(2), "Compo(2), influent concentration, ug/L")
  Call WriteFortranInput(f, MI.Compo(3), "Compo(3), Freundlich K, (umol/g)*(L/umol)^(1/n)")
  Call WriteFortranInput(f, MI.Compo(4), "Compo(4), Freundlich 1/n, dimless")
  Call WriteFortranInput(f, MI.Kine(1), "Kine(1), film transfer coefficient, cm/s")
  Call WriteFortranInput(f, MI.Kine(2), "Kine(2), surface diffusion coefficient, cm^2/s")
  Call WriteFortranInput(f, ModelCPHSDM_EofTestMarker, "EOFTESTMARKER")
  Close #f
  'STORE FOR LATER USE.
  ModelCPHSDM_Inputs = MI
End Sub
Sub ModelCPHSDM_WritePathFile()
Dim f As Integer
Dim fn_This As String
Dim qq As String
  qq = Chr$(34)
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelCPHSDM_IN_PathFile
  Open fn_This For Output As #f
  Print #f, qq & ModelCPHSDM_IN_Main & qq
  Print #f, qq & ModelCPHSDM_OUT_SuccessFlag & qq
  Print #f, qq & ModelCPHSDM_OUT_Main & qq
  Close #f
End Sub


Attribute VB_Name = "ModelECM"
Option Explicit

Const ModelECM_IN_PathFile = "ECM1.IN"
Const ModelECM_IN_Main = "ECM2.IN"
Const ModelECM_OUT_SuccessFlag = "ECM1.OUT"
Const ModelECM_OUT_Main = "ECM2.OUT"

Const ModelECM_Version = 1#
Const ModelECM_ExeName = "ECM5.EXE"
Const ModelECM_EofTestMarker = 123456#

Global Const MODELTYPE_PSDM = 0
Global Const MODELTYPE_CPHSDM = 1
Global Const MODELTYPE_ECM = 2

Const ModelECM_NMAX = 20
Private Type ModelECM_Inputs_Type
  NX As Integer                                   'DIMENSIONLESS
  VOID_I As Double                                'DIMENSIONLESS
  DEN_I As Double                                 'g/cm^3
  FLRT_I As Double                                'gal/min-ft^2
  INDEX_IO(1 To ModelECM_NMAX) As Integer          'DIMENSIONLESS
  XK_I(1 To ModelECM_NMAX) As Double              '(umol/g)*(L/umol)^(1/n)
  XN_I(1 To ModelECM_NMAX) As Double              'DIMENSIONLESS
  C0_I(1 To ModelECM_NMAX) As Double              'ug/L
  XMW_I(1 To ModelECM_NMAX) As Double             'g/gmol
End Type
Dim ModelECM_Inputs As ModelECM_Inputs_Type
Private Type ModelECM_Outputs_Type
  NX As Integer                                   'DIMENSIONLESS
  C_O(1 To ModelECM_NMAX, 1 To ModelECM_NMAX) As Double
  DGY_O(1 To ModelECM_NMAX, 1 To ModelECM_NMAX) As Double
  FCS_O(1 To ModelECM_NMAX, 1 To ModelECM_NMAX) As Double
  OATS_O(1 To ModelECM_NMAX) As Double
  Q_O(1 To ModelECM_NMAX, 1 To ModelECM_NMAX) As Double
  QAVE_O(1 To ModelECM_NMAX, 1 To ModelECM_NMAX) As Double
  SSTC_O(1 To ModelECM_NMAX) As Double
  VW_O(1 To ModelECM_NMAX) As Double
  ZZZ_O(1 To ModelECM_NMAX) As Double
  C0_O(1 To ModelECM_NMAX) As Double              'ug/L
End Type
Dim ModelECM_Outputs As ModelECM_Outputs_Type

'MISC VARIABLES (TIMER).
Global ModelIO_Timer_TimeStart As String
Global ModelIO_Timer_TimeEnd As String
Global ModelIO_Timer_SummaryMsg As String




Const ModelECM_declarations_end = True


Sub ModelECM_Go()
  Call ModelECM_WritePathFile
  Call ModelECM_WriteMainFile
  Call ModelECM_CallEXE
  Call ModelECM_ProcessOutput
  If (ModelIO_IsKeepTempFiles() = False) Then
    Call ModelECM_RemoveLinkFiles
  End If
End Sub


Sub ModelECM_RemoveLinkFiles()
  Call KillFile_If_Exists(Exe_Path & "\" & ModelECM_IN_PathFile)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelECM_IN_Main)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelECM_OUT_SuccessFlag)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelECM_OUT_Main)
End Sub
Sub ModelECM_CallEXE()
Dim CmdLine As String
Dim Test As String
  Call ChangeDir_Exes
  'ChDir App.Path
  'frmMain.CommonDialog1.Filename = App.Path & "\*.*"
  'CmdLine = Exe_Path & "\" & ModelECM_ExeName
  'CmdLine = ModelECM_ExeName
  'ChDir App.Path & "\exes"
  'Test = Dir("*.*")
  'Test = Dir: Call Show_Message(Test)
  'Test = Dir: Call Show_Message(Test)
  'Test = Dir: Call Show_Message(Test)
  'Test = Dir: Call Show_Message(Test)
  'Test = Dir: Call Show_Message(Test)
  'Test = Dir: Call Show_Message(Test)
  'Call Show_Message(CurDir$)
  CmdLine = ModelECM_ExeName
  Call ModelIO_Timer_Start
  Call FortranLink_ExecAndWaitForProcess(CmdLine)
  Call ModelIO_Timer_End
  Call ChangeDir_Main
End Sub
Sub ModelECM_ProcessOutput()
Dim f As Integer
Dim fn_This As String
Dim DummyStr1 As String
Dim Flag_IMSL As Integer
Dim MI As ModelECM_Inputs_Type
Dim MO As ModelECM_Outputs_Type
Dim i As Integer
Dim j As Integer
Dim L As Integer
Dim EOFTESTMARKER As Double
Dim MASSBAL_C0_e_Vf() As Double
Dim MASSBAL_TERM_SUM() As Double
Dim MASSBAL_PERCENT_ERR() As Double
'Call debug_output("e1")
  'MAKE COPY OF INPUT DATA.
  MI = ModelECM_Inputs
  'READ SUCCESS FLAG OUTPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelECM_OUT_SuccessFlag
  If (Not FileExists(fn_This)) Then
    Call Show_Error("Unable to find output file: Calculations failed.")
    Exit Sub
  End If
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, Flag_IMSL
  Close #f
  If (Flag_IMSL <> 0) Then
    Call Show_Error("The model calculations failed.")
    Exit Sub
  End If
'Call debug_output("e2")
  'READ MAIN OUTPUT FILE.
  fn_This = Exe_Path & "\" & ModelECM_OUT_Main
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, MO.NX
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    Input #f, MI.INDEX_IO(i)
  Next i
'Call debug_output("e2a")
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    For j = 1 To MO.NX
      Input #f, MO.C_O(i, j)
    Next j
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    For j = 1 To MO.NX
      Input #f, MO.DGY_O(i, j)
    Next j
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    For j = 1 To MO.NX
      Input #f, MO.FCS_O(i, j)
    Next j
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    Input #f, MO.OATS_O(i)
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    For j = 1 To MO.NX
      Input #f, MO.Q_O(i, j)
    Next j
  Next i
'Call debug_output("e2b")
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    For j = 1 To MO.NX
      Input #f, MO.QAVE_O(i, j)
    Next j
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    Input #f, MO.SSTC_O(i)
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    Input #f, MO.VW_O(i)
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    Input #f, MO.ZZZ_O(i)
  Next i
'Call debug_output("e2c")
  Line Input #f, DummyStr1
  For i = 1 To MO.NX
    Input #f, MO.C0_O(i)
  Next i
'Call debug_output("e2d")
  Line Input #f, DummyStr1
  Input #f, EOFTESTMARKER
  If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelECM_EofTestMarker)) Then
    Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
    Exit Sub
  End If
  Close #f
  ModelECM_Outputs = MO
  ModelECM_Inputs = MI
'Call debug_output("e3")
  'PERFORM MASS-BALANCE CALCULATION.
  ReDim MASSBAL_C0_e_Vf(1 To MO.NX)
  ReDim MASSBAL_TERM_SUM(1 To MO.NX)
  ReDim MASSBAL_PERCENT_ERR(1 To MO.NX)
  Call ModelECM_MASS_BALANCE( _
      MO.NX, _
      MO.VW_O(), _
      MO.C_O(), _
      MO.Q_O(), _
      MI.VOID_I, _
      MI.DEN_I, _
      MI.FLRT_I, _
      MO.C0_O(), _
      MASSBAL_C0_e_Vf(), _
      MASSBAL_TERM_SUM(), _
      MASSBAL_PERCENT_ERR())
'------------------------------------------------------------------------------------------------------------------------
'f = FreeFile
'Open "c:\vb5ecm.txt" For Output As #f
'Print #f, "MO.NX"
'Print #f, MO.NX
'Print #f, "MO.VW_O(i)"
'For i = 1 To MO.NX
'  Print #f, MO.VW_O(i)
'Next i
'Print #f, "MO.C_O(i,j)"
'For i = 1 To MO.NX
'  For j = 1 To MO.NX
'    Print #f, MO.C_O(i, j)
'  Next j
'Next i
'Print #f, "MO.Q_O(i,j)"
'For i = 1 To MO.NX
'  For j = 1 To MO.NX
'    Print #f, MO.Q_O(i, j)
'  Next j
'Next i
'Print #f, "MI.VOID_I"
'Print #f, MI.VOID_I
'Print #f, "MI.DEN_I"
'Print #f, MI.DEN_I
'Print #f, "MI.FLRT_I"
'Print #f, MI.FLRT_I
'Print #f, "MO.C0_O(i)"
'For i = 1 To MI.NX
'  Print #f, MO.C0_O(i)
'Next i
'Close #f
'------------------------------------------------------------------------------------------------------------------------
  'TRANSFER OUTPUT DATA TO MORE PERMANENT MEMORY.
  For i = 1 To MO.NX
    Output_ECM(i).index = MI.INDEX_IO(i)
  Next i
  For L = 1 To MO.NX
    'J = Output_ECM(L).Index
    j = L
    For i = 1 To MO.NX
      If (i = 1) Then
        Output_ECM(j).C_Over_C0(i) = 1#
      Else
        Output_ECM(j).C_Over_C0(i) = MO.FCS_O(L, i)
      End If
      Output_ECM(j).Solid_Concentration(i) = MO.Q_O(L, i)
      Output_ECM(j).Liquid_Concentration(i) = MO.C_O(L, i)
    Next i
    Output_ECM(j).Bed_Volume_Fed = MO.OATS_O(L)
    Output_ECM(j).Dimensionless_Bed_Length = MO.ZZZ_O(L)
    Output_ECM(j).SS_Treatment_Capacity = MO.SSTC_O(L)
    Output_ECM(j).Wave_Velocity = MO.VW_O(L)
    Output_ECM(j).Carbon_Usage_Rate = MI.DEN_I * 1000# * 1000# / MO.OATS_O(L)
  Next L
'Call debug_output("e4")
  For i = 1 To MO.NX
    Output_ECM_MASSBAL.MASSBAL_C0_e_Vf(i) = MASSBAL_C0_e_Vf(i)
    Output_ECM_MASSBAL.MASSBAL_TERM_SUM(i) = MASSBAL_TERM_SUM(i)
    Output_ECM_MASSBAL.MASSBAL_PERCENT_ERR(i) = MASSBAL_PERCENT_ERR(i)
  Next i
  frmMain.mnuResultsItem(2).Enabled = True
  Number_Component_ECM = MO.NX
  Call Show_Message( _
      "ECM Model Calculations Complete." & _
      vbCrLf & _
      vbCrLf & _
      ModelIO_Timer_SummaryMsg)
'Call debug_output("e5")
End Sub
Sub ModelECM_WriteMainFile()
Dim f As Integer
Dim fn_This As String
Dim MI As ModelECM_Inputs_Type
Dim i As Integer
Dim j As Integer
  'PREPARE INPUTS.
  MI.NX = Number_Component_ECM
  MI.VOID_I = 1# - Bed.Weight / (Bed.Diameter / 2#) ^ 2# / PI / Bed.length / Carbon.Density / 1000#
  MI.DEN_I = (1# - MI.VOID_I) * Carbon.Density
  MI.FLRT_I = (Bed.Flowrate / Bed.Diameter ^ 2# * 4# / PI) * _
      (60# * 0.3048 ^ 2 * 1000# / 3.785)
  For i = 1 To MI.NX
    j = Component_Index_ECM(i)
    MI.INDEX_IO(i) = j
    'CONVERT FROM (mg/g)*(L/mg)^(1/n) TO (umol/g)*(L/umol)^(1/n).
    MI.XK_I(i) = Component(j).Use_K * _
        (1000# / Component(j).MW) ^ _
        (1 - Component(j).Use_OneOverN)
    MI.XN_I(i) = Component(j).Use_OneOverN
    'CONVERT FROM mg/L TO ug/L.
    MI.C0_I(i) = Component(j).InitialConcentration * 1000#
    MI.XMW_I(i) = Component(j).MW
  Next i
  'WRITE INPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelECM_IN_Main
  'fn_This = App.Path & "\" & ModelECM_IN_Main
  Open fn_This For Output As #f
  Call WriteFortranInput(f, ModelECM_Version, "MODULE_VERSION")
  Call WriteFortranInput(f, MI.NX, "NX, number of components")
  Call WriteFortranInput(f, MI.VOID_I, "VOID_I, bed void fraction, dim'less")
  Call WriteFortranInput(f, MI.DEN_I, "DEN_I, bed density, g/cm^3")
  Call WriteFortranInput(f, MI.FLRT_I, "FLRT_I, superficial flow rate, gal/min-ft^2")
  For i = 1 To MI.NX
    Call WriteFortranInput(f, MI.INDEX_IO(i), "INDEX_IO(" & Trim$(Str$(i)) & "), component index")
    Call WriteFortranInput(f, MI.XK_I(i), "XK_I(" & Trim$(Str$(i)) & "), Freundlich K, (umol/g)*(L/umol)^(1/n)")
    Call WriteFortranInput(f, MI.XN_I(i), "XN_I(" & Trim$(Str$(i)) & "), Freundlich 1/n, dim'less")
    Call WriteFortranInput(f, MI.C0_I(i), "C0_I(" & Trim$(Str$(i)) & "), influent concentration, ug/L")
    Call WriteFortranInput(f, MI.XMW_I(i), "XMW_I(" & Trim$(Str$(i)) & "), molecular weight, g/gmol")
  Next i
  Call WriteFortranInput(f, ModelECM_EofTestMarker, "EOFTESTMARKER")
  Close #f
  'STORE FOR LATER USE.
  ModelECM_Inputs = MI
End Sub
Sub ModelECM_WritePathFile()
Dim f As Integer
Dim fn_This As String
Dim qq As String
  qq = Chr$(34)
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelECM_IN_PathFile
  'fn_This = App.Path & "\" & ModelECM_IN_PathFile
  Open fn_This For Output As #f
  Print #f, qq & ModelECM_IN_Main & qq
  Print #f, qq & ModelECM_OUT_SuccessFlag & qq
  Print #f, qq & ModelECM_OUT_Main & qq
  Close #f
End Sub


'C********************************************************************
'C
'C MASS_BALANCE
'C
'C Description:  This routine will do the mass balance on the output
'C               from the ECM program for each component and tell
'C               the percent error on the mass balance.
'C
'C Input Variables:
'C    N =        Number of Components
'C    VW =       Array of Wave Velocities for each zone (1 to N)
'C (cm / s)
'C    C =        Array of Liquid Phase Concentrations for Each
'C               Component in Each Zone : C(Component,Zone) -
'C               N x N two-dimensional array (ug/L)
'C    Q =        Array of Gas Phase Concentrations for Each
'C               Component in Each Zone : q(Component,Zone) -
'C               N x N two-dimensional array (ug/g)
'C    EBED =     Void Fraction of Bed (-)
'C    DEN =      Bulk Density of Adsorbent (g/cm3)
'C FLRT = Flowrate(gpm / ft2)
'C    COK =      Array of Liquid Phase Influent Concentrations
'C               (1 to N) (ug/L)
'C
'C Output Variables:
'C    C0_e_Vf =  Left-hand side of mass balance (ug/cm2/s). Array
'C               from 1 to N.
'C    TERM_SUM = Right-hand side of mass balance (ug/cm2/s).
'C               Array from 1 to N.
'C    PERCENT_ERR = Percent difference between C0_e_Vf and
'C                  TERM_SUM (%). Array from 1 to N.
'C
'C Variables internal to this Subroutine:
'C    VF =       Interstitial fluid velocity (L/cm2/s)
'C
'C********************************************************************
Sub ModelECM_MASS_BALANCE( _
    N As Integer, _
    VW() As Double, _
    C() As Double, _
    Q() As Double, _
    EBED As Double, _
    DEN As Double, _
    FLRT As Double, _
    COK() As Double, _
    OUTPUT_C0_e_Vf() As Double, _
    OUTPUT_TERM_SUM() As Double, _
    OUTPUT_PERCENT_ERR() As Double)
Dim VF As Double
Dim i As Integer
Dim j As Integer
Dim TERM As Double
  VF = FLRT * 1000# / 60# / (30.48 ^ 2#) / 264.17 / EBED
  For i = 1 To N
    OUTPUT_C0_e_Vf(i) = COK(i) * VF * EBED
  Next i
  For i = 1 To N
    OUTPUT_TERM_SUM(i) = 0#
    For j = 1 To N
      If (j = 1) Then
        TERM = VW(j) * (Q(i, j) * DEN + C(i, j) * EBED / 1000#)
      Else
        TERM = (VW(j) - VW(j - 1)) * (Q(i, j) * DEN + C(i, j) * EBED / 1000#)
      End If
      OUTPUT_TERM_SUM(i) = OUTPUT_TERM_SUM(i) + TERM
    Next j
    OUTPUT_PERCENT_ERR(i) = _
        Abs(((OUTPUT_C0_e_Vf(i) - OUTPUT_TERM_SUM(i)) / _
        OUTPUT_C0_e_Vf(i))) * 100#
  Next i
'
'      SUBROUTINE ECM_MASSBAL (N,VW,C,Q,EBED,DEN,FLRT,COK,C0_e_Vf,
'     &                         TERM_SUM,PERCENT_ERR,VF)
'
'      IMPLICIT NONE
'      INTEGER N,I,J,K
'      DOUBLE PRECISION VW(N),C(N,N),Q(N,N),EBED,DEN,FLRT,COK(N)
'      DOUBLE PRECISION TERM,C0_e_Vf(N),TERM_SUM(N),
'     &                 PERCENT_ERR(N),VF
'
'      VF = FLRT * 1000.0D0 / 60.0D0 / (30.48D0**2) / 264.17D0 / EBED
'
'      DO 10, I = 1,N
'         C0_e_Vf(i) = COK(i) * VF * EBED
'10    CONTINUE
'
'C**** Note:  I = Number of Component, J = Number of Zone
'
'      DO 20, I = 1,N
'         TERM_SUM(i) = 0#
'         DO 30, J = 1,N
'            IF (J.EQ.1) THEN
'               TERM = VW(j) * (Q(i, j) * DEN + C(i, j) * EBED / 1000#)
'            Else
'               TERM = (VW(J)-VW(J-1)) *
'     &                (Q(I,J)*DEN+C(I,J)*EBED/1000.0D0)
'            End If
'            TERM_SUM(i) = TERM_SUM(i) + TERM
'30       CONTINUE
'         PERCENT_ERR(i) = DABS(((C0_e_Vf(i) - TERM_SUM(i)) / C0_e_Vf(i)))
'     &                      * 100.0D0
'20    CONTINUE
'
'      End
'
'C********************************************************************
'
End Sub










'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'//////////////////     THE FOLLOWING CODE APPLIES TO ALL MODELS, NOT JUST THE ECM.     /////////////////////////////////////
'////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub AllModels_Verify_Selected_Components(Model As Integer)
Dim i As Integer
  Select Case Model
    Case MODELTYPE_PSDM:
      Number_Component_PFPSDM = 0
      For i = 1 To Number_Component
        If (frmMain.lstComponents.Selected(i - 1)) Then
          Number_Component_PFPSDM = Number_Component_PFPSDM + 1
          If Number_Component_PFPSDM > Number_Compo_Max_PFPSDM Then
            Call Show_Error("You selected too many components for the PSDM!")
            Number_Component_PFPSDM = 0
            Exit Sub
          End If
          Component_Index_PFPSDM(Number_Component_PFPSDM) = i
        End If
      Next i
      If Number_Component_PFPSDM = 0 Then
        Call Show_Error("You did not select any component for the PSDM!")
      End If
    Case MODELTYPE_CPHSDM:
      Number_Component_CPM = 0
      For i = 1 To Number_Component
        If (frmMain.lstComponents.Selected(i - 1)) Then
          Number_Component_CPM = Number_Component_CPM + 1
          If Number_Component_CPM > Number_Compo_Max_CPM Then
            Call Show_Error("You selected too many components for the CPHSDM!")
            Number_Component_CPM = 0
            Exit Sub
          End If
          Component_Index_CPM = i
        End If
      Next i
      If Number_Component_CPM = 0 Then
        Call Show_Error("You did not select any component for the CPHSDM!")
      End If
    Case MODELTYPE_ECM:
      Number_Component_ECM = 0
      For i = 1 To Number_Component
        If (frmMain.lstComponents.Selected(i - 1)) Then
          Number_Component_ECM = Number_Component_ECM + 1
          If (Number_Component_ECM > Number_Compo_Max_ECM) Then
            Call Show_Error("You selected too many components for the ECM!")
            Number_Component_ECM = 0
            Exit Sub
          End If
          Component_Index_ECM(Number_Component_ECM) = i
        End If
      Next i
      If (Number_Component_ECM = 0) Then
        Call Show_Error("You did not select any component for the ECM!")
      End If
  End Select
End Sub


Function ModelIO_DoNumberCheck(N1 As Double, N2 As Double) As Boolean
  If (Abs(N1 + 0.000001) / N2 - 1#) <= 0.001 Then
    'NUMBERS ARE CLOSE TO IDENTICAL.
    ModelIO_DoNumberCheck = True
  Else
    'NUMBERS ARE _NOT_ CLOSE TO IDENTICAL.
    ModelIO_DoNumberCheck = False
  End If
End Function


Sub ModelIO_Timer_Start()
  ModelIO_Timer_TimeStart = Now
End Sub
Sub ModelIO_Timer_End()
Dim Elapsed_Min As Double
Dim TotalTimeStr As String
  ModelIO_Timer_TimeEnd = Now
  Elapsed_Min = _
      DateDiff("s", ModelIO_Timer_TimeStart, _
               ModelIO_Timer_TimeEnd) / 60#
  TotalTimeStr = Format$(Elapsed_Min, "0.00")
  ModelIO_Timer_SummaryMsg = _
      "Calculation Started:    " & ModelIO_Timer_TimeStart & _
      vbCrLf & _
      "Calculation Ended:    " & ModelIO_Timer_TimeEnd & _
      vbCrLf & _
      vbCrLf & _
      "Total Calculation Time = " & TotalTimeStr & " Minutes"
End Sub


Function ModelIO_IsKeepTempFiles() As Boolean
  ModelIO_IsKeepTempFiles = frmMain.mnuMTUItem(40).Checked
End Function
Attribute VB_Name = "ModelIPE"
Option Explicit

Const ModelIPE_IN_PathFile = "IPES1.IN"
Const ModelIPE_IN_Main = "IPES2.IN"
Const ModelIPE_OUT_SuccessFlag = "IPES1.OUT"
Const ModelIPE_OUT_Main = "IPES2.OUT"

Const ModelIPE_Version = 1#
Const ModelIPE_ExeName = "IPES3.EXE"
Const ModelIPE_EofTestMarker = 123456#

Global Const MODULECODE_ADLIQ = 1
Global Const MODULECODE_HOFMAN = 5
Global Const MODULECODE_SPEQ = 4

Dim SHARED_MODULECODE As Integer
Dim SHARED_NL As Integer
Dim SHARED_OMAG As Double

'
'///////////// ADLIQ INPUTS / OUTPUTS ////////////////////////////////////////////////////////////////////////////////////////////////
'
Private Type ModelIPE_ADLIQ_Inputs_Type
  BB As Double      'POLANYI PARAMETER.
  W0 As Double      'POLANYI PARAMETER.
  GM As Double      'POLANYI PARAMETER (dimless).
  CBULK As Double   'BULK CONCENTRATION (ug/L).
  ORGDEN As Double  'ORGANIC DENSITY (g/cm^3).
  TT As Double      'TEMPERATURE (degrees Kelvin).
  FWT As Double     'MOLECULAR WEIGHT (g/gmol).
  SOLUB As Double   'AQUEOUS SOLUBILITY (mg/L).
  NL As Integer     'NUMBER OF REGRESSION POINTS (dimless).
  OMAG As Double    'ORDER OF MAGNITUDE OF REGRESSION (dimless).
End Type
Dim ModelIPE_ADLIQ_Inputs As ModelIPE_ADLIQ_Inputs_Type
Private Type ModelIPE_ADLIQ_Outputs_Type
  CSAV As Double    'AVERAGE BULK CONC (ug/L).
  QSAV As Double    'POLANYI ADSORPTION CAPACITY (ug/g).
  XK1 As Double     'FREUNDLICH K (ug/g)*(L/ug)^(1/n).
  XK2 As Double     'FREUNDLICH K (umol/g)*(L/umol)^(1/n).
  XNF As Double     'FREUNDLICH 1/N (dimless).
  CBEG As Double    'CORRELATION LOWER BOUND (ug/L).
  CEND As Double    'CORRELATION UPPER BOUND (ug/L).
  RSQD As Double    'REGRESSION R-SQUARED (dimless).
  RMSE As Double    'ROOT MEAN SQUARE ERROR (dimless?).
  ErrMat(1 To 30) As Integer      'ERROR MATRIX.
  ALERR As Integer                'HAS ANY ERROR/WARNING OCCURRED?
End Type
Dim ModelIPE_ADLIQ_Outputs As ModelIPE_ADLIQ_Outputs_Type


'
'///////////// HOFMAN INPUTS / OUTPUTS ////////////////////////////////////////////////////////////////////////////////////////////////
'
Private Type ModelIPE_HOFMAN_Inputs_Type
  IN_DATA(1 To 11) As Double        'VARIOUS PARAMETERS.
  NL As Integer     'NUMBER OF REGRESSION POINTS (dimless).
End Type
Dim ModelIPE_HOFMAN_Inputs As ModelIPE_HOFMAN_Inputs_Type
Private Type ModelIPE_HOFMAN_Outputs_Type
  CSAV As Double    'AVERAGE BULK CONC (ug/L).
  QSAV As Double    'POLANYI ADSORPTION CAPACITY (ug/g).
  XK1 As Double     'FREUNDLICH K (ug/g)*(L/ug)^(1/n).
  XK2 As Double     'FREUNDLICH K (umol/g)*(L/umol)^(1/n).
  XNF As Double     'FREUNDLICH 1/N (dimless).
  CBEG As Double    'CORRELATION LOWER BOUND (ug/L).
  CEND As Double    'CORRELATION UPPER BOUND (ug/L).
  RSQD As Double    'REGRESSION R-SQUARED (dimless).
  RMSE As Double    'ROOT MEAN SQUARE ERROR (dimless?).
  ErrMat(1 To 30) As Integer      'ERROR MATRIX.
  HOERR As Integer                'HAS ANY ERROR/WARNING OCCURRED?
End Type
Dim ModelIPE_HOFMAN_Outputs As ModelIPE_HOFMAN_Outputs_Type


'
'///////////// SPEQ INPUTS / OUTPUTS ////////////////////////////////////////////////////////////////////////////////////////////////
'
Private Type ModelIPE_SPEQ_Inputs_Type
  IN_DATA(1 To 10) As Double        'VARIOUS PARAMETERS.
  NL As Integer     'NUMBER OF REGRESSION POINTS (dimless).
  XERR As Integer   '??? FORCING TO ZERO SEEMS ACCEPTABLE.
End Type
Dim ModelIPE_SPEQ_Inputs As ModelIPE_SPEQ_Inputs_Type
Private Type ModelIPE_SPEQ_Outputs_Type
  CSAV As Double    'AVERAGE BULK CONC (ug/L).
  QSAV As Double    'POLANYI ADSORPTION CAPACITY (ug/g).
  XK1 As Double     'FREUNDLICH K (ug/g)*(L/ug)^(1/n).
  XK2 As Double     'FREUNDLICH K (umol/g)*(L/umol)^(1/n).
  XNF As Double     'FREUNDLICH 1/N (dimless).
  CBEG As Double    'CORRELATION LOWER BOUND (ug/L).
  CEND As Double    'CORRELATION UPPER BOUND (ug/L).
  ErrMat(1 To 30) As Integer      'ERROR MATRIX.
  SQERR As Integer                'HAS ANY ERROR/WARNING OCCURRED?
End Type
Dim ModelIPE_SPEQ_Outputs As ModelIPE_SPEQ_Outputs_Type





Const ModelIPE_declarations_end = True


Sub ModelIPE_Go( _
    WhichModule As Integer, _
    INPUT_NL As Integer, _
    INPUT_OMAG As Double, _
    Raise_Dirty_Flag As Boolean)
Dim Found As Boolean
  SHARED_NL = INPUT_NL
  SHARED_OMAG = INPUT_OMAG
  SHARED_MODULECODE = WhichModule
  Found = False
  Raise_Dirty_Flag = False
  Select Case WhichModule
    Case MODULECODE_ADLIQ:        '3-PARAMETER POLANYI (LIQUID).
      Call ModelIPE_ADLIQ_Go(Raise_Dirty_Flag)
    Case MODULECODE_SPEQ:         'D-R SPREADING PRESSURE (GAS).
      Call ModelIPE_SPEQ_Go(Raise_Dirty_Flag)
    Case MODULECODE_HOFMAN:       'D-R UNIFORM ADSORBATE (LIQUID).
      Call ModelIPE_HOFMAN_Go(Raise_Dirty_Flag)
    Case Else:
      Call Show_Error("Invalid IPE module type " & _
          Trim$(Str$(WhichModule)) & ".  Select a different " & _
          "IPE module type.")
      Exit Sub
  End Select
End Sub




'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////////    ADLIQ MODULE    //////////////////////////////////////////////////////////////////////////////////
'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub ModelIPE_ADLIQ_ProcessOutput(Raise_Dirty_Flag As Boolean)
Dim f As Integer
Dim fn_This As String
Dim DummyStr1 As String
Dim DummyVal1 As Integer
Dim i As Integer
Dim Flag_IPE As Integer
Dim MI As ModelIPE_ADLIQ_Inputs_Type
Dim MO As ModelIPE_ADLIQ_Outputs_Type
Dim OkayToUse As Boolean
Dim EOFTESTMARKER As Double
  'READ SUCCESS FLAG OUTPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelIPE_OUT_SuccessFlag
  If (Not FileExists(fn_This)) Then
    Call Show_Error("Unable to find output file: Calculations failed.")
    Exit Sub
  End If
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, Flag_IPE
  Close #f
  'READ MAIN OUTPUT FILE.
  fn_This = Exe_Path & "\" & ModelIPE_OUT_Main
  Open fn_This For Input As #f
  Line Input #f, DummyStr1: Input #f, MO.CSAV
  Line Input #f, DummyStr1: Input #f, MO.QSAV
  Line Input #f, DummyStr1: Input #f, MO.XK1
  Line Input #f, DummyStr1: Input #f, MO.XK2
  Line Input #f, DummyStr1: Input #f, MO.XNF
  Line Input #f, DummyStr1: Input #f, MO.CBEG
  Line Input #f, DummyStr1: Input #f, MO.CEND
  Line Input #f, DummyStr1: Input #f, MO.RSQD
  Line Input #f, DummyStr1: Input #f, MO.RMSE
  Line Input #f, DummyStr1
  For i = 1 To 30
    Input #f, MO.ErrMat(i)
  Next i
  Line Input #f, DummyStr1
  Input #f, MO.ALERR           'COPY OF ALERR / Flag_IPE.
  Line Input #f, DummyStr1
  Input #f, EOFTESTMARKER
  If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelIPE_EofTestMarker)) Then
    Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
    Exit Sub
  End If
  Close #f
  ModelIPE_ADLIQ_Outputs = MO
  MI = ModelIPE_ADLIQ_Inputs
  'DISPLAY WARNINGS/ERRORS IF NECESSARY.
  OkayToUse = AllIPEModels_ErrorCheck(MO.ALERR, MO.ErrMat())
  If (Not OkayToUse) Then Exit Sub
  'PROCESS IPE RESULTS.
  IPES_Data.Input.BB = MI.BB
  IPES_Data.Input.W0 = MI.W0
  IPES_Data.Input.GM = MI.GM
  'Conversion from ug/g to mg/g
  IPES_Data.Output.QSAV = MO.QSAV / 1000#
  'Conversion from ug/g to mg/g
  IPES_Data.Output.CSAV = MO.CSAV / 1000#
  IPES_Data.Output.CBEG = MO.CBEG / 1000#
  IPES_Data.Output.CEND = MO.CEND / 1000#
  'Conversion from (ug/g)x(l/ug)^(1/n) to (mg/g)x(l/mg)^(1/n)
  IPES_Data.Output.XK1 = MO.XK1 * (1000#) ^ (MO.XNF - 1)
  'Conversion from (umol/g)x(l/umol)^(1/n) to (mmol/g)x(l/mmol)^(1/n)
  IPES_Data.Output.XK2 = MO.XK2 * (1000#) ^ (MO.XNF - 1)
  IPES_Data.Output.XN = MO.XNF
  IPES_Data.Output.RSQD = MO.RSQD
  IPES_Data.Output.RMSE = MO.RMSE
  'TRANSFER K AND 1/n.
  Component(0).IPESResult_K = IPES_Data.Output.XK1
  Component(0).IPESResult_OneOverN = IPES_Data.Output.XN
  'RAISE DIRTY FLAG.
  Raise_Dirty_Flag = True
  'DISPLAY RESULTS.
  Call frmModelIPEResults. _
      frmModelIPEResults_Run(SHARED_MODULECODE)
End Sub
Sub ModelIPE_ADLIQ_WriteMainFile()
Dim MI As ModelIPE_ADLIQ_Inputs_Type
Dim f As Integer
Dim fn_This As String
  'PREPARE INPUTS.
  'NOTE: IT IS ASSUMED THAT Component(0) CONTAINS THE
  'CHEMICAL PROPERTIES OF INTEREST.
  MI.BB = Carbon.BB
  MI.W0 = Carbon.W0
  MI.GM = Carbon.PolanyiExponent
  MI.CBULK = Component(0).InitialConcentration * 1000#
  MI.ORGDEN = Component(0).Liquid_Density
  MI.TT = Bed.Temperature + 273.15
  MI.FWT = Component(0).MW
  MI.SOLUB = Component(0).Aqueous_Solubility
  MI.NL = SHARED_NL
  MI.OMAG = SHARED_OMAG
  'WRITE INPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelIPE_IN_Main
  Open fn_This For Output As #f
  Call WriteFortranInput(f, ModelIPE_Version, "MODULE_VERSION")
  Call WriteFortranInput(f, MI.BB, "BB, Polanyi parameter")
  Call WriteFortranInput(f, MI.W0, "W0, Polanyi parameter")
  Call WriteFortranInput(f, MI.GM, "GM, Polanyi exponent")
  Call WriteFortranInput(f, MI.CBULK, "CBULK, bulk concentration, ug/L")
  Call WriteFortranInput(f, MI.ORGDEN, "ORGDEN, organic density, g/cm^3")
  Call WriteFortranInput(f, MI.TT, "TT, temperature, degK")
  Call WriteFortranInput(f, MI.FWT, "FWT, molecular weight, g/gmol")
  Call WriteFortranInput(f, MI.SOLUB, "SOLUB, aqueous solubility, mg/L")
  Call WriteFortranInput(f, MI.NL, "NL, number of regression points, dimless")
  Call WriteFortranInput(f, MI.OMAG, "OMAG, order of magnitude of regression, dimless")
  Call WriteFortranInput(f, ModelIPE_EofTestMarker, "EOFTESTMARKER")
  Close #f
  'STORE FOR LATER USE.
  ModelIPE_ADLIQ_Inputs = MI
End Sub
Sub ModelIPE_ADLIQ_Go(Raise_Dirty_Flag As Boolean)
  Call ModelIPE_WritePathFile(MODULECODE_ADLIQ)
  Call ModelIPE_ADLIQ_WriteMainFile
  Call ModelIPE_CallEXE
  Call ModelIPE_ADLIQ_ProcessOutput(Raise_Dirty_Flag)
  If (ModelIO_IsKeepTempFiles() = False) Then
    Call ModelIPE_RemoveLinkFiles
  End If
End Sub


'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////////    HOFMAN MODULE    /////////////////////////////////////////////////////////////////////////////////
'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub ModelIPE_HOFMAN_ProcessOutput(Raise_Dirty_Flag As Boolean)
Dim f As Integer
Dim fn_This As String
Dim DummyStr1 As String
Dim DummyVal1 As Integer
Dim i As Integer
Dim Flag_IPE As Integer
Dim MI As ModelIPE_HOFMAN_Inputs_Type
Dim MO As ModelIPE_HOFMAN_Outputs_Type
Dim OkayToUse As Boolean
Dim EOFTESTMARKER As Double
  'READ SUCCESS FLAG OUTPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelIPE_OUT_SuccessFlag
  If (Not FileExists(fn_This)) Then
    Call Show_Error("Unable to find output file: Calculations failed.")
    Exit Sub
  End If
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, Flag_IPE
  Close #f
  'READ MAIN OUTPUT FILE.
  fn_This = Exe_Path & "\" & ModelIPE_OUT_Main
  Open fn_This For Input As #f
  Line Input #f, DummyStr1: Input #f, MO.CSAV
  Line Input #f, DummyStr1: Input #f, MO.QSAV
  Line Input #f, DummyStr1: Input #f, MO.XK1
  Line Input #f, DummyStr1: Input #f, MO.XK2
  Line Input #f, DummyStr1: Input #f, MO.XNF
  Line Input #f, DummyStr1: Input #f, MO.CBEG
  Line Input #f, DummyStr1: Input #f, MO.CEND
  Line Input #f, DummyStr1: Input #f, MO.RSQD
  Line Input #f, DummyStr1: Input #f, MO.RMSE
  Line Input #f, DummyStr1
  For i = 1 To 30
    Input #f, MO.ErrMat(i)
  Next i
  Line Input #f, DummyStr1
  Input #f, MO.HOERR           'COPY OF HOERR / Flag_IPE.
  Line Input #f, DummyStr1
  Input #f, EOFTESTMARKER
  If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelIPE_EofTestMarker)) Then
    Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
    Exit Sub
  End If
  Close #f
  ModelIPE_HOFMAN_Outputs = MO
  MI = ModelIPE_HOFMAN_Inputs
  'DISPLAY WARNINGS/ERRORS IF NECESSARY.
  OkayToUse = AllIPEModels_ErrorCheck(MO.HOERR, MO.ErrMat())
  If (Not OkayToUse) Then Exit Sub
  'PROCESS IPE RESULTS.
  IPES_Data.Input.BB = MI.IN_DATA(1)
  IPES_Data.Input.W0 = MI.IN_DATA(2)
  IPES_Data.Input.GM = MI.IN_DATA(9)
  'Conversion from ug/g to mg/g
  IPES_Data.Output.QSAV = MO.QSAV / 1000#
  'Conversion from ug/g to mg/g
  IPES_Data.Output.CSAV = MO.CSAV / 1000#
  IPES_Data.Output.CBEG = MO.CBEG / 1000#
  IPES_Data.Output.CEND = MO.CEND / 1000#
  'Conversion from (ug/g)x(l/ug)^(1/n) to (mg/g)x(l/mg)^(1/n)
  IPES_Data.Output.XK1 = MO.XK1 * (1000#) ^ (MO.XNF - 1)
  'Conversion from (umol/g)x(l/umol)^(1/n) to (mmol/g)x(l/mmol)^(1/n)
  IPES_Data.Output.XK2 = MO.XK2 * (1000#) ^ (MO.XNF - 1)
  IPES_Data.Output.XN = MO.XNF
  IPES_Data.Output.RSQD = MO.RSQD
  IPES_Data.Output.RMSE = MO.RMSE
  'TRANSFER K AND 1/n.
  Component(0).IPESResult_K = IPES_Data.Output.XK1
  Component(0).IPESResult_OneOverN = IPES_Data.Output.XN
  'RAISE DIRTY FLAG.
  Raise_Dirty_Flag = True
  'DISPLAY RESULTS.
  Call frmModelIPEResults. _
      frmModelIPEResults_Run(SHARED_MODULECODE)
End Sub
Sub ModelIPE_HOFMAN_WriteMainFile()
Dim MI As ModelIPE_HOFMAN_Inputs_Type
Dim f As Integer
Dim fn_This As String
  'PREPARE INPUTS.
  'NOTE: IT IS ASSUMED THAT Component(0) CONTAINS THE
  'CHEMICAL PROPERTIES OF INTEREST.
  MI.IN_DATA(1) = Carbon.BB
  MI.IN_DATA(2) = Carbon.W0
  MI.IN_DATA(3) = Bed.Temperature + 273.15
  MI.IN_DATA(4) = Component(0).InitialConcentration * 1000#
  MI.IN_DATA(5) = Component(0).Liquid_Density
  MI.IN_DATA(6) = Component(0).MW
  MI.IN_DATA(7) = Component(0).Vapor_Pressure / 101325 * 760       'UNITS: mmHg.
  MI.IN_DATA(8) = Component(0).Aqueous_Solubility
  MI.IN_DATA(9) = Component(0).Refractive_Index
  MI.IN_DATA(10) = Carbon.PolanyiExponent
  MI.IN_DATA(11) = SHARED_OMAG
  MI.NL = SHARED_NL
  'WRITE INPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelIPE_IN_Main
  Open fn_This For Output As #f
  Call WriteFortranInput(f, ModelIPE_Version, "MODULE_VERSION")
  Call WriteFortranInput(f, MI.IN_DATA(1), "IN_DATA(1), Polanyi parameter BB")
  Call WriteFortranInput(f, MI.IN_DATA(2), "IN_DATA(2), Polanyi parameter W0")
  Call WriteFortranInput(f, MI.IN_DATA(3), "IN_DATA(3), temperature, degK")
  Call WriteFortranInput(f, MI.IN_DATA(4), "IN_DATA(4), bulk concentration, ug/L")
  Call WriteFortranInput(f, MI.IN_DATA(5), "IN_DATA(5), organic density, g/cm^3")
  Call WriteFortranInput(f, MI.IN_DATA(6), "IN_DATA(6), molecular weight, g/gmol")
  Call WriteFortranInput(f, MI.IN_DATA(7), "IN_DATA(7), vapor pressure, mmHg")
  Call WriteFortranInput(f, MI.IN_DATA(8), "IN_DATA(8), aqueous solubility, mg/L")
  Call WriteFortranInput(f, MI.IN_DATA(9), "IN_DATA(9), refractive index, dimless")
  Call WriteFortranInput(f, MI.IN_DATA(10), "IN_DATA(10), Polanyi exponent GM, dimless")
  Call WriteFortranInput(f, MI.IN_DATA(11), "IN_DATA(11), order of magnitude of regression, dimless")
  Call WriteFortranInput(f, MI.NL, "NL, number of regression points, dimless")
  Call WriteFortranInput(f, ModelIPE_EofTestMarker, "EOFTESTMARKER")
  Close #f
  'STORE FOR LATER USE.
  ModelIPE_HOFMAN_Inputs = MI
End Sub
Sub ModelIPE_HOFMAN_Go(Raise_Dirty_Flag As Boolean)
  Call ModelIPE_WritePathFile(MODULECODE_HOFMAN)
  Call ModelIPE_HOFMAN_WriteMainFile
  Call ModelIPE_CallEXE
  Call ModelIPE_HOFMAN_ProcessOutput(Raise_Dirty_Flag)
  If (ModelIO_IsKeepTempFiles() = False) Then
    Call ModelIPE_RemoveLinkFiles
  End If
End Sub


'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////////    SPEQ MODULE    ///////////////////////////////////////////////////////////////////////////////////
'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub ModelIPE_SPEQ_ProcessOutput(Raise_Dirty_Flag As Boolean)
Dim f As Integer
Dim fn_This As String
Dim DummyStr1 As String
Dim DummyVal1 As Integer
Dim i As Integer
Dim Flag_IPE As Integer
Dim MI As ModelIPE_SPEQ_Inputs_Type
Dim MO As ModelIPE_SPEQ_Outputs_Type
Dim OkayToUse As Boolean
Dim EOFTESTMARKER As Double
  'READ SUCCESS FLAG OUTPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelIPE_OUT_SuccessFlag
  If (Not FileExists(fn_This)) Then
    Call Show_Error("Unable to find output file: Calculations failed.")
    Exit Sub
  End If
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, Flag_IPE
  Close #f
  'READ MAIN OUTPUT FILE.
  fn_This = Exe_Path & "\" & ModelIPE_OUT_Main
  Open fn_This For Input As #f
  Line Input #f, DummyStr1: Input #f, MO.CSAV
  Line Input #f, DummyStr1: Input #f, MO.QSAV
  Line Input #f, DummyStr1: Input #f, MO.XK1
  Line Input #f, DummyStr1: Input #f, MO.XK2
  Line Input #f, DummyStr1: Input #f, MO.XNF
  Line Input #f, DummyStr1: Input #f, MO.CBEG
  Line Input #f, DummyStr1: Input #f, MO.CEND
  'Line Input #f, DummyStr1: Input #f, MO.RSQD
  'Line Input #f, DummyStr1: Input #f, MO.RMSE
  Line Input #f, DummyStr1
  For i = 1 To 30
    Input #f, MO.ErrMat(i)
  Next i
  Line Input #f, DummyStr1
  Input #f, MO.SQERR           'COPY OF SQERR / Flag_IPE.
  Line Input #f, DummyStr1
  Input #f, EOFTESTMARKER
  If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelIPE_EofTestMarker)) Then
    Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
    Exit Sub
  End If
  Close #f
  ModelIPE_SPEQ_Outputs = MO
  MI = ModelIPE_SPEQ_Inputs
  'DISPLAY WARNINGS/ERRORS IF NECESSARY.
  OkayToUse = AllIPEModels_ErrorCheck(MO.SQERR, MO.ErrMat())
  If (Not OkayToUse) Then Exit Sub
  'PROCESS IPE RESULTS.
  IPES_Data.Input.BB = MI.IN_DATA(1)
  IPES_Data.Input.W0 = MI.IN_DATA(2)
  IPES_Data.Input.GM = MI.IN_DATA(9)
  '---- Conversion from ug/g to mg/g
  IPES_Data.Output.QSAV = MO.QSAV / 1000#
  '---- Conversion from ug/g to mg/g
  IPES_Data.Output.CSAV = MO.CSAV / 1000#
  'IPES_Data.Output.CBEG = MO.CBEG / 1000#
  'IPES_Data.Output.CEND = MO.CEND / 1000#
  '---- Conversion from (ug/g)x(l/ug)^(1/n) to (mg/g)x(l/mg)^(1/n)
  IPES_Data.Output.XK1 = MO.XK1 * (1000#) ^ (MO.XNF - 1)
  '---- Conversion from (umol/g)x(l/umol)^(1/n) to (mmol/g)x(l/mmol)^(1/n)
  IPES_Data.Output.XK2 = MO.XK2 * (1000#) ^ (MO.XNF - 1)
  IPES_Data.Output.XN = MO.XNF
  'IPES_Data.Output.RSQD = MO.RSQD
  'IPES_Data.Output.RMSE = MO.RMSE
  'CURRENTLY, THE SPEQ() ROUTINE DOES NOT PROPERLY OUTPUT
  'THE VALUES FOR RSQD, RMSE, CBED, OR CEND.
  IPES_Data.Output.RSQD = 0#
  IPES_Data.Output.RMSE = 0#
  IPES_Data.Output.CBEG = 0#
  IPES_Data.Output.CEND = 0#
  'TRANSFER K AND 1/n.
  Component(0).IPESResult_K = IPES_Data.Output.XK1
  Component(0).IPESResult_OneOverN = IPES_Data.Output.XN
  'RAISE DIRTY FLAG.
  Raise_Dirty_Flag = True
  'DISPLAY RESULTS.
  Call frmModelIPEResults. _
      frmModelIPEResults_Run(SHARED_MODULECODE)
End Sub
Sub ModelIPE_SPEQ_WriteMainFile()
Dim MI As ModelIPE_SPEQ_Inputs_Type
Dim f As Integer
Dim fn_This As String
  'PREPARE INPUTS.
  'NOTE: IT IS ASSUMED THAT Component(0) CONTAINS THE
  'CHEMICAL PROPERTIES OF INTEREST.
  MI.IN_DATA(1) = Carbon.BB
  MI.IN_DATA(2) = Carbon.W0
  MI.IN_DATA(3) = Bed.Temperature + 273.15
  MI.IN_DATA(4) = Component(0).InitialConcentration * 1000#
  MI.IN_DATA(5) = Component(0).Liquid_Density
  MI.IN_DATA(6) = Component(0).MW
  MI.IN_DATA(7) = Component(0).Vapor_Pressure / 101325 * 760       'UNITS: mmHg.
  MI.IN_DATA(8) = Component(0).Refractive_Index
  MI.IN_DATA(9) = Carbon.PolanyiExponent
  MI.IN_DATA(10) = 0.000001
     'WARNING: If IN_DATA(10) (the tolerance for the SPEQ()
     'subroutine) is set to 1e-7, 1e-8, or lower, the SPEQ()
     'routine will attempt to achieve a ridiculous number of
     'significant figures.  Because 3 significant figures are
     'perhaps above the limit for most K and 1/n calculations
     'of this type, a tolerance of 1e-6 or even 1e-5 or 1e-4
     'should be used instead.
  MI.NL = SHARED_NL
  MI.XERR = 0         'I DON'T KNOW WHAT THIS VARIABLE DOES.
  'MI.XERR = CInt(SHARED_OMAG)
  'WRITE INPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelIPE_IN_Main
  Open fn_This For Output As #f
  Call WriteFortranInput(f, ModelIPE_Version, "MODULE_VERSION")
  Call WriteFortranInput(f, MI.IN_DATA(1), "IN_DATA(1), Polanyi parameter BB")
  Call WriteFortranInput(f, MI.IN_DATA(2), "IN_DATA(2), Polanyi parameter W0")
  Call WriteFortranInput(f, MI.IN_DATA(3), "IN_DATA(3), temperature, degK")
  Call WriteFortranInput(f, MI.IN_DATA(4), "IN_DATA(4), bulk concentration, ug/L")
  Call WriteFortranInput(f, MI.IN_DATA(5), "IN_DATA(5), organic density, g/cm^3")
  Call WriteFortranInput(f, MI.IN_DATA(6), "IN_DATA(6), molecular weight, g/gmol")
  Call WriteFortranInput(f, MI.IN_DATA(7), "IN_DATA(7), vapor pressure, mmHg")
  Call WriteFortranInput(f, MI.IN_DATA(8), "IN_DATA(8), refractive index, dimless")
  Call WriteFortranInput(f, MI.IN_DATA(9), "IN_DATA(9), Polanyi exponent GM, dimless")
  Call WriteFortranInput(f, MI.IN_DATA(10), "IN_DATA(10), SPEQ numerical tolerance, e.g. 1e-6, dimless")
  Call WriteFortranInput(f, MI.NL, "NL, number of regression points, dimless")
  Call WriteFortranInput(f, MI.XERR, "XERR, not sure what this does; 0 seems a good value")
  Call WriteFortranInput(f, ModelIPE_EofTestMarker, "EOFTESTMARKER")
  Close #f
  'STORE FOR LATER USE.
  ModelIPE_SPEQ_Inputs = MI
End Sub
Sub ModelIPE_SPEQ_Go(Raise_Dirty_Flag As Boolean)
  Call ModelIPE_WritePathFile(MODULECODE_SPEQ)
  Call ModelIPE_SPEQ_WriteMainFile
  Call ModelIPE_CallEXE
  Call ModelIPE_SPEQ_ProcessOutput(Raise_Dirty_Flag)
  If (ModelIO_IsKeepTempFiles() = False) Then
    Call ModelIPE_RemoveLinkFiles
  End If
End Sub


'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'////////////////    SHARED SUBROUTINES    ////////////////////////////////////////////////////////////////////////////
'//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Sub ModelIPE_CallEXE()
Dim CmdLine As String
  Call ChangeDir_Exes
  CmdLine = ModelIPE_ExeName
  Call FortranLink_ExecAndWaitForProcess(CmdLine)
  Call ChangeDir_Main
End Sub
Sub ModelIPE_WritePathFile(WhichModule As Integer)
Dim f As Integer
Dim fn_This As String
Dim qq As String
  qq = Chr$(34)
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelIPE_IN_PathFile
  Open fn_This For Output As #f
  Print #f, Trim$(Str$(WhichModule))
  Print #f, qq & ModelIPE_IN_Main & qq
  Print #f, qq & ModelIPE_OUT_SuccessFlag & qq
  Print #f, qq & ModelIPE_OUT_Main & qq
  Close #f
End Sub
Sub ModelIPE_RemoveLinkFiles()
  Call KillFile_If_Exists(Exe_Path & "\" & ModelIPE_IN_PathFile)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelIPE_IN_Main)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelIPE_OUT_SuccessFlag)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelIPE_OUT_Main)
End Sub
'RETURNS:
'    TRUE = OKAY TO USE THIS DATA.
'    FALSE = ERRORS HAVE INVALIDATED THIS DATA.
Function AllIPEModels_ErrorCheck( _
    ErrFlag As Integer, _
    ErrMat() As Integer) _
    As Boolean
Dim Ret_OkayToUse As Boolean
Dim NoMsgs As Boolean
Dim OnlyWarning As Boolean
Dim temp As String
Dim ThisMsg As String
Dim i As Integer
  Ret_OkayToUse = True
  NoMsgs = True
  OnlyWarning = False
  If ((ErrFlag <> 0) Or (ErrMat(1) <> 0)) Then
    NoMsgs = False
  End If
  If (Not NoMsgs) Then
    temp = ""
    For i = 1 To 30
      If (ErrMat(i) = 0) Then Exit For
      If (i <> 1) Then temp = temp & vbCrLf
      Select Case ErrMat(i)
        Case 11:
          ThisMsg = "11 -- ERROR: You specified a bulk concentration that is greater than the chemical's saturation concentration."
        Case 12:
          ThisMsg = "12 -- WARNING: You specified a bulk concentration " & _
              "and order of magnitude " & _
              "which define a concentration range that goes " & _
              "higher than the chemical's saturation " & _
              "concentration.  The upper limit of concentration was " & _
              "adjusted to 99% of the " & _
              "solubility concentration."
          OnlyWarning = True
        Case 13:
          ThisMsg = "13 -- ERROR: You specified inappropriate isotherm " & _
              "regression limits: CBEG > CEND."
        Case 14:
          ThisMsg = "14 -- ERROR: There was a mathematical error: " & _
              "the model tried to take the DEXP() of a number < -710."
        Case 15:
          ThisMsg = "15 -- ERROR: There was a mathematical error: " & _
              "the model tried to raise ten to a number < -710."
        Case 16:
          ThisMsg = "16 -- ERROR: The Polanyi correlation range was exceeded (QCAP < 1.0E-03)."
        Case 17:
          ThisMsg = "17 -- WARNING: Some of the highest concentrations " & _
              "in the concentration range specified are " & _
              "in the 'pore-filling' regime where " & _
              "(Pi/Ps) > 0.2, and therefore may correspond " & _
              "to capillary condensation."
          OnlyWarning = True
        Case 18:
          ThisMsg = "18 -- ERROR: You specified a bulk concentration " & _
              "that is greater than the chemical's saturation concentration."
        Case 19:
          ThisMsg = "19 -- ERROR: The upper isotherm limit exceeds the " & _
              "chemical's saturation concentration."
        Case 20:
          ThisMsg = "20 -- ERROR: Error in non-linear equation routine GOLDEN."
        Case 21:
          ThisMsg = "21 -- ERROR: The D-R correlation range was exceeded (QCAP < 1.0E-03)."
        Case Else
          ThisMsg = "Unknown error #" & Trim$(Str$(ErrMat(i)))
      End Select
      temp = temp & ThisMsg
    Next i
    If (OnlyWarning) Then
      temp = "The following warning(s) occurred:" & _
          vbCrLf & vbCrLf & temp
    Else
      temp = "The following warning(s) and/or error(s) occurred:" & _
          vbCrLf & vbCrLf & temp
    End If
    Call Show_Error(temp)
    'MsgBox "The following errors occured:" & Chr$(13) & Format$(Flag, "0") & Chr$(13) & Format$(Flag2(1), "0"), 64, Application_Name
  End If
  If ((OnlyWarning) Or (NoMsgs)) Then
    Ret_OkayToUse = True
  Else
    Ret_OkayToUse = False
  End If
  AllIPEModels_ErrorCheck = Ret_OkayToUse
End Function



Attribute VB_Name = "ModelPSDM"
Option Explicit

Const ModelPSDM_IN_PathFile = "PSDM1.IN"
Const ModelPSDM_IN_Main = "PSDM2.IN"
Const ModelPSDM_OUT_SuccessFlag = "PSDM1.OUT"
Const ModelPSDM_OUT_Main = "PSDM2.OUT"
Const ModelPSDM_OUT_CvsT = "PSDM3.OUT"

Const ModelPSDM_Version = 1#
Const ModelPSDM_ExeName = "PSDM12.EXE"
Const ModelPSDM_EofTestMarker = 123456#

Const ModelPSDM_MXCOMP = 6
Const ModelPSDM_MAXPTS = 400
Const ModelPSDM_MAXDE = 750
Private Type ModelPSDM_Inputs_Type
  NUMB As Integer
  CHEMICALS(1 To ModelPSDM_MXCOMP, 1 To 16) As Double
  ADS_PROP(1 To 4) As Double
  C_PROP(1 To 3) As Double
  TT(1 To 3) As Double
  MXX As Integer
  NXX As Integer
  TotalAxialElementCount As Integer
  N_PW As Long
  NINI As Integer
  TINI(1 To ModelPSDM_MAXPTS) As Double
End Type
Dim ModelPSDM_Inputs As ModelPSDM_Inputs_Type
'Private Type ModelPSDM_Inputs2_Type
'  CINI(1 To ModelPSDM_MXCOMP, 1 To ModelPSDM_MAXPTS) As Double
'End Type
Dim ModelPSDM_Inputs_CINI(1 To ModelPSDM_MXCOMP, 1 To ModelPSDM_MAXPTS) As Double

Private Type ModelPSDM_Outputs_Type
  VARS1(1 To 15) As Double
  VARS2(1 To ModelPSDM_MXCOMP, 1 To 19) As Double
  NITP As Integer
  T(1 To ModelPSDM_MAXPTS) As Double
  NFLAG As Integer
End Type
Dim ModelPSDM_Outputs As ModelPSDM_Outputs_Type
'Private Type ModelPSDM_Outputs2_Type
'  CPVB(1 To ModelPSDM_MXCOMP, 1 To ModelPSDM_MAXPTS) As Double
'End Type
Dim ModelPSDM_Outputs_CPVB(1 To ModelPSDM_MXCOMP, 1 To ModelPSDM_MAXPTS) As Double





Const ModelPSDM_declarations_end = True


Sub ModelPSDM_Go()
Dim Failed As Boolean
  Call ModelPSDM_WritePathFile
  Call ModelPSDM_WriteMainFile(Failed)
  If (Failed) Then Exit Sub
  Call ModelPSDM_CallEXE
  Call ModelPSDM_ProcessOutput
  If (ModelIO_IsKeepTempFiles() = False) Then
    Call ModelPSDM_RemoveLinkFiles
  End If
End Sub


Sub ModelPSDM_RemoveLinkFiles()
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDM_IN_PathFile)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDM_IN_Main)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDM_OUT_SuccessFlag)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDM_OUT_Main)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDM_OUT_CvsT)
End Sub
Sub ModelPSDM_CallEXE()
Dim CmdLine As String
  Call ChangeDir_Exes
  CmdLine = ModelPSDM_ExeName
  Call ModelIO_Timer_Start
  Call FortranLink_ExecAndWaitForProcess(CmdLine)
  Call ModelIO_Timer_End
  Call ChangeDir_Main
End Sub
Sub ModelPSDM_ProcessOutput()
Dim f As Integer
Dim fn_This As String
Dim NFLAG As Integer
Dim DummyStr1 As String
Dim temp As String
Dim i As Integer
Dim j As Integer
Dim EOFTESTMARKER As Double
Dim Flag05 As Boolean
Dim Flag50 As Boolean
Dim Flag95 As Boolean
Dim MI As ModelPSDM_Inputs_Type
Dim MO As ModelPSDM_Outputs_Type
  MI = ModelPSDM_Inputs
  'READ SUCCESS FLAG OUTPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelPSDM_OUT_SuccessFlag
  If (Not FileExists(fn_This)) Then
    Call Show_Error("Unable to find output file: Calculations failed.")
    Exit Sub
  End If
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, NFLAG
  Close #f
  If (NFLAG <> 0) Then
    Select Case NFLAG
      Case 15
        temp = "WARNING...  T + H = T ON NEXT STEP"
      Case 105
        temp = "KFLAG = -1 FROM INTEGRATOR"
      Case 115
        temp = "H HAS BEEN REDUCED TO AND STEP WILL BE RETRIED"
      Case 155
        temp = "PROBLEM APPEARS UNSOLVABLE WITH GIVEN INPUT"
      Case 205
        temp = "THE REQUESTED ERROR IS SMALLER THAN CAN BE HANDLED"
      Case 255
        temp = "INTEGRATION HALTED BY DRIVER EPS TOO SMALL TO BE ATTAINED FOR THE MACHINE PRECISION"
      Case 305
        temp = "CORRECTOR CONVERGENCE COULD NOT BE ACHIEVED"
      Case 405
        temp = "ILLEGAL INPUT... EPS < 0"
      Case 415
        temp = "ILLEGAL INPUT... N <= 0"
      Case 425
        temp = "ILLEGAL INPUT... (T0-TOUT)*H >= 0"
      Case 435
        temp = "ILLEGAL INPUT... INDEX"
      Case 445
        temp = "INTERPOLATION WAS DONE AS ON NORMAL RETURN; DESIRED PARAMETER CHANGES WERE NOT MADE."
      Case Else
        temp = "Unknown Error"
    End Select
    temp = "Error #" & Trim$(Str$(NFLAG)) & ": " & temp
    Call Show_Error("The PSDM failed to converge." & vbCrLf & temp)
    Exit Sub
  Else
    Call Show_Message( _
        "PSDM Model Calculations Complete." & _
        vbCrLf & _
        vbCrLf & _
        ModelIO_Timer_SummaryMsg)
  End If
  'READ MAIN OUTPUT FILE.
  fn_This = Exe_Path & "\" & ModelPSDM_OUT_Main
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  For i = 1 To 15
    Input #f, MO.VARS1(i)
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MI.NUMB
    For j = 1 To 19
      Input #f, MO.VARS2(i, j)
    Next j
  Next i
  Line Input #f, DummyStr1
  Input #f, MO.NFLAG
  Line Input #f, DummyStr1
  Input #f, EOFTESTMARKER
  If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelPSDM_EofTestMarker)) Then
    Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
    Exit Sub
  End If
  Close #f
  'READ C-vs-t OUTPUT FILE.
  fn_This = Exe_Path & "\" & ModelPSDM_OUT_CvsT
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, MO.NITP
  Line Input #f, DummyStr1
  For i = 1 To MO.NITP
    Input #f, MO.T(i)
  Next i
  Line Input #f, DummyStr1
  For i = 1 To MI.NUMB
    For j = 1 To MO.NITP
      'Input #f, MO.CPVB(i, j)
      Input #f, ModelPSDM_Outputs_CPVB(i, j)
    Next j
  Next i
  Line Input #f, DummyStr1
  Input #f, EOFTESTMARKER
  If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelPSDM_EofTestMarker)) Then
    Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
    Exit Sub
  End If
  Close #f
  ModelPSDM_Outputs = MO
  'TRANSFER OUTPUT DATA TO MORE PERMANENT MEMORY.
  Results.is_psdm_in_room_model = False
  Results.npoints = MO.NITP
  Results.NComponent = MI.NUMB
  Results.Bed = Bed
  Results.Carbon = Carbon
  For i = 1 To 15
    PSDM_Inputs.VARS1(i) = MO.VARS1(i)
  Next i
  PSDM_Inputs.VARS1(8) = SF() * 264.17205 * 60 / 10.76391         'Convert m/s to gal/min-ft^2.
  PSDM_Inputs.VARS1(11) = Re()
  PSDM_Inputs.VARS1(12) = Bed.WaterDensity
  PSDM_Inputs.VARS1(13) = Bed.WaterViscosity
  For i = 1 To Number_Component_PFPSDM
    For j = 1 To 18
      PSDM_Inputs.VARS2(i, j) = MO.VARS2(i, j)
    Next j
    PSDM_Inputs.VARS2(i, 6) = Diffl(i)
    PSDM_Inputs.VARS2(i, 18) = SC(i)
    j = Component_Index_PFPSDM(i)
    PSDM_Inputs.VARS2(i, 19) = Component(j).SPDFR
  Next i
  'DETERMINE 5%, 50%, AND 95% SATURATION TIMES.
  Flag05 = True
  Flag50 = True
  Flag95 = True
  ReDim BrokeThrough(1 To Number_Component_PFPSDM) As Integer
  Dim IsFoulingCase As Integer
  'ReDim NumPoints_Before_BrokeThrough(Number_Component_PFPSDM) As Integer
  For i = 1 To Number_Component_PFPSDM
    BrokeThrough(i) = False
    'NumPoints_Before_BrokeThrough(i) = -1
    Results.NumPoints_Before_ThroughPut_100(i) = MO.NITP
  Next i
  IsFoulingCase = False
  For i = 1 To Number_Component_PFPSDM
    j = Component_Index_PFPSDM(i)
    If (Component(j).K_Reduction) Then
      IsFoulingCase = True
    End If
  Next i
  For i = 1 To Number_Component_PFPSDM
    Results.Component(i) = Component(Component_Index_PFPSDM(i))
    For j = 1 To MO.NITP
     If (((IsFoulingCase) And (ModelPSDM_Outputs_CPVB(i, j) > 0.9995)) Or (BrokeThrough(i))) Then
       '---- Stop the plot as soon as C/C0>=0.9995; this is accomplished
       '.... by setting .CP = -10000#, which tells the plotting routine to
       '.... stop plotting.
       Results.CP(i, j) = -10000#
       If (Not BrokeThrough(i)) Then
         Results.NumPoints_Before_ThroughPut_100(i) = j - 1
       End If
       BrokeThrough(i) = True
       ''---- Assume C/C0=1.0 as soon as C/C0>=0.9995
       'Results.CP(i, j) = 1#
       'If (Not BrokeThrough(i)) Then
       '  Results.NumPoints_Before_ThroughPut_100(i) = j - 1
       'End If
       'BrokeThrough(i) = True
       ''NumPoints_Before_BrokeThrough(i) = j - 1
     Else
       Results.CP(i, j) = ModelPSDM_Outputs_CPVB(i, j)
     End If
     If j > 2 Then
       If (ModelPSDM_Outputs_CPVB(i, j) >= 0.05) And (ModelPSDM_Outputs_CPVB(i, j - 1) < 0.05) And Flag05 Then
          Results.ThroughPut_05(i).T = _
              (MO.T(j) - MO.T(j - 1)) / _
              (ModelPSDM_Outputs_CPVB(i, j) - ModelPSDM_Outputs_CPVB(i, j - 1)) * (0.05 - ModelPSDM_Outputs_CPVB(i, j - 1)) + MO.T(j - 1)
          Results.ThroughPut_05(i).C = _
              ((ModelPSDM_Outputs_CPVB(i, j) - ModelPSDM_Outputs_CPVB(i, j - 1)) / (MO.T(j) - MO.T(j - 1)) * _
              (Results.ThroughPut_05(i).T - MO.T(j - 1)) + ModelPSDM_Outputs_CPVB(i, j - 1)) * _
              Component(Component_Index_PFPSDM(i)).InitialConcentration
          Flag05 = False
       End If
       If (ModelPSDM_Outputs_CPVB(i, j) >= 0.5) And (ModelPSDM_Outputs_CPVB(i, j - 1) < 0.5) And Flag50 Then
          Results.ThroughPut_50(i).T = _
              (MO.T(j) - MO.T(j - 1)) / _
              (ModelPSDM_Outputs_CPVB(i, j) - ModelPSDM_Outputs_CPVB(i, j - 1)) * (0.5 - ModelPSDM_Outputs_CPVB(i, j - 1)) + MO.T(j - 1)
          Results.ThroughPut_50(i).C = _
              ((ModelPSDM_Outputs_CPVB(i, j) - ModelPSDM_Outputs_CPVB(i, j - 1)) / (MO.T(j) - MO.T(j - 1)) * _
              (Results.ThroughPut_50(i).T - MO.T(j - 1)) + ModelPSDM_Outputs_CPVB(i, j - 1)) * _
              Component(Component_Index_PFPSDM(i)).InitialConcentration
          Flag50 = False
          If Flag05 Then
            Results.ThroughPut_05(i).T = -1#
            Results.ThroughPut_05(i).C = -1#
            Flag05 = False
          End If
       End If
       If (ModelPSDM_Outputs_CPVB(i, j) >= 0.95) And (ModelPSDM_Outputs_CPVB(i, j - 1) < 0.95) And Flag95 Then
          Results.ThroughPut_95(i).T = _
              (MO.T(j) - MO.T(j - 1)) / _
              (ModelPSDM_Outputs_CPVB(i, j) - ModelPSDM_Outputs_CPVB(i, j - 1)) * (0.95 - ModelPSDM_Outputs_CPVB(i, j - 1)) + MO.T(j - 1)
          Results.ThroughPut_95(i).C = _
              ((ModelPSDM_Outputs_CPVB(i, j) - ModelPSDM_Outputs_CPVB(i, j - 1)) / (MO.T(j) - MO.T(j - 1)) * _
              (Results.ThroughPut_95(i).T - MO.T(j - 1)) + ModelPSDM_Outputs_CPVB(i, j - 1)) * _
              Component(Component_Index_PFPSDM(i)).InitialConcentration
          Flag95 = False
          If Flag50 Then
            Results.ThroughPut_50(i).T = -1#
            Results.ThroughPut_50(i).C = -1#
            Flag50 = False
          End If
          If Flag05 Then
            Results.ThroughPut_05(i).T = -1#
            Results.ThroughPut_05(i).C = -1#
            Flag05 = False
          End If
       End If
     End If
    Next j
    If Flag95 Then
       Results.ThroughPut_95(i).T = -1#
       Results.ThroughPut_95(i).C = -1#
       Flag95 = False
    End If
    If Flag50 Then
       Results.ThroughPut_50(i).T = -1#
       Results.ThroughPut_50(i).C = -1#
       Flag50 = False
    End If
    If Flag05 Then
       Results.ThroughPut_05(i).T = -1#
       Results.ThroughPut_05(i).C = -1#
       Flag05 = False
    End If
    Flag05 = True  'Set these flags to True such that
    Flag50 = True  ' Results.ThroughPut_??(I).T and Results.ThroughPut_??(I).C
    Flag95 = True  ' are calculated for the next compound
  Next i
  For i = 1 To Number_Points_Max
    Results.T(i) = MO.T(i)
  Next i
  'ENABLE RESULTS MENU COMMANDS.
  frmMain.mnuResultsItem(0).Enabled = True
  If (NData_Points > 0) Then
    frmMain.mnuResultsItem(3).Enabled = True
  End If
End Sub
Sub ModelPSDM_WriteMainFile(Failed As Boolean)
Dim MI As ModelPSDM_Inputs_Type
Dim i As Integer
Dim j As Integer
Dim Number_Equations As Integer
Dim WorkSpace_Size As Long
Dim msg As String
Dim f As Integer
Dim fn_This As String
  Failed = False
  'CALCULATE WORKSPACE SIZE.
  Number_Equations = Number_Component_PFPSDM * (MC * (NC + 1) - 1)
  If Number_Equations > Max_Equations_DGEAR Then
    msg = "Maximum number of equations PSDM can solve = " & Str$(Max_Equations_DGEAR) & vbCrLf
    msg = msg & "Current number of equations specified for PSDM to solve = " & Str$(Number_Equations) & vbCrLf & vbCrLf
    msg = msg & "(No. of Equations PSDM Must Solve) = NCOMP*(MC*(NC+1)-1)" & vbCrLf & vbCrLf
    msg = msg & "Please ensure that this number does not exceed the maximum." & vbCrLf & vbCrLf
    msg = msg & "Note:  " & vbCrLf
    msg = msg & "    NCOMP = Number of Components = " & Str$(Number_Component_PFPSDM) & vbCrLf
    msg = msg & "    MC = Number of Axial Collocation Points = " & Str$(MC) & vbCrLf
    msg = msg & "    NC = Number of Radial Collocation Points = " & Str$(NC) & vbCrLf
    Call Show_Error(msg)
    Failed = True
    Exit Sub
  End If
  WorkSpace_Size = Number_Equations ^ 2 + 2 * Number_Equations
  'PREPARE INPUTS.
  MI.NUMB = Number_Component_PFPSDM
  For i = 1 To MI.NUMB
    j = Component_Index_PFPSDM(i)
    MI.CHEMICALS(i, 1) = Component(j).MW
    'CONVERT Co FROM mg/L TO ug/L.
    MI.CHEMICALS(i, 2) = Component(j).InitialConcentration * 1000#
    MI.CHEMICALS(i, 3) = Component(j).MolarVolume
    'CONVERT K FROM (mg/g)*(L/mg)^(1/n) to (umol/g)*(L/umol)^(1/n).
    MI.CHEMICALS(i, 4) = Component(j).Use_K * (1000# / Component(j).MW) ^ (1# - Component(j).Use_OneOverN)
    MI.CHEMICALS(i, 5) = Component(j).Use_OneOverN
    MI.CHEMICALS(i, 6) = Component(j).kf
    MI.CHEMICALS(i, 7) = Component(j).Ds
    MI.CHEMICALS(i, 8) = Component(j).Dp
    If (Bed.Phase = 0) Then
      If (Component(j).K_Reduction) And _
          (Bed.Water_Correlation.Coeff(1) <> 1# And Bed.Water_Correlation.Coeff(2) <> 0# And _
          Bed.Water_Correlation.Coeff(3) <> 0# And Bed.Water_Correlation.Coeff(4) <> 0#) Then
        MI.CHEMICALS(i, 9) = Bed.Water_Correlation.Coeff(1) * Component(j).Correlation.Coeff(1) + _
            Component(j).Correlation.Coeff(2)
        MI.CHEMICALS(i, 10) = Bed.Water_Correlation.Coeff(2) * Component(j).Correlation.Coeff(1)
        MI.CHEMICALS(i, 11) = Bed.Water_Correlation.Coeff(3) * Component(j).Correlation.Coeff(1)
        MI.CHEMICALS(i, 12) = Bed.Water_Correlation.Coeff(4) * Component(j).Correlation.Coeff(1)
      Else
        MI.CHEMICALS(i, 9) = 1#
        MI.CHEMICALS(i, 10) = 0#
        MI.CHEMICALS(i, 11) = 0#
        MI.CHEMICALS(i, 12) = 0#
      End If
    Else
      MI.CHEMICALS(i, 9) = 1#
      MI.CHEMICALS(i, 10) = 0#
      MI.CHEMICALS(i, 11) = 0#
      MI.CHEMICALS(i, 12) = 0#
    End If
    MI.CHEMICALS(i, 13) = Component(j).Tortuosity
    If ((Component(j).Constant_Tortuosity) And (Component(j).Use_Tortuosity_Correlation)) Then
      MI.CHEMICALS(i, 14) = 2#
      MI.CHEMICALS(i, 15) = 0#
    Else
      If (Component(j).Use_Tortuosity_Correlation) Then
        MI.CHEMICALS(i, 14) = 0.334
        MI.CHEMICALS(i, 15) = 0.00000661
      Else
        MI.CHEMICALS(i, 14) = 2#
        MI.CHEMICALS(i, 15) = 0#
      End If
    End If
    MI.CHEMICALS(i, 16) = 100000#       'in minutes
  Next i
  'NOTE: ADJUSTMENT OF LENGTH AND DIAMETER IS NOW PERFORMED
  'INSIDE THE FORTRAN MODULE.
  ''''MI.ADS_PROP(1) = Bed.Length / CDbl(Bed.NumberOfBeds)
  MI.ADS_PROP(1) = Bed.length
  MI.ADS_PROP(2) = Bed.Diameter
  ''''MI.ADS_PROP(3) = Bed.Weight / CDbl(Bed.NumberOfBeds)
  MI.ADS_PROP(3) = Bed.Weight
  MI.ADS_PROP(4) = Bed.Flowrate
  'If (only_make_input_file) Then
  '  ADS_PROP(1) = ADS_PROP(1) * CDbl(Bed.NumberOfBeds)
  '  ADS_PROP(3) = ADS_PROP(3) * CDbl(Bed.NumberOfBeds)
  'End If
  MI.C_PROP(1) = Carbon.Porosity
  MI.C_PROP(2) = Carbon.Density
  MI.C_PROP(3) = Carbon.ParticleRadius * 100#      'To convert in cm
  MI.TT(1) = TimeP.End
  'Test value of Tinit
  If (TimeP.Init <= 0#) Then
    MI.TT(2) = 0.0001
  Else
    MI.TT(2) = TimeP.Init
  End If
  MI.TT(3) = TimeP.Step
  MI.MXX = MC
  MI.NXX = NC
  MI.TotalAxialElementCount = Bed.NumberOfBeds
  MI.N_PW = WorkSpace_Size
  MI.NINI = Number_Influent_Points
  For j = 1 To MI.NINI
    MI.TINI(j) = T_Influent(j)
    For i = 1 To MI.NUMB
      'CONVERT FROM mg/L TO ug/L.
      ModelPSDM_Inputs_CINI(i, j) = C_Influent(Component_Index_PFPSDM(i), j) * 1000#
    Next i
  Next j
  'WRITE INPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelPSDM_IN_Main
  Open fn_This For Output As #f
  Call WriteFortranInput(f, ModelPSDM_Version, "MODULE_VERSION")
  Call WriteFortranInput(f, MI.NUMB, "NUMB, number of chemicals in simulation")
  For i = 1 To MI.NUMB
    Call WriteFortranInput(f, MI.CHEMICALS(i, 1), "CHEMICALS(" & Trim$(Str$(i)) & ",1), molecular weight, g/gmol")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 2), "CHEMICALS(" & Trim$(Str$(i)) & ",2), influent concentration, ug/L")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 3), "CHEMICALS(" & Trim$(Str$(i)) & ",3), molar volume, cm^3/gmol")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 4), "CHEMICALS(" & Trim$(Str$(i)) & ",4), Freundlich K, (umol/g)*(L/umol)^(1/n)")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 5), "CHEMICALS(" & Trim$(Str$(i)) & ",5), Freundlich 1/n, dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 6), "CHEMICALS(" & Trim$(Str$(i)) & ",6), film transfer coefficient (kf), cm/s ")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 7), "CHEMICALS(" & Trim$(Str$(i)) & ",7), surface diffusion coefficient (Ds), cm^2/s")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 8), "CHEMICALS(" & Trim$(Str$(i)) & ",8), pore diffusion coefficient (Dp), cm^2/s")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 9), "CHEMICALS(" & Trim$(Str$(i)) & ",9) = RK1(" & Trim$(Str$(i)) & "), fouling correlation coef. #1, dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 10), "CHEMICALS(" & Trim$(Str$(i)) & ",10) = RK2(" & Trim$(Str$(i)) & "), fouling correlation coef. #2, 1/min")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 11), "CHEMICALS(" & Trim$(Str$(i)) & ",11) = RK3(" & Trim$(Str$(i)) & "), fouling correlation coef. #3, dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 12), "CHEMICALS(" & Trim$(Str$(i)) & ",12) = RK4(" & Trim$(Str$(i)) & "), fouling correlation coef. #4, 1/min")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 13), "CHEMICALS(" & Trim$(Str$(i)) & ",13) = TORTU(" & Trim$(Str$(i)) & "), tortuosity (never used?), dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 14), "CHEMICALS(" & Trim$(Str$(i)) & ",14) = TOR(" & Trim$(Str$(i)) & "), tortuosity coef., dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 15), "CHEMICALS(" & Trim$(Str$(i)) & ",15) = PART(" & Trim$(Str$(i)) & "), part. coef., dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 16), "CHEMICALS(" & Trim$(Str$(i)) & ",16) = TTORTU(" & Trim$(Str$(i)) & "), time parameter, min")
  Next i
  Call WriteFortranInput(f, MI.ADS_PROP(1), "ADS_PROP(1), length of bed, m")
  Call WriteFortranInput(f, MI.ADS_PROP(2), "ADS_PROP(2), diameter of bed, m")
  Call WriteFortranInput(f, MI.ADS_PROP(3), "ADS_PROP(3), weight of adsorbent in bed, kg")
  Call WriteFortranInput(f, MI.ADS_PROP(4), "ADS_PROP(4), influent flow rate, m^3/s")
  Call WriteFortranInput(f, MI.C_PROP(1), "C_PROP(1), particle void fraction, dimless")
  Call WriteFortranInput(f, MI.C_PROP(2), "C_PROP(2), particle density, g/cm^3")
  Call WriteFortranInput(f, MI.C_PROP(3), "C_PROP(3), particle radius, cm")
  Call WriteFortranInput(f, MI.TT(1), "TT(1), time to end simulation, minutes")
  Call WriteFortranInput(f, MI.TT(2), "TT(2), time to begin simulation, minutes")
  Call WriteFortranInput(f, MI.TT(3), "TT(3), time step, minutes")
  Call WriteFortranInput(f, MI.MXX, "MXX, number of axial collocation points, dimless")
  Call WriteFortranInput(f, MI.NXX, "NXX, number of radial collocation points, dimless")
  Call WriteFortranInput(f, MI.TotalAxialElementCount, "TotalAxialElementCount, number of axial elements, dimless")
  Call WriteFortranInput(f, MI.N_PW, "N_PW, equation workspace size, bytes")
  Call WriteFortranInput(f, MI.NINI, "NINI, number of influent concentration points, dimless")
  Print #f, "TINI(i), time profile for CINI() array, minutes"
  For i = 1 To MI.NINI
    Print #f, MI.TINI(i)
  Next i
  Print #f, "CINI(i,j), influent concentration profile, ug/L"
  For i = 1 To MI.NUMB
    For j = 1 To MI.NINI
      Print #f, ModelPSDM_Inputs_CINI(i, j)
    Next j
  Next i
  Call WriteFortranInput(f, ModelPSDM_EofTestMarker, "EOFTESTMARKER")
  Close #f
  'STORE FOR LATER USE.
  ModelPSDM_Inputs = MI
End Sub
Sub ModelPSDM_WritePathFile()
Dim f As Integer
Dim fn_This As String
Dim qq As String
  qq = Chr$(34)
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelPSDM_IN_PathFile
  Open fn_This For Output As #f
  Print #f, qq & ModelPSDM_IN_Main & qq
  Print #f, qq & ModelPSDM_OUT_SuccessFlag & qq
  Print #f, qq & ModelPSDM_OUT_Main & qq
  Print #f, qq & ModelPSDM_OUT_CvsT & qq
  Close #f
End Sub


'Return value:
'  TRUE = Okay to call the PSDM
'  FALSE = Something went wrong, ABORT!  ABORT!
Function Prepare_To_Run_PSDM() As Integer
Dim i As Integer
Dim j As Integer
Dim Num_K_Reduction As Integer
Dim Num_A_and_Not_B As Integer
Dim Num_Not_a_and_B As Integer
ReDim Name_A_and_Not_B(1 To Number_Compo_Max) As String
ReDim Name_Not_A_and_B(1 To Number_Compo_Max) As String
Dim Is_A As Integer
Dim Is_B As Integer
Dim msg As String
Dim RetVal As Integer
  '
  ' PERFORM SEVERAL VERIFICATIONS BEFORE RUNNING THE PSDM.
  '
  If (TimeP.Init > TimeP.End) Then
    Call Show_Error("The initial simulation time (" & _
        TimeP.Init / 24# / 60# & " days) is greater than the " & _
        "final simulation time (" & TimeP.End / 24# / 60# & _
        " days).  PSDM cannot be run until this is fixed.")
    Prepare_To_Run_PSDM = False
    Exit Function
  End If
  If (TimeP.Step < ((TimeP.End - TimeP.Init) / _
      (Number_Points_Max - 1))) Then
    Call Show_Error("The simulation time step (" & _
        TimeP.Step / 24# / 60# & " days) is too small.  The " & _
        "maximum number of points is 400.  PSDM cannot be run " & _
        "until this is fixed.")
    Prepare_To_Run_PSDM = False
    Exit Function
  End If
  Call AllModels_Verify_Selected_Components(MODELTYPE_PSDM)
  If (Number_Component_PFPSDM = 0) Then
    Prepare_To_Run_PSDM = False
    Exit Function
  End If
  For i = 1 To Number_Component_PFPSDM
    For j = i + 1 To Number_Component_PFPSDM
      If Trim$(Component(Component_Index_PFPSDM(i)).Name) = _
          Trim$(Component(Component_Index_PFPSDM(j)).Name) Then
        Call Show_Error("Components " & _
            Format$(Component_Index_PFPSDM(i), "0") & " and " & _
            Format$(Component_Index_PFPSDM(j), "0") & _
            " have the same name." & vbCrLf & _
            "Please change one before running the PSDM.")
        Prepare_To_Run_PSDM = False
        Exit Function
      End If
    Next j
  Next i
  '
  '---- Make sure # PSDM fouling components is <= 1.
  '
  Num_K_Reduction = 0
  For i = 0 To frmMain.lstComponents.ListCount - 1
    If (frmMain.lstComponents.Selected(i)) Then
      If (Component(i + 1).K_Reduction) Then
        Num_K_Reduction = Num_K_Reduction + 1
      End If
    End If
  Next i
  If (Num_K_Reduction > 1) Then
    Call Show_Error("There are currently " & _
        Trim$(Str$(Num_K_Reduction)) & _
        " components specified for fouling.  Only 1 may be " & _
        "specified for a run of the PSDM.")
    Prepare_To_Run_PSDM = False
    Exit Function
  End If
  '
  '---- Show warning if A and not B, or not A and B,
  '.... for any component where:
  '.... A = pore diffusion correlation for tortuosity selected
  '.... B = fouling correlation selected
  '
  Num_A_and_Not_B = 0
  Num_Not_a_and_B = 0
  For i = 0 To frmMain.lstComponents.ListCount - 1
    If (frmMain.lstComponents.Selected(i)) Then
      Is_A = (Component(i + 1).Use_Tortuosity_Correlation)
      Is_B = (Component(i + 1).K_Reduction)
      '---- Check for A and not B case:
      If ((Is_A) And (Not Is_B)) Then
        Num_A_and_Not_B = Num_A_and_Not_B + 1
        Name_A_and_Not_B(Num_A_and_Not_B) = Trim$(Component(i + 1).Name)
      End If
      '---- Check for not A and B case:
      If ((Not Is_A) And (Is_B)) Then
        Num_Not_a_and_B = Num_Not_a_and_B + 1
        Name_Not_A_and_B(Num_Not_a_and_B) = Trim$(Component(i + 1).Name)
      End If
    End If
  Next i
  If ((Num_A_and_Not_B > 0) Or (Num_Not_a_and_B > 0)) Then
    msg = "Warning:" & vbCrLf
    If (Num_A_and_Not_B > 0) Then
      msg = msg & vbCrLf
      msg = msg & "The following components have the pore diffusion "
      msg = msg & "correlation for tortuosity selected, but no "
      msg = msg & "fouling correlation selected:"
      msg = msg & vbCrLf
      For i = 1 To Num_A_and_Not_B
        msg = msg & "    " & Name_A_and_Not_B(i)
        msg = msg & vbCrLf
      Next i
    End If
    If (Num_Not_a_and_B > 0) Then
      msg = msg & vbCrLf
      msg = msg & "The following components have the pore diffusion "
      msg = msg & "correlation for tortuosity NOT selected, but a "
      msg = msg & "fouling correlation is selected:"
      msg = msg & vbCrLf
      For i = 1 To Num_Not_a_and_B
        msg = msg & "    " & Name_Not_A_and_B(i)
        msg = msg & vbCrLf
      Next i
    End If
    msg = msg & vbCrLf
    msg = msg & "This configuration is not the recommended way to run "
    msg = msg & "the PSDM.  It is recommended that you either (a) "
    msg = msg & "turn both correlations on or (b) "
    msg = msg & "turn both correlations off.  Do you wish to proceed "
    msg = msg & "with this currently-specified PSDM run anyway?"
    RetVal = MsgBox(msg, vbQuestion + vbYesNo, Application_Name)
    If (RetVal = vbNo) Then
      Prepare_To_Run_PSDM = False
      Exit Function
    End If
  End If
  Prepare_To_Run_PSDM = True
End Function



Attribute VB_Name = "ModelPSDMInRoom"
Option Explicit

Const ModelPSDMInRoom_IN_PathFile = "PROOM1.IN"
Const ModelPSDMInRoom_IN_Main = "PROOM2.IN"
Const ModelPSDMInRoom_OUT_SuccessFlag = "PROOM1.OUT"
Const ModelPSDMInRoom_OUT_Main = "PROOM2.OUT"
Const ModelPSDMInRoom_OUT_CvsT = "PROOM3.OUT"

Const ModelPSDMInRoom_Version = 1#
Const ModelPSDMInRoom_ExeName = "PROOM10C.EXE"
''''Const ModelPSDMInRoom_EofTestMarker = 123456#
Const ModelPSDMInRoom_EofTestMarker = 12345.678

Const ModelPSDMInRoom_MXCOMP = 6
Const ModelPSDMInRoom_MAXPTS = 400
Const ModelPSDMInRoom_MAXDE = 750
Private Type ModelPSDMInRoom_Inputs_Type
  NUMB As Integer
  CHEMICALS(1 To ModelPSDMInRoom_MXCOMP, 1 To 16) As Double
  INITIAL_ROOM_CONC(1 To ModelPSDMInRoom_MXCOMP) As Double
  ADS_PROP(1 To 4) As Double
  C_PROP(1 To 3) As Double
  TT(1 To 3) As Double
  MXX As Integer
  NXX As Integer
  TotalAxialElementCount As Integer
  N_PW As Long
  NINI As Integer
  TINI(1 To ModelPSDMInRoom_MAXPTS) As Double
  ROOM_VOL As Double        'cm^3
  ROOM_FLOWRATE As Double   'cm^3/s
  ROOM_C0(1 To ModelPSDMInRoom_MXCOMP) As Double                'ug/L
  ROOM_EMIT(1 To ModelPSDMInRoom_MXCOMP) As Double              'ug/s
  FN_MASSBAL_OUT As String
  FN_CR_OUT As String
  FN_CB_OUT As String
End Type
Dim ModelPSDMInRoom_Inputs As ModelPSDMInRoom_Inputs_Type
'Private Type ModelPSDMInRoom_Inputs2_Type
'  CINI(1 To ModelPSDMInRoom_MXCOMP, 1 To ModelPSDMInRoom_MAXPTS) As Double
'End Type
Dim ModelPSDMInRoom_Inputs_CINI(1 To ModelPSDMInRoom_MXCOMP, 1 To ModelPSDMInRoom_MAXPTS) As Double

Private Type ModelPSDMInRoom_Outputs_Type
  VARS1(1 To 15) As Double
  VARS2(1 To ModelPSDMInRoom_MXCOMP, 1 To 19) As Double
  NITP As Integer
  T(1 To ModelPSDMInRoom_MAXPTS) As Double
  NFLAG As Integer
End Type
Dim ModelPSDMInRoom_Outputs As ModelPSDMInRoom_Outputs_Type
'Private Type ModelPSDMInRoom_Outputs2_Type
'  CPVB(1 To ModelPSDMInRoom_MXCOMP, 1 To ModelPSDMInRoom_MAXPTS) As Double
'End Type
Dim ModelPSDMInRoom_Outputs_CPVB(1 To ModelPSDMInRoom_MXCOMP, 1 To ModelPSDMInRoom_MAXPTS) As Double





Const ModelPSDMInRoom_declarations_end = True


Sub ModelPSDMInRoom_Go()
Dim Failed As Boolean
  Call ModelPSDMInRoom_RemoveLinkFiles
  Call ModelPSDMInRoom_WritePathFile
  Call ModelPSDMInRoom_WriteMainFile(Failed)
  If (Failed) Then Exit Sub
  Call ModelPSDMInRoom_CallEXE
  Call ModelPSDMInRoom_ProcessOutput
  If (ModelIO_IsKeepTempFiles() = False) Then
    Call ModelPSDMInRoom_RemoveLinkFiles
  End If
End Sub


Sub ModelPSDMInRoom_RemoveLinkFiles()
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDMInRoom_IN_PathFile)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDMInRoom_IN_Main)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDMInRoom_OUT_SuccessFlag)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDMInRoom_OUT_Main)
  Call KillFile_If_Exists(Exe_Path & "\" & ModelPSDMInRoom_OUT_CvsT)
End Sub
Sub ModelPSDMInRoom_CallEXE()
Dim CmdLine As String
  Call ChangeDir_Exes
  CmdLine = ModelPSDMInRoom_ExeName
  Call ModelIO_Timer_Start
  Call FortranLink_ExecAndWaitForProcess(CmdLine)
  Call ModelIO_Timer_End
  Call ChangeDir_Main
End Sub
Sub ModelPSDMInRoom_ProcessOutput()
Dim f As Integer
Dim fn_This As String
Dim NFLAG As Integer
Dim DummyStr1 As String
Dim temp As String
Dim i As Integer
Dim j As Integer
Dim k As Integer
Dim EOFTESTMARKER As Double
Dim Flag05 As Boolean
Dim Flag50 As Boolean
Dim Flag95 As Boolean
Dim MI As ModelPSDMInRoom_Inputs_Type
Dim MO As ModelPSDMInRoom_Outputs_Type
  MI = ModelPSDMInRoom_Inputs
  'READ SUCCESS FLAG OUTPUT FILE.
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelPSDMInRoom_OUT_SuccessFlag
  If (Not FileExists(fn_This)) Then
    Call Show_Error("Unable to find output file: Calculations failed.")
    Exit Sub
  End If
  Open fn_This For Input As #f
  Line Input #f, DummyStr1
  Input #f, NFLAG
  Close #f
  If (NFLAG <> 0) Then
    Select Case NFLAG
      Case 15
        temp = "WARNING...  T + H = T ON NEXT STEP"
      Case 105
        temp = "KFLAG = -1 FROM INTEGRATOR"
      Case 115
        temp = "H HAS BEEN REDUCED TO AND STEP WILL BE RETRIED"
      Case 155
        temp = "PROBLEM APPEARS UNSOLVABLE WITH GIVEN INPUT"
      Case 205
        temp = "THE REQUESTED ERROR IS SMALLER THAN CAN BE HANDLED"
      Case 255
        temp = "INTEGRATION HALTED BY DRIVER EPS TOO SMALL TO BE ATTAINED FOR THE MACHINE PRECISION"
      Case 305
        temp = "CORRECTOR CONVERGENCE COULD NOT BE ACHIEVED"
      Case 405
        temp = "ILLEGAL INPUT... EPS < 0"
      Case 415
        temp = "ILLEGAL INPUT... N <= 0"
      Case 425
        temp = "ILLEGAL INPUT... (T0-TOUT)*H >= 0"
      Case 435
        temp = "ILLEGAL INPUT... INDEX"
      Case 445
        temp = "INTERPOLATION WAS DONE AS ON NORMAL RETURN; DESIRED PARAMETER CHANGES WERE NOT MADE."
      Case Else
        temp = "Unknown Error"
    End Select
    temp = "Error #" & Trim$(Str$(NFLAG)) & ": " & temp
    Call Show_Error("The PSDM failed to converge." & vbCrLf & temp)
    Exit Sub
  Else
    Call Show_Message( _
        "PSDM Model Calculations Complete." & _
        vbCrLf & _
        vbCrLf & _
        ModelIO_Timer_SummaryMsg)
  End If
  ''READ MAIN OUTPUT FILE.
  'fn_This = Exe_Path & "\" & ModelPSDMInRoom_OUT_Main
  'Open fn_This For Input As #f
  'Line Input #f, DummyStr1
  'For i = 1 To 15
  '  Input #f, MO.VARS1(i)
  'Next i
  'Line Input #f, DummyStr1
  'For i = 1 To MI.NUMB
  '  For j = 1 To 19
  '    Input #f, MO.VARS2(i, j)
  '  Next j
  'Next i
  'Line Input #f, DummyStr1
  'Input #f, MO.NFLAG
  'Line Input #f, DummyStr1
  'Input #f, EOFTESTMARKER
  'If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelPSDMInRoom_EofTestMarker)) Then
  '  Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
  '  Exit Sub
  'End If
  'Close #f
  '
  '//////////////// READ C-vs-t OUTPUT FILE. ////////////////////////////////////////////////////////////////////////////////////////////////
  '
    f = FreeFile
    fn_This = Exe_Path & "\" & ModelPSDMInRoom_OUT_CvsT
    Open fn_This For Input As #f
Dim Found As Boolean
Dim ThisRow As Integer
Dim NumArgsExpected As Integer
Dim NumArgsGot As Integer
Dim ThisLine As String
Dim Dummy As String
Dim NumRows As Integer
    Found = False
    ThisRow = 1
    NumArgsExpected = 1 + Number_Component_PFPSDM
    Do While (1 = 1)
      If (EOF(f)) Then
        'UNABLE TO FIND NFLAG!  ASSUME A PROBLEM OCCURRED.
        Exit Do
      End If
      Line Input #1, ThisLine
      ThisLine = Trim$(ThisLine)
      If (UCase$(Trim$(ThisLine)) = UCase$(Trim$("END_OF_DATA"))) Then
        Found = True
        Exit Do
      End If
      ThisLine = Parser2_RemoveDuplicateSeparators(" ", ThisLine)
      NumArgsGot = Parser2_GetNumArgs(" ", ThisLine)
      If (NumArgsGot <> NumArgsExpected) Then
        'UNEXPECTED NUMBER OF ARGUMENTS!  EXIT.
        Close #f
        Call Show_Error("The model output file `" & fn_This & _
            "` was corrupted (unexpected number of arguments on line #" & _
            Trim$(Str$(ThisRow)) & ".  Calculations failed.")
        Exit Sub
      End If
      Call Parser2_GetArg(" ", ThisLine, 1, Dummy)
      MO.T(ThisRow) = CDbl(Val(Dummy))
      For i = 1 To Number_Component_PFPSDM
        Call Parser2_GetArg(" ", ThisLine, 1 + i, Dummy)
        ModelPSDMInRoom_Outputs_CPVB(i, ThisRow) = CDbl(Val(Dummy))
      Next i
      ThisRow = ThisRow + 1
    Loop
    If (Not Found) Then
      'ERROR -- UNABLE TO FIND NFLAG!
      Close #f
      Call Show_Error("The model output file `" & fn_This & _
          "` was corrupted (unable to find the end-of-data designator).  " & _
          "Calculations failed.")
      Exit Sub
    End If
    Close #f
    NumRows = ThisRow - 1
    MO.NITP = NumRows
    ''''GoTo SkipPastOldCode1

    'CP(i,j) -- i=component, j=ThisRow
    'T(i,1) -- i=ThisRow
    '
    'T(ThisRow,1), CP(1,ThisRow), ... CP(NCOMP,ThisRow)


  
'  fn_This = Exe_Path & "\" & ModelPSDMInRoom_OUT_CvsT
'  Open fn_This For Input As #f
'  Line Input #f, DummyStr1
'  Input #f, MO.NITP
'  Line Input #f, DummyStr1
'  For i = 1 To MO.NITP
'    Input #f, MO.T(i)
'  Next i
'  Line Input #f, DummyStr1
'  For i = 1 To MI.NUMB
'    For j = 1 To MO.NITP
'      'Input #f, MO.CPVB(i, j)
'      Input #f, ModelPSDMInRoom_Outputs_CPVB(i, j)
'    Next j
'  Next i
'  Line Input #f, DummyStr1
'  Input #f, EOFTESTMARKER
'  If (False = ModelIO_DoNumberCheck(EOFTESTMARKER, ModelPSDMInRoom_EofTestMarker)) Then
'    Call Show_Error("The model calculations failed: invalid file format (EOF marker).")
'    Exit Sub
'  End If
'  Close #f
  ModelPSDMInRoom_Outputs = MO
  '
  '//////////////// TRANSFER OUTPUT DATA TO MORE PERMANENT MEMORY. ////////////////////////////////////////////////////////////////////////////////
  '
  Results.is_psdm_in_room_model = True
  Results.npoints = MO.NITP
  Results.NComponent = MI.NUMB
  Results.Bed = Bed
  Results.Carbon = Carbon
  For i = 1 To 15
    PSDM_Inputs.VARS1(i) = MO.VARS1(i)
  Next i
  PSDM_Inputs.VARS1(8) = SF() * 264.17205 * 60 / 10.76391         'Convert m/s to gal/min-ft^2.
  PSDM_Inputs.VARS1(11) = Re()
  PSDM_Inputs.VARS1(12) = Bed.WaterDensity
  PSDM_Inputs.VARS1(13) = Bed.WaterViscosity
  For i = 1 To Number_Component_PFPSDM
    For j = 1 To 18
      PSDM_Inputs.VARS2(i, j) = MO.VARS2(i, j)
    Next j
    PSDM_Inputs.VARS2(i, 6) = Diffl(i)
    PSDM_Inputs.VARS2(i, 18) = SC(i)
    j = Component_Index_PFPSDM(i)
    PSDM_Inputs.VARS2(i, 19) = Component(j).SPDFR
  Next i
  '
  '//////////////// HANDLE MISCELLANEOUS PSDM-IN-ROOM STUFF. ///////////////////////////////////////////////////////////////////
  '
  ' TRANSFER Cr,ss VALUES TO Results STRUCTURE.
  ' IS ANY Cr,ss VALUE VERY CLOSE TO ZERO?
  '
  Dim AnyCrCloseToZero As Integer
  AnyCrCloseToZero = False
  For i = 1 To Number_Component_PFPSDM
    k = Component_Index_PFPSDM(i)
    Results.psdmroom_Crss(i) = RoomParams.ROOM_SS_VALUE(k)
    If (Abs(Results.psdmroom_Crss(i)) < 1E-20) Then
      AnyCrCloseToZero = True
    End If
  Next i
  Results.AnyCrCloseToZero = AnyCrCloseToZero
  '
  ' CONVERT ALL Cr TO Cr/Cr,ss VALUES IF NONE OF THE VALUES
  ' OF Cr,ss ARE CLOSE TO ZERO.
  '
  If (AnyCrCloseToZero = False) Then
    For i = 1 To Number_Component_PFPSDM
      For j = 1 To MO.NITP
        ModelPSDMInRoom_Outputs_CPVB(i, j) = _
            ModelPSDMInRoom_Outputs_CPVB(i, j) / _
            Results.psdmroom_Crss(i)
      Next j
    Next i
  End If
  '
  '//////////////// DETERMINE 5%, 50%, AND 95% SATURATION TIMES. ////////////////////////////////////////////////////////////////
  '
  Flag05 = True
  Flag50 = True
  Flag95 = True
  ReDim BrokeThrough(1 To Number_Component_PFPSDM) As Integer
  Dim IsFoulingCase As Integer
  'ReDim NumPoints_Before_BrokeThrough(Number_Component_PFPSDM) As Integer
  For i = 1 To Number_Component_PFPSDM
    BrokeThrough(i) = False
    'NumPoints_Before_BrokeThrough(i) = -1
    Results.NumPoints_Before_ThroughPut_100(i) = MO.NITP
  Next i
  IsFoulingCase = False
  For i = 1 To Number_Component_PFPSDM
    j = Component_Index_PFPSDM(i)
    If (Component(j).K_Reduction) Then
      IsFoulingCase = True
    End If
  Next i
  For i = 1 To Number_Component_PFPSDM
    Results.Component(i) = Component(Component_Index_PFPSDM(i))
    For j = 1 To MO.NITP
     If (((IsFoulingCase) And (ModelPSDMInRoom_Outputs_CPVB(i, j) > 0.9995)) Or (BrokeThrough(i))) Then
       '---- Stop the plot as soon as C/C0>=0.9995; this is accomplished
       '.... by setting .CP = -10000#, which tells the plotting routine to
       '.... stop plotting.
       Results.CP(i, j) = -10000#
       If (Not BrokeThrough(i)) Then
         Results.NumPoints_Before_ThroughPut_100(i) = j - 1
       End If
       BrokeThrough(i) = True
       ''---- Assume C/C0=1.0 as soon as C/C0>=0.9995
       'Results.CP(i, j) = 1#
       'If (Not BrokeThrough(i)) Then
       '  Results.NumPoints_Before_ThroughPut_100(i) = j - 1
       'End If
       'BrokeThrough(i) = True
       ''NumPoints_Before_BrokeThrough(i) = j - 1
     Else
       Results.CP(i, j) = ModelPSDMInRoom_Outputs_CPVB(i, j)
     End If
     If j > 2 Then
       If (ModelPSDMInRoom_Outputs_CPVB(i, j) >= 0.05) And (ModelPSDMInRoom_Outputs_CPVB(i, j - 1) < 0.05) And Flag05 Then
          Results.ThroughPut_05(i).T = _
              (MO.T(j) - MO.T(j - 1)) / _
              (ModelPSDMInRoom_Outputs_CPVB(i, j) - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) * (0.05 - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) + MO.T(j - 1)
          Results.ThroughPut_05(i).C = _
              ((ModelPSDMInRoom_Outputs_CPVB(i, j) - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) / (MO.T(j) - MO.T(j - 1)) * _
              (Results.ThroughPut_05(i).T - MO.T(j - 1)) + ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) * _
              Component(Component_Index_PFPSDM(i)).InitialConcentration
          Flag05 = False
       End If
       If (ModelPSDMInRoom_Outputs_CPVB(i, j) >= 0.5) And (ModelPSDMInRoom_Outputs_CPVB(i, j - 1) < 0.5) And Flag50 Then
          Results.ThroughPut_50(i).T = _
              (MO.T(j) - MO.T(j - 1)) / _
              (ModelPSDMInRoom_Outputs_CPVB(i, j) - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) * (0.5 - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) + MO.T(j - 1)
          Results.ThroughPut_50(i).C = _
              ((ModelPSDMInRoom_Outputs_CPVB(i, j) - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) / (MO.T(j) - MO.T(j - 1)) * _
              (Results.ThroughPut_50(i).T - MO.T(j - 1)) + ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) * _
              Component(Component_Index_PFPSDM(i)).InitialConcentration
          Flag50 = False
          If Flag05 Then
            Results.ThroughPut_05(i).T = -1#
            Results.ThroughPut_05(i).C = -1#
            Flag05 = False
          End If
       End If
       If (ModelPSDMInRoom_Outputs_CPVB(i, j) >= 0.95) And (ModelPSDMInRoom_Outputs_CPVB(i, j - 1) < 0.95) And Flag95 Then
          Results.ThroughPut_95(i).T = _
              (MO.T(j) - MO.T(j - 1)) / _
              (ModelPSDMInRoom_Outputs_CPVB(i, j) - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) * (0.95 - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) + MO.T(j - 1)
          Results.ThroughPut_95(i).C = _
              ((ModelPSDMInRoom_Outputs_CPVB(i, j) - ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) / (MO.T(j) - MO.T(j - 1)) * _
              (Results.ThroughPut_95(i).T - MO.T(j - 1)) + ModelPSDMInRoom_Outputs_CPVB(i, j - 1)) * _
              Component(Component_Index_PFPSDM(i)).InitialConcentration
          Flag95 = False
          If Flag50 Then
            Results.ThroughPut_50(i).T = -1#
            Results.ThroughPut_50(i).C = -1#
            Flag50 = False
          End If
          If Flag05 Then
            Results.ThroughPut_05(i).T = -1#
            Results.ThroughPut_05(i).C = -1#
            Flag05 = False
          End If
       End If
     End If
    Next j
    If Flag95 Then
       Results.ThroughPut_95(i).T = -1#
       Results.ThroughPut_95(i).C = -1#
       Flag95 = False
    End If
    If Flag50 Then
       Results.ThroughPut_50(i).T = -1#
       Results.ThroughPut_50(i).C = -1#
       Flag50 = False
    End If
    If Flag05 Then
       Results.ThroughPut_05(i).T = -1#
       Results.ThroughPut_05(i).C = -1#
       Flag05 = False
    End If
    Flag05 = True  'Set these flags to True such that
    Flag50 = True  ' Results.ThroughPut_??(I).T and Results.ThroughPut_??(I).C
    Flag95 = True  ' are calculated for the next compound
  Next i
  For i = 1 To Number_Points_Max
    Results.T(i) = MO.T(i)
  Next i
  '
  '//////////////// ENABLE RESULTS MENU COMMANDS. ////////////////////////////////////////////////////////////////////////////////
  '
  frmMain.mnuResultsItem(0).Enabled = True
  'frmMain.mnuResultsItem(10).Enabled = True: MsgBox "Note, remove this line!"
  'If (NData_Points > 0) Then
  '  frmMain.mnuResultsItem(3).Enabled = True
  'End If
End Sub
Sub ModelPSDMInRoom_WriteMainFile(Failed As Boolean)
Dim MI As ModelPSDMInRoom_Inputs_Type
Dim i As Integer
Dim j As Integer
Dim Number_Equations As Integer
Dim WorkSpace_Size As Long
Dim msg As String
Dim f As Integer
Dim fn_This As String
Dim ThisLine As String
  Failed = False
  'CALCULATE WORKSPACE SIZE.
  Number_Equations = Number_Component_PFPSDM * (MC * (NC + 1) - 1)
  If Number_Equations > Max_Equations_DGEAR Then
    msg = "Maximum number of equations PSDM can solve = " & Str$(Max_Equations_DGEAR) & vbCrLf
    msg = msg & "Current number of equations specified for PSDM to solve = " & Str$(Number_Equations) & vbCrLf & vbCrLf
    msg = msg & "(No. of Equations PSDM Must Solve) = NCOMP*(MC*(NC+1)-1)" & vbCrLf & vbCrLf
    msg = msg & "Please ensure that this number does not exceed the maximum." & vbCrLf & vbCrLf
    msg = msg & "Note:  " & vbCrLf
    msg = msg & "    NCOMP = Number of Components = " & Str$(Number_Component_PFPSDM) & vbCrLf
    msg = msg & "    MC = Number of Axial Collocation Points = " & Str$(MC) & vbCrLf
    msg = msg & "    NC = Number of Radial Collocation Points = " & Str$(NC) & vbCrLf
    Call Show_Error(msg)
    Failed = True
    Exit Sub
  End If
  WorkSpace_Size = Number_Equations ^ 2 + 2 * Number_Equations
  'PREPARE INPUTS.
  MI.NUMB = Number_Component_PFPSDM
  For i = 1 To MI.NUMB
    j = Component_Index_PFPSDM(i)
    MI.CHEMICALS(i, 1) = Component(j).MW
    'CONVERT Co FROM mg/L TO ug/L.
    MI.CHEMICALS(i, 2) = Component(j).InitialConcentration * 1000#
    MI.CHEMICALS(i, 3) = Component(j).MolarVolume
    'CONVERT K FROM (mg/g)*(L/mg)^(1/n) to (umol/g)*(L/umol)^(1/n).
    MI.CHEMICALS(i, 4) = Component(j).Use_K * (1000# / Component(j).MW) ^ (1# - Component(j).Use_OneOverN)
    MI.CHEMICALS(i, 5) = Component(j).Use_OneOverN
    MI.CHEMICALS(i, 6) = Component(j).kf
    MI.CHEMICALS(i, 7) = Component(j).Ds
    MI.CHEMICALS(i, 8) = Component(j).Dp
    If (Bed.Phase = 0) Then
      If (Component(j).K_Reduction) And _
          (Bed.Water_Correlation.Coeff(1) <> 1# And Bed.Water_Correlation.Coeff(2) <> 0# And _
          Bed.Water_Correlation.Coeff(3) <> 0# And Bed.Water_Correlation.Coeff(4) <> 0#) Then
        MI.CHEMICALS(i, 9) = Bed.Water_Correlation.Coeff(1) * Component(j).Correlation.Coeff(1) + _
            Component(j).Correlation.Coeff(2)
        MI.CHEMICALS(i, 10) = Bed.Water_Correlation.Coeff(2) * Component(j).Correlation.Coeff(1)
        MI.CHEMICALS(i, 11) = Bed.Water_Correlation.Coeff(3) * Component(j).Correlation.Coeff(1)
        MI.CHEMICALS(i, 12) = Bed.Water_Correlation.Coeff(4) * Component(j).Correlation.Coeff(1)
      Else
        MI.CHEMICALS(i, 9) = 1#
        MI.CHEMICALS(i, 10) = 0#
        MI.CHEMICALS(i, 11) = 0#
        MI.CHEMICALS(i, 12) = 0#
      End If
    Else
      MI.CHEMICALS(i, 9) = 1#
      MI.CHEMICALS(i, 10) = 0#
      MI.CHEMICALS(i, 11) = 0#
      MI.CHEMICALS(i, 12) = 0#
    End If
    MI.CHEMICALS(i, 13) = Component(j).Tortuosity
    If ((Component(j).Constant_Tortuosity) And (Component(j).Use_Tortuosity_Correlation)) Then
      MI.CHEMICALS(i, 14) = 2#
      MI.CHEMICALS(i, 15) = 0#
    Else
      If (Component(j).Use_Tortuosity_Correlation) Then
        MI.CHEMICALS(i, 14) = 0.334
        MI.CHEMICALS(i, 15) = 0.00000661
      Else
        MI.CHEMICALS(i, 14) = 2#
        MI.CHEMICALS(i, 15) = 0#
      End If
    End If
    MI.CHEMICALS(i, 16) = 100000#       'in minutes
    '
    '    ON NEXT LINE, CONVERT mg/L TO ug/L
    MI.INITIAL_ROOM_CONC(i) = RoomParams.INITIAL_ROOM_CONC(i) * 1000#
  Next i
  'NOTE: ADJUSTMENT OF LENGTH AND DIAMETER IS NOW PERFORMED
  'INSIDE THE FORTRAN MODULE.
  ''''MI.ADS_PROP(1) = Bed.Length / CDbl(Bed.NumberOfBeds)
  MI.ADS_PROP(1) = Bed.length
  MI.ADS_PROP(2) = Bed.Diameter
  ''''MI.ADS_PROP(3) = Bed.Weight / CDbl(Bed.NumberOfBeds)
  MI.ADS_PROP(3) = Bed.Weight
  MI.ADS_PROP(4) = Bed.Flowrate
  'If (only_make_input_file) Then
  '  ADS_PROP(1) = ADS_PROP(1) * CDbl(Bed.NumberOfBeds)
  '  ADS_PROP(3) = ADS_PROP(3) * CDbl(Bed.NumberOfBeds)
  'End If
  MI.C_PROP(1) = Carbon.Porosity
  MI.C_PROP(2) = Carbon.Density
  MI.C_PROP(3) = Carbon.ParticleRadius * 100#      'To convert in cm
  MI.TT(1) = TimeP.End
  'Test value of Tinit
  If (TimeP.Init <= 0#) Then
    MI.TT(2) = 0.0001
  Else
    MI.TT(2) = TimeP.Init
  End If
  MI.TT(3) = TimeP.Step
  MI.MXX = MC
  MI.NXX = NC
  MI.TotalAxialElementCount = Bed.NumberOfBeds
  ''''MI.N_PW = WorkSpace_Size
  MI.NINI = Number_Influent_Points
  For j = 1 To MI.NINI
    MI.TINI(j) = T_Influent(j)
    For i = 1 To MI.NUMB
      'CONVERT FROM mg/L TO ug/L.
      ModelPSDMInRoom_Inputs_CINI(i, j) = C_Influent(Component_Index_PFPSDM(i), j) * 1000#
    Next i
  Next j
  '
  ' ON NEXT LINE, CONVERT m^3 TO cm^3.
  MI.ROOM_VOL = RoomParams.ROOM_VOL * 1000000#
  '
  ' ON NEXT LINE, CONVERT m^3/s TO cm^3/s.
  MI.ROOM_FLOWRATE = RoomParams.ROOM_FLOWRATE * 1000000#
  For i = 1 To MI.NUMB
    '
    ' ON NEXT LINE, CONVERT mg/L TO ug/L.
    MI.ROOM_C0(i) = RoomParams.ROOM_C0(i) * 1000#
    MI.ROOM_EMIT(i) = RoomParams.ROOM_EMIT(i)
  Next i
  MI.FN_MASSBAL_OUT = "proom_massbal.out"
  MI.FN_CR_OUT = ModelPSDMInRoom_OUT_CvsT
  MI.FN_CB_OUT = "proom_cb.out"
  '
  ' ////////////////// WRITE INPUT FILE. ////////////////////////////////////////////////////////////////////////////////////////////////////////////
  '
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelPSDMInRoom_IN_Main
  Open fn_This For Output As #f
  Call WriteFortranInput(f, 0, "NOTE1: ")
  Call WriteFortranInput(f, 0, "NOTE2: ")
  Call WriteFortranInput(f, 0, "NOTE3: ")
  Call WriteFortranInput(f, 0, "NOTE4: ")
  Print #f, String$(75, "-")
  Call WriteFortranInput(f, MI.ADS_PROP(1), "ADS_PROP(1), length, m")
  Call WriteFortranInput(f, MI.ADS_PROP(2), "ADS_PROP(2), diameter, m")
  Call WriteFortranInput(f, MI.ADS_PROP(3), "ADS_PROP(3), weight of adsorbent, kg")
  Call WriteFortranInput(f, MI.ADS_PROP(4), "ADS_PROP(4), influent flow rate, m^3/s")
  Call WriteFortranInput(f, MI.C_PROP(1), "C_PROP(1), void fraction of particle, -")
  Call WriteFortranInput(f, MI.C_PROP(2), "C_PROP(2), apparent density, g/cm^3")
  Call WriteFortranInput(f, MI.C_PROP(3), "C_PROP(3), particle radius, cm")
  Call WriteFortranInput(f, MI.MXX, "MXX: number of axial collocation points")
  Call WriteFortranInput(f, MI.NXX, "NXX: number of radial collocation points")
  Call WriteFortranInput(f, MI.NUMB, "NUMB: number of chemicals")
  Call WriteFortranInput(f, MI.NINI, "NINI: number of influent points")
  Call WriteFortranInput(f, MI.TotalAxialElementCount, "NUMBED: current axial element number in series to simulate")
  Call WriteFortranInput(f, 1, "BEDSIMTYPE: 0=simulate only this axial element, 1=simulate NUMBED number of axial elements all at once")
  Call WriteFortranInput(f, 0, "ISDBUG: debug setting, 0=no debugging")
  Call WriteFortranInput(f, MI.TT(1), "TT(1), time to end simulation, min")
  Call WriteFortranInput(f, MI.TT(2), "TT(2), time to begin simulation, min")
  Call WriteFortranInput(f, MI.TT(3), "TT(3), time step, min")
  Print #f, String$(75, "-")
  Call WriteFortranInput(f, 1, "IS_IN_ROOM: equal to 1 if the filter is within a room (treated as a CSTR); extra parameters below if equal to 1.")
  Call WriteFortranInput(f, MI.ROOM_VOL, "ROOM_VOL, volume of room, cm^3")
  Call WriteFortranInput(f, MI.ROOM_FLOWRATE, "ROOM_FLOWRATE, volumetric flow through room, cm^3/s")
  For i = 1 To MI.NUMB
    Call WriteFortranInput(f, MI.ROOM_C0(i), "ROOM_C0(1), component #1 concentration influent to room, ug/L")
    Call WriteFortranInput(f, MI.ROOM_EMIT(i), "ROOM_EMIT(1), component #1 emission rate in room, ug/s")
  Next i
  Call WriteFortranInput(f, MI.FN_MASSBAL_OUT, "FN_MASSBAL_OUT, filename of mass balance output file")
  Call WriteFortranInput(f, MI.FN_CR_OUT, "FN_CR_OUT, filename of room concentration vs time output file")
  Call WriteFortranInput(f, MI.FN_CB_OUT, "FN_CB_OUT, filename of bed effluent concentration vs time output file")
  Print #f, String$(75, "-")
  For i = 1 To MI.NUMB
    Call WriteFortranInput(f, "NO_DATA", "NAME(" & Trim$(Str$(i)) & ",1), not actually input")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 1), "CHEMICALS(" & Trim$(Str$(i)) & ",1), molecular weight, g/gmol")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 2), "CHEMICALS(" & Trim$(Str$(i)) & ",2), influent concentration, ug/L")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 3), "CHEMICALS(" & Trim$(Str$(i)) & ",3), molar volume, cm^3/gmol")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 4), "CHEMICALS(" & Trim$(Str$(i)) & ",4), Freundlich K, (umol/g)*(L/umol)^(1/n)")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 5), "CHEMICALS(" & Trim$(Str$(i)) & ",5), Freundlich 1/n, dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 6), "CHEMICALS(" & Trim$(Str$(i)) & ",6), film transfer coefficient (kf), cm/s ")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 7), "CHEMICALS(" & Trim$(Str$(i)) & ",7), surface diffusion coefficient (Ds), cm^2/s")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 8), "CHEMICALS(" & Trim$(Str$(i)) & ",8), pore diffusion coefficient (Dp), cm^2/s")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 9), "CHEMICALS(" & Trim$(Str$(i)) & ",9) = RK1(" & Trim$(Str$(i)) & "), fouling correlation coef. #1, dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 10), "CHEMICALS(" & Trim$(Str$(i)) & ",10) = RK2(" & Trim$(Str$(i)) & "), fouling correlation coef. #2, 1/min")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 11), "CHEMICALS(" & Trim$(Str$(i)) & ",11) = RK3(" & Trim$(Str$(i)) & "), fouling correlation coef. #3, dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 12), "CHEMICALS(" & Trim$(Str$(i)) & ",12) = RK4(" & Trim$(Str$(i)) & "), fouling correlation coef. #4, 1/min")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 13), "CHEMICALS(" & Trim$(Str$(i)) & ",13) = TORTU(" & Trim$(Str$(i)) & "), tortuosity (never used?), dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 14), "CHEMICALS(" & Trim$(Str$(i)) & ",14) = TOR(" & Trim$(Str$(i)) & "), tortuosity coef., dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 15), "CHEMICALS(" & Trim$(Str$(i)) & ",15) = PART(" & Trim$(Str$(i)) & "), part. coef., dimless")
    Call WriteFortranInput(f, MI.CHEMICALS(i, 16), "CHEMICALS(" & Trim$(Str$(i)) & ",16) = TTORTU(" & Trim$(Str$(i)) & "), time parameter, min")
    Call WriteFortranInput(f, MI.INITIAL_ROOM_CONC(i), "INITIAL_ROOM_CONC(" & Trim$(Str$(i)) & "), initial concentration in room, ug/L")
  Next i
  If (MI.NINI <> 0) Then
    Print #f, String$(75, "-")
    Print #f, "NOTE1A: THE FOLLOWING LINES CONTAIN INFLUENT CONCENTRATION VS TIME DATA."
    Print #f, "NOTE1B: THE ORDER FOR EACH LINE IS: TIME (MINUTES), CONC#1 (UG/L), ..., CONC#n (UG/L)."
    For i = 1 To MI.NINI
      ThisLine = Trim$(Str$(MI.TINI(i)))
      For j = 1 To MI.NUMB
        ThisLine = ThisLine & "    "
        ThisLine = ThisLine & Trim$(Str$(ModelPSDMInRoom_Inputs_CINI(j, i)))
      Next j
      Print #f, ThisLine
    Next i
  End If

'  Print #f, "TINI(i), time profile for CINI() array, minutes"
'  For i = 1 To MI.NINI
'    Print #f, MI.TINI(i)
'  Next i
'  Print #f, "CINI(i,j), influent concentration profile, ug/L"
'  For i = 1 To MI.NUMB
'    For j = 1 To MI.NINI
'      Print #f, ModelPSDMInRoom_Inputs_CINI(i, j)
'    Next j
'  Next i
  
'  MI.NINI = Number_Influent_Points
'  For j = 1 To MI.NINI
'    MI.TINI(j) = T_Influent(j)
'    For i = 1 To MI.NUMB
'      'CONVERT FROM mg/L TO ug/L.
'      ModelPSDMInRoom_Inputs_CINI(i, j) = C_Influent(Component_Index_PFPSDM(i), j) * 1000#
'    Next i
'  Next j
  
  Print #f, String$(75, "-")
  Call WriteFortranInput(f, ModelPSDMInRoom_EofTestMarker, "EOFTESTMARKER")
  Close #f
  'STORE FOR LATER USE.
  ModelPSDMInRoom_Inputs = MI
End Sub
Sub ModelPSDMInRoom_WritePathFile()
Dim f As Integer
Dim fn_This As String
Dim qq As String
  qq = Chr$(34)
  f = FreeFile
  fn_This = Exe_Path & "\" & ModelPSDMInRoom_IN_PathFile
  Open fn_This For Output As #f
  Print #f, "1"
  Print #f, qq & ModelPSDMInRoom_IN_Main & qq
  Print #f, qq & ModelPSDMInRoom_OUT_SuccessFlag & qq
  Print #f, qq & ModelPSDMInRoom_OUT_Main & qq
  Print #f, qq & ModelPSDMInRoom_OUT_CvsT & qq
  Close #f
End Sub


'Return value:
'  TRUE = Okay to call the PSDM
'  FALSE = Something went wrong, ABORT!  ABORT!
Function Prepare_To_Run_PSDM_In_Room() As Integer
Dim i As Integer
Dim j As Integer
Dim Num_K_Reduction As Integer
Dim Num_A_and_Not_B As Integer
Dim Num_Not_a_and_B As Integer
ReDim Name_A_and_Not_B(1 To Number_Compo_Max) As String
ReDim Name_Not_A_and_B(1 To Number_Compo_Max) As String
Dim Is_A As Integer
Dim Is_B As Integer
Dim msg As String
Dim RetVal As Integer
  '
  ' PERFORM SEVERAL VERIFICATIONS BEFORE RUNNING THE PSDM.
  '
  If (TimeP.Init > TimeP.End) Then
    Call Show_Error("The initial simulation time (" & _
        TimeP.Init / 24# / 60# & " days) is greater than the " & _
        "final simulation time (" & TimeP.End / 24# / 60# & _
        " days).  PSDM cannot be run until this is fixed.")
    Prepare_To_Run_PSDM_In_Room = False
    Exit Function
  End If
  If (TimeP.Step < ((TimeP.End - TimeP.Init) / _
      (Number_Points_Max - 1))) Then
    Call Show_Error("The simulation time step (" & _
        TimeP.Step / 24# / 60# & " days) is too small.  The " & _
        "maximum number of points is 400.  PSDM cannot be run " & _
        "until this is fixed.")
    Prepare_To_Run_PSDM_In_Room = False
    Exit Function
  End If
  Call AllModels_Verify_Selected_Components(MODELTYPE_PSDM)
  If (Number_Component_PFPSDM = 0) Then
    Prepare_To_Run_PSDM_In_Room = False
    Exit Function
  End If
  For i = 1 To Number_Component_PFPSDM
    For j = i + 1 To Number_Component_PFPSDM
      If Trim$(Component(Component_Index_PFPSDM(i)).Name) = _
          Trim$(Component(Component_Index_PFPSDM(j)).Name) Then
        Call Show_Error("Components " & _
            Format$(Component_Index_PFPSDM(i), "0") & " and " & _
            Format$(Component_Index_PFPSDM(j), "0") & _
            " have the same name." & vbCrLf & _
            "Please change one before running the PSDM.")
        Prepare_To_Run_PSDM_In_Room = False
        Exit Function
      End If
    Next j
  Next i
  '
  '---- Make sure # PSDM fouling components is <= 1.
  '
  Num_K_Reduction = 0
  For i = 0 To frmMain.lstComponents.ListCount - 1
    If (frmMain.lstComponents.Selected(i)) Then
      If (Component(i + 1).K_Reduction) Then
        Num_K_Reduction = Num_K_Reduction + 1
      End If
    End If
  Next i
  If (Num_K_Reduction > 1) Then
    Call Show_Error("There are currently " & _
        Trim$(Str$(Num_K_Reduction)) & _
        " components specified for fouling.  Only 1 may be " & _
        "specified for a run of the PSDM.")
    Prepare_To_Run_PSDM_In_Room = False
    Exit Function
  End If
  '
  '---- Show warning if A and not B, or not A and B,
  '.... for any component where:
  '.... A = pore diffusion correlation for tortuosity selected
  '.... B = fouling correlation selected
  '
  Num_A_and_Not_B = 0
  Num_Not_a_and_B = 0
  For i = 0 To frmMain.lstComponents.ListCount - 1
    If (frmMain.lstComponents.Selected(i)) Then
      Is_A = (Component(i + 1).Use_Tortuosity_Correlation)
      Is_B = (Component(i + 1).K_Reduction)
      '---- Check for A and not B case:
      If ((Is_A) And (Not Is_B)) Then
        Num_A_and_Not_B = Num_A_and_Not_B + 1
        Name_A_and_Not_B(Num_A_and_Not_B) = Trim$(Component(i + 1).Name)
      End If
      '---- Check for not A and B case:
      If ((Not Is_A) And (Is_B)) Then
        Num_Not_a_and_B = Num_Not_a_and_B + 1
        Name_Not_A_and_B(Num_Not_a_and_B) = Trim$(Component(i + 1).Name)
      End If
    End If
  Next i
  If ((Num_A_and_Not_B > 0) Or (Num_Not_a_and_B > 0)) Then
    msg = "Warning:" & vbCrLf
    If (Num_A_and_Not_B > 0) Then
      msg = msg & vbCrLf
      msg = msg & "The following components have the pore diffusion "
      msg = msg & "correlation for tortuosity selected, but no "
      msg = msg & "fouling correlation selected:"
      msg = msg & vbCrLf
      For i = 1 To Num_A_and_Not_B
        msg = msg & "    " & Name_A_and_Not_B(i)
        msg = msg & vbCrLf
      Next i
    End If
    If (Num_Not_a_and_B > 0) Then
      msg = msg & vbCrLf
      msg = msg & "The following components have the pore diffusion "
      msg = msg & "correlation for tortuosity NOT selected, but a "
      msg = msg & "fouling correlation is selected:"
      msg = msg & vbCrLf
      For i = 1 To Num_Not_a_and_B
        msg = msg & "    " & Name_Not_A_and_B(i)
        msg = msg & vbCrLf
      Next i
    End If
    msg = msg & vbCrLf
    msg = msg & "This configuration is not the recommended way to run "
    msg = msg & "the PSDM.  It is recommended that you either (a) "
    msg = msg & "turn both correlations on or (b) "
    msg = msg & "turn both correlations off.  Do you wish to proceed "
    msg = msg & "with this currently-specified PSDM run anyway?"
    RetVal = MsgBox(msg, vbQuestion + vbYesNo, Application_Name)
    If (RetVal = vbNo) Then
      Prepare_To_Run_PSDM_In_Room = False
      Exit Function
    End If
  End If
  Prepare_To_Run_PSDM_In_Room = True
End Function


Sub Parser2_GetArg(sepchar As String, inline As String, ArgNum As Integer, retStr As String)
Dim i As Integer
Dim j As Integer
  retStr = ""
  j = 1
  For i = 1 To Len(inline)
    If (Mid$(inline, i, 1) = sepchar) Then
      j = j + 1
      If (j > ArgNum) Then Exit For
    Else
      If (j = ArgNum) Then
        retStr = retStr + Mid$(inline, i, 1)
      End If
    End If
  Next i
End Sub
Function Parser2_GetNumArgs(sepchar As String, inline As String) As Integer
Dim NumArgs As Integer
Dim i As Integer
  NumArgs = 1     'between chr #1 and first separator char.
  For i = 1 To Len(inline)
    If (Mid$(inline, i, 1) = sepchar) Then
      NumArgs = NumArgs + 1
    End If
  Next i
  Parser2_GetNumArgs = NumArgs
End Function
Function Parser2_RemoveDuplicateSeparators(sepchar As String, inline As String) As String
Dim retStr As String
Dim i As Integer
Dim ok_append As Integer
Dim thisc As String
  retStr = ""
  For i = 1 To Len(inline)
    ok_append = True
    thisc = Mid$(inline, i, 1)
    If (i > 1) Then
      If (thisc = sepchar) Then
        If (Right$(retStr, 1) = sepchar) Then
          ok_append = False
        End If
      End If
    End If
    If (ok_append) Then
      retStr = retStr & thisc
    End If
  Next i
  Parser2_RemoveDuplicateSeparators = retStr
End Function



Attribute VB_Name = "Refresh"
Option Explicit



Private Sub frmMain_Repopulate_Values()
  'UPDATE NUMERIC VALUES TO WINDOW.
  
  'WATER/AIR PROPERTIES.
  Call unitsys_set_number_in_base_units(frmMain.txtWater(0), Bed.Temperature)
  Call unitsys_set_number_in_base_units(frmMain.txtWater(1), Bed.Pressure)
  'frmMain.txtWater(0) = Format$(Bed.Temperature, "0.00")
  'frmMain.txtWater(1) = Format$(Bed.Pressure, "0.000")
  ''txtWater(2) = Format$(Bed.WaterDensity, "0.000E+00")
  ''txtWater(3) = Format$(Bed.WaterViscosity, "0.00E+00")

  'SIM PARAMS FOR PSDM ONLY.
  Call unitsys_set_number_in_base_units(frmMain.txtNumberOfBeds, CDbl(Bed.NumberOfBeds))
  Call unitsys_set_number_in_base_units(frmMain.txtNPoint(0), CDbl(MC))
  Call unitsys_set_number_in_base_units(frmMain.txtNPoint(1), CDbl(NC))
  Call unitsys_set_number_in_base_units(frmMain.txtTime(0), TimeP.End)
  Call unitsys_set_number_in_base_units(frmMain.txtTime(1), TimeP.Init)
  Call unitsys_set_number_in_base_units(frmMain.txtTime(2), TimeP.Step)
  'frmMain.txtNumberOfBeds = Format$(Bed.NumberOfBeds, "0")
  'frmMain.txtNPoint(0) = Format$(MC, "0")
  'frmMain.txtNPoint(1) = Format$(NC, "0")
  'frmMain.txtTime(0) = Format_It(TimeP.End / 60# / 24#, 2)
  'frmMain.txtTime(1) = Format_It(TimeP.Init / 60# / 24#, 2)
  'frmMain.txtTime(2) = Format_It(TimeP.Step / 60# / 24#, 2)

  'FIXED BED PROPERTIES.
  Call unitsys_set_number_in_base_units(frmMain.txtBedValue(0), Bed.length)
  Call unitsys_set_number_in_base_units(frmMain.txtBedValue(1), Bed.Diameter)
  Call unitsys_set_number_in_base_units(frmMain.txtBedValue(2), Bed.Weight)
  'ConversionFactor = LengthConversionFactor(CInt(frmMain.txtBedUnits(0).ListIndex))
  'frmMain.txtBedValue(0) = Format_It(Bed.Length * ConversionFactor, 3)
  'ConversionFactor = LengthConversionFactor(CInt(frmMain.txtBedUnits(1).ListIndex))
  'frmMain.txtBedValue(1) = Format_It(Bed.Diameter * ConversionFactor, 3)
  'ConversionFactor = MassConversionFactor(CInt(frmMain.txtBedUnits(2).ListIndex))
  'frmMain.txtBedValue(2) = Format_It(Bed.Weight * ConversionFactor, 2)
  ''** Note: Update_Display() takes care of Flowrate and EBCT.
  
  'ADSORBENT PROPERTIES.
  Call AssignTextAndTag(frmMain.txtCarbon(0), Trim$(Carbon.Name))
  Call unitsys_set_number_in_base_units(frmMain.txtCarbon(1), Carbon.Density)
  Call unitsys_set_number_in_base_units(frmMain.txtCarbon(2), Carbon.ParticleRadius)
  Call unitsys_set_number_in_base_units(frmMain.txtCarbon(3), Carbon.Porosity)
  Call unitsys_set_number_in_base_units(frmMain.txtCarbon(4), Carbon.ShapeFactor)
  'frmMain.txtCarbon(0) = Carbon.name
  'ConversionFactor = DensityConversionFactor(CInt(frmMain.txtCarbonUnits(1).ListIndex))
  'frmMain.txtCarbon(1) = Format$(Carbon.Density * ConversionFactor, "0.000")
  'ConversionFactor = LengthConversionFactor(CInt(frmMain.txtCarbonUnits(2).ListIndex))
  'frmMain.txtCarbon(2) = Format$(Carbon.ParticleRadius * ConversionFactor, "0.00000")
  'frmMain.txtCarbon(3) = Format$(Carbon.Porosity, "0.000")
  'frmMain.txtCarbon(4) = Format$(Carbon.ShapeFactor, "0.000")
End Sub
Sub frmMain_Refresh()
Dim i As Integer
Dim ConversionFactor As Double
Dim dd As Double
Dim T As Double

Dim Enabled_Add As Boolean
Dim Enabled_Delete As Boolean
Dim Enabled_Edit As Boolean
'Dim Enabled_PSDM_Results As Boolean
'Dim Enabled_CPHSDM_Results As Boolean
'Dim Enabled_ECM_Results As Boolean
'Dim Enabled_PSDM_Comparison As Boolean
'Dim Enabled_CPHSDM_Comparison As Boolean
Dim Enabled_OptionsMenu As Boolean
Dim Enabled_RunMenu As Boolean
Dim Enabled_Save As Boolean
Dim Enabled_ViewDimless As Boolean
Dim Is_At_Least_One_Component As Boolean
Dim SAVE_OLD_POSITION As Integer

  '/////////// FORMERLY NAMED Update_Display_Data() ////////////////////////////////
  'UPDATE COMPONENT SELECTION LIST AND SCROLLBOX.
  If (frmMain.cboSelectCompo.ListCount >= 1) And _
      (frmMain.cboSelectCompo.ListIndex >= 0) Then
    SAVE_OLD_POSITION = frmMain.cboSelectCompo.ListIndex
  Else
    SAVE_OLD_POSITION = -1
  End If
  frmMain.lstComponents.Clear
  frmMain.cboSelectCompo.Clear
  For i = 1 To Number_Component
    frmMain.cboSelectCompo.AddItem Component(i).Name
    frmMain.lstComponents.AddItem Component(i).Name
    frmMain.lstComponents.Selected(i - 1) = Component(i).Is_Selected_On_List
  Next i
  If (SAVE_OLD_POSITION <> -1) And _
      (SAVE_OLD_POSITION <= frmMain.cboSelectCompo.ListCount - 1) Then
    frmMain.cboSelectCompo.ListIndex = SAVE_OLD_POSITION
  Else
    If (frmMain.cboSelectCompo.ListCount >= 1) Then
      frmMain.cboSelectCompo.ListIndex = SAVE_OLD_POSITION = 0
    End If
  End If
   
  'COMPONENT SELECTION STUFF.
  If (Number_Component > 0) Then
    frmMain.cboSelectCompo.Enabled = True
    ''''''''frmMain.cboSelectCompo.ListIndex = 0
  Else
    frmMain.cboSelectCompo.Enabled = False
    Component_Number_Selected = 0
  End If
  
  'ENABLE/DISABLE ADD/DELETE/EDIT.
  Enabled_Add = True              'ENABLE ADD.
  Enabled_Delete = True           'ENABLE DELETE.
  Enabled_Edit = True             'ENABLE EDIT.
  If (Number_Component = Number_Compo_Max) Then
    Enabled_Add = False             'DISABLE ADD.
  End If
  If (Number_Component = 0) Then
    Enabled_Delete = False        'DISABLE DELETE.
    Enabled_Edit = False          'DISABLE EDIT.
  End If
  'ENABLE/DISABLE OPTIONS MENU, RUN MENU, AND SAVE/SAVE-AS.
  Is_At_Least_One_Component = (Number_Component >= 1)
  Enabled_OptionsMenu = Is_At_Least_One_Component
  Enabled_RunMenu = Is_At_Least_One_Component
  Enabled_Save = Is_At_Least_One_Component
  Enabled_ViewDimless = Is_At_Least_One_Component
  'ACTUATE ENABLE/DISABLE VARIABLES TO CONTROLS/MENUS.
  '---- ADD/DELETE/EDIT.
  frmMain.cmdADEComponent(0).Enabled = Enabled_Add
  frmMain.cmdADEComponent(1).Enabled = Enabled_Delete
  frmMain.cmdADEComponent(2).Enabled = Enabled_Edit
  ''---- RESULTS MENU: PSDM, CPHSDM, ECM, COMPARE PSDM, COMPARE CPHSDM.
  'frmMain.mnuResultsItem(0).Enabled = Enabled_PSDM_Results
  'frmMain.mnuResultsItem(1).Enabled = Enabled_CPHSDM_Results
  'frmMain.mnuResultsItem(2).Enabled = Enabled_ECM_Results
  'frmMain.mnuResultsItem(3).Enabled = Enabled_PSDM_Comparison
  'frmMain.mnuResultsItem(4).Enabled = Enabled_CPHSDM_Comparison
  '---- OPTIONS MENU: FOULING, INFLUENT CONC, EFFLUENT CONC.
  frmMain.mnuOptionsItem(0).Enabled = Enabled_OptionsMenu
  frmMain.mnuOptionsItem(1).Enabled = Enabled_OptionsMenu
  frmMain.mnuOptionsItem(2).Enabled = Enabled_OptionsMenu
  '---- RUN MENU: PSDM, CPHSDM, ECM.
  frmMain.mnuRunItem(0).Enabled = Enabled_RunMenu
  frmMain.mnuRunItem(1).Enabled = Enabled_RunMenu
  frmMain.mnuRunItem(2).Enabled = Enabled_RunMenu
  frmMain.mnuRunItem(10).Enabled = Enabled_RunMenu    'PSDM-IN-ROOM.
  '---- FILE MENU: SAVE AND SAVE-AS.
  frmMain.mnuFileItem(2).Enabled = Enabled_Save
  frmMain.mnuFileItem(3).Enabled = Enabled_Save
  '---- VIEW DIM'LESS GROUPS.
  frmMain.cmdViewDimensionless.Enabled = Enabled_ViewDimless
    
  'RE-DISPLAY ALL VALUES.
  Call frmMain_Repopulate_Values
  '/////////// FORMERLY NAMED Update_Display_Data() [ENDS] ////////////////////////////////
  
  'RE-CALCULATE AND DISPLAY BED DENSITY.
  Call Update_Bed_Density_Display
  
  'RE-CALCULATE AND DISPLAY BED POROSITY,
  'SUPERFICIAL VELOCITY AND INTERSTITIAL VELOCITY.
  Call Update_Several_Bed_Properties(3)
  
  '/////////// FORMERLY NAMED Update_Display() ////////////////////////////////
  'RE-CALCULATE AND DISPLAY EBCT.
  dd = Bed.Flowrate
  'dd = dd * FlowConversionFactor(CInt(frmMain.txtBedUnits(3).ListIndex))
  'frmMain.txtBedValue(3) = Format$(dd, "0.000E+00")
  Call unitsys_set_number_in_base_units(frmMain.txtBedValue(3), dd)   'FLOW RATE.
'  dd = Bed.Length * Pi * Bed.Diameter * Bed.Diameter / 4# / Bed.Flowrate / 60#   'EBCT in min
  dd = Bed.length * PI * Bed.Diameter * Bed.Diameter / 4# / Bed.Flowrate          'EBCT in sec
  'dd = dd * TimeConversionFactor(CInt(frmMain.txtBedUnits(4).ListIndex))
  'frmMain.txtBedValue(4) = Format_It(dd, 2)
  Call unitsys_set_number_in_base_units(frmMain.txtBedValue(4), dd)   'EBCT.
  
  'RE-CALCULATE SPDFR CORRELATION VALUE FOR EACH COMPONENT.
  If (Number_Component > 0) Then
    For i = 1 To Number_Component
      If (Component(i).Use_SPDFR_Correlation) Then
        Component(i).SPDFR = SPDFR_Corr(Component_Number_Selected)
      End If
    Next i
  End If
  '/////////// FORMERLY NAMED Update_Display() [ENDS] //////////////////////////////////

  'ADDED 9/4/98.
  If (FileNote = "") Then
    frmMain.cmdNote(0).Visible = True
    frmMain.cmdNote(1).Visible = False
  Else
    frmMain.cmdNote(0).Visible = False
    frmMain.cmdNote(1).Visible = True
  End If

End Sub


Private Sub frmCompoProp_Repopulate_Values()
Dim Frm As Form
Set Frm = frmCompoProp
  'UPDATE NUMERIC VALUES TO WINDOW.
  '---- MAIN BLOCK.
  Call AssignTextAndTag( _
      Frm.txtDataComponentProperty(0), Trim$(Component(0).Name))
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(1), Component(0).MW)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(2), Component(0).MolarVolume)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(3), Component(0).BP)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(4), Component(0).InitialConcentration)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(10), Component(0).Liquid_Density)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(9), Component(0).Aqueous_Solubility)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(7), Component(0).Vapor_Pressure)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(8), Component(0).Refractive_Index)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(11), CDbl(Component(0).CAS))
  '---- FREUNDLICH K AND 1/N BLOCK.
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(5), Component(0).Use_K)
  Call unitsys_set_number_in_base_units( _
      Frm.txtDataComponentProperty(6), Component(0).Use_OneOverN)
End Sub
Sub frmCompoProp_Refresh()
  'RE-DISPLAY ALL VALUES.
  Call frmCompoProp_Repopulate_Values



End Sub


Sub frmInputParamsPSDMInRoom_Repopulate_Values( _
    Temp_RP As RoomParam_Type, _
    in_NOW_CONTAMINANT As Integer)
Dim Frm As Form
Set Frm = frmInputParamsPSDMInRoom
  'UPDATE NUMERIC VALUES TO WINDOW.
  '---- MAIN BLOCK.
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(0), Temp_RP.ROOM_VOL)
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(1), Temp_RP.ROOM_FLOWRATE)
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(2), Temp_RP.ROOM_C0(in_NOW_CONTAMINANT))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(3), Temp_RP.ROOM_EMIT(in_NOW_CONTAMINANT))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(4), Temp_RP.INITIAL_ROOM_CONC(in_NOW_CONTAMINANT))
End Sub
Sub frmInputParamsPSDMInRoom_Refresh( _
    Temp_RP As RoomParam_Type, _
    in_NOW_CONTAMINANT As Integer)
Dim Frm As Form
Set Frm = frmInputParamsPSDMInRoom
  'RE-DISPLAY ALL VALUES.
  Call frmInputParamsPSDMInRoom_Repopulate_Values( _
      Temp_RP, _
      in_NOW_CONTAMINANT)
'Dim newVal As Double
'Dim ConversionFactor As Double
  ''VOLUME OF ROOM.
  'ConversionFactor = VolumeConversionFactor(CInt(cboUnits(0).ListIndex))
  'newVal = TempData.ROOM_VOL * ConversionFactor
  'Call AssignTextAndTag_WithRange(txtData(0), newVal, 1E-20, 1E+20)
  ''FLOW RATE OF AIR THROUGH ROOM.
  'ConversionFactor = FlowConversionFactor(CInt(cboUnits(1).ListIndex))
  'newVal = TempData.ROOM_FLOWRATE * ConversionFactor
  'Call AssignTextAndTag_WithRange(txtData(1), newVal, 1E-20, 1E+20)
  'DISPLAY CALCULATED PARAMETERS.
  Frm.lblAirRate.Caption = NumberToMFBString(Temp_RP.ROOM_CHANGE_RATE)
  'ENABLING/DISABLING VARIOUS STUFF.
  If (Temp_RP.COUNT_CONTAMINANT = 0) Then
    Frm.txtData(2).Enabled = False
    Frm.txtData(3).Enabled = False
    Frm.txtData(4).Enabled = False
    Frm.cboChemical.Enabled = False
    'DISPLAY CALCULATED PARAMETERS.
    Frm.lblSSValue.Enabled = False
    Frm.lblSSValue.Caption = "n/a"
  Else
    ''CONCENTRATION OF CONTAMINANT IN THE AIR STREAM INFLUENT TO THE ROOM.
    'ConversionFactor = ConcentrationConversionFactor(CInt(cboUnits(2).ListIndex))
    'newVal = TempData.ROOM_C0(NOW_CONTAMINANT) * ConversionFactor
    'Call AssignTextAndTag_WithRange(txtData(2), newVal, 0#, 1E+20)
    ''MASS EMISSION RATE OF CONTAMINANT.
    'ConversionFactor = MassEmissionRateConversionFactor(CInt(cboUnits(3).ListIndex))
    'newVal = TempData.ROOM_EMIT(NOW_CONTAMINANT) * ConversionFactor
    'Call AssignTextAndTag_WithRange(txtData(3), newVal, 0#, 1E+20)
    ''CONCENTRATION OF CONTAMINANT IN ROOM AT TIME = ZERO.
    'ConversionFactor = ConcentrationConversionFactor(CInt(cboUnits(4).ListIndex))
    'newVal = TempData.INITIAL_ROOM_CONC(NOW_CONTAMINANT) * ConversionFactor
    'Call AssignTextAndTag_WithRange(txtData(4), newVal, 0#, 1E+20)
    'ENABLE TEXT BOXES.
    Frm.txtData(2).Enabled = True
    Frm.txtData(3).Enabled = True
    Frm.txtData(4).Enabled = True
    Frm.cboChemical.Enabled = True
    'DISPLAY CALCULATED PARAMETERS.
    Frm.lblSSValue.Enabled = True
    Frm.lblSSValue.Caption = NumberToMFBString(Temp_RP.ROOM_SS_VALUE(in_NOW_CONTAMINANT))
  End If
  If (Frm.cboChemical.ListCount > 0) Then
    Frm.ssframe_ContaminantProps.Caption = "Properties of " & Frm.cboChemical.List(Frm.cboChemical.ListIndex) & ":"
  Else
    Frm.ssframe_ContaminantProps.Caption = "No Contaminants Defined"
  End If
End Sub


Sub frmKinetic_Repopulate_Values()
Dim Frm As Form
Set Frm = frmKinetic
  'DISPLAY CURRENT VALUES FOR UNIT CONTROLS.
  Call unitsys_set_number_in_base_units( _
      Frm.txtKF, Component(0).KP_User_Input(1))
  Call unitsys_set_number_in_base_units( _
      Frm.txtDS, Component(0).KP_User_Input(2))
  Call unitsys_set_number_in_base_units( _
      Frm.txtDP, Component(0).KP_User_Input(3))
  Call unitsys_set_number_in_base_units( _
      Frm.txtSPDFR, Component(0).SPDFR)
  Call unitsys_set_number_in_base_units( _
      Frm.txtTort, Component(0).Tortuosity)
End Sub
Sub frmKinetic_Refresh()
Dim Frm As Form
Set Frm = frmKinetic
  'RE-DISPLAY ALL VALUES.
  Call frmKinetic_Repopulate_Values
  'DISPLAY CORRELATION NAMES.
  Frm.lblCorrelationKF.Caption = Get_Correlation_Description(0)
  Frm.lblCorrelationDS.Caption = Get_Correlation_Description(1)
  Frm.lblCorrelationDP.Caption = Get_Correlation_Description(2)
  'DISPLAY USER/CORRELATION OPTIONBOXES.
  Frm.lblCorrelationKF.Enabled = Frm.optKF(1).Value
  Frm.lblCorrelationDS.Enabled = Frm.optDS(1).Value
  Frm.lblCorrelationDP.Enabled = Frm.optDP(1).Value
  'DISPLAY CORRELATION OUTPUTS.
  Frm.lblKF = Format$(kf(0), "0.00E+00")
  Frm.lblDS = Format$(Ds(0), "0.00E+00")
  Frm.lblDP = Format$(Dp(0), "0.00E+00")




End Sub


Sub frmFreundlich_Show_KNData( _
    lblx As Control, _
    NowVal As Double, _
    UseFormat As String)
  If (NowVal = -1#) Then
    lblx.ForeColor = QBColor(12)
    lblx.Caption = "Unavailable"
  Else
    lblx.ForeColor = QBColor(0)
    lblx.Caption = Format$(NowVal, UseFormat)
  End If
End Sub
Sub frmFreundlich_Repopulate_Values()
Dim Frm As Form
Set Frm = frmFreundlich
  'DISPLAY CURRENT VALUES FOR UNIT CONTROLS.
  Call unitsys_set_number_in_base_units( _
      Frm.txtInput(11), Component(0).IPES_OrderOfMagnitude)
  Call unitsys_set_number_in_base_units( _
      Frm.txtInput(12), CDbl(Component(0).IPES_NumRegressionPts))
  Call unitsys_set_number_in_base_units( _
      Frm.UserOneOverN, Component(0).UserEntered_OneOverN)
  Call unitsys_set_number_in_base_units( _
      Frm.UserK, Component(0).UserEntered_K)
End Sub
Sub frmFreundlich_Refresh()
Dim Frm As Form
Set Frm = frmFreundlich
Dim Ctl As Control
Dim Ctl_Inv1 As Control
Dim Ctl_Inv2 As Control
Dim Avail_Height As Long
Dim Avail_Width As Long
Dim XXX As Long
Dim yyy As Long
Dim WhichSelected As Integer
Dim temp As String
'Debug.Print "frmFreundlich_Refresh()"
  'REDISPLAY ALL VALUES.
  Call frmFreundlich_Repopulate_Values
  'CENTER THE TOP FRAME.
  Frm.fraSource.Left = (Frm.ScaleWidth - Frm.fraSource.Width) / 2
  'SET UP FRAMES APPROPRIATELY.
  If (Frm.optFreundlichSource(0).Value) Then
    Set Ctl = Frm.fraIsothermDB
    Set Ctl_Inv1 = Frm.fraIPES
    Set Ctl_Inv2 = Frm.fraUserInput
  End If
  If (Frm.optFreundlichSource(1).Value) Then
    Set Ctl_Inv1 = Frm.fraIsothermDB
    Set Ctl = Frm.fraIPES
    Set Ctl_Inv2 = Frm.fraUserInput
  End If
  If (Frm.optFreundlichSource(2).Value) Then
    Set Ctl_Inv1 = Frm.fraIsothermDB
    Set Ctl_Inv2 = Frm.fraIPES
    Set Ctl = Frm.fraUserInput
  End If
  Ctl.Visible = True
  Ctl_Inv1.Visible = False
  Ctl_Inv2.Visible = False
  Avail_Height = Frm.sspanel_StatusBar.Top - _
      (Frm.fraSource.Top + Frm.fraSource.Height)
  Avail_Width = Frm.ScaleWidth
  XXX = (Avail_Width - Ctl.Width) / 2
  yyy = Frm.fraSource.Top + Frm.fraSource.Height + _
      (Avail_Height - Ctl.Height) / 2
  Ctl.Move XXX, yyy
  'VALIDATE/INVALIDATE SOURCES.
  If (Component(0).IsothermDB_K > 0#) And (Component(0).IsothermDB_OneOverN > 0#) Then
    'VALIDATE ISOTHERM DB AS SOURCE.
    Frm.optFreundlichSource(0).Caption = "Isotherm &Database"
  Else
    Frm.optFreundlichSource(0).Caption = "(Isotherm &Database)"
  End If
  If (Component(0).IPESResult_K > 0#) And (Component(0).IPESResult_OneOverN > 0#) Then
    'VALIDATE IPE CALCULATION AS SOURCE.
    Frm.optFreundlichSource(1).Caption = "Isotherm Parameter &Estimation"
  Else
    Frm.optFreundlichSource(1).Caption = "(Isotherm Parameter &Estimation)"
  End If
  'ENSURE PROPER SOURCE IS CHECKED.
  'HALT_OPTFREUNDLICHSOURCE = True
  Select Case Component(0).Source_KandOneOverN
    Case KNSOURCE_ISOTHERMDB: Frm.optFreundlichSource(0).Value = True
    Case KNSOURCE_IPES: Frm.optFreundlichSource(1).Value = True
    Case KNSOURCE_USERINPUT: Frm.optFreundlichSource(2).Value = True
  End Select
  'HALT_OPTFREUNDLICHSOURCE = False
  'DETERMINE WHICH OPTION WAS SELECTED.
  If (Frm.optFreundlichSource(0)) Then WhichSelected = 0
  If (Frm.optFreundlichSource(1)) Then WhichSelected = 1
  If (Frm.optFreundlichSource(2)) Then WhichSelected = 2
  'DISPLAY WARNING IF NEEDED.
  Frm.sspanel_Warning.Visible = False
  If (Left$(Frm.optFreundlichSource(WhichSelected).Caption, 1) = "(") Then
    Frm.sspanel_Warning.Visible = True
    Select Case WhichSelected
      Case 0
        temp = "You must select an isotherm from the isotherm " & _
            "database.  To do so, select a component on the left, " & _
            "and then select an isotherm record " & _
            "on the right.  " & _
            "If you do not, K and 1/n source will " & _
            "revert to user-input."
        Frm.lblWarning.Caption = temp
      Case 1
        temp = "You must calculate K and 1/n using IPE.  " & _
            "To do so, click on the button marked " & Chr$(34) & _
            "Perform IPE Calculations" & Chr$(34) & _
            " from within this screen.  If you do not, " & _
            "K and 1/n source will revert to user-input."
        Frm.lblWarning.Caption = temp
    End Select
  End If
  'DISPLAY CURRENT POLANYI PARAMETERS.
  Frm.txtInput(13) = Trim$(Carbon.Name)
  Frm.txtInput(0) = Format$(Carbon.W0, "0.000E+00")
  Frm.txtInput(1) = Format$(Carbon.BB, "0.000E+00")
  Frm.txtInput(10) = Format$(Carbon.PolanyiExponent, "0.000E+00")
  'DISPLAY CURRENT IPE K AND 1/N.
  Call frmFreundlich_Show_KNData( _
      Frm.lblValue(4), Component(0).IPESResult_OneOverN, "0.000")
  Call frmFreundlich_Show_KNData( _
      Frm.lblValue(5), Component(0).IPESResult_K, "###,##0.0")
  'DISPLAY CURRENT ISOTHERM DATABASE K AND 1/N.
  Call frmFreundlich_Show_KNData( _
      Frm.lblValue(1), Component(0).IsothermDB_OneOverN, "0.000")
  Call frmFreundlich_Show_KNData( _
      Frm.lblValue(0), Component(0).IsothermDB_K, "###,##0.0")
  



End Sub



Sub frmPolanyi_Repopulate_Values()
Dim Frm As Form
Set Frm = frmPolanyi
  'DISPLAY CURRENT VALUES FOR UNIT CONTROLS.
  Call unitsys_set_number_in_base_units( _
      Frm.txtInput(0), Carbon.W0)
  Call unitsys_set_number_in_base_units( _
      Frm.txtInput(1), Carbon.BB)
  Call unitsys_set_number_in_base_units( _
      Frm.txtInput(2), Carbon.PolanyiExponent)
End Sub
Sub frmPolanyi_Refresh()
'Dim frm As Form
'Set frm = frmPolanyi
  'RE-DISPLAY ALL VALUES.
  Call frmPolanyi_Repopulate_Values
End Sub


Sub frmFluidProps_Repopulate_Values()
Dim Frm As Form
Set Frm = frmFluidProps
  'DISPLAY CURRENT VALUES FOR UNIT CONTROLS.
  Call unitsys_set_number_in_base_units( _
      Frm.txtWater(0), Bed.WaterDensity)
  Call unitsys_set_number_in_base_units( _
      Frm.txtWater(1), Bed.WaterViscosity)
End Sub
Sub frmFluidProps_Refresh()
Dim Frm As Form
Set Frm = frmFluidProps
  Call frmFluidProps_Repopulate_Values
  'UPDATE CORRELATION USAGE BOXES.
  Frm.chkCorr(0).Value = State_Check_Water(1)
  Frm.chkCorr(1).Value = State_Check_Water(2)
  Frm.txtWater(0).Locked = State_Check_Water(1)
  Frm.txtWater(1).Locked = State_Check_Water(2)
End Sub


Sub frmEditAdsorberData_Repopulate_Values()
Dim Frm As Form
Set Frm = frmEditAdsorberData
  'DISPLAY CURRENT VALUES FOR UNIT CONTROLS.
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(0), CDbl(Val(frmEditAdsorberData_Record.InternalArea)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(1), CDbl(Val(frmEditAdsorberData_Record.MaxCapacity)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(2), CDbl(Val(frmEditAdsorberData_Record.OutsideDiameter)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(5), CDbl(Val(frmEditAdsorberData_Record.DefaultFlowRate)))
  'TEXT DATA.
  Frm.txtData(7) = Trim$(frmEditAdsorberData_Record.PartNumber)
  Frm.txtData(3) = Trim$(frmEditAdsorberData_Record.DesignPressure)
  Frm.txtData(4) = Trim$(frmEditAdsorberData_Record.DesignFlowRange)
  Frm.txtData(6) = Trim$(frmEditAdsorberData_Record.Note)
End Sub
Sub frmEditAdsorberData_Refresh()
'Dim frm As Form
'Set frm = frmEditAdsorberData
  Call frmEditAdsorberData_Repopulate_Values
End Sub


Sub frmEditCarbonData_Repopulate_Values()
Dim Frm As Form
Set Frm = frmEditCarbonData
  'DISPLAY CURRENT VALUES FOR UNIT CONTROLS.
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(0), CDbl(Val(frmEditCarbonData_Record.AppDen)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(1), CDbl(Val(frmEditCarbonData_Record.ParticleRadius)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(2), CDbl(Val(frmEditCarbonData_Record.ParticlePorosity)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(4), CDbl(Val(frmEditCarbonData_Record.W0)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(5), CDbl(Val(frmEditCarbonData_Record.BB)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(6), CDbl(Val(frmEditCarbonData_Record.PolanyiExponent)))
  'TEXT DATA.
  Frm.txtData(7) = Trim$(frmEditCarbonData_Record.Name)
  Frm.txtData(3) = Trim$(frmEditCarbonData_Record.AdsType)
End Sub
Sub frmEditCarbonData_Refresh()
Dim Frm As Form
Set Frm = frmEditCarbonData
  Call frmEditCarbonData_Repopulate_Values
End Sub


Sub frmEditIsothermData_Repopulate_Values()
Dim Frm As Form
Set Frm = frmEditIsothermData
  'DISPLAY CURRENT VALUES FOR UNIT CONTROLS.
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(0), CDbl(Val(frmEditIsothermData_Record.k)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(1), CDbl(Val(frmEditIsothermData_Record.Cmin)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(2), CDbl(Val(frmEditIsothermData_Record.pHmin)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(3), CDbl(Val(frmEditIsothermData_Record.Tmin)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(4), CDbl(Val(frmEditIsothermData_Record.OneOverN)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(5), CDbl(Val(frmEditIsothermData_Record.Cmax)))
  Call unitsys_set_number_in_base_units( _
      Frm.txtData(6), CDbl(Val(frmEditIsothermData_Record.pHmax)))
  'TEXT DATA.
  Frm.txtData(7) = Trim$(frmEditIsothermData_Record.CarbonName)
  Frm.txtData(8) = Trim$(frmEditIsothermData_Record.CAS)
  Frm.txtData(9) = Trim$(frmEditIsothermData_Record.Name)
  Frm.txtData(10) = Trim$(frmEditIsothermData_Record.Source)
  Frm.txtData(11) = Trim$(frmEditIsothermData_Record.Comments)
End Sub
Sub frmEditIsothermData_Refresh()
Dim Frm As Form
Set Frm = frmEditIsothermData
  Call frmEditIsothermData_Repopulate_Values
End Sub


Attribute VB_Name = "StEPP_Clipboard"
Option Explicit


Sub Do_ImportClipboard(Was_Aborted As Boolean)
Dim num_lines As Integer
Dim cliptext As String
Dim line_in As String
Dim r As Integer
Dim link_pressure As Double
Dim link_temperature As Double
Dim link_ChemCount As Integer
Const CHEMPROP_MIN = 0
Const CHEMPROP_MAX = 12
ReDim link_ChemProp(CHEMPROP_MIN To CHEMPROP_MAX, 1 To 1) As Double
ReDim link_ChemName(1 To 1) As String
ReDim link_ChemCAS(1 To 1) As String
ReDim link_ChemPropAvailable(CHEMPROP_MIN To CHEMPROP_MAX, 1 To 1) As Integer
ReDim link_IsImportable(1 To 1) As Integer
Dim i As Integer
Dim j As Integer
Const PROP_VAPORPRESSURE = 0
Const PROP_ACTIVITYCOEFFICIENT = 1
Const PROP_HENRYSCONSTANT = 2
Const PROP_MOLECULARWEIGHT = 3
Const PROP_NORMALBOILINGPOINT = 4
Const PROP_LIQUIDDENSITY = 5
Const PROP_MOLARVOLUMEATOPT = 6
Const PROP_MOLARVOLUMEATNBP = 7
Const PROP_REFRACTIVEINDEX = 8
Const PROP_AQUEOUSSOLUBILITY = 9
Const PROP_LOGKOW = 10
Const PROP_LIQUIDDIFFUSIVITY = 11
Const PROP_GASDIFFUSIVITY = 12
Dim Num_Imported As Integer
Dim ThisComp As ComponentPropertyType
Dim msg As String
Dim vb3CrLf As String
Dim Num_Failed As Integer

  Was_Aborted = True
  On Error GoTo err_Do_ImportClipboard
  cliptext = Clipboard.GetText()
  cliptext = Parser_RemoveCharacters(Chr$(10), cliptext)
  num_lines = Parser_GetNumArgs(Chr$(13), cliptext)
  r = 1
  Call Parser_GetArg(Chr$(13), cliptext, r, line_in)
  If (Trim$(UCase$(line_in)) <> Trim$(UCase$("1234567890:START_OF_STEPP_CLIPBOARD_EXPORT"))) Then
    GoTo err_nonfatal_err_Do_ImportClipboard
  End If
  r = r + 2
  Call Parser_GetArg(Chr$(13), cliptext, r, line_in)
  link_pressure = CDbl(Val(line_in))
  If (link_pressure <= 0#) Then GoTo err_nonfatal_err_Do_ImportClipboard
  r = r + 2
  Call Parser_GetArg(Chr$(13), cliptext, r, line_in)
  link_temperature = CDbl(Val(line_in))
  If (link_temperature <= 0#) Then GoTo err_nonfatal_err_Do_ImportClipboard
  r = r + 2
  Call Parser_GetArg(Chr$(13), cliptext, r, line_in)
  link_ChemCount = CInt(Val(line_in))
  If (link_ChemCount <= 0) Then GoTo err_nonfatal_err_Do_ImportClipboard
  ReDim link_ChemProp(CHEMPROP_MIN To CHEMPROP_MAX, 1 To link_ChemCount)
  ReDim link_ChemName(1 To link_ChemCount)
  ReDim link_ChemCAS(1 To link_ChemCount)
  ReDim link_ChemPropAvailable(CHEMPROP_MIN To CHEMPROP_MAX, 1 To link_ChemCount)
  ReDim link_IsImportable(1 To link_ChemCount)
  For i = 1 To link_ChemCount
    For j = CHEMPROP_MIN To CHEMPROP_MAX
      link_ChemPropAvailable(j, i) = True
    Next j
    r = r + 2
    Call Parser_GetArg(Chr$(13), cliptext, r, line_in)
    link_ChemName(i) = Trim$(UCase$(line_in))
    If (link_ChemName(i) = "") Then GoTo err_nonfatal_err_Do_ImportClipboard
    r = r + 2
    Call Parser_GetArg(Chr$(13), cliptext, r, line_in)
    link_ChemCAS(i) = Trim$(UCase$(line_in))
    'If (link_ChemCAS(i) = "") Then GoTo err_nonfatal_err_Do_ImportClipboard
    For j = CHEMPROP_MIN To CHEMPROP_MAX
      r = r + 2
      Call Parser_GetArg(Chr$(13), cliptext, r, line_in)
      line_in = Trim$(UCase$(line_in))
      If (Trim$(UCase$("UNAVAILABLE")) = line_in) Then
        link_ChemPropAvailable(j, i) = False
      Else
        link_ChemProp(j, i) = CDbl(Val(line_in))
      End If
    Next j
  Next i
  r = r + 1
  Call Parser_GetArg(Chr$(13), cliptext, r, line_in)
  If (Trim$(UCase$(line_in)) <> Trim$(UCase$("1234567890:END_OF_STEPP_CLIPBOARD_EXPORT"))) Then
    GoTo err_nonfatal_err_Do_ImportClipboard
  End If
  
  'ARE THERE ENOUGH EMPTY COMPONENT SLOTS REMAINING?
  If (Number_Component + link_ChemCount > Number_Compo_Max) Then
    Call Show_Error("Unable to import all of chemicals in file " & _
        "because the maximum number of chemicals has been reached.")
    'Unload Me
    Exit Sub
  End If

  'DOES THE USER REALLY WANT TO IMPORT AT THIS TEMPERATURE AND PRESSURE?
      '---- I'VE DECIDED TO SKIP THIS STEP.  THE USER BEWARE.
  
  'DETERMINE WHICH COMPONENTS ARE IMPORTABLE.
  For i = 1 To link_ChemCount
    link_IsImportable(i) = True
    If (Not link_ChemPropAvailable(PROP_VAPORPRESSURE, i)) Then link_IsImportable(i) = False
    If (Not link_ChemPropAvailable(PROP_MOLECULARWEIGHT, i)) Then link_IsImportable(i) = False
    If (Not link_ChemPropAvailable(PROP_NORMALBOILINGPOINT, i)) Then link_IsImportable(i) = False
    If (Not link_ChemPropAvailable(PROP_LIQUIDDENSITY, i)) Then link_IsImportable(i) = False
    If (Not link_ChemPropAvailable(PROP_MOLARVOLUMEATNBP, i)) Then link_IsImportable(i) = False
    If (Not link_ChemPropAvailable(PROP_REFRACTIVEINDEX, i)) Then link_IsImportable(i) = False
    If (Not link_ChemPropAvailable(PROP_AQUEOUSSOLUBILITY, i)) Then link_IsImportable(i) = False
  Next i

  'IMPORT ALL IMPORTABLE COMPONENTS.
  Num_Imported = 0
  For i = 1 To link_ChemCount
    If (link_IsImportable(i)) Then
      Num_Imported = Num_Imported + 1
      Call SetComponentDefaults(ThisComp, -1)
      ThisComp.name = link_ChemName(i)
      ThisComp.Cas = CLng(Val(link_ChemCAS(i)))
      ThisComp.Vapor_Pressure = link_ChemProp(PROP_VAPORPRESSURE, i)
      ThisComp.MW = link_ChemProp(PROP_MOLECULARWEIGHT, i)
      ThisComp.BP = link_ChemProp(PROP_NORMALBOILINGPOINT, i)
      ThisComp.Liquid_Density = link_ChemProp(PROP_LIQUIDDENSITY, i) / 1000#
      ThisComp.MolarVolume = link_ChemProp(PROP_MOLARVOLUMEATNBP, i) * 1000#
      ThisComp.Refractive_Index = link_ChemProp(PROP_REFRACTIVEINDEX, i)
      ThisComp.Aqueous_Solubility = link_ChemProp(PROP_AQUEOUSSOLUBILITY, i)
      Number_Component = Number_Component + 1
      Component(Number_Component) = ThisComp
      
      ''Take care of miscellaneous screen B.S.
      'frmpfpsdm!cmdViewDimensionless.Enabled = True
      'frmpfpsdm!cmdEditComponent.Enabled = True
      'frmpfpsdm!cmdDeleteComponent.Enabled = True
      'frmpfpsdm!lstComponents.AddItem thiscomp.name
      'frmpfpsdm!cboSelectCompo.Enabled = True
      'frmpfpsdm!cboSelectCompo.AddItem thiscomp.name
      'If (Number_Component = Number_Compo_Max) Then
      '  frmpfpsdm!cmdAddComponent.Enabled = False
      'End If
      ''Set index of the kinetic combo box to the new chemical
      'frmpfpsdm!cboSelectCompo.ListIndex = frmpfpsdm!cboSelectCompo.ListCount - 1
      ''Update the corresponding kinetic data displayed
      'Call Update_Display_Kinetic
      'If (Number_Component > 0) Then
      '  frmpfpsdm!mnuRunItem(0).Enabled = True
      '  frmpfpsdm!mnuRunItem(1).Enabled = True
      '  frmpfpsdm!mnuRunItem(2).Enabled = True
      '  frmpfpsdm!mnuOptionsItem(0).Enabled = True
      '  frmpfpsdm!mnuOptionsItem(1).Enabled = True  'Variable Influent concentration
      '  frmpfpsdm!mnuOptionsItem(2).Enabled = True  'Variable Effluent concentration
      'End If
    End If
  Next i

  'DISPLAY WARNING/SUCCESS MESSAGE.
  vb3CrLf = Chr$(13) & Chr$(10)
  If (Num_Imported <> 0) Then
    msg = "Successfully imported " & Trim$(Str$(Num_Imported)) & " component"
    If (Num_Imported <> 1) Then msg = msg & "s"
    msg = msg & " from StEPP:" & vb3CrLf
    For i = 1 To link_ChemCount
      If (link_IsImportable(i)) Then
        msg = msg & "    " & Trim$(link_ChemName(i)) & vb3CrLf
      End If
    Next i
    msg = msg & "The properties are for a "
    msg = msg & "pressure of " & Trim$(Str$(link_pressure)) & " Pa "
    msg = msg & "and a "
    msg = msg & "temperature of " & Trim$(Str$(link_temperature)) & " degrees Celcius." & vb3CrLf
    msg = msg & vb3CrLf
    msg = msg & "Don't forget to set the correct values of Freundlich K, "
    msg = msg & "Freundlich 1/n, and initial concentration for each "
    msg = msg & "of these components." & vb3CrLf
  Else
    msg = "Unable to import any components from StEPP." & vb3CrLf
  End If
  Num_Failed = link_ChemCount - Num_Imported
  If (Num_Failed <> 0) Then
    msg = msg & vb3CrLf
    msg = msg & "Failed to import the following component"
    If (Num_Failed <> 1) Then msg = msg & "s"
    msg = msg & ":" & vb3CrLf
    For i = 1 To link_ChemCount
      If (Not link_IsImportable(i)) Then
        msg = msg & "    " & Trim$(link_ChemName(i)) & vb3CrLf
      End If
    Next i
    msg = msg & vb3CrLf
    msg = msg & "Important note: In order to successfully import a component "
    msg = msg & "from StEPP, the following properties must be available: "
    msg = msg & "vapor pressure, "
    msg = msg & "molecular weight, "
    msg = msg & "normal boiling point, "
    msg = msg & "liquid density, "
    msg = msg & "molar volume at the normal boiling point, "
    msg = msg & "refractive index, "
    msg = msg & "and aqueous solubility.  "
    msg = msg & "To force an import to occur, you may modify the user input "
    msg = msg & "value of the unavailable properties from within StEPP."
    msg = msg & vb3CrLf
  End If
  Call Show_Message(msg)
  Was_Aborted = False
  
exit_err_err_Do_ImportClipboard:
  Exit Sub
err_nonfatal_err_Do_ImportClipboard:
  Call Show_Error("An error occurred during the import process.")
  GoTo exit_err_err_Do_ImportClipboard
err_Do_ImportClipboard:
  Call Show_Error("An error occurred during the import process.")
  Resume exit_err_err_Do_ImportClipboard
End Sub

Attribute VB_Name = "Structs"
Option Explicit


Global Const USE_GASPHASE_WAKAO_AND_FUNAZUKRI = False  'False 'True

Global Const Application_Name = "Adsorption Design Software"

Global Const name_app = "AdDesignS"
Global Const name_app_long = "Adsorption Design Software"

'Constants
'Global Const NVersion = 1.3
Global Const NVersion = 1.4
Global Const Latest_DataVersion_Major = 1
Global Const Latest_DataVersion_Minor = 60
Global Const Number_Compo_Max = 10
Global Const MAXCHEMICAL = Number_Compo_Max
Global Const Number_Compo_Max_PFPSDM = 6
Global Const Number_Compo_Max_ECM = 9
Global Const Number_Compo_Max_CPM = 1
Global Const Number_Points_Max = 400
Global Const Number_Data_Points_Max = 400
Global Const Number_Max_Influent_Points = 400
Global Const Max_Number_Correlation_Compo = 25
Global Const Max_Number_Water_Correlations = 25
Global Const CPM_Max_Points = 100
Global Const PI = 3.14159265359

  'Modified Hokanson 2/8/97
  'Global Const Max_Radial_Collocation = 6
Global Const Max_Radial_Collocation = 18
Global Const Max_Equations_DGEAR = 750
  'end Modified Hokanson 2/8/97

Global Const Max_Axial_Collocation = 18
Global Const Max_Number_Fouling_Iterations = 100
Global Const Maximum_Beds_In_Series = 200
Global Const EPS_ERROR_CRITERIA = 0.0005

Type Tempo_Data
    MW As Double
    Solubility As Double
    Density As Double
    R_Index As Double
    T As Double
    Pvap As Double
End Type

Type IPES_Input
    Adsorbent As String
    BB As Double
    W0 As Double
    RH As Double    'Relative Humidity
    C As Double     'Concentration
    Phase As String * 6
    IMOD As Integer
    GM As Double
    OMAG As Double
    NL As Integer
End Type

Type IPES_Output
    XN As Double
    XK1 As Double
    XK2 As Double
    CSAV As Double
    QSAV As Double
    CBEG As Double
    CEND As Double
    RSQD As Double
    RMSE As Double
    Error_Matrix(30) As Integer
    CorrelationPoints_lnC(1 To 200) As Double
    CorrelationPoints_lnQ(1 To 200) As Double
    CorrelationPoints_NumPoints As Integer
    QCAP(1 To 200) As Double
    ADSP(1 To 200) As Double
    PI(1 To 200) As Double
End Type

Type IPES_Variable
    Input As IPES_Input
    Output As IPES_Output
End Type

Type Correlation_Compound_Type
    Name As String
    Coeff(2) As Double
End Type

Type Correlation_Water_Type
    Name As String
    Coeff(4) As Double
End Type

Global Const KNSOURCE_ISOTHERMDB = 1
Global Const KNSOURCE_IPES = 2
Global Const KNSOURCE_USERINPUT = 3


Global Const IPESMETHOD_LIQ_3PARAM = 1
Global Const IPESMETHOD_LIQ_DRUNIFORM = 2
Global Const IPESMETHOD_LIQ_DRNONUNIFORM = 3
Global Const IPESMETHOD_GAS_DRZERORH = 101
Global Const IPESMETHOD_GAS_CALGONBPL = 102
Global Const IPESMETHOD_GAS_DRSPREADINGP = 103


Type ComponentPropertyType
'Isotherm Freundlich q=k*C^OneOverN
    
    '***** Properties: *****
    Name As String * 50
    CAS As Long
    MW As Double                    'g/mol
    MolarVolume As Double           'cm3/mol
    BP As Double                    'degrees Celcius
    InitialConcentration As Double  'mg/l
    Use_K As Double                 '(mg/g)*(L/mg)^OneoverN
    Use_OneOverN As Double          '(-)
    Source_KandOneOverN As Integer  'Isotherm DB / IPES / User-Input
    UserEntered_K As Double
    UserEntered_OneOverN As Double
    Treatment_Objective As Double
    '***** IPES RELATED: *****
    IPES_OrderOfMagnitude As Double
    IPES_NumRegressionPts As Integer
    IPES_RelativeHumidity As Double
    IPES_EstimationMethod As Integer
    Liquid_Density As Double        'g/cm^3
    Aqueous_Solubility As Double    'mg/L
    Vapor_Pressure As Double        'Pa
    Refractive_Index As Double      '(-)
    IPESResult_K As Double
    IPESResult_OneOverN As Double
    
    '***** Isotherm Database: *****
    IsothermDB_Component_Name As String * 70
      '(note: includes CAS and Name exactly as it appears on the Freundlich Isotherm Parameters form)
    IsothermDB_Range_Num As Integer
      '(this is the list index [1-n] of the selected range.)
    IsothermDB_K As Double
    IsothermDB_OneOverN As Double

    '***** Kinetics *****
    SPDFR As Double
    SPDFR_Low_Concentration As Integer
    Use_SPDFR_Correlation As Integer
    Corr(3) As Integer
    kf As Double                    'cm/s
    Ds As Double                    'cm2/s
    Dp As Double                    'cm2/s
    KP_User_Input(3) As Double
    Tortuosity As Double
    Use_Tortuosity_Correlation As Integer
    Constant_Tortuosity As Integer

    '***** ECM *****
    K_Reduction As Integer          'Boolean
    Correlation As Correlation_Compound_Type
                                    'Correlation to calculate K reduction

    Is_Selected_On_List As Boolean
        'TEMPORARY INTERNAL VARIABLE: NOT SAVED.
End Type

Type PropertyUnitsType
    MW As String
    MolarVolume As String
    BP As String
    InitialConcentration As String
    Liquid_Density As String
    Aqueous_Solubility As String
    Vapor_Pressure As String
    Refractive_Index As String
    k As String
    BedTemperature As String
    BedPressure As String
    BedFluidDensity As String
    BedFluidViscosity As String
End Type
Global PropertyUnits As PropertyUnitsType

Type BedPropertyType
    length As Double            'm
    Diameter As Double          'm
    Weight As Double            'kg
    Flowrate As Double          'm3/s
    Density As Double           'g/cm3
    SuperficialVelocity As Double  'm/s
    Porosity As Double          '(-)
    InterstitialVelocity As Double 'm/s
    Area As Double              'm2
    Volume As Double            'm3
    TAU As Double               'min (packed bed contact time)
    NumberOfBeds As Integer     '(-)
    WaterDensity As Double      'g/cm3
    WaterViscosity As Double    'g/cm.s
    Temperature As Double       'C
    Pressure As Double          'Atm
    Phase As Integer            '=0 -> liquid, =1 -> gas
    Water_Correlation As Correlation_Water_Type   'Correlation to calcualte K reduc

    UnitsLength As Integer
    UnitsDiameter As Integer
    UnitsWeight As Integer
    UnitsFlowrate As Integer
    UnitsEBCT As Integer
    UnitsFluidDensity As Integer
    UnitsFluidViscosity As Integer
    UnitsFluidTemperature As Integer
    UnitsFluidPressure As Integer
End Type

Type CarbonPropertyType
    'Manu As String
    Name As String
    Porosity As Double         ' -
    Density As Double          'g/cm3  Apparent density
    ParticleRadius As Double   'm
    Tortuosity As Double       ' -            'UNUSED!!!
' Need to add W0, BB, Polanyi Exponent here!
' It appears safe to add these variables.
    W0 As Double
    BB As Double
    PolanyiExponent As Double

    '---- Added by EJO on 11/1/96 for kf (external mass xfer coefficient)
    ShapeFactor As Double       ' -
End Type

Type DataCarbon
    Index As Integer
    CAS As Long
    Name As String * 50
    NameC As String * 20
    pHmin As Double
    pHmax As Double
    k As Double
    N As Double 'Actually, this is 1/n
    Cmin As Double
    Cmax As Double
    Temperature As Double
    Phase As String * 50
    Source As String * 50
    Comments As String * 50
End Type

Type Para_Int
    Init As Double
    End As Double
    np As Integer
    Step As Double
End Type

Type Throughput
    T As Double
    C As Double
End Type

Type ResultsType
    NComponent As Integer
    npoints As Integer
    CP(Number_Compo_Max, Number_Points_Max) As Double
    T(Number_Points_Max) As Double
    ThroughPut_05(Number_Compo_Max) As Throughput
    ThroughPut_50(Number_Compo_Max) As Throughput
    ThroughPut_95(Number_Compo_Max) As Throughput
    Component(Number_Compo_Max) As ComponentPropertyType
    Bed As BedPropertyType
    Carbon As CarbonPropertyType
    Use_Tortuosity_Correlation As Integer
    Constant_Tortuosity As Integer
    NumPoints_Before_ThroughPut_100(Number_Compo_Max) As Integer       'Used by PSDM to cut off display when C/C0 >= 1
    is_psdm_in_room_model As Integer
    psdmroom_Crss(1 To Number_Compo_Max) As Double       'ug/L
    AnyCrCloseToZero As Integer
End Type

Type PSDMInputsType
    VARS1(1 To 15) As Double
    VARS2(1 To Number_Compo_Max, 1 To 19) As Double
End Type

Type ECM_Data
    Index As Integer
    Bed_Volume_Fed As Double
    Wave_Velocity As Double
    Dimensionless_Bed_Length As Double
    SS_Treatment_Capacity As Double
    Solid_Concentration(Number_Compo_Max) As Double
    Liquid_Concentration(Number_Compo_Max)  As Double
    C_Over_C0(Number_Compo_Max) As Double
    Carbon_Usage_Rate As Double
End Type

Type ECM_MASSBAL
    MASSBAL_C0_e_Vf(Number_Compo_Max) As Double
    MASSBAL_TERM_SUM(Number_Compo_Max) As Double
    MASSBAL_PERCENT_ERR(Number_Compo_Max) As Double
End Type
Global Output_ECM_MASSBAL As ECM_MASSBAL

Type CPM_Data
    T(CPM_Max_Points) As Double
    C_Over_C0(CPM_Max_Points)  As Double
    Par(7) As Double
    ThroughPut_05 As Throughput
    ThroughPut_50 As Throughput
    ThroughPut_95 As Throughput
    Component As ComponentPropertyType
    Bed As BedPropertyType
    Carbon As CarbonPropertyType
    Use_Tortuosity_Correlation As Integer
    Constant_Tortuosity As Integer
End Type

Type Isotherm_Data
    number As Integer
    Selected As Long
    Record As DataCarbon
End Type

Type Isotherm_Data_Save
    New_CAS As Integer
    New_Name As Integer
    Record As DataCarbon
End Type

Type Isotherm_Chemical
    CAS As Long
    Name As String * 50
    Update_Name As Integer
    Update_CAS As Integer
End Type

Type Carbon_Data
    Name As String * 50
    Density As Double
    ParticleRadius As Double
    Porosity As Double
    ShapeFactor As Double
    Tortuosity As Double                  'UNUSED!
    Phase As Integer '1=Liquid, 2 =gas
    Type As String * 50
    W0 As Double
    b As Double
    PolanyiExponent As Double
End Type

'Variables for Help System
Global HelpFile As String

'Variable for security
Global Open_Database As Integer

'Variables
Global PFPSDM_Path As String, Error_In_Kinetic_Calculation As Integer
Global Database_Path As String
Global Exe_Path As String     'NEW 9/2/98.
Global Flag_Openfile As Integer
Global Update_Value_From_Carbon As Integer, Update_Value_From_IPES As Integer
Global Temp_Text As String 'Temporary string to store former value of a text box
Global AddFlag As Integer 'Flag - True = Add a chemical to the list - False = Edit chemical properties
Global Component_Number_Selected As Integer
Global State_Check_Water(2) As Integer  'Flag to know whether correlations are used for water properties
Global Filename As String, Previous_FileName As String
Global Results As ResultsType
Global PSDM_Inputs As PSDMInputsType
Global Print_To_Printer As Integer 'Flag - True = print to Printer - False = Print to file
Global NL As String
Global batchrun As Integer
Global Treatment_Objective(Number_Compo_Max_PFPSDM) As Throughput

'Variable for Tortuosity as a function of Time
Global Use_Tortuosity_Correlation As Integer, Constant_Tortuosity As Integer

'Variable for the search function
Global Start_Search As Integer
Global Find_String As String, Index_NameT As Integer, Index_Find As Integer

'Variables for K reduction
Global Number_Correlations_Compounds As Integer
Global Number_Water_Correlations As Integer
Global Correlations_For_Classes(Max_Number_Correlation_Compo) As Correlation_Compound_Type
Global Correlations_For_Water(Max_Number_Water_Correlations) As Correlation_Water_Type

'Variable used to transfer data to excel
Global Excel_4 As Integer
Global PFPSDM_Excel As Integer

'Variables used to edit the isotherm database
Global Mode_Chemical As Integer, Mode_Isotherm As Integer
Global Iso_Data As Isotherm_Data
Global Iso_Data_Save As Isotherm_Data_Save
Global Iso_Chemical As Isotherm_Chemical

'Variables used to edit the carbon database
Global Mode_Manu As Integer
Global Mode_Carbon As Integer
Global Name_Manufacturer_In As String
Global Name_Manufacturer_Out As String
Global Carbon_Data_In As Carbon_Data
Global Carbon_Data_Out As Carbon_Data

'Variables for ECM model
Global Output_ECM(Number_Compo_Max) As ECM_Data
Global Number_Component_ECM As Integer
Global Component_Index_ECM(Number_Compo_Max_ECM)

'Variables for the Contant Pattern Model
Global CPHSDM_Excel As Integer
Global Number_Component_CPM As Integer
Global Component_Index_CPM As Integer
Global CPM_Results As CPM_Data

'Variables for the PFPSDM FORTRAN program
Global C_Influent(Number_Compo_Max, Number_Max_Influent_Points) As Double, T_Influent(Number_Max_Influent_Points) As Double
Global Number_Influent_Points As Integer
Global TimeP As Para_Int
Global MC As Integer, NC As Integer
Global Number_Component As Integer
Global Bed As BedPropertyType
Global Component(0 To Number_Compo_Max) As ComponentPropertyType 'Component(0) is a component used for temporary storage. Component(1) to Component(N) are the components in the listbox
Global Carbon As CarbonPropertyType

Global Component_Index_PFPSDM(Number_Compo_Max_PFPSDM) As Integer
Global Number_Component_PFPSDM As Integer

Global IPES_Data As IPES_Variable
Global Properties_For_IPES As Tempo_Data

'Flags to avoid problems when loading a file...
Global Use_Update_Display_Kinetic As Integer

'Flags to check whether or not the user wants the data to be saved before exiting
' in the QueryUnload event from the main window
Global ReallyQuit  As Integer

'Arrays to store the experimental data points for comparison to a PSDM simulation
Global T_Data_Points(Number_Data_Points_Max)   As Double
Global C_Data_Points(Number_Compo_Max, Number_Data_Points_Max) As Double
Global NData_Points As Integer
'Global NComponents As Integer

'Variable to store isotherm parameters to plot it
Global IsothermProperties As DataCarbon

'Variable to tell frmBatch its default model to simulate
Global BatchSimulation_DefaultModel As Integer

'Variables to tell frmStEPPImport what to do.
Global Const STEPPIMPORT_ADDCOMPONENTS = 1
Global Const STEPPIMPORT_IPESCOMPONENT = 2
Global StEPPImportDestination As Integer
Global StEPPImportSuccess As Integer
Type StEPP_to_IPES_Properties_type
  Name As String
  MW As Double
  MolarVolume As Double
  BP As Double
End Type
Global StEPP_to_IPES_Properties As StEPP_to_IPES_Properties_type

Attribute VB_Name = "Structs2"
Option Explicit

'//////// COMMUNICATIONS WITH frmEditAdsorber: ////////////////////////////////////////////////////////
Type rec_adsorber_db_manufacturers
  UniqueID As String    'Must be an integer in string form!
  Name As String
End Type

Type rec_adsorber_db_adsorbers
  UniqueID_Manufacturer As Integer
  Phase As Integer
  PartNumber As String * 20
  InternalArea As String * 20
  MaxCapacity As String * 20
  OutsideDiameter As String * 20
  DesignPressure As String * 20
  DesignFlowRange As String * 20
  DefaultFlowRate As String * 20
  Note As String * 100
End Type

Global adsorber_db_num_manufacturers As Integer
Global adsorber_db_manufacturers() As rec_adsorber_db_manufacturers

Global adsorber_db_num_adsorbers As Integer
Global adsorber_db_adsorbers() As rec_adsorber_db_adsorbers

Type rec_frmEditAdsorber_ReturnParameters
  D As Double
  L As Double
  M As Double
  Q As Double
End Type

Global frmEditAdsorber_ReturnParameters As rec_frmEditAdsorber_ReturnParameters


'//////// COMMUNICATIONS WITH frmEditAdsorberData: /////////////////////////////////////////////////
Global frmEditAdsorberData_Record As rec_adsorber_db_adsorbers


'//////// COMMUNICATIONS WITH frmEditCarbonData: /////////////////////////////////////////////////
Type frmEditCarbonData_Record_Type
  PhaseIsLiquid As Boolean
  Name As String
  AppDen As Double
  ParticleRadius As Double
  ParticlePorosity As Double
  AdsType As String
  W0 As Double
  BB As Double
  PolanyiExponent As Double
End Type
Global frmEditCarbonData_Record As frmEditCarbonData_Record_Type


'//////// COMMUNICATIONS WITH frmEditIsothermData: /////////////////////////////////////////////////
Type frmEditIsothermData_Record_Type
  PhaseIsLiquid As Boolean
  Name As String
  k As Double
  OneOverN As Double
  Cmin As Double
  Cmax As Double
  pHmin As Double
  pHmax As Double
  Source As String
  CarbonName As String
  Tmin As String
  CAS As String
  Comments As String
End Type
Global frmEditIsothermData_Record As frmEditIsothermData_Record_Type



'---- frmConcentrations variables
Global frmConcentrations_cancelled As Integer
Global frmConcentrations_Times(1 To 400) As Double
Global frmConcentrations_Concs(1 To 10, 1 To 400) As Double
Global frmConcentrations_NumPoints As Integer
Global frmConcentrations_NumConcs As Integer
Global frmConcentrations_caption As String
Global frmConcentrations_TimeOrderImportant As Integer
Global frmConcentrations_Cunits As String
Global frmConcentrations_Tunits As String

'---- frmShow_Data_And_Prediction variables
Global frmCompareData_WhichSet As Integer
Global Const frmCompareData_WhichSet_PSDM = 1
Global Const frmCompareData_WhichSet_CPHSDM = 2
Global frmCompareData_caption As String






'MISCELLANEOUS.
Global FileNote As String

Attribute VB_Name = "StructsDo"
Option Explicit


'INPUTS:
'    CompNum =
'        0 OR ABOVE : COMPONENT NUMBER TO USE FOR CALLS TO
'                     Dp(), Ds(), Kf()
'        -1 : DO NOT MAKE CALLS TO Dp(), Ds(), Kf() [SEE BELOW]
'OUTPUTS:
'    x = COMPONENT STRUCTURE TO SET DEFAULTS FOR.
Sub SetComponentDefaults( _
    X As ComponentPropertyType, _
    CompNum As Integer)
Dim i As Integer

  '***** Properties: *****
  X.Name = "New Component"
  '---- Changed by Eric J. Oman 8/8/97 BEGINS:
  X.CAS = 0
  'x.Cas = 79016
  '---- Changed by Eric J. Oman 8/8/97 ENDS.
  X.MW = 131.39
  X.MolarVolume = 102#
  X.BP = 87
  X.InitialConcentration = 50#
  X.Use_K = 98#
  X.Use_OneOverN = 0.43
  X.Source_KandOneOverN = KNSOURCE_USERINPUT
  X.UserEntered_K = 98#
  X.UserEntered_OneOverN = 0.43
  X.Treatment_Objective = 0.005

  '***** IPES *****
  X.IPES_OrderOfMagnitude = 4#
  X.IPES_NumRegressionPts = 50
  X.IPES_RelativeHumidity = 0#
  X.IPES_EstimationMethod = IPESMETHOD_LIQ_3PARAM
  X.Liquid_Density = 1.53
  X.Aqueous_Solubility = 1100#
  X.Vapor_Pressure = 9830#
  X.Refractive_Index = 1.475
  X.IPESResult_K = -1
  X.IPESResult_OneOverN = -1

  '***** Isotherm Database *****
  X.IsothermDB_Component_Name = ""
  X.IsothermDB_Range_Num = -1
  X.IsothermDB_K = -1
  X.IsothermDB_OneOverN = -1

  '***** Kinetics *****
  X.SPDFR = 5#
  X.SPDFR_Low_Concentration = True
  X.Use_SPDFR_Correlation = False
  X.Tortuosity = 1#
  X.Use_Tortuosity_Correlation = False
  X.Constant_Tortuosity = True

  For i = 1 To 3
    X.Corr(i) = True
  Next i
  If (CompNum <> -1) Then
    X.Dp = Dp(CompNum)
    X.Ds = Ds(CompNum)
    X.kf = kf(CompNum)
  Else
    X.Dp = 0.0000000001
    X.Ds = 0.0000000001
    X.kf = 0.0000000001
  End If
  X.KP_User_Input(1) = X.kf
  X.KP_User_Input(2) = X.Ds
  X.KP_User_Input(3) = X.Dp

  '***** ECM *****
  X.K_Reduction = False
  'Note: leaving x.Correlation (K reduction) unset.
  
  X.Is_Selected_On_List = False

End Sub
Sub SetBedDefaults(BedPhase As Integer)
  'Liquid Phase
  If (BedPhase = 0) Then
    Bed.Phase = 0
    Bed.length = 2.765
    Bed.Diameter = 3.048
    Bed.Weight = 9072#
    Bed.Flowrate = 0.03577
    Bed.NumberOfBeds = 1
    Bed.WaterDensity = 0.99915
    Bed.Temperature = 15#
    Bed.WaterViscosity = 0.0115
    Bed.Pressure = 1#
  End If
  'Gas Phase
  If (BedPhase = 1) Then
    Bed.Phase = 1
    Bed.length = 1.09
    Bed.Diameter = 3.66
    Bed.Weight = 4540#
    Bed.Flowrate = 1.09
    Bed.NumberOfBeds = 1
    Bed.WaterDensity = 0.99569
    Bed.Temperature = 30#
    Bed.WaterViscosity = 0.00815
    Bed.Pressure = 1#
  End If
End Sub
Sub SetCarbonDefaults(BedPhase As Integer)
  If (BedPhase = 0) Then
    Carbon.Name = "Calgon F 400"
    Carbon.Density = 0.803                  'g/cm^3
    Carbon.ParticleRadius = 0.0513 / 100#     'cm ---> m
    Carbon.Porosity = 0.641                 '(-)
    Carbon.ShapeFactor = 1#
    Carbon.Tortuosity = 1#    'UNUSED!
    Carbon.W0 = 0.63
    Carbon.BB = 0.02766
    Carbon.PolanyiExponent = 1.208
  End If
  If (BedPhase = 1) Then
    Carbon.Name = "Calgon BPL 4x6 mesh"
    Carbon.Density = 0.85
    Carbon.ParticleRadius = 0.186 / 100#      'cm ---> m
    Carbon.Porosity = 0.595
    Carbon.ShapeFactor = 1#
    Carbon.Tortuosity = 1#    'UNUSED!
    Carbon.W0 = 0.46
    Carbon.BB = 0.0000000337
    Carbon.PolanyiExponent = 2#
  End If
End Sub


'BedPhase:
'    0 = LIQUID PHASE.
'    1 = GAS PHASE.
Sub Initialize_All_Data(BedPhase As Integer)
Dim i As Integer
    
  Number_Component = 0
  
  Bed.Phase = BedPhase
  Call chem_phase(BedPhase)

  Filename = ""
  frmMain.Caption = name_app & "  -  (Untitled)"
  FileNote = ""
  
  'Set Default PFPSDM Simulation Data:
  Number_Influent_Points = 0
  MC = 8
  NC = 3
  TimeP.Init = 19000#
  TimeP.End = 250000#
  TimeP.np = 1900
  TimeP.Step = 600#
  
  'Set Default Carbon Data:
  Call SetCarbonDefaults(BedPhase)   'Set Carbon defaults for Liquid Phase (0).
  
  'Set Default Bed Data:
  Call SetBedDefaults(BedPhase)      'Set Bed defaults for Liquid Phase (0).
  
  'Set Default Water Correlation Data:
  Bed.Water_Correlation.Name = "Organic Free Water"
  Bed.Water_Correlation.Coeff(1) = 1#
  Bed.Water_Correlation.Coeff(2) = 0#
  Bed.Water_Correlation.Coeff(3) = 0#
  Bed.Water_Correlation.Coeff(4) = 0#
  
  ''Display Carbon and Bed Values on Window:
  'frmMain.txtCarbon(0) = Trim$(Carbon.name)
  'frmMain.txtCarbon(1) = Format$(Carbon.Density, "0.000")
  'frmMain.txtCarbon(2) = Format$(Carbon.ParticleRadius * 100#, "0.00000")
  'frmMain.txtCarbon(3) = Format$(Carbon.Porosity, "0.000")
  'frmMain.txtCarbon(4) = Format$(Carbon.ShapeFactor, "0.000")
  'frmMain.txtBedValue(0) = Format_It(Bed.Length, 3)
  'frmMain.txtBedValue(1) = Format_It(Bed.Diameter, 3)
  'frmMain.txtBedValue(2) = Format_It(Bed.Weight, 2)
  'frmMain.txtBedValue(3) = Format$(Bed.Flowrate, "0.000E+00")
        
  'Initialization for Kinetic Parameters
  Use_Tortuosity_Correlation = False          'UNUSED!
  Constant_Tortuosity = True                  'UNUSED!
  
  'Initialization for Water Properties
  State_Check_Water(1) = 1
  State_Check_Water(2) = 1
  
  'Set Default Units:
  frmMain.txtBedUnits(0).ListIndex = 0
  frmMain.txtBedUnits(1).ListIndex = 0
  frmMain.txtBedUnits(2).ListIndex = 0
  frmMain.txtBedUnits(3).ListIndex = 0
  frmMain.txtBedUnits(4).ListIndex = 0
  frmMain.txtCarbonUnits(1).ListIndex = 0
  frmMain.txtCarbonUnits(2).ListIndex = 0
  PropertyUnits.MW = "mg/mmol"
  PropertyUnits.MolarVolume = "mL/gmol"
  PropertyUnits.BP = "C"
  PropertyUnits.InitialConcentration = "mg/L"
  PropertyUnits.Liquid_Density = "g/mL"
  PropertyUnits.Aqueous_Solubility = "mg/L"
  PropertyUnits.Vapor_Pressure = "Pa"
  PropertyUnits.k = "(mg/g)*(L/mg)^(1/n)"
  
  'Temporary kludge until we allow saveable-settable units:
  Call unitsys_set_units(frmMain.txtTime(0), "d")
  Call unitsys_set_units(frmMain.txtTime(1), "d")
  Call unitsys_set_units(frmMain.txtTime(2), "d")
  
  'REFRESH THE MAIN WINDOW.
  Call frmMain_Refresh
  
  'OLD STUFF:
         ''Call Update_Display       'This routine calculates EBCT from txtBedValue(0...3)
         '''''''frmmain.txtBedValue(4) = Format_It(21.03, 2)
      
         '''Update the display in the main window
         ''Call Update_Display_Data
         ''Call Update_Display_Kinetic
         ''Call Update_Bed_Density_Display
  'OLD STUFF [ENDS].

  'SET PSDM-IN-ROOM MODEL PARAMETERS.
  RoomParams.COUNT_CONTAMINANT = 0
  RoomParams.ROOM_VOL = 40776259# / 100# / 100# / 100#
  RoomParams.ROOM_FLOWRATE = 3397.89 / 100# / 100# / 100#
  For i = 1 To Number_Compo_Max
    RoomParams.ROOM_C0(i) = 0#
    RoomParams.ROOM_EMIT(i) = 1.7
    RoomParams.INITIAL_ROOM_CONC(i) = 0#
  Next i
  RoomParams.ROOM_VOL_Units = "m" & Chr$(179)
  RoomParams.ROOM_FLOWRATE_Units = "m" & Chr$(179) & "/s"
  RoomParams.ROOM_C0_Units = "mg/L"
  RoomParams.ROOM_EMIT_Units = "g/s"
  RoomParams.INITIAL_ROOM_CONC_Units = "mg/L"
  Call RoomParam_Recalculate(RoomParams)

End Sub


Sub GetMoreBedParameters()
Dim EBCT As Double
  Bed.Area = PI * Bed.Diameter * Bed.Diameter / 4
  Bed.Volume = Bed.Area * Bed.length
  Bed.Density = Bed.Weight / Bed.Volume / 1000
  Bed.Porosity = 1# - Bed.Density / Carbon.Density
  Bed.SuperficialVelocity = Bed.Flowrate / Bed.Area
  Bed.InterstitialVelocity = Bed.SuperficialVelocity / Bed.Porosity
  EBCT = Bed.Volume / Bed.Flowrate / 60
  Bed.TAU = EBCT * Bed.Porosity
End Sub
Sub Update_Bed_Density_Display()
  Call GetMoreBedParameters
  frmMain.lblBedDensityDisplay = Format$(Bed.Density, "0.0000")
End Sub


'change_type:
'    1 = RE-CALCULATE AND DISPLAY BED POROSITY.
'    2 = RE-CALCULATE AND DISPLAY SUPERFICIAL VELOCITY AND INTERSTITIAL VELOCITY.
'    3 = RE-CALCULATE AND DISPLAY (ALL OF THE ABOVE).
Sub Update_Several_Bed_Properties(change_type As Integer)
  Select Case change_type
    Case 1
      Bed.Porosity = 1# - Bed.Density / Carbon.Density
      Bed.InterstitialVelocity = Bed.SuperficialVelocity / Bed.Porosity
      'display superficial velocity and interstitial velocity in units of m/hr
      frmMain.lblporosity.Caption = Format_It(Bed.Porosity, 3)
      frmMain.lblInterstitialVelocity.Caption = Format_It(Bed.InterstitialVelocity * 3600#, 3)
    Case 2
      Bed.SuperficialVelocity = Bed.Flowrate / Bed.Area
      Bed.InterstitialVelocity = Bed.SuperficialVelocity / Bed.Porosity
      'display superficial velocity and interstitial velocity in units of m/hr
      frmMain.lblSuperficialVelocity.Caption = Format_It(Bed.SuperficialVelocity * 3600#, 3)
      frmMain.lblInterstitialVelocity.Caption = Format_It(Bed.InterstitialVelocity * 3600#, 3)
    Case 3
      Bed.Porosity = 1# - Bed.Density / Carbon.Density
      Bed.SuperficialVelocity = Bed.Flowrate / Bed.Area
      Bed.InterstitialVelocity = Bed.SuperficialVelocity / Bed.Porosity
      'display superficial velocity and interstitial velocity in units of m/hr
      frmMain.lblporosity.Caption = Format_It(Bed.Porosity, 3)
      frmMain.lblSuperficialVelocity.Caption = Format_It(Bed.SuperficialVelocity * 3600#, 3)
      frmMain.lblInterstitialVelocity.Caption = Format_It(Bed.InterstitialVelocity * 3600#, 3)
  End Select
End Sub


Sub chem_phase(Index As Integer)
'Dim response As Integer
'Dim temp As String
'Dim p1 As String, p2 As String
  ''DO NOT RUN THIS CODE IF THE PHASE HAS ALREADY BEEN CHANGED
  ''(AS INDICATED BY THE CHECKMARK NEXT TO THE PHASE LABEL
  ''ON THE MENU).
  'If (frmMain.mnuPhaseItem(Index).Checked) Then Exit Sub
  'If (Not Flag_Openfile) Then
  '  'If loading in a data file, don't ask the user
  '  'about changing phases.
  'Select Case index
  '  Case 0
  '    p1 = "gas"
  '    p2 = "liquid"
  '  Case 1
  '    p1 = "liquid"
  '    p2 = "gas"
  'End Select
  '  'temp = "Changing phase from " & p1 & " to " & p2 & " will destroy all current data."
  '  'temp = temp & NL & "Change phase anyway?"
  '  'response = MsgBox(temp, MB_YESNO + MB_ICONQUESTION + MB_DEFBUTTON2, Application_Name)
  '  'If (response <> IDYES) Then Exit Sub
  'End If
  
  Select Case Index
    Case 0
      frmMain.mnuPhaseItem(0).Checked = True
      frmMain.mnuPhaseItem(1).Checked = False
      Bed.Phase = 0
      'If (Not Flag_Openfile) Then Call Initialize_All_Data(0)
      'frmMain.cmdEditWater.Caption = "Edi&t Water Properties"
      'Call H2ODens(Bed.WaterDensity, Bed.Temperature + 273.15)
      'Call H2OVisc(Bed.WaterViscosity, Bed.Temperature + 273.15)
      'Bed.WaterDensity = Bed.WaterDensity / 1000#
      'Bed.WaterViscosity = Bed.WaterViscosity * 10#
      frmMain.ssframe_Water.Caption = "Water Properties:"
    Case 1
      frmMain.mnuPhaseItem(0).Checked = False
      frmMain.mnuPhaseItem(1).Checked = True
      Bed.Phase = 1
      'If (Not Flag_Openfile) Then Call Initialize_All_Data(1)
      'frmMain.cmdEditWater.Caption = "Edi&t Air Properties"
      'Call AIRDens(Bed.WaterDensity, Bed.Temperature + 273.15, Bed.Pressure)
      'Call AirVisc(Bed.WaterViscosity, Bed.Temperature + 273.15)
      'Bed.WaterDensity = Bed.WaterDensity / 1000#
      'Bed.WaterViscosity = Bed.WaterViscosity * 10#
      frmMain.ssframe_Water.Caption = "Air Properties:"
  End Select
  Call Update_FluidDensity(Bed.Temperature, Bed.Pressure, Bed.WaterDensity)
  Call Update_FluidViscosity(Bed.Temperature, Bed.WaterViscosity)
  Call Update_KP_Values
  'Call Update_Display_Kinetic
  'Call Update_Bed_Density_Display
End Sub

Attribute VB_Name = "Structs_PSDMInRoom"
Option Explicit

'
' NOTE:
' IF Distribute_PSDMInRoom IS SET TO FALSE, THEN
' Activate_PSDMInRoom IS SET TO FALSE.
' IF Distribute_PSDMInRoom IS SET TO TRUE, THEN
' THE EXISTENCE OF THE FILE $(AppPath)\PSDMROOM.DAT IS
' CHECKED.  IF THIS FILE EXISTS, Activate_PSDMInRoom
' IS SET TO TRUE.  IF THIS FILE DOES NOT EXIST,
' Activate_PSDMInRoom IS SET TO FALSE.
'
' IF Activate_PSDMInRoom IS SET TO TRUE, THE PSDM-IN-ROOM
' MENU ENTRIES AND FILE-LOAD CAPABILITIES ARE ENABLED;
' IF SET TO FALSE, THESE CAPABILITIES ARE DISABLED.
'
Global Const Distribute_PSDMInRoom = True
'Global Const Distribute_PSDMInRoom = False
Global Activate_PSDMInRoom As Boolean

'-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type RoomParam_Type
  '---- INPUT ROOM PARAMETERS: ----
  COUNT_CONTAMINANT As Integer
  ROOM_VOL As Double                          'm^3
  ROOM_FLOWRATE As Double                     'm^3/s
  ROOM_C0(1 To Number_Compo_Max) As Double    'mg/L
  ROOM_EMIT(1 To Number_Compo_Max) As Double  'ug/s
  '---- CALCULATED ROOM PARAMETERS: ----
  ROOM_CHANGE_RATE As Double                  'hour^(-1)
  ROOM_SS_VALUE(1 To Number_Compo_Max) As Double  'ug/L
  '---- UNITS FOR ALL VARIABLES: ----
  ROOM_VOL_Units As String        'default: m^3
  ROOM_FLOWRATE_Units As String   'default: m^3/s
  ROOM_C0_Units As String         'default: mg/L
  ROOM_EMIT_Units As String       'default: ug/s
  INITIAL_ROOM_CONC_Units As String  'default: mg/L
  '---- NEW AS OF 9/16/98: ----
  INITIAL_ROOM_CONC(1 To Number_Compo_Max) As Double 'mg/L
End Type
Global RoomParams As RoomParam_Type
'-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------







Const Structs_PSDMInRoom_declarations_end = True


Sub RoomParam_Recalculate(rp As RoomParam_Type)
Dim i As Integer
  '(ROOM_CHANGE_RATE,hour^-1) =
  '(ROOM_FLOWRATE,m^3/s)/(ROOM_VOL,m^3)*(60 s/min)*(60 min/hr)
  rp.ROOM_CHANGE_RATE = rp.ROOM_FLOWRATE / rp.ROOM_VOL * 60# * 60#
  For i = 1 To Number_Compo_Max
    '(ROOM_SS_VALUE,ug/L) =
    '(ROOM_C0,mg/L)*(1000 ug/mg) +
    '(ROOM_EMIT,ug/s)/((ROOM_FLOWRATE,m^3/s)*(1000 L/m^3))
    rp.ROOM_SS_VALUE(i) = rp.ROOM_C0(i) * 1000# + rp.ROOM_EMIT(i) / (rp.ROOM_FLOWRATE * 1000#)
  Next i
End Sub



Attribute VB_Name = "UnitCnv0"
Global Const PRESSURE_PA = 0
Global Const PRESSURE_KPA = 1
Global Const PRESSURE_BARS = 2
Global Const PRESSURE_ATM = 3
Global Const PRESSURE_PSI = 4
Global Const PRESSURE_MMHG = 5
Global Const PRESSURE_MH2O = 6
Global Const PRESSURE_FTH2O = 7
Global Const PRESSURE_INHG = 8

Global Const TEMPERATURE_K = 0
Global Const TEMPERATURE_C = 1
Global Const TEMPERATURE_R = 2
Global Const TEMPERATURE_F = 3

Global Const LENGTH_M = 0
Global Const LENGTH_CM = 1
Global Const LENGTH_FT = 2
Global Const LENGTH_IN = 3

Global Const MASS_KG = 0
Global Const MASS_G = 1
Global Const MASS_LB = 2

Global Const FLOW_M3_per_S = 0
Global Const FLOW_M3_per_D = 1
Global Const FLOW_CM3_per_S = 2
Global Const FLOW_ML_per_MIN = 3
Global Const FLOW_FT3_per_S = 4
Global Const FLOW__FT3_per_D = 5
Global Const FLOW_GPM = 6
Global Const FLOW_GPD = 7
Global Const FLOW_MGD = 8
    
Global Const TIME_MIN = 0
Global Const TIME_S = 1
Global Const TIME_HR = 2
Global Const TIME_D = 3

Global Const APPARENT_DENSITY_G_per_ML = 0
Global Const APPARENT_DENSITY_KG_per_M3 = 1
Global Const APPARENT_DENSITY_LB_per_FT3 = 2
Global Const APPARENT_DENSITY_LB_per_GAL = 3

Global Const RESIN_CAPACITY_MEQ_per_G = 0
Global Const RESIN_CAPACITY_MEQ_per_MLbed = 1
Global Const RESIN_CAPACITY_MEQ_per_MLresin = 2

Global Const MOLECULAR_WEIGHT_MG_per_MMOL = 0
Global Const MOLECULAR_WEIGHT_UG_per_UMOL = 1
Global Const MOLECULAR_WEIGHT_G_per_GMOL = 2
Global Const MOLECULAR_WEIGHT_KG_per_KMOL = 3

Global Const CONCENTRATION_MG_per_L = 0
Global Const CONCENTRATION_UG_per_L = 1
Global Const CONCENTRATION_G_per_L = 2
Global Const CONCENTRATION_MEQ_per_L = 3
Global Const CONCENTRATION_EQ_per_L = 4
Global Const CONCENTRATION_MMOL_per_L = 5
Global Const CONCENTRATION_UMOL_per_L = 6
Global Const CONCENTRATION_GMOL_per_L = 7

Global Const DIFFUSIVITY_CM2_per_S = 0
Global Const DIFFUSIVITY_CM2_per_MIN = 1
Global Const DIFFUSIVITY_M2_per_S = 2
Global Const DIFFUSIVITY_M2_per_MIN = 3
Global Const DIFFUSIVITY_M2_per_HR = 4
Global Const DIFFUSIVITY_M2_per_D = 5
Global Const DIFFUSIVITY_FT2_per_S = 6
Global Const DIFFUSIVITY_FT2_per_MIN = 7
Global Const DIFFUSIVITY_FT2_per_HR = 8
Global Const DIFFUSIVITY_FT2_per_D = 9

Global Const VELOCITY_CM_per_S = 0
Global Const VELOCITY_CM_per_MIN = 1
Global Const VELOCITY_M_per_S = 2
Global Const VELOCITY_M_per_MIN = 3
Global Const VELOCITY_M_per_HR = 4
Global Const VELOCITY_M_per_D = 5
Global Const VELOCITY_FT_per_S = 6
Global Const VELOCITY_FT_per_MIN = 7
Global Const VELOCITY_FT_per_HR = 8
Global Const VELOCITY_FT_per_D = 9

Function ConcentrationConversionFactor(UnitsToConvertTo As Integer, Valence As Double, MolecularWeight As Double) As Double
   'Valence in eq/mol; Molecular Weight in mg/mmol

   'This function will convert from standard concentration units (mg/L) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case CONCENTRATION_UG_per_L   'Convert to ug/L
         ConcentrationConversionFactor = 1000#
      Case CONCENTRATION_G_per_L   'Convert to g/L
         ConcentrationConversionFactor = 1# / 1000#
      Case CONCENTRATION_MEQ_per_L   'Convert to meq/L
         ConcentrationConversionFactor = Valence / MolecularWeight
      Case CONCENTRATION_EQ_per_L   'Convert to eq/L
         ConcentrationConversionFactor = Valence / MolecularWeight / 1000
      Case CONCENTRATION_MMOL_per_L   'Convert to mmol/L
         ConcentrationConversionFactor = 1# / MolecularWeight
      Case CONCENTRATION_UMOL_per_L   'Convert to umol/L
         ConcentrationConversionFactor = 1000# / MolecularWeight
      Case CONCENTRATION_GMOL_per_L   'Convert to gmol/L
         ConcentrationConversionFactor = 1 / 1000# / MolecularWeight

   End Select

End Function

Function DensityConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard density units (g/ml) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case APPARENT_DENSITY_KG_per_M3   'Convert to kg/m3
         DensityConversionFactor = 1000#
      Case APPARENT_DENSITY_LB_per_FT3   'Convert to lb/ft3
         DensityConversionFactor = (2.20462 / 1000#) / (35.3145 / 1000#)
      Case APPARENT_DENSITY_LB_per_GAL   'Convert to lb/gal
         DensityConversionFactor = (2.20462 / 1000#) / (7.4805 / 28317)
   End Select

End Function

Function DiffusivityConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard diffusivity units (cm2/s) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case DIFFUSIVITY_CM2_per_MIN   'Convert to cm2/min
         DiffusivityConversionFactor = 60#
      Case DIFFUSIVITY_M2_per_S   'Convert to m2/s
         DiffusivityConversionFactor = 1 / (100# ^ 2)
      Case DIFFUSIVITY_M2_per_MIN   'Convert to m2/min
         DiffusivityConversionFactor = 60# / (100# ^ 2)
      Case DIFFUSIVITY_M2_per_HR   'Convert to m2/hr
         DiffusivityConversionFactor = (60# * 60#) / (100# ^ 2)
      Case DIFFUSIVITY_M2_per_D   'Convert to m2/d
         DiffusivityConversionFactor = (60# * 60# * 24#) / (100# ^ 2)
      Case DIFFUSIVITY_FT2_per_S   'Convert to ft2/s
         DiffusivityConversionFactor = (3.2808 ^ 2 / 100# ^ 2)
      Case DIFFUSIVITY_FT2_per_MIN   'Convert to ft2/min
         DiffusivityConversionFactor = 60# * (3.2808 ^ 2 / 100# ^ 2)
      Case DIFFUSIVITY_FT2_per_HR   'Convert to ft2/hr
         DiffusivityConversionFactor = 60# * 60# * (3.2808 ^ 2 / 100# ^ 2)
      Case DIFFUSIVITY_FT2_per_D   'Convert to ft2/d
         DiffusivityConversionFactor = 60# * 60# * 24# * (3.2808 ^ 2 / 100# ^ 2)
   End Select

End Function

Function FlowConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard flow units (m3/s) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case FLOW_M3_per_D   'Convert to m3/d
         FlowConversionFactor = 86400#
      Case FLOW_CM3_per_S   'Convert to cm3/s
         FlowConversionFactor = 100# * 100# * 100#
      Case FLOW_ML_per_MIN   'Convert to ml/min
         FlowConversionFactor = 1000000# * 60#
      Case FLOW_FT3_per_S   'Convert to ft3/s
         FlowConversionFactor = 35.3145
      Case FLOW__FT3_per_D   'Convert to ft3/d
         FlowConversionFactor = 35.3145 * 86400#
      Case FLOW_GPM   'Convert to gpm
         FlowConversionFactor = 264.17 * 60#
      Case FLOW_GPD   'Convert to gpd
         FlowConversionFactor = 264.17 * 86400#
      Case FLOW_MGD   'Convert to MGD
         FlowConversionFactor = (264.17 / 1000000#) * 86400

   End Select

End Function

Function LengthConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard length units (m) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case LENGTH_CM   'Convert to cm
         LengthConversionFactor = 100#
      Case LENGTH_FT   'Convert to feet
         LengthConversionFactor = 3.2808
      Case LENGTH_IN   'Convert to inches
         LengthConversionFactor = 39.37
   End Select

End Function

Function MassConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard mass units (kg) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case MASS_G   'Convert to g
         MassConversionFactor = 1000#
      Case MASS_LB   'Convert to lb
         MassConversionFactor = 2.20462
   End Select

End Function

Function PressureConversionFactor(UnitsToConvertTo As Integer) As Double

   'This function will convert from standard pressure units (Pa) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case PRESSURE_KPA   'Convert to kPa
         PressureConversionFactor = 1# / 1000#
      Case PRESSURE_BARS   'Convert to bars
         PressureConversionFactor = 1# / 100000#
      Case PRESSURE_ATM   'Convert to atm
         PressureConversionFactor = 1# / 101325#
      Case PRESSURE_PSI   'Convert to psi
         PressureConversionFactor = 14.696 / 101325#
      Case PRESSURE_MMHG   'Convert to mm Hg
         PressureConversionFactor = 760# / 101325#
      Case PRESSURE_MH2O   'Convert to m H2O
         PressureConversionFactor = 10.333 / 101325#
      Case PRESSURE_FTH2O   'Convert to ft H2O
         PressureConversionFactor = 33.9 / 101325#
      Case PRESSURE_INHG   'Convert to in. Hg
         PressureConversionFactor = 29.921 / 101325#

   End Select

End Function

Function ResinCapacityConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard resin capacity units (meq/g) to
   'the units specified by the user.

   Dim BedVolume As Double, ColumnArea As Double

   ColumnArea = PI * (Bed.Diameter * 100#) ^ 2 / 4
   Select Case UnitsToConvertTo
      Case RESIN_CAPACITY_MEQ_per_MLbed   'Convert to meq/ml bed
         ResinCapacityConversionFactor = Bed.Weight * 1000# / ColumnArea / (Bed.Length * 100#)
      Case RESIN_CAPACITY_MEQ_per_MLresin   'Convert to meq/ml resin
         ResinCapacityConversionFactor = Resin.ApparentDensity
   End Select

End Function

Function ReverseTemperatureConversion(UnitsToConvertFrom As Integer, Temperature_NonKelvin As Double) As Double
   'This function will convert from non-standard temperature units (C, R, or F) to
   'standard temperature units (K)

   Select Case UnitsToConvertFrom
      Case TEMPERATURE_C   'Convert from Deg. C
         ReverseTemperatureConversion = Temperature_NonKelvin + 273.15
      Case TEMPERATURE_R   'Convert from Deg. R
         ReverseTemperatureConversion = Temperature_NonKelvin / 1.8
      Case TEMPERATURE_F   'Convert from Deg. F
         ReverseTemperatureConversion = ((Temperature_NonKelvin - 32#) / 1.8) + 273.15
   End Select

End Function

Function TemperatureConversion(UnitsToConvertTo As Integer, Temperature_Kelvin As Double) As Double
   'This function will convert from standard temperature units (K) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case TEMPERATURE_C   'Convert to Deg. C
         TemperatureConversion = Temperature_Kelvin - 273.15
      Case TEMPERATURE_R   'Convert to Deg. R
         TemperatureConversion = 1.8 * Temperature_Kelvin
      Case TEMPERATURE_F   'Convert to Deg. F
         TemperatureConversion = 1.8 * (Temperature_Kelvin - 273.15) + 32#
   End Select

End Function

Function TimeConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard time units (min) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case TIME_S   'Convert to s
         TimeConversionFactor = 60#
      Case TIME_HR   'Convert to hr
         TimeConversionFactor = 1# / 60#
      Case TIME_D   'Convert to d
         TimeConversionFactor = 1# / 1440#

   End Select

End Function

Function VelocityConversionFactor(UnitsToConvertTo As Integer) As Double

   'This function will convert from standard velocity units (cm/s) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case VELOCITY_CM_per_MIN   'Convert to cm/min
         VelocityConversionFactor = 60#
      Case VELOCITY_M_per_S   'Convert to m/s
         VelocityConversionFactor = 1 / (100#)
      Case VELOCITY_M_per_MIN   'Convert to m/min
         VelocityConversionFactor = 60# / (100#)
      Case VELOCITY_M_per_HR   'Convert to m/hr
         VelocityConversionFactor = (60# * 60#) / (100#)
      Case VELOCITY_M_per_D   'Convert to m/d
         VelocityConversionFactor = (60# * 60# * 24#) / (100#)
      Case VELOCITY_FT_per_S   'Convert to ft/s
         VelocityConversionFactor = (3.2808 / 100#)
      Case VELOCITY_FT_per_MIN   'Convert to ft/min
         VelocityConversionFactor = 60# * (3.2808 / 100#)
      Case VELOCITY_FT_per_HR   'Convert to ft/hr
         VelocityConversionFactor = 60# * 60# * (3.2808 / 100#)
      Case VELOCITY_FT_per_D   'Convert to ft/d
         VelocityConversionFactor = 60# * 60# * 24# * (3.2808 / 100#)
   End Select

End Function

Attribute VB_Name = "UnitConv_old"
Global Const PRESSURE_PA = 0
Global Const PRESSURE_KPA = 1
Global Const PRESSURE_BARS = 2
Global Const PRESSURE_ATM = 3
Global Const PRESSURE_PSI = 4
Global Const PRESSURE_MMHG = 5
Global Const PRESSURE_MH2O = 6
Global Const PRESSURE_FTH2O = 7
Global Const PRESSURE_INHG = 8

Global Const TEMPERATURE_K = 0
Global Const TEMPERATURE_C = 1
Global Const TEMPERATURE_R = 2
Global Const TEMPERATURE_F = 3

Global Const LENGTH_M = 0
Global Const LENGTH_CM = 1
Global Const LENGTH_FT = 2
Global Const LENGTH_IN = 3

Global Const MASS_KG = 0
Global Const MASS_G = 1
Global Const MASS_LB = 2

Global Const FLOW_M3_per_S = 0
Global Const FLOW_M3_per_D = 1
Global Const FLOW_CM3_per_S = 2
Global Const FLOW_ML_per_MIN = 3
Global Const FLOW_FT3_per_S = 4
Global Const FLOW__FT3_per_D = 5
Global Const FLOW_GPM = 6
Global Const FLOW_GPD = 7
Global Const FLOW_MGD = 8
    
Global Const TIME_S = 0
Global Const TIME_MIN = 1
Global Const TIME_HR = 2
Global Const TIME_D = 3
Global Const TIME_YEAR = 4

Global Const APPARENT_DENSITY_G_per_ML = 0
Global Const APPARENT_DENSITY_KG_per_M3 = 1
Global Const APPARENT_DENSITY_LB_per_FT3 = 2
Global Const APPARENT_DENSITY_LB_per_GAL = 3

Global Const RESIN_CAPACITY_MEQ_per_G = 0
Global Const RESIN_CAPACITY_MEQ_per_MLbed = 1
Global Const RESIN_CAPACITY_MEQ_per_MLresin = 2

Global Const MOLECULAR_WEIGHT_MG_per_MMOL = 0
Global Const MOLECULAR_WEIGHT_UG_per_UMOL = 1
Global Const MOLECULAR_WEIGHT_G_per_GMOL = 2
Global Const MOLECULAR_WEIGHT_KG_per_KMOL = 3

Global Const CONCENTRATION_UG_per_L = 0
Global Const CONCENTRATION_MG_per_L = 1
Global Const CONCENTRATION_G_per_L = 2
'Global Const CONCENTRATION_MEQ_per_L = 3
'Global Const CONCENTRATION_EQ_per_L = 4
'Global Const CONCENTRATION_MMOL_per_L = 5
'Global Const CONCENTRATION_UMOL_per_L = 6
'Global Const CONCENTRATION_GMOL_per_L = 7

Global Const DIFFUSIVITY_M2_per_S = 0
Global Const DIFFUSIVITY_M2_per_MIN = 1
Global Const DIFFUSIVITY_M2_per_HR = 2
Global Const DIFFUSIVITY_M2_per_D = 3
Global Const DIFFUSIVITY_CM2_per_S = 4
Global Const DIFFUSIVITY_CM2_per_MIN = 5
Global Const DIFFUSIVITY_FT2_per_S = 6
Global Const DIFFUSIVITY_FT2_per_MIN = 7
Global Const DIFFUSIVITY_FT2_per_HR = 8
Global Const DIFFUSIVITY_FT2_per_D = 9

Global Const VELOCITY_CM_per_S = 0
Global Const VELOCITY_CM_per_MIN = 1
Global Const VELOCITY_M_per_S = 2
Global Const VELOCITY_M_per_MIN = 3
Global Const VELOCITY_M_per_HR = 4
Global Const VELOCITY_M_per_D = 5
Global Const VELOCITY_FT_per_S = 6
Global Const VELOCITY_FT_per_MIN = 7
Global Const VELOCITY_FT_per_HR = 8
Global Const VELOCITY_FT_per_D = 9

Global Const MOLAR_VOLUME_M3_per_KMOL = 0
Global Const MOLAR_VOLUME_M3_per_GMOL = 1
Global Const MOLAR_VOLUME_L_per_GMOL = 2
Global Const MOLAR_VOLUME_ML_per_GMOL = 3

Global Const K_FREUNDLICH_MG_G_L = 0
Global Const K_FREUNDLICH_MMOL_G_L = 1
Global Const K_FREUNDLICH_UG_G_L = 2
Global Const K_FREUNDLICH_UMOL_G_L = 3

Global Const PRESSUREPERLENGTH_PA_per_M = 0
Global Const PRESSUREPERLENGTH_PSI_per_FT = 1
Global Const PRESSUREPERLENGTH_ATM_per_FT = 2

Global Const MASSLOADINGRATE_KG_M2_S = 0
Global Const MASSLOADINGRATE_G_M2_D = 1
Global Const MASSLOADINGRATE_LBM_FT2_S = 2

Global Const AREA_M2 = 0
Global Const AREA_CM2 = 1
Global Const AREA_FT2 = 2

Global Const VOLUME_M3 = 0
Global Const VOLUME_CM3 = 1
Global Const VOLUME_LITER = 2
Global Const VOLUME_FT3 = 3
Global Const VOLUME_GAL = 4

Global Const INVERSETIME_S = 0
Global Const INVERSETIME_MIN = 1
Global Const INVERSETIME_HR = 2
Global Const INVERSETIME_D = 3

Global Const POWER_W = 0
Global Const POWER_KW = 1
Global Const POWER_HP = 2
Global Const POWER_FTLB_per_S = 3

Global Const POWERPERVOLUME_W_per_M3 = 0
Global Const POWERPERVOLUME_KW_per_M3 = 1
Global Const POWERPERVOLUME_HP_per_FT3 = 2
Global Const POWERPERVOLUME_FTLB_per_S_FT3 = 3


'--------------------------------------------------------
'---  Unit Types:
'--------------------------------------------------------
Global Const UNITS_LENGTH = 1
Global Const UNITS_TIME = 2
Global Const UNITS_MASS = 3
Global Const UNITS_PRESSURE = 4
Global Const UNITS_TEMPERATURE = 5
Global Const UNITS_FLOW = 6
Global Const UNITS_PRESSUREPERLENGTH = 7
Global Const UNITS_MASSLOADINGRATE = 8
Global Const UNITS_INVERSETIME = 9
Global Const UNITS_AREA = 10
Global Const UNITS_VOLUME = 11
Global Const UNITS_DIFFUSIVITY = 12
Global Const UNITS_CONCENTRATION = 13
Global Const UNITS_POWER = 14
Global Const UNITS_POWERPERVOLUME = 15
Global Const UNITS_MW = 16
Global Const UNITS_MOLARVOLUME = 17


'--------------------------------------------------------
'---  SI or English indicator
'--------------------------------------------------------
Global Const UNITSTYPE_SI = 1
Global Const UNITSTYPE_ENGLISH = 2


Function AreaConversionFactor(UnitsToConvertTo As Integer) As Double
'This function will convert from standard area units (m^2) to
'the units specified by the user.

  Select Case UnitsToConvertTo
    Case AREA_M2
      AreaConversionFactor = 1#
    Case AREA_CM2
      AreaConversionFactor = 10000#
    Case AREA_FT2
      AreaConversionFactor = 10.7639
  End Select

End Function

Sub Combobox_KeyPress(KeyAscii As Integer)

  If KeyAscii = 13 Then
    KeyAscii = 0
    SendKeys "{Tab}"
    Exit Sub
  End If

End Sub

Function ConcentrationConversionFactor(UnitsToConvertTo As Integer) As Double
'This function will convert from standard concentration units (mg/L) to
'the units specified by the user.

   Select Case UnitsToConvertTo
      Case CONCENTRATION_UG_per_L
         ConcentrationConversionFactor = 1000#
      Case CONCENTRATION_MG_per_L   'Convert to mg/L
         ConcentrationConversionFactor = 1#
      Case CONCENTRATION_G_per_L   'Convert to g/L
         ConcentrationConversionFactor = 1# / 1000#

'      Case CONCENTRATION_MEQ_per_L   'Convert to meq/L
'         ConcentrationConversionFactor = Valence / MolecularWeight
'      Case CONCENTRATION_EQ_per_L   'Convert to eq/L
'         ConcentrationConversionFactor = Valence / MolecularWeight / 1000
'      Case CONCENTRATION_MMOL_per_L   'Convert to mmol/L
'         ConcentrationConversionFactor = 1# / MolecularWeight
'      Case CONCENTRATION_UMOL_per_L   'Convert to umol/L
'         ConcentrationConversionFactor = 1000# / MolecularWeight
'      Case CONCENTRATION_GMOL_per_L   'Convert to gmol/L
'         ConcentrationConversionFactor = 1 / 1000# / MolecularWeight

   End Select

End Function

Function DensityConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard density units (g/ml) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case APPARENT_DENSITY_G_per_ML
         DensityConversionFactor = 1#
      Case APPARENT_DENSITY_KG_per_M3   'Convert to kg/m3
         DensityConversionFactor = 1000#
      Case APPARENT_DENSITY_LB_per_FT3   'Convert to lb/ft3
         DensityConversionFactor = (0.002204622622) / (3.53146667215E-05)
         '(2.20462 / 1000#) / (35.3145 / 1000#)
      Case APPARENT_DENSITY_LB_per_GAL   'Convert to lb/gal
         DensityConversionFactor = (2.20462 / 1000#) / (7.4805 / 28317)
   End Select

End Function

Function DiffusivityConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard diffusivity units (m^2/s) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case DIFFUSIVITY_M2_per_S
         DiffusivityConversionFactor = 1
      Case DIFFUSIVITY_M2_per_MIN   'Convert to m2/min
         DiffusivityConversionFactor = 60#
      Case DIFFUSIVITY_M2_per_HR   'Convert to m2/hr
         DiffusivityConversionFactor = 60# * 60#
      Case DIFFUSIVITY_M2_per_D   'Convert to m2/d
         DiffusivityConversionFactor = (60# * 60# * 24#)
      Case DIFFUSIVITY_CM2_per_S  'Convert to cm2/s
         DiffusivityConversionFactor = 100# * 100#
      Case DIFFUSIVITY_CM2_per_MIN   'Convert to cm2/min
         DiffusivityConversionFactor = (100# * 100#) * (60#)
      Case DIFFUSIVITY_FT2_per_S   'Convert to ft2/s
         DiffusivityConversionFactor = 10.7639
      Case DIFFUSIVITY_FT2_per_MIN   'Convert to ft2/min
         DiffusivityConversionFactor = 10.7639 * 60#
      Case DIFFUSIVITY_FT2_per_HR   'Convert to ft2/hr
         DiffusivityConversionFactor = 10.7639 * (60# * 60#)
      Case DIFFUSIVITY_FT2_per_D   'Convert to ft2/d
         DiffusivityConversionFactor = 10.7639 * (60# * 60# * 24#)
   End Select

End Function

Function FlowConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard flow units (m3/s) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case FLOW_M3_per_S
         FlowConversionFactor = 1#
      Case FLOW_M3_per_D   'Convert to m3/d
         FlowConversionFactor = 86400#
      Case FLOW_CM3_per_S   'Convert to cm3/s
         FlowConversionFactor = 100# * 100# * 100#
      Case FLOW_ML_per_MIN   'Convert to ml/min
         FlowConversionFactor = 1000000# * 60#
      Case FLOW_FT3_per_S   'Convert to ft3/s
         FlowConversionFactor = 35.3145
      Case FLOW__FT3_per_D   'Convert to ft3/d
         FlowConversionFactor = 35.3145 * 86400#
      Case FLOW_GPM   'Convert to gpm
         FlowConversionFactor = 264.17 * 60#
      Case FLOW_GPD   'Convert to gpd
         FlowConversionFactor = 264.17 * 86400#
      Case FLOW_MGD   'Convert to MGD
         FlowConversionFactor = (264.17 / 1000000#) * 86400

   End Select

End Function

Function GetConversionFactor(WhatUnits As Integer, ListIndex As Integer)

  Select Case WhatUnits
    Case UNITS_LENGTH
      GetConversionFactor = LengthConversionFactor(ListIndex)
    Case UNITS_TIME
      GetConversionFactor = TimeConversionFactor(ListIndex)
    Case UNITS_MASS
      GetConversionFactor = MassConversionFactor(ListIndex)
    Case UNITS_PRESSURE
      GetConversionFactor = PressureConversionFactor(ListIndex)
    'Case UNITS_TEMPERATURE
    '  GetConversionFactor = TemperatureConversionFactor(ListIndex)
    Case UNITS_FLOW
      GetConversionFactor = FlowConversionFactor(ListIndex)
    Case UNITS_PRESSUREPERLENGTH
      GetConversionFactor = PressurePerLengthConversionFactor(ListIndex)
    Case UNITS_MASSLOADINGRATE
      GetConversionFactor = MassLoadingRateConversionFactor(ListIndex)
    Case UNITS_INVERSETIME
      GetConversionFactor = InverseTimeConversionFactor(ListIndex)
    Case UNITS_AREA
      GetConversionFactor = AreaConversionFactor(ListIndex)
    Case UNITS_VOLUME
      GetConversionFactor = VolumeConversionFactor(ListIndex)
    Case UNITS_DIFFUSIVITY
      GetConversionFactor = DiffusivityConversionFactor(ListIndex)
    Case UNITS_CONCENTRATION
      GetConversionFactor = ConcentrationConversionFactor(ListIndex)
    Case UNITS_POWER
      GetConversionFactor = PowerConversionFactor(ListIndex)
    Case UNITS_POWERPERVOLUME
      GetConversionFactor = PowerPerVolumeConversionFactor(ListIndex)
    Case UNITS_MW
      GetConversionFactor = MolecularWeightConversionFactor(ListIndex)
    Case UNITS_MOLARVOLUME
      GetConversionFactor = MolarVolumeConversionFactor(ListIndex)
      
      
    'more to come....

  End Select

End Function

Function GetUnits(UnitList As ComboBox) As String

  GetUnits = Trim$(UnitList.List(UnitList.ListIndex))

End Function

Function InverseTimeConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard inverse time units (1/sec) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case INVERSETIME_S
         InverseTimeConversionFactor = 1#
      Case INVERSETIME_MIN    'Convert to 1/min
         InverseTimeConversionFactor = 60#
      Case INVERSETIME_HR     'Convert to 1/hr
         InverseTimeConversionFactor = 60# * 60#
      Case INVERSETIME_D      'Convert to 1/d
         InverseTimeConversionFactor = 60# * 60# * 24#
   End Select

End Function

Function KFreundlichConversionFactor(UnitsToConvertTo As Integer, oneovern As Double, MW As Double) As Double
   'This function will convert from standard Freundlich K units
   '((mg/g)*(L/mg)^(1/n)) to the units specified by the user.
Dim factor1 As Double
Dim factor2 As Double

  factor1 = MW ^ (oneovern - 1)
   factor2 = 1000 ^ (1 - oneovern)
   
   Select Case UnitsToConvertTo
      Case K_FREUNDLICH_MG_G_L
         'No conversion.
         KFreundlichConversionFactor = 1#
      Case K_FREUNDLICH_MMOL_G_L
         'Convert to (mmol/g)*(L/mmol)^(1/n)
         KFreundlichConversionFactor = factor1
      Case K_FREUNDLICH_UG_G_L
         'Convert to (ug/g)*(L/ug)^(1/n)
         KFreundlichConversionFactor = factor2
      Case K_FREUNDLICH_UMOL_G_L
         'Convert to (umol/g)*(L/umol)^(1/n)
         KFreundlichConversionFactor = factor1 * factor2
   End Select

End Function

Function LengthConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard length units (m) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case LENGTH_M
         LengthConversionFactor = 1#
      Case LENGTH_CM   'Convert to cm
         LengthConversionFactor = 100#
      Case LENGTH_FT   'Convert to feet
         LengthConversionFactor = 3.2808
      Case LENGTH_IN   'Convert to inches
         LengthConversionFactor = 39.37
   End Select

End Function

Function MassConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard mass units (kg) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case MASS_KG
         MassConversionFactor = 1#
      Case MASS_G   'Convert to g
         MassConversionFactor = 1000#
      Case MASS_LB   'Convert to lb
         MassConversionFactor = 2.20462
   End Select

End Function

Function MassLoadingRateConversionFactor(UnitsToConvertTo As Integer) As Double
'This function will convert from standard mass loading rate units (kg/m^2/s) to
'the units specified by the user.

  Select Case UnitsToConvertTo
    Case MASSLOADINGRATE_KG_M2_S
      MassLoadingRateConversionFactor = 1#
    Case MASSLOADINGRATE_G_M2_D
      MassLoadingRateConversionFactor = 86400# * 1000#
    Case MASSLOADINGRATE_LBM_FT2_S
      MassLoadingRateConversionFactor = 2.20462 / 10.7639
  End Select

End Function

Function MolarVolumeConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard molar volume units (m^3/kmol) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case MOLAR_VOLUME_M3_per_KMOL
         MolarVolumeConversionFactor = 1#
      Case MOLAR_VOLUME_M3_per_GMOL   'Convert to m^3/gmol
         MolarVolumeConversionFactor = 1# / 1000#
      Case MOLAR_VOLUME_L_per_GMOL    'Convert to L/gmol
         MolarVolumeConversionFactor = 1#
      Case MOLAR_VOLUME_ML_per_GMOL   'Convert to mL/gmol
         MolarVolumeConversionFactor = 1000#
   End Select

End Function

Function MolecularWeightConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function always returns 1#
   '(all MW's are the same in this version of UNITCONV.BAS).

   MolecularWeightConversionFactor = 1#

End Function

Sub Populate_Area_Units(dest As ComboBox, Default_Unit As Integer)
  
  dest.Clear
  dest.AddItem "m" & Chr$(178)
  dest.AddItem "cm" & Chr$(178)
  dest.AddItem "ft" & Chr$(178)
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Concentration_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem Chr$(181) & "g/L"
  dest.AddItem "mg/L"
  dest.AddItem "g/L"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Density_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "g/mL"
  dest.AddItem "kg/m" & Chr$(179)
  dest.AddItem "lb/ft" & Chr$(179)
  dest.AddItem "lb/gal"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Diffusivity_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "m" & Chr$(178) & "/s"
  dest.AddItem "m" & Chr$(178) & "/min"
  dest.AddItem "m" & Chr$(178) & "/hr"
  dest.AddItem "m" & Chr$(178) & "/d"
  dest.AddItem "cm" & Chr$(178) & "/s"
  dest.AddItem "cm" & Chr$(178) & "/min"
  dest.AddItem "ft" & Chr$(178) & "/s"
  dest.AddItem "ft" & Chr$(178) & "/min"
  dest.AddItem "ft" & Chr$(178) & "/hr"
  dest.AddItem "ft" & Chr$(178) & "/d"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Flowrate_Units(dest As ComboBox, Default_Unit As Integer)
  
  dest.Clear
  dest.AddItem "m" & Chr$(179) & "/s"
  dest.AddItem "m" & Chr$(179) & "/d"
  dest.AddItem "cm" & Chr$(179) & "/s"
  dest.AddItem "mL/min"
  dest.AddItem "ft" & Chr$(179) & "/s"
  dest.AddItem "ft" & Chr$(179) & "/d"
  dest.AddItem "gpm"
  dest.AddItem "gpd"
  dest.AddItem "MGD"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_InverseTime_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "1/s"
  dest.AddItem "1/min"
  dest.AddItem "1/hr"
  dest.AddItem "1/d"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_KFreundlich_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "(mg/g)*(L/mg)^(1/n)"
  dest.AddItem "(mmol/g)*(L/mmol)^(1/n)"
  dest.AddItem "(" & Chr$(181) & "g/g)*(L/" & Chr$(181) & "g)^(1/n)"
  dest.AddItem "(" & Chr$(181) & "mol/g)*(L/" & Chr$(181) & "mol)^(1/n)"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Length_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "m"
  dest.AddItem "cm"
  dest.AddItem "ft"
  dest.AddItem "in"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Mass_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "kg"
  dest.AddItem "g"
  dest.AddItem "lb"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_MassLoadingRate_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "kg/m" & Chr$(178) & "-s"
  dest.AddItem "g/m" & Chr$(178) & "-d"
  dest.AddItem "lbm/ft" & Chr$(178) & "-s"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_MolarVolume_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "m" & Chr$(179) & "/kmol"
  dest.AddItem "m" & Chr$(179) & "/gmol"
  dest.AddItem "L/gmol"
  dest.AddItem "mL/gmol"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_MolecularWeight_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "mg/mmol"
  dest.AddItem Chr$(181) & "g/" & Chr$(181) & "mol"
  dest.AddItem "g/gmol"
  dest.AddItem "kg/kmol"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Power_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "W"
  dest.AddItem "kW"
  dest.AddItem "hp"
  dest.AddItem "ft-lb/s"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_PowerPerVolume_Units(dest As ComboBox, Default_Unit As Integer)
  
  dest.Clear
  dest.AddItem "W/m" & Chr$(179)
  dest.AddItem "kW/m" & Chr$(179)
  dest.AddItem "hp/ft" & Chr$(179)
  dest.AddItem "ft-lb/ft" & Chr$(179) & "-s"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Pressure_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "Pa"
  dest.AddItem "kPa"
  dest.AddItem "bars"
  dest.AddItem "atm"
  dest.AddItem "psi"
  dest.AddItem "mmHg"
  dest.AddItem "mH20"
  dest.AddItem "ftH20"
  dest.AddItem "inHg"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_PressurePerLength_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "Pa/m"
  dest.AddItem "psi/ft"
  dest.AddItem "atm/ft"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Temperature_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "K"
  dest.AddItem "C"
  dest.AddItem "R"
  dest.AddItem "F"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Time_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "s"
  dest.AddItem "min"
  dest.AddItem "hr"
  dest.AddItem "d"
  dest.AddItem "year"
  dest.ListIndex = Default_Unit

End Sub

Sub Populate_Volume_Units(dest As ComboBox, Default_Unit As Integer)

  dest.Clear
  dest.AddItem "m" & Chr$(179)
  dest.AddItem "cm" & Chr$(179)
  dest.AddItem "liter"
  dest.AddItem "ft" & Chr$(179)
  dest.AddItem "gal"
  dest.ListIndex = Default_Unit

End Sub

Function PowerConversionFactor(UnitsToConvertTo As Integer) As Double
'This function will convert from standard power units (watts) to
'the units specified by the user.

  Select Case UnitsToConvertTo
    Case POWER_W
      PowerConversionFactor = 1#
    Case POWER_KW
      PowerConversionFactor = 1# / 1000#
    Case POWER_HP
      PowerConversionFactor = 1# / 745.6999
    Case POWER_FTLB_per_S
      PowerConversionFactor = 1# / 1.35582
  End Select

End Function

Function PowerPerVolumeConversionFactor(UnitsToConvertTo As Integer) As Double
'This function will convert from standard power per volume units (watts/m^3) to
'the units specified by the user.

  Select Case UnitsToConvertTo
    Case POWERPERVOLUME_W_per_M3
      PowerPerVolumeConversionFactor = 1#
    Case POWERPERVOLUME_KW_per_M3
      PowerPerVolumeConversionFactor = 1# / 1000#
    Case POWERPERVOLUME_HP_per_FT3
      PowerPerVolumeConversionFactor = 1# / 26334.14
    Case POWERPERVOLUME_FTLB_per_S_FT3
      PowerPerVolumeConversionFactor = 1# / 47.88026
  End Select

End Function

Function PressureConversionFactor(UnitsToConvertTo As Integer) As Double

   'This function will convert from standard pressure units (Pa) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case PRESSURE_PA
         PressureConversionFactor = 1#
      Case PRESSURE_KPA   'Convert to kPa
         PressureConversionFactor = 1# / 1000#
      Case PRESSURE_BARS   'Convert to bars
         PressureConversionFactor = 1# / 100000#
      Case PRESSURE_ATM   'Convert to atm
         PressureConversionFactor = 1# / 101325#
      Case PRESSURE_PSI   'Convert to psi
         PressureConversionFactor = 14.696 / 101325#
      Case PRESSURE_MMHG   'Convert to mm Hg
         PressureConversionFactor = 760# / 101325#
      Case PRESSURE_MH2O   'Convert to m H2O
         PressureConversionFactor = 10.333 / 101325#
      Case PRESSURE_FTH2O   'Convert to ft H2O
         PressureConversionFactor = 33.9 / 101325#
      Case PRESSURE_INHG   'Convert to in. Hg
         PressureConversionFactor = 29.921 / 101325#

   End Select

End Function

Function PressurePerLengthConversionFactor(UnitsToConvertTo As Integer) As Double
'This function will convert from standard pressure/length units (Pa/m) to
'the units specified by the user.

  Select Case UnitsToConvertTo
    Case PRESSUREPERLENGTH_PA_per_M
      PressurePerLengthConversionFactor = 1#
    Case PRESSUREPERLENGTH_PSI_per_FT
      PressurePerLengthConversionFactor = 0.3048 / 6894.76
    Case PRESSUREPERLENGTH_ATM_per_FT
      PressurePerLengthConversionFactor = 0.3048 / 101325
  End Select

End Function

Function ResinCapacityConversionFactor(UnitsToConvertTo As Integer) As Double
''   'This function will convert from standard resin capacity units (meq/g) to
'   'the units specified by the user.
'
'   Dim BedVolume As Double, ColumnArea As Double
'
'   ColumnArea = Pi * (Bed.Diameter * 100#) ^ 2 / 4
'   Select Case UnitsToConvertTo
'      Case RESIN_CAPACITY_MEQ_per_MLbed   'Convert to meq/ml bed
'         ResinCapacityConversionFactor = Bed.Weight * 1000# / ColumnArea / (Bed.Length * 100#)
'      Case RESIN_CAPACITY_MEQ_per_MLresin   'Convert to meq/ml resin
'         ResinCapacityConversionFactor = Resin.ApparentDensity
'   End Select
'
End Function

Function ReverseTemperatureConversion(UnitsToConvertFrom As Integer, Temperature_NonCelcius As Double) As Double
   'This function will convert from non-standard temperature units (K, R, or F) to
   'standard temperature units (C)

   Select Case UnitsToConvertFrom
      
      Case TEMPERATURE_C   'Convert from Deg. C
         ReverseTemperatureConversion = Temperature_NonCelcius
      Case TEMPERATURE_K   'Convert from Deg. K
         ReverseTemperatureConversion = Temperature_NonCelcius - 273.15
      Case TEMPERATURE_R   'Convert from Deg. R
         ReverseTemperatureConversion = (Temperature_NonCelcius / 1.8) - 273.15
      Case TEMPERATURE_F   'Convert from Deg. F
         ReverseTemperatureConversion = ((Temperature_NonCelcius + 459.67) / 1.8) - 273.15
   End Select

End Function

Sub SetUnits(UnitList As ComboBox, NewUnitStr As String)
Dim i As Integer
Dim NewUnit As Integer

  NewUnit = -1

  For i = 0 To UnitList.ListCount - 1
    If (Trim$(UnitList.List(i)) = Trim$(NewUnitStr)) Then
      NewUnit = i
      Exit For
    End If
  Next i

  If (NewUnit = -1) Then
    'Error!  Unit not found!
    NewUnit = 0
  End If

  UnitList.ListIndex = NewUnit
  
End Sub

Function TemperatureConversion(UnitsToConvertTo As Integer, Temperature_Celcius As Double) As Double
   'This function will convert from standard temperature units (C) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case TEMPERATURE_C
         TemperatureConversion = Temperature_Celcius
      Case TEMPERATURE_K   'Convert to Deg. K
         TemperatureConversion = Temperature_Celcius + 273.15
      Case TEMPERATURE_R   'Convert to Deg. R
         TemperatureConversion = (Temperature_Celcius + 273.15) * 1.8
      Case TEMPERATURE_F   'Convert to Deg. F
         TemperatureConversion = (Temperature_Celcius + 273.15) * 1.8 - 459.67
   End Select

End Function

Function TimeConversionFactor(UnitsToConvertTo As Integer) As Double
   'This function will convert from standard time units (sec) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case TIME_S
         TimeConversionFactor = 1#
      Case TIME_MIN   'Convert to min
         TimeConversionFactor = 1 / 60#
      Case TIME_HR    'Convert to hr
         TimeConversionFactor = 1# / 60# / 60#
      Case TIME_D     'Convert to d
         TimeConversionFactor = 1# / 60# / 60# / 24#
      Case TIME_YEAR     'Convert to year
         TimeConversionFactor = 1# / 60# / 60# / 24# / 365.25
   
   End Select

End Function

Function VelocityConversionFactor(UnitsToConvertTo As Integer) As Double

   'This function will convert from standard velocity units (cm/s) to
   'the units specified by the user.

   Select Case UnitsToConvertTo
      Case VELOCITY_CM_per_S
         VelocityConversionFactor = 1#
      Case VELOCITY_CM_per_MIN   'Convert to cm/min
         VelocityConversionFactor = 60#
      Case VELOCITY_M_per_S   'Convert to m/s
         VelocityConversionFactor = 1 / (100#)
      Case VELOCITY_M_per_MIN   'Convert to m/min
         VelocityConversionFactor = 60# / (100#)
      Case VELOCITY_M_per_HR   'Convert to m/hr
         VelocityConversionFactor = (60# * 60#) / (100#)
      Case VELOCITY_M_per_D   'Convert to m/d
         VelocityConversionFactor = (60# * 60# * 24#) / (100#)
      Case VELOCITY_FT_per_S   'Convert to ft/s
         VelocityConversionFactor = (3.2808 / 100#)
      Case VELOCITY_FT_per_MIN   'Convert to ft/min
         VelocityConversionFactor = 60# * (3.2808 / 100#)
      Case VELOCITY_FT_per_HR   'Convert to ft/hr
         VelocityConversionFactor = 60# * 60# * (3.2808 / 100#)
      Case VELOCITY_FT_per_D   'Convert to ft/d
         VelocityConversionFactor = 60# * 60# * 24# * (3.2808 / 100#)
   End Select

End Function

Function VolumeConversionFactor(UnitsToConvertTo As Integer) As Double
'This function will convert from standard volume units (m^3) to
'the units specified by the user.

  Select Case UnitsToConvertTo
    Case VOLUME_M3
      VolumeConversionFactor = 1#
    Case VOLUME_CM3
      VolumeConversionFactor = 1000# * 1000#
    Case VOLUME_LITER
      VolumeConversionFactor = 1000#
    Case VOLUME_FT3
      VolumeConversionFactor = 35.3147
    Case VOLUME_GAL
      VolumeConversionFactor = 264.172
  End Select

End Function

Attribute VB_Name = "UNITSYS0"
Option Explicit

Type rec_unitsys
  deleted As Integer
  formx As Form
  lblx As Control
  TxtX As Control
  CboX As Control
  unittype As String
  baseunit As String
  format_entry As String
  format_display As String
  current_value As Double
  has_units As Integer
  dirty As Integer
End Type

Global unitsys() As rec_unitsys

Global Const WHICHFORMAT_FORMAT_ENTRY = 1
Global Const WHICHFORMAT_FORMAT_DISPLAY = 2

Global Most_Recent_GotFocus As Integer




Const UNITSYS0_declarations_end = 0


Sub unitsys_clear_dirty_flag_on_form(formx As Form)
Dim i As Integer

  For i = 1 To UBound(unitsys)
    If (Not unitsys(i).deleted) Then
      If (formx.hWnd = unitsys(i).formx.hWnd) Then
        unitsys(i).dirty = False
      End If
    End If
  Next i

End Sub


Sub unitsys_control_cbox_click(CboX As Control)
Dim H As Integer
Dim NewUnits As String

  H = unitsys_lookup_cbox(CboX)
  If (H = -1) Then Exit Sub

  NewUnits = CboX.List(CboX.ListIndex)
  Call unitsys_display_a_number(H, NewUnits, WHICHFORMAT_FORMAT_DISPLAY)

End Sub


Sub unitsys_control_txtx_gotfocus(TxtX As Control)
Dim H As Integer
Dim nowunit As String
  'GET HANDLE.
  H = unitsys_lookup_txtx(TxtX)     'txtx.name
  If (H = -1) Then Exit Sub
  'DISPLAY NUMBER USING DATA-ENTRY FORMAT
  If (unitsys(H).has_units) Then
    nowunit = unitsys(H).CboX.List(unitsys(H).CboX.ListIndex)
    Call unitsys_display_a_number(H, nowunit, WHICHFORMAT_FORMAT_ENTRY)
  Else
    Call unitsys_display_a_number(H, "", WHICHFORMAT_FORMAT_ENTRY)
  End If
  'HIGHLIGHT THE SELECTION.
  'unitsys(h).txtx.SelStart = 0
  'unitsys(h).txtx.SelLength = Len(unitsys(h).txtx)
  Call Global_GotFocus(unitsys(H).TxtX)
  'SET MOST RECENT.
  Most_Recent_GotFocus = H
End Sub
'PARAMETERS:
'- txtx: the text control
'- newvalue: new numerical value in BASE units!
Sub unitsys_control_txtx_lostfocus(TxtX As Control, NewValue As Double)
Dim H As Integer
Dim nowunit As String
  'GET HANDLE.
  H = unitsys_lookup_txtx(TxtX)
  If (H = -1) Then Exit Sub
  'STORE NEW DATA INTO VARIABLE.
  unitsys(H).current_value = NewValue
  'FORMAT FOR DISPLAY.
  If (unitsys(H).has_units) Then
    nowunit = unitsys(H).CboX.List(unitsys(H).CboX.ListIndex)
    Call unitsys_display_a_number(H, nowunit, WHICHFORMAT_FORMAT_DISPLAY)
  Else
    Call unitsys_display_a_number(H, "", WHICHFORMAT_FORMAT_DISPLAY)
  End If
  'DE-HIGHLIGHT THE SELECTION.
  Call Global_LostFocus(TxtX)
  'SET MOST RECENT.
  Most_Recent_GotFocus = -1
End Sub
Sub unitsys_control_MostRecent_Force_lostfocus()
Dim H As Integer
Dim NewValue As Double
Dim TxtX As Control
  'GET HANDLE.
  H = Most_Recent_GotFocus
  If (H <= 0) Then Exit Sub
  'FORCE MOST RECENT TEXTBOX TO LOSE FOCUS (WITHOUT CHANGES).
  NewValue = unitsys(H).current_value
  Set TxtX = unitsys(H).TxtX
  Call unitsys_control_txtx_lostfocus(TxtX, NewValue)
End Sub


'RETURNS:
'- FALSE = Failed to validate this new data
'- TRUE = New data validated OK
'PARAMETERS:
'- txtx = Text control (INPUT)
'- val_low = Low value in the base unit (double) (INPUT)
'- val_high = High value in the base unit (double) (INPUT)
'- newvalue = The new value output to the caller (double) (RETURNED)
'- raise_dirty_flag = Whether the data has changed (boolean) (RETURNED)
Function unitsys_control_txtx_lostfocus_validate( _
    TxtX As Control, _
    Val_Low As Double, _
    Val_High As Double, _
    NewValue As Double, _
    Raise_Dirty_Flag As Boolean)
Dim H As Integer
Dim dbl As Double
Dim msg As String

Dim newvalue_oldunits As Double
Dim newvalue_baseunits As Double
Dim nowunits As String

Dim OldValue As Double

  H = unitsys_lookup_txtx(TxtX)
  If (H = -1) Then
    unitsys_control_txtx_lostfocus_validate = False
    Exit Function
  End If

  'DEFAULT: DATA HAS NOT CHANGED.
  Raise_Dirty_Flag = False

  'READ IN THE OLD VALUE FROM UNIT SYSTEM MEMORY TO LOCAL MEMORY.
  OldValue = unitsys(H).current_value
  NewValue = OldValue   'SET NEWVALUE IN CASE AN ERROR OCCURS!
  
  'IS THIS THE CONTROL THAT MOST RECENTLY HAD FOCUS ACCORDING
  'TO MY INTERNAL RECORDS?  IF NOT, WE HAVE TO INVALIDATE
  'THE LOSTFOCUS.
  If (H = Most_Recent_GotFocus) Then
    'THIS IS OKAY; DO NOTHING.
  Else
    unitsys_control_txtx_lostfocus_validate = False
    NewValue = OldValue
    Exit Function
  End If

  'DETERMINE UNITS; IF AN ERROR OCCURS, THIS WILL ALLOW THE
  'OLD VALUE TO BE REDISPLAYED IN ITS PROPER UNITS.
  If (unitsys(H).has_units) Then
    nowunits = unitsys(H).CboX.List(unitsys(H).CboX.ListIndex)
  Else
    nowunits = ""
  End If
  
  'CONVERT STRING TO DOUBLE.
  On Error GoTo err_unitsys_control_txtx_lostfocus_validate
  NewValue = CDbl(TxtX.Text)

  'CONVERT VALUE TO BASE UNITS (IF APPLICABLE).
  If (unitsys(H).has_units) Then
    ''''nowunits = unitsys(h).cbox.List(unitsys(h).cbox.ListIndex)
    newvalue_oldunits = NewValue
    Call unitsys_convert(unitsys(H).unittype, nowunits, unitsys(H).baseunit, newvalue_oldunits, newvalue_baseunits)
    NewValue = newvalue_baseunits
  Else
    ''''nowunits = ""
  End If

  'PERFORM RANGE CHECK.
  If ((NewValue < Val_Low) Or (NewValue > Val_High)) Then
    unitsys_control_txtx_lostfocus_validate = False
    If (unitsys(H).has_units) Then
      msg = "The data entered (" & Chr$(34) & TxtX.Text & Chr$(34) & _
          " " & nowunits & ") is outside of the range " & Trim$(Str$(Val_Low)) & _
          " to " & Trim$(Str$(Val_High)) & " " & unitsys(H).baseunit & _
          ".  This data has been replaced with its previous value."
      Call unitsys_display_a_number(H, nowunits, WHICHFORMAT_FORMAT_DISPLAY)
      'ADDED ON 8/27/98.
      NewValue = OldValue
    Else
      msg = "The data entered (" & Chr$(34) & TxtX.Text & Chr$(34) & _
          ") is outside of the range " & Trim$(Str$(Val_Low)) & " to " _
          & Trim$(Str$(Val_High)) & ".  This data has been replaced with its previous value."
      'xaxaxa
      ''''unitsys(h).txtx = Format$(unitsys(h).current_value, unitsys(h).format_entry)
      Call unitsys_display_a_number(H, "", WHICHFORMAT_FORMAT_DISPLAY)
      'ADDED ON 8/27/98.
      NewValue = OldValue
    End If
    ''''MsgBox msg
    'NOTE: DISPLAYING A MESSAGE BOX INTERFERES
    'WITH THE LOSTFOCUS-GOTFOCUS; SKIPPING THIS STEP.
    Exit Function
  End If
  
  'TELL CALLER THIS DATA IS VALID!!
  unitsys_control_txtx_lostfocus_validate = True
  
  'UPDATE DIRTY FLAG IF NEEDED.
  If (Abs(((OldValue + 0.00000001) / (NewValue + 0.00000001)) - 1) > 0.00001) Then
    unitsys(H).dirty = True
    'MsgBox "Dirty flag raised!"
    Raise_Dirty_Flag = True
  End If
  
exit_err_unitsys_control_txtx_lostfocus_validate:
  Exit Function

err_unitsys_control_txtx_lostfocus_validate:
  unitsys_control_txtx_lostfocus_validate = False
  msg = "The data entered is invalid (" & Chr$(34) & TxtX.Text & Chr$(34) & _
      ").  This data has been replaced with its previous value."
  'xaxaxa
  ''''unitsys(h).txtx = Format$(unitsys(h).current_value, unitsys(h).format_display)
  Call unitsys_display_a_number(H, nowunits, WHICHFORMAT_FORMAT_DISPLAY)
  ''''MsgBox msg
  'NOTE: DISPLAYING A MESSAGE BOX INTERFERES
  'WITH THE LOSTFOCUS-GOTFOCUS; SKIPPING THIS STEP.
  GoTo exit_err_unitsys_control_txtx_lostfocus_validate

End Function


'PARAMETERS:
'- unittype = type of unit
'- unit_from = unit to convert from
'- unit_to = unit to convert to
'- val_from = value to convert from
'- val_to = results (OUTPUT)
Sub unitsys_convert(unittype As String, unit_from As String, unit_to As String, val_from As Double, val_to As Double)
Dim Found As Integer

Dim uf As String
Dim ut As String
Dim temp_degK As Double
Dim factor_from As Double
Dim factor_to As Double

  Found = False
  If (UCase$(unittype) = "TEMPERATURE") Then
    uf = UCase$(unit_from)
    If (uf = "K") Then
      temp_degK = val_from
    ElseIf (uf = "C") Then
      temp_degK = val_from + 273.15
    ElseIf (uf = "R") Then
      temp_degK = val_from * 5# / 9#
    ElseIf (uf = "F") Then
      temp_degK = 273.15 + (val_from - 32#) * (5# / 9#)
    End If
    ut = UCase$(unit_to)
    If (ut = "K") Then
      val_to = temp_degK
    ElseIf (ut = "C") Then
      val_to = temp_degK - 273.15
    ElseIf (ut = "R") Then
      val_to = temp_degK * 9# / 5#
    ElseIf (ut = "F") Then
      val_to = 32 + (temp_degK - 273.15) * (9# / 5#)
    End If
    Found = True
  End If
  If (Not Found) Then
    factor_from = unitsys_convert_getfactor(unittype, unit_from)
    factor_to = unitsys_convert_getfactor(unittype, unit_to)
    If (factor_from = 0#) Or (factor_to = 0#) Then
      'CONVERT USING APPLICATION-SPECIFIC UNIT CODE.
      Call local_unitsys_convert(unittype, unit_from, unit_to, val_from, val_to)
      Exit Sub
    End If
    
    'CONVERT USING SIMPLE CONVERSION FACTORS.
    val_to = val_from / factor_to * factor_from
  End If
  
End Sub


Function unitsys_convert_getfactor(unittype As String, unitname As String)
Dim X As Double    'RETURN VALUE
Dim ut As String
Dim un As String

  X = 0#
  ut = UCase$(Trim$(unittype))
  un = UCase$(Trim$(unitname))
  If (ut = "LENGTH") Then
    If (un = "M") Then X = 1#
    If (un = "CM") Then X = 0.01
    If (un = "FT") Then X = 0.3048
    If (un = "IN") Then X = 0.0254
  End If
  If (ut = "MASS") Then
    If (un = "KG") Then X = 1#
    If (un = "G") Then X = 1# / 1000#
    If (un = "LB") Then X = 0.45359237
  End If
  If (ut = "TIME") Then
    If (un = "S") Then X = 1#
    If (un = "MIN") Then X = 1# * 60#
    If (un = "HR") Then X = 1# * 60# * 60#
    If (un = "D") Then X = 1# * 60# * 60# * 24#
    If (un = "YEAR") Then X = 1# * 60# * 60# * 24# * 365.25
  End If
  If (ut = "INVERSE_TIME") Then
    If (un = "1/S") Then X = 1#
    If (un = "1/MIN") Then X = 1# / 60#
    If (un = "1/HR") Then X = 1# / 60# / 60#
    If (un = "1/DAY") Then X = 1# / 60# / 60# / 24#
    If (un = "1/YEAR") Then X = 1# / 60# / 60# / 24# / 365.25
  End If
  If (ut = "REACTION_SOLIDPHASE") Then
    If (un = "1/S") Then X = 1#
    If (un = "1/MIN") Then X = 1# / 60#
    If (un = "1/HR") Then X = 1# / 60# / 60#
    If (un = "1/DAY") Then X = 1# / 60# / 60# / 24#
    If (un = "1/YEAR") Then X = 1# / 60# / 60# / 24# / 365.25
  End If
  If (ut = "REACTION_LIQUIDPHASE") Then
    If (un = "L/MOL-S") Then X = 1#
    If (un = "CM/MOL-S") Then X = 1# / 1000#
  End If
  If (ut = "REACTION_GASPHASE") Then
    If (un = "L/MOL-S") Then X = 1#
    If (un = "CM/MOL-S") Then X = 1# / 1000#
  End If
  If (ut = "LANGMUIR_QM") Then
    If (un = "MOL/G") Then X = 1#
  End If
  If (ut = "LANGMUIR_B") Then
    If (un = "L/MOL") Then X = 1#
  End If
  If (ut = "FLOW_VOLUMETRIC") Then
    If (un = "M/S") Then X = 1#
    If (un = "M/D") Then X = 1# / (60# * 60# * 24#)
    If (un = "CM/S") Then X = 1# / (100# * 100# * 100#)
    If (un = "ML/MIN") Then X = 1# / (100# * 100# * 100#) / (60#)
    If (un = "FT/S") Then X = 1# / (35.31466672)
    If (un = "FT/D") Then X = 1# / (35.31466672) / (60# * 60# * 24#)
    If (un = "GPM") Then X = 1# / (264.1720524) / (60#)
    If (un = "GPD") Then X = 1# / (264.1720524) / (60# * 60# * 24#)
    If (un = "MGD") Then X = (1000# * 1000#) / (264.1720524) / (60# * 60# * 24#)
    If (un = "FT/MIN") Then X = 1# / (35.31466672) / (60# * 24#)
  End If
  If (ut = "DENSITY") Then
    If (un = "G/ML") Then X = 1# * 1000#
    If (un = "KG/M") Then X = 1#
    If (un = "LB/FT") Then X = 1# * (0.45359237) / (0.028316847)
    If (un = "LB/GAL") Then X = 1# * (0.45359237) / (0.00378541178)
  End If
  If (ut = "CONCENTRATION") Then
    If (un = "G/L") Then X = 1# * 1000# * 1000#
    If (un = "MG/L") Then X = 1# * 1000#
    If (un = "G/L") Then X = 1#
  End If
  If (ut = "PRESSURE") Then
    ''If (un = "N/M") Then X = 1#
    'If (un = "PA") Then x = 1#
    'If (un = "LBF/IN") Then x = 1# * 6894.75729
    'If (un = "ATM") Then x = 1# * 101325#
    If (un = "PA") Then X = 1#
    If (un = "KPA") Then X = 1# / (1# / 1000#)
    If (un = "BARS") Then X = 1# / (1# / 100000#)
    If (un = "ATM") Then X = 1# / (1# / 101325#)
    If (un = "PSI") Then X = 1# / (14.696 / 101325#)
    If (un = "MMHG") Then X = 1# / (760# / 101325#)
    If (un = "MH20") Then X = 1# / (10.333 / 101325#)
    If (un = "FTH20") Then X = 1# / (33.9 / 101325#)
    If (un = "INHG") Then X = 1# / (29.921 / 101325#)
  End If
  If (ut = "VELOCITY") Then
    If (un = "M/S") Then X = 1#
    If (un = "M/HR") Then X = 1# * 0.0002777777
    If (un = "FT/S") Then X = 1# * 0.3048
    If (un = "FT/HR") Then X = 1# * 0.3048 * 0.0002777777
  End If
  If (ut = "MOLAR_VOLUME") Then
    If (un = "M/KMOL") Then X = 1# * 0.001
    If (un = "M/GMOL") Then X = 1#
    If (un = "L/GMOL") Then X = 1# * 0.001
    If (un = "ML/GMOL") Then X = 1# * 0.000001
  End If
  If (ut = "VISCOSITY") Then
    If (un = "KG/M-S") Then X = 1#
    If (un = "G/CM-S") Then X = 1# * 0.1
    If (un = "CP") Then X = 1# * 0.001
  End If
  If (ut = "MOLECULAR_WEIGHT") Then
    If (un = "MG/MMOL") Then X = 1#
    If (un = "G/MOL") Then X = 1#
    If (un = "G/GMOL") Then X = 1#
    If (un = "KG/KMOL") Then X = 1#
  End If
  If (ut = "VOLUME") Then
    If (un = "M") Then X = 1#
    If (un = "CM") Then X = 0.000001
    If (un = "LITER") Then X = 0.001
    If (un = "FT") Then X = 0.028316846592
    If (un = "GAL") Then X = 0.003785411784
  End If
  If (ut = "MASS_EMISSION_RATE") Then
    If (un = "G/S") Then X = 1#
    If (un = "G/MIN") Then X = 1# / 60#
    If (un = "MG/S") Then X = 1# * 1000#
    If (un = "MG/MIN") Then X = 1000# / 60#
    
    'If (un = "G/S") Then X = 1#
    'If (un = "G/MIN") Then X = 1# * 1000#
    'If (un = "MG/S") Then X = 1# / 60#
    'If (un = "MG/MIN") Then X = 1000# / 60#
  End If
  unitsys_convert_getfactor = X

End Function


'PARAMETERS:
'- h: handle to unit control
'- nowunit: current units of this control (if any)
'- which_format: 1=format_entry, 2=format_display
Sub unitsys_display_a_number(H As Integer, nowunit As String, which_format As Integer)
Dim num_in_properunits As Double
Dim use_format As String
Dim Number_To_Display As Double
Dim ForceToAFormat As Boolean
  'DETERMINE ACTUAL NUMBER TO DISPLAY ON THE SCREEN.
  If (Not unitsys(H).has_units) Then
    Number_To_Display = unitsys(H).current_value
  Else
    Call unitsys_convert(unitsys(H).unittype, _
        unitsys(H).baseunit, nowunit, _
        unitsys(H).current_value, num_in_properunits)
    Number_To_Display = num_in_properunits
  End If
  'DETERMINE APPROPRIATE NUMERIC FORMAT TO USE.
  Select Case which_format
    Case WHICHFORMAT_FORMAT_ENTRY:
      ForceToAFormat = Not (Trim$(unitsys(H).format_entry) = "")
      If (ForceToAFormat) Then use_format = unitsys(H).format_entry
      If (Not ForceToAFormat) Then use_format = GetDoubleFormatLonger(Number_To_Display)
    Case WHICHFORMAT_FORMAT_DISPLAY:
      ForceToAFormat = Not (Trim$(unitsys(H).format_display) = "")
      If (ForceToAFormat) Then use_format = unitsys(H).format_display
      If (Not ForceToAFormat) Then use_format = GetDoubleFormat(Number_To_Display)
  End Select
  'DISPLAY THE NUMBER.
  unitsys(H).TxtX = Format$(Number_To_Display, use_format)
End Sub


Function unitsys_get_numerical_value(TxtX As Control) As Double
Dim H As Integer
  H = unitsys_lookup_txtx(TxtX)
  unitsys_get_numerical_value = unitsys(H).current_value
End Function


Sub unitsys_initialize()
  ReDim Preserve unitsys(1 To 1)
  unitsys(1).deleted = True
End Sub


Function unitsys_is_any_data_dirty(formx As Form)
Dim RetVal As Integer
Dim i As Integer

  RetVal = False
  For i = 1 To UBound(unitsys)
    If (Not unitsys(i).deleted) Then
      If (formx.hWnd = unitsys(i).formx.hWnd) Then
        If (unitsys(i).dirty) Then
          RetVal = True
          Exit For
        End If
      End If
    End If
  Next i
  unitsys_is_any_data_dirty = RetVal
End Function


Function unitsys_lookup_cbox(CboX As Control)
Dim i As Integer
Dim Found As Integer
Dim H As Integer

  Found = False
  For i = 1 To UBound(unitsys)
    If (Not unitsys(i).deleted) Then
      If (unitsys(i).has_units) Then
        If (CboX.hWnd = unitsys(i).CboX.hWnd) Then
          Found = True
          H = i
        End If
      End If
    End If
  Next i
  If (Not Found) Then
    unitsys_lookup_cbox = -1
  Else
    unitsys_lookup_cbox = H
  End If

End Function


Function unitsys_lookup_txtx(TxtX As Control)
Dim i As Integer
Dim Found As Integer
Dim H As Integer
  Found = False
  For i = 1 To UBound(unitsys)
    If (Not unitsys(i).deleted) Then
'txtx.hwnd
'unitsys(i).txtx.hWnd
      If (TxtX.hWnd = unitsys(i).TxtX.hWnd) Then
        Found = True
        H = i
      End If
    End If
  Next i
  If (Not Found) Then
    unitsys_lookup_txtx = -1
  Else
    unitsys_lookup_txtx = H
  End If
End Function


Sub unitsys_populate_units(H As Integer, unittype As String, initunit As String)
Dim u As String
Dim cbc As Control
Dim i As Integer
Dim Found As Integer

  u = LCase$(unittype)
  Set cbc = unitsys(H).CboX
  cbc.Clear
  Found = False
  If (u = "length") Then
    Found = True
    cbc.AddItem "m"
    cbc.AddItem "cm"
    cbc.AddItem "ft"
    cbc.AddItem "in"
  End If
  If (u = "mass") Then
    Found = True
    cbc.AddItem "kg"
    cbc.AddItem "g"
    cbc.AddItem "lb"
  End If
  If (u = "time") Then
    Found = True
    cbc.AddItem "s"
    cbc.AddItem "min"
    cbc.AddItem "hr"
    cbc.AddItem "d"
    cbc.AddItem "year"
  End If
  If (u = "inverse_time") Then
    Found = True
    cbc.AddItem "1/s"
    cbc.AddItem "1/min"
    cbc.AddItem "1/hr"
    cbc.AddItem "1/day"
    cbc.AddItem "1/year"
  End If
  If (u = "reaction_solidphase") Then
    Found = True
    cbc.AddItem "1/s"
    cbc.AddItem "1/min"
    cbc.AddItem "1/hr"
    cbc.AddItem "1/day"
    cbc.AddItem "1/year"
  End If
  If (u = "reaction_liquidphase") Then
    Found = True
    cbc.AddItem "L/mol-s"
    cbc.AddItem "cm/mol-s"
  End If
  If (u = "reaction_gasphase") Then
    Found = True
    cbc.AddItem "L/mol-s"
    cbc.AddItem "cm/mol-s"
  End If
  If (u = "langmuir_qm") Then
    Found = True
    cbc.AddItem "mol/g"
  End If
  If (u = "langmuir_b") Then
    Found = True
    cbc.AddItem "L/mol"
  End If
  If (u = "flow_volumetric") Then
    Found = True
    cbc.AddItem "m/s"
    cbc.AddItem "m/d"
    cbc.AddItem "cm/s"
    cbc.AddItem "mL/min"
    cbc.AddItem "ft/s"
    cbc.AddItem "ft/d"
    cbc.AddItem "gpm"
    cbc.AddItem "gpd"
    cbc.AddItem "MGD"
    cbc.AddItem "ft/min"
  End If
  If (u = "density") Then
    Found = True
    cbc.AddItem "g/mL"
    cbc.AddItem "kg/m"
    cbc.AddItem "lb/ft"
    cbc.AddItem "lb/gal"
  End If
  If (u = "temperature") Then
    Found = True
    cbc.AddItem "K"
    cbc.AddItem "C"
    cbc.AddItem "R"
    cbc.AddItem "F"
  End If
  If (u = "concentration") Then
    Found = True
    cbc.AddItem "g/L"
    cbc.AddItem "mg/L"
    cbc.AddItem "g/L"
  End If
  If (u = "pressure") Then
    Found = True
    cbc.AddItem "Pa"      '"N/m"
    cbc.AddItem "kPa"
    cbc.AddItem "bars"
    cbc.AddItem "atm"
    cbc.AddItem "psi"
    cbc.AddItem "mmHg"
    cbc.AddItem "mH20"
    cbc.AddItem "ftH20"
    cbc.AddItem "inHg"
  End If
  If (u = "velocity") Then
    Found = True
    cbc.AddItem "m/s"
    cbc.AddItem "m/hr"
    cbc.AddItem "ft/s"
    cbc.AddItem "ft/hr"
  End If
  If (u = "molar_volume") Then
    Found = True
    cbc.AddItem "m/kmol"
    cbc.AddItem "m/gmol"
    cbc.AddItem "L/gmol"
    cbc.AddItem "mL/gmol"
  End If
  If (u = "viscosity") Then
    Found = True
    cbc.AddItem "kg/m-s"
    cbc.AddItem "g/cm-s"
    cbc.AddItem "cP"
  End If
  If (u = "molecular_weight") Then
    Found = True
    cbc.AddItem "mg/mmol"
    cbc.AddItem "g/mol"
    cbc.AddItem "g/gmol"
    cbc.AddItem "kg/kmol"
  End If
  If (u = "volume") Then
    Found = True
    cbc.AddItem "m"
    cbc.AddItem "cm"
    cbc.AddItem "liter"
    cbc.AddItem "ft"
    cbc.AddItem "gal"
  End If
  If (u = "mass_emission_rate") Then
    Found = True
    cbc.AddItem "g/s"
    cbc.AddItem "g/min"
    cbc.AddItem "mg/s"
    cbc.AddItem "mg/min"
  End If
  If (Not Found) Then
    Call local_unitsys_populate_units(H, unittype)
  End If
  For i = 0 To cbc.ListCount - 1
    If (UCase$(initunit) = UCase$(cbc.List(i))) Then
      cbc.ListIndex = i
      Exit For
    End If
  Next i
  
End Sub


'PURPOSE: Register a new unit control.
'Parameters:
'- formx: pointer to form that contains unit control
'- lblx: description label
'- txtx: data-entry textbox
'- cbox: unit checkbox
'- unittype: unit type (string)
'- initunit: initial unit (string)
'- baseunit: base unit, used to store numerical value (string)
'- format_entry: numerical format for data-entry
'- format_display: numerical format for display
'- initnum: initial number in _base_ units! (double)
'- has_units: if unit-conversion features enabled, this is TRUE
Sub unitsys_register( _
    formx As Form, _
    lblx As Control, _
    TxtX As Control, _
    CboX As Control, _
    unittype As String, _
    initunit As String, _
    baseunit As String, _
    format_entry As String, _
    format_display As String, _
    initnum As Double, _
    has_units As Integer)
Dim H As Integer
Dim i As Integer
Dim Found As Integer
Dim ub As Integer
  
Dim num_in_properunits As Double

  Found = 0
  ub = UBound(unitsys)
  For i = 1 To ub
    If (unitsys(i).deleted) Then
      Found = i
      Exit For
    End If
  Next i
  If (Found = 0) Then
    ReDim Preserve unitsys(1 To ub + 1)
    H = ub + 1
  Else
    H = Found
  End If
  
  '==== INSTALL NEW UNIT CONTROL
  'TELL ANY PROCESSES THIS CONTROL DOES NOT EXIST YET!
  unitsys(H).dirty = False
  unitsys(H).deleted = True
  Set unitsys(H).formx = formx
  Set unitsys(H).lblx = lblx
  Set unitsys(H).TxtX = TxtX
  Set unitsys(H).CboX = CboX
'txtx.hwnd
  unitsys(H).unittype = unittype
  unitsys(H).baseunit = baseunit
  unitsys(H).format_entry = format_entry
  unitsys(H).format_display = format_display
  unitsys(H).has_units = has_units
  unitsys(H).current_value = initnum
  Call unitsys_display_a_number(H, initunit, WHICHFORMAT_FORMAT_DISPLAY)
  If (unitsys(H).has_units) Then
    Call unitsys_populate_units(H, unittype, initunit)
  End If
  
  'TELL ANY PROCESSES THIS CONTROL IS READY FOR OPERATION.
  unitsys(H).deleted = False

End Sub


Sub unitsys_set_number_in_base_units(TxtX As Control, new_value As Double)
Dim H As Integer
Dim nowunit As String
  H = unitsys_lookup_txtx(TxtX)
  If (H = -1) Then Exit Sub
  unitsys(H).current_value = new_value
  'Call unitsys_display_a_number(h, unitsys(h).baseunit, WHICHFORMAT_FORMAT_DISPLAY)
  If (unitsys(H).has_units) Then
    nowunit = unitsys(H).CboX.List(unitsys(H).CboX.ListIndex)
    Call unitsys_display_a_number(H, nowunit, WHICHFORMAT_FORMAT_DISPLAY)
  Else
    Call unitsys_display_a_number(H, "", WHICHFORMAT_FORMAT_DISPLAY)
  End If
End Sub


Function unitsys_get_units(CboX As Control) As String
  unitsys_get_units = CboX.List(CboX.ListIndex)
End Function
Sub unitsys_set_units(TxtX As Control, new_units As String)
Dim H As Integer
Dim i As Integer
Dim Found As Integer
Dim max As Integer
  H = unitsys_lookup_txtx(TxtX)
  If (H <= 0) Then Exit Sub
  Found = False
  max = unitsys(H).CboX.ListCount - 1
  For i = 0 To max
    If (Trim$(UCase$(unitsys(H).CboX.List(i))) = Trim$(UCase$(new_units))) Then
      Found = True
      Exit For
    End If
  Next i
  If (Found) Then
    unitsys(H).CboX.ListIndex = i
  End If
End Sub


Sub unitsys_unregister_one_control(H As Integer)
  unitsys(H).deleted = True
  Set unitsys(H).formx = Nothing
  Set unitsys(H).lblx = Nothing
  Set unitsys(H).TxtX = Nothing
  Set unitsys(H).CboX = Nothing
End Sub


Sub unitsys_unregister_all_on_form(formx As Form)
Dim i As Integer
  For i = 1 To UBound(unitsys)
    If (Not unitsys(i).deleted) Then
      If (formx.hWnd = unitsys(i).formx.hWnd) Then
        'formx.name
        Call unitsys_unregister_one_control(i)
      End If
    End If
  Next i
End Sub


Attribute VB_Name = "UNITS_LOCAL"

''COMMUNICATIONS WITH frmBed.
'Global frmBed_Copy_Of_CURRENT_BEDCOMPONENT As Integer
'Global frmBed_Copy_Of_TempBedDef As BedDefinition_Type
'Global frmBed_Copy_Of_TempProj As Project_Type
'      'NOTE: THIS RECORD IS USED TO OBTAIN THE VALUES
'      'OF THE FOLLOWING VARIABLES (CURRENTLY DISPLAYED COMPONENT):
'      '    - molecular weight
'      '    - Freundlich 1/n





Const UNITS_LOCAL_declarations_end = 0


Function local_unitsys_convert_getfactor_FreundlichK( _
    unittype As String, _
    factor1 As Double, _
    factor2 As Double) As Double
Dim x As Double
  Select Case Trim$(UCase$(unittype))
    Case "(MG/G)*(L/MG)^(1/N)":
      x = 1#
    Case "(MMOL/G)*(L/MMOL)^(1/N)":
      x = 1# / factor1
    Case "(G/G)*(L/G)^(1/N)":
      x = 1# / factor2
    Case "(MOL/G)*(L/MOL)^(1/N)":
      x = 1# / factor1 / factor2
  End Select
  local_unitsys_convert_getfactor_FreundlichK = x
End Function


Sub local_unitsys_convert( _
    unittype As String, _
    unit_from As String, _
    unit_to As String, _
    val_from As Double, _
    val_to As Double)
Dim now_MW As Double
Dim now_OneOverN As Double
Dim factor1 As Double
Dim factor2 As Double
Dim factor_from As Double
Dim factor_to As Double
  unittype = Trim$(UCase$(unittype))
  If (unittype = Trim$(UCase$("freundlich_k"))) Then
    'now_MW = frmBed_Copy_Of_TempProj.Components( _
    '    frmBed_Copy_Of_CURRENT_BEDCOMPONENT).xwt
    'now_OneOverN = frmBed_Copy_Of_TempBedDef.BedComponents( _
    '    frmBed_Copy_Of_CURRENT_BEDCOMPONENT).XN
    now_MW = Component(0).MW
    now_OneOverN = Component(0).Use_OneOverN
    factor1 = (now_MW) ^ (now_OneOverN - 1#)
    factor2 = (1000#) ^ (1# - now_OneOverN)
    factor_from = local_unitsys_convert_getfactor_FreundlichK(unit_from, factor1, factor2)
    factor_to = local_unitsys_convert_getfactor_FreundlichK(unit_to, factor1, factor2)
    'PERFORM THE CONVERSION.
    val_to = val_from / factor_to * factor_from
  End If
End Sub
Sub local_unitsys_populate_units(h As Integer, unittype As String)
  unittype = Trim$(UCase$(unittype))
  If (unittype = Trim$(UCase$("freundlich_k"))) Then
    unitsys(h).cbox.AddItem "(mg/g)*(L/mg)^(1/n)"
    unitsys(h).cbox.AddItem "(mmol/g)*(L/mmol)^(1/n)"
    unitsys(h).cbox.AddItem "(g/g)*(L/g)^(1/n)"
    unitsys(h).cbox.AddItem "(mol/g)*(L/mol)^(1/n)"
  End If
End Sub


Attribute VB_Name = "Validations"
Option Explicit

Sub Check_Length(D As Double, Flag_Small As Integer)
Dim E As Double
Dim msg As String
  E = Bed.Weight * 4# / PI / Bed.Diameter ^ 2 / D / Carbon.Density / 1000#
  If (E > 0.999) Then
    msg = "The bed length you just entered is too small to contain the weight of activated carbon you have specified."
    msg = msg & Chr$(10) & Chr$(10) & "Recommendation: Try to re-specify bed diameter, bed length, weight of carbon, and/or carbon density."
    Call Show_Error(msg)
    Flag_Small = True
  Else
    Flag_Small = False
  End If
End Sub
Sub Check_Density(D As Double, Flag_Small As Integer)
Dim E As Double
Dim msg As String
  E = Bed.Weight * 4# / PI / Bed.Diameter ^ 2 / Bed.Length / D / 1000#
  If E > 0.999 Then
    msg = "The apparent density of carbon you just entered creates a bed dimensioning scenario where the bed is too small to contain the weight of activated carbon you have specified."
    msg = msg & Chr$(10) & Chr$(10) & "Recommendation: Try to re-specify bed diameter, bed length, weight of carbon, and/or carbon density."
    Call Show_Error(msg)
    Flag_Small = True
  Else
    Flag_Small = False
  End If
End Sub
Sub Check_Diameter(D As Double, Flag_Small As Integer)
Dim E As Double
Dim msg As String
  E = Bed.Weight * 4# / PI / D ^ 2 / Bed.Length / Carbon.Density / 1000#
  If E > 0.999 Then
    msg = "The bed diameter you just entered is too small to contain the weight of activated carbon you have specified."
    msg = msg & Chr$(10) & Chr$(10) & "Recommendation: Try to re-specify bed diameter, bed length, weight of carbon, and/or carbon density."
    Call Show_Error(msg)
    Flag_Small = True
  Else
    Flag_Small = False
  End If
End Sub
Sub Check_Weight(w As Double, Flag_Small As Integer)
Dim E As Double
Dim msg As String
  E = w * 4# / PI / Bed.Diameter ^ 2 / Bed.Length / Carbon.Density / 1000#
  If E > 0.999 Then
    msg = "The weight of activated carbon you just entered is too large to be contained by the bed with your specified dimensions."
    msg = msg & Chr$(10) & Chr$(10) & "Recommendation: Try to re-specify bed diameter, bed length, weight of carbon, and/or carbon density."
    Call Show_Error(msg)
    Flag_Small = True
  Else
    Flag_Small = False
  End If
End Sub


Sub Check_Time_Parameters(WhichParam As Integer, EnteredValue As Double, ForceAbort As Integer)
Dim New_FirstPoint As Double
Dim New_LastPoint As Double
Dim New_TimeStep As Double
Dim UserMsg As String
Dim Force_New_TimeStep As Double
Dim Old_TimeStep As Double
Dim conversionfactor1 As Double
Dim conversionfactor2 As Double

  ForceAbort = False
  
  New_FirstPoint = TimeP.Init
  New_LastPoint = TimeP.End
  New_TimeStep = TimeP.Step
  Select Case WhichParam
    Case 0    'Total run time
      New_LastPoint = EnteredValue
    Case 1    'First point
      New_FirstPoint = EnteredValue
    Case 2    'Time step
      New_TimeStep = EnteredValue
  End Select
    
  If (New_FirstPoint > New_LastPoint) Then
    ForceAbort = True
    Call Show_Error("The first time cannot be greater than the " & _
        "final time.")
    Exit Sub
  End If
  If (New_TimeStep < ((New_LastPoint - New_FirstPoint) / (Number_Points_Max - 1))) Then
    ForceAbort = True
    Call Show_Error("The time step is too small.  The maximum " & _
        "number of points is " & _
        Trim$(Str$(Number_Points_Max)) & ".")
    Exit Sub
  End If
  If ((Bed.NumberOfBeds = 1) Or (New_FirstPoint < 0.00011)) Then
    'Do nothing--this is okay.
  Else
    'For beds in series, initial time must be approximately zero.
    ForceAbort = True
    Old_TimeStep = New_TimeStep
    UserMsg = "For more than one axial element, the initial time must be approximately zero.  The initial time has been automatically reset to 0.0001 minutes."
    New_FirstPoint = 0.0001
    Force_New_TimeStep = (New_LastPoint - New_FirstPoint) / (Number_Points_Max - 5)
    If (New_TimeStep < Force_New_TimeStep) Then
      New_TimeStep = Force_New_TimeStep
      UserMsg = UserMsg & "  In addition, the time step was adjusted from " & Format_It(Old_TimeStep, 3) & " minutes to " & Format_It(New_TimeStep, 3) & " minutes."
    End If
    Call Show_Error(UserMsg)
    
    'THIS CODE WAS INTENDED TO REDISPLAY TIMES TO MAIN WINDOW.
    'IT IS NO LONGER NEEDED BECAUSE A CALL TO frmMain_Refresh() OCCURS
    'RIGHT AFTER THE CALL TO THIS SUBROUTINE.
    'conversionfactor1 = TimeConversionFactor(CInt(frmMain.txttimeunits(1).ListIndex))
    'conversionfactor2 = TimeConversionFactor(CInt(frmMain.txttimeunits(2).ListIndex))
    'txtTime(1) = Format_It(New_FirstPoint * 60 * conversionfactor1, 3)
    'txtTime(2) = Format_It(New_TimeStep * 60 * conversionfactor2, 3)
    TimeP.Init = New_FirstPoint
    TimeP.Step = New_TimeStep
    
    Exit Sub
  End If
    


    'If FirstPT > EndT Then
    '  MsgBox "The first point is greater than the final point.", MB_ICONEXCLAMATION, Application_Name
    '  Exit Sub
    'ElseIf Time_Step < ((EndT - FirstPT) / (Number_Points_Max - 1)) Then
    '  MsgBox "Time step is too small. The maximum number of points is 400.", MB_ICONEXCLAMATION, Application_Name
    '  Exit Sub
    'End If
    'TimeP.End = EndT * 24 * 60#    'To convert from days to minutes
    'If (Bed.NumberOfBeds = 1) Or ((FirstPT * 24# * 60#) < .00011) Then
    '   TimeP.Init = FirstPT * 24# * 60#  'To convert from days to minutes
    '   TimeP.Step = Time_Step * 24# * 60# 'To convert from days to minutes
    'Else   'For beds in series, initial time must be approximately zero
    '   FirstPT = .0001 / 24# / 60#
    '   NewTimeStep = (EndT - FirstPT) / (Number_Points_Max - 5)
    '   If Time_Step < NewTimeStep Then Time_Step = NewTimeStep
    '   MsgBox "For beds in series, the initial time must be approximately zero.  The initial time will automatically be adjusted to reflect this.  If necessary, the time step will also be adjusted.", MB_ICONINFORMATION
    '   txtTime(1) = Format_It(FirstPT, 2)
    '   txtTime(2) = Format_It(Time_Step, 2)
    '   Exit Sub
    'End If

End Sub


